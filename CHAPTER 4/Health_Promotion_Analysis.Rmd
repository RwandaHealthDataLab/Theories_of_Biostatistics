---
title: "Health Promotion: Smoking Cessation Study"
author: "Biostatistics Analysis"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
    highlight: tango
    code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.width = 12, fig.height = 8)
```

# Background

This analysis is based on a study conducted among 234 people who had expressed a desire to stop smoking but had not yet stopped. On the day they quit smoking, several measurements were taken:

- **Carbon monoxide (CO) level**: Provides an "objective" indicator of cigarettes smoked per day
- **Time since last cigarette**: Used to adjust CO levels
- **Corrected CO level**: Adjusted for time since last cigarette (LogCOadj)
- **Age and sex**: Demographic information
- **Self-reported cigarettes per day**: Subjective measure of smoking intensity

Participants were followed for 1 year to determine the number of days they remained abstinent. The number of days abstinent ranged from 0 days (quit for less than 1 day) to 365 days (abstinent for the full year).

**Research Questions:**
1. What is the probability of remaining abstinent at 1, 3, 6, and 12 months?
2. Are age, sex, cigarettes per day, and/or CO level related to success in quitting?

# Libraries

```{r libraries}
library(tidyverse)
library(knitr)
library(gridExtra)
library(scales)
library(survival)
```

# Data Import

```{r data-import}
# Read the SMOKE dataset
smoke_data <- read.csv("Rosner_FundamentalsBiostatistics_8e_Data_Sets/ASCII-comma/SMOKE.DAT.txt", check.names = FALSE)

# Remove quotes from column names
colnames(smoke_data) <- gsub("'", "", colnames(smoke_data))

# Display variable information
cat("Dataset Structure:\n")
str(smoke_data)

cat("\n\nVariable Descriptions:\n")
cat("Id: Subject identification number\n")
cat("Age: Age in years\n")
cat("Gender: Sex (1 = Male, 2 = Female)\n")
cat("Cig_day: Self-reported number of cigarettes smoked per day\n")
cat("CO: Carbon monoxide level (ppm)\n")
cat("Min_last: Minutes since last cigarette smoked\n")
cat("LogCOadj: Log of adjusted CO level (corrected for time since last cigarette)\n")
cat("Day_abs: Number of days abstinent (0-365)\n")

# Create labeled factors and additional variables
smoke_data <- smoke_data %>%
  mutate(
    Gender_Label = factor(Gender, levels = c(1, 2), labels = c("Male", "Female")),
    # Handle missing values (9999 indicates missing)
    CO_clean = ifelse(CO == 9999, NA, CO),
    Min_last_clean = ifelse(Min_last == 9999, NA, Min_last),
    LogCOadj_clean = ifelse(LogCOadj == 9999, NA, LogCOadj),
    # Create age groups
    Age_Group = cut(Age, breaks = c(0, 35, 50, 100),
                    labels = c("≤35", "36-50", ">50"),
                    include.lowest = TRUE),
    # Create cigarette categories
    Cig_Category = cut(Cig_day, breaks = c(0, 20, 30, 100),
                       labels = c("≤20/day", "21-30/day", ">30/day"),
                       include.lowest = TRUE),
    # Create CO level categories (using median split)
    CO_Category = cut(CO_clean, breaks = c(0, median(CO_clean, na.rm = TRUE), Inf),
                      labels = c("Low CO", "High CO"),
                      include.lowest = TRUE)
  )

# Display first few rows
head(smoke_data, 15) %>%
  select(Id, Age, Gender_Label, Cig_day, CO, LogCOadj_clean, Day_abs) %>%
  kable(caption = "First 15 Rows of SMOKE Dataset")

# Summary statistics
cat("\n\nSample Size: ", nrow(smoke_data), " participants\n")
cat("Missing CO values: ", sum(is.na(smoke_data$CO_clean)), "\n")
cat("Missing LogCOadj values: ", sum(is.na(smoke_data$LogCOadj_clean)), "\n")
```

# Data Exploration

```{r data-exploration}
# Summary statistics for continuous variables
summary_stats <- smoke_data %>%
  summarise(
    N = n(),
    Mean_Age = mean(Age, na.rm = TRUE),
    SD_Age = sd(Age, na.rm = TRUE),
    Mean_Cig_Day = mean(Cig_day, na.rm = TRUE),
    SD_Cig_Day = sd(Cig_day, na.rm = TRUE),
    Mean_CO = mean(CO_clean, na.rm = TRUE),
    SD_CO = sd(CO_clean, na.rm = TRUE),
    Mean_Days_Abs = mean(Day_abs, na.rm = TRUE),
    SD_Days_Abs = sd(Day_abs, na.rm = TRUE),
    Median_Days_Abs = median(Day_abs, na.rm = TRUE)
  )

t(summary_stats) %>%
  kable(digits = 2, caption = "Summary Statistics", col.names = "Value")

# Distribution by gender
cat("\n\nDistribution by Gender:\n")
smoke_data %>%
  count(Gender_Label) %>%
  mutate(Percentage = n / sum(n) * 100) %>%
  kable(digits = 1, col.names = c("Gender", "N", "Percentage (%)"))

# Success rate (full year abstinence)
success_rate <- sum(smoke_data$Day_abs == 365) / nrow(smoke_data) * 100
cat(sprintf("\n\nFull Year Abstinence Rate: %.1f%% (%d/%d)\n",
            success_rate,
            sum(smoke_data$Day_abs == 365),
            nrow(smoke_data)))

# Distribution of days abstinent
cat("\n\nDistribution of Days Abstinent:\n")
quantile(smoke_data$Day_abs, probs = c(0, 0.25, 0.5, 0.75, 1)) %>%
  kable(caption = "Quantiles of Days Abstinent", col.names = "Days")
```

---

# Problem 4.55: Life Table Analysis

**Question:** Develop a life table similar to Table 4.15, giving the number of people who remained abstinent at 1, 2, ..., 12 months of life (assume for simplicity that there are 30 days in each of the first 11 months after quitting and 35 days in the 12th month). Plot these data. Compute the probability that a person will remain abstinent at 1, 3, 6, and 12 months after quitting.

## Life Table Construction

```{r problem-4.55-lifetable}
# Define month intervals (in days)
month_days <- c(30, 60, 90, 120, 150, 180, 210, 240, 270, 300, 330, 365)
month_labels <- 1:12

# Create life table
life_table <- data.frame(
  Month = month_labels,
  Days_End = month_days
)

# Calculate life table statistics for each month
for (i in 1:nrow(life_table)) {
  current_days <- life_table$Days_End[i]

  if (i == 1) {
    # Month 1: start with all participants
    n_start <- nrow(smoke_data)
    n_relapsed <- sum(smoke_data$Day_abs < current_days)
    n_abstinent <- sum(smoke_data$Day_abs >= current_days)
  } else {
    # Subsequent months
    prev_days <- life_table$Days_End[i - 1]
    n_start <- sum(smoke_data$Day_abs >= prev_days)
    n_relapsed <- sum(smoke_data$Day_abs >= prev_days & smoke_data$Day_abs < current_days)
    n_abstinent <- sum(smoke_data$Day_abs >= current_days)
  }

  life_table$N_Start[i] <- n_start
  life_table$N_Relapsed[i] <- n_relapsed
  life_table$N_Abstinent[i] <- n_abstinent
  life_table$Proportion_Relapsed[i] <- n_relapsed / n_start
  life_table$Proportion_Abstinent[i] <- n_abstinent / n_start
  life_table$Cumulative_Survival[i] <- n_abstinent / nrow(smoke_data)
}

# Display life table
life_table %>%
  mutate(
    Pct_Relapsed = Proportion_Relapsed * 100,
    Pct_Abstinent = Proportion_Abstinent * 100,
    Pct_Cumulative = Cumulative_Survival * 100
  ) %>%
  select(Month, Days_End, N_Start, N_Relapsed, N_Abstinent,
         Pct_Relapsed, Pct_Cumulative) %>%
  kable(digits = 2,
        col.names = c("Month", "Days", "N at Start", "N Relapsed",
                      "N Abstinent", "% Relapsed", "% Cumulative Abstinent"),
        caption = "Life Table: Smoking Abstinence Over 12 Months")
```

## Survival Probabilities at Key Time Points

```{r problem-4.55-probabilities}
# Calculate probabilities at 1, 3, 6, and 12 months
key_months <- c(1, 3, 6, 12)
key_probs <- life_table %>%
  filter(Month %in% key_months) %>%
  select(Month, Days_End, N_Abstinent, Cumulative_Survival)

cat("Probability of Remaining Abstinent at Key Time Points:\n\n")
key_probs %>%
  mutate(
    Probability = Cumulative_Survival,
    Percentage = Cumulative_Survival * 100,
    N_Total = nrow(smoke_data)
  ) %>%
  select(Month, Days_End, N_Abstinent, N_Total, Probability, Percentage) %>%
  kable(digits = 4,
        col.names = c("Month", "Days", "N Abstinent", "N Total",
                      "Probability", "Percentage (%)"),
        caption = "Survival Probabilities at 1, 3, 6, and 12 Months")

# Extract specific probabilities
prob_1mo <- life_table$Cumulative_Survival[life_table$Month == 1]
prob_3mo <- life_table$Cumulative_Survival[life_table$Month == 3]
prob_6mo <- life_table$Cumulative_Survival[life_table$Month == 6]
prob_12mo <- life_table$Cumulative_Survival[life_table$Month == 12]

cat("\n\nSummary:\n")
cat(sprintf("- Probability of abstinence at 1 month:  %.4f (%.2f%%)\n", prob_1mo, prob_1mo * 100))
cat(sprintf("- Probability of abstinence at 3 months: %.4f (%.2f%%)\n", prob_3mo, prob_3mo * 100))
cat(sprintf("- Probability of abstinence at 6 months: %.4f (%.2f%%)\n", prob_6mo, prob_6mo * 100))
cat(sprintf("- Probability of abstinence at 12 months: %.4f (%.2f%%)\n", prob_12mo, prob_12mo * 100))
```

## Visualization

```{r problem-4.55-plot, fig.height=10}
# Survival curve plot
p1 <- ggplot(life_table, aes(x = Month, y = Cumulative_Survival * 100)) +
  geom_line(size = 1.2, color = "steelblue") +
  geom_point(size = 3, color = "steelblue") +
  geom_point(data = life_table %>% filter(Month %in% key_months),
             aes(x = Month, y = Cumulative_Survival * 100),
             size = 5, color = "red", shape = 21, fill = "red") +
  geom_text(data = life_table %>% filter(Month %in% key_months),
            aes(x = Month, y = Cumulative_Survival * 100,
                label = sprintf("%.1f%%", Cumulative_Survival * 100)),
            vjust = -1.5, size = 4, fontface = "bold") +
  labs(title = "Smoking Abstinence Survival Curve",
       subtitle = "Proportion of Participants Remaining Abstinent Over 12 Months",
       x = "Month After Quitting",
       y = "Proportion Abstinent (%)") +
  scale_x_continuous(breaks = 1:12) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, 10)) +
  theme_minimal() +
  theme(plot.title = element_text(size = 16, face = "bold"),
        plot.subtitle = element_text(size = 12),
        axis.title = element_text(size = 12, face = "bold"))

# Number of relapses per month
p2 <- ggplot(life_table, aes(x = Month, y = N_Relapsed)) +
  geom_bar(stat = "identity", fill = "coral", alpha = 0.7) +
  geom_text(aes(label = N_Relapsed), vjust = -0.5, size = 3.5) +
  labs(title = "Number of Relapses by Month",
       x = "Month After Quitting",
       y = "Number of Relapses") +
  scale_x_continuous(breaks = 1:12) +
  theme_minimal() +
  theme(plot.title = element_text(size = 14, face = "bold"))

# Proportion relapsing per month
p3 <- ggplot(life_table, aes(x = Month, y = Proportion_Relapsed * 100)) +
  geom_bar(stat = "identity", fill = "darkred", alpha = 0.7) +
  geom_text(aes(label = sprintf("%.1f%%", Proportion_Relapsed * 100)),
            vjust = -0.5, size = 3) +
  labs(title = "Relapse Rate by Month (Among Those Still Abstinent)",
       x = "Month After Quitting",
       y = "Relapse Rate (%)") +
  scale_x_continuous(breaks = 1:12) +
  theme_minimal() +
  theme(plot.title = element_text(size = 14, face = "bold"))

grid.arrange(p1, p2, p3, ncol = 1, heights = c(1.2, 1, 1))
```

## Kaplan-Meier Survival Analysis

```{r problem-4.55-km}
# Create survival object
# Event = relapse (1 if relapsed, 0 if still abstinent at end of study)
smoke_data <- smoke_data %>%
  mutate(
    event = ifelse(Day_abs < 365, 1, 0),  # 1 = relapsed, 0 = censored at 365 days
    time = Day_abs
  )

# Fit Kaplan-Meier curve
km_fit <- survfit(Surv(time, event) ~ 1, data = smoke_data)

# Plot using base R
plot(km_fit,
     conf.int = TRUE,
     col = "steelblue",
     lwd = 2,
     main = "Kaplan-Meier Survival Curve: Days to Relapse",
     xlab = "Days Since Quitting",
     ylab = "Probability of Remaining Abstinent",
     mark.time = TRUE)
grid()

# Summary at specific time points
summary_km <- summary(km_fit, times = c(30, 90, 180, 365))
km_table <- data.frame(
  Time = summary_km$time,
  N_Risk = summary_km$n.risk,
  N_Event = summary_km$n.event,
  Survival = summary_km$surv,
  CI_Lower = summary_km$lower,
  CI_Upper = summary_km$upper
)

km_table %>%
  mutate(
    Month = c(1, 3, 6, 12),
    Survival_Pct = Survival * 100,
    CI_Lower_Pct = CI_Lower * 100,
    CI_Upper_Pct = CI_Upper * 100
  ) %>%
  select(Month, Time, N_Risk, N_Event, Survival_Pct, CI_Lower_Pct, CI_Upper_Pct) %>%
  kable(digits = 2,
        col.names = c("Month", "Days", "N at Risk", "N Events",
                      "Survival (%)", "95% CI Lower", "95% CI Upper"),
        caption = "Kaplan-Meier Survival Estimates with 95% Confidence Intervals")
```

---

# Problem 4.56: Stratified Life Table Analysis

**Question:** Develop life tables for subsets of the data based on age, sex, number of cigarettes per day, and CO level (one variable at a time). Given these data, do you feel age, sex, number of cigarettes per day, and/or CO level are related to success in quitting?

## Function to Create Life Tables by Subgroup

```{r problem-4.56-function}
# Function to create life table for a subgroup
create_life_table_subgroup <- function(data, group_var) {
  # Calculate survival for each group
  results <- data %>%
    group_by(!!sym(group_var)) %>%
    summarise(
      N_Total = n(),
      N_1mo = sum(Day_abs >= 30),
      N_3mo = sum(Day_abs >= 90),
      N_6mo = sum(Day_abs >= 180),
      N_12mo = sum(Day_abs >= 365),
      Surv_1mo = N_1mo / N_Total,
      Surv_3mo = N_3mo / N_Total,
      Surv_6mo = N_6mo / N_Total,
      Surv_12mo = N_12mo / N_Total,
      .groups = "drop"
    )

  return(results)
}
```

## Analysis by Gender

```{r problem-4.56-gender}
cat("=== LIFE TABLE ANALYSIS BY GENDER ===\n\n")

# Create life table by gender
life_table_gender <- create_life_table_subgroup(smoke_data, "Gender_Label")

life_table_gender %>%
  mutate(
    Pct_1mo = Surv_1mo * 100,
    Pct_3mo = Surv_3mo * 100,
    Pct_6mo = Surv_6mo * 100,
    Pct_12mo = Surv_12mo * 100
  ) %>%
  select(Gender_Label, N_Total, N_1mo, N_3mo, N_6mo, N_12mo,
         Pct_1mo, Pct_3mo, Pct_6mo, Pct_12mo) %>%
  kable(digits = 2,
        col.names = c("Gender", "N Total", "N 1mo", "N 3mo", "N 6mo", "N 12mo",
                      "% 1mo", "% 3mo", "% 6mo", "% 12mo"),
        caption = "Life Table by Gender")

# Kaplan-Meier by gender
km_gender <- survfit(Surv(time, event) ~ Gender_Label, data = smoke_data)

# Log-rank test
logrank_gender <- survdiff(Surv(time, event) ~ Gender_Label, data = smoke_data)

cat("\n\nLog-Rank Test for Gender:\n")
cat(sprintf("Chi-square: %.3f\n", logrank_gender$chisq))
cat(sprintf("p-value: %.4f\n", pchisq(logrank_gender$chisq, df = 1, lower.tail = FALSE)))

if (pchisq(logrank_gender$chisq, df = 1, lower.tail = FALSE) < 0.05) {
  cat("\nConclusion: There IS a statistically significant difference in abstinence by gender.\n")
} else {
  cat("\nConclusion: There is NO statistically significant difference in abstinence by gender.\n")
}

# Plot
plot(km_gender,
     conf.int = TRUE,
     col = c("blue", "red"),
     lwd = 2,
     main = "Kaplan-Meier Curves by Gender",
     xlab = "Days Since Quitting",
     ylab = "Probability of Remaining Abstinent",
     mark.time = TRUE)
legend("topright",
       legend = c("Male", "Female"),
       col = c("blue", "red"),
       lwd = 2,
       bty = "n")
grid()
```

## Analysis by Age Group

```{r problem-4.56-age}
cat("\n\n=== LIFE TABLE ANALYSIS BY AGE GROUP ===\n\n")

# Create life table by age group
life_table_age <- create_life_table_subgroup(smoke_data, "Age_Group")

life_table_age %>%
  mutate(
    Pct_1mo = Surv_1mo * 100,
    Pct_3mo = Surv_3mo * 100,
    Pct_6mo = Surv_6mo * 100,
    Pct_12mo = Surv_12mo * 100
  ) %>%
  select(Age_Group, N_Total, N_1mo, N_3mo, N_6mo, N_12mo,
         Pct_1mo, Pct_3mo, Pct_6mo, Pct_12mo) %>%
  kable(digits = 2,
        col.names = c("Age Group", "N Total", "N 1mo", "N 3mo", "N 6mo", "N 12mo",
                      "% 1mo", "% 3mo", "% 6mo", "% 12mo"),
        caption = "Life Table by Age Group")

# Kaplan-Meier by age
km_age <- survfit(Surv(time, event) ~ Age_Group, data = smoke_data)

# Log-rank test
logrank_age <- survdiff(Surv(time, event) ~ Age_Group, data = smoke_data)

cat("\n\nLog-Rank Test for Age Group:\n")
cat(sprintf("Chi-square: %.3f\n", logrank_age$chisq))
cat(sprintf("p-value: %.4f\n", pchisq(logrank_age$chisq, df = 2, lower.tail = FALSE)))

if (pchisq(logrank_age$chisq, df = 2, lower.tail = FALSE) < 0.05) {
  cat("\nConclusion: There IS a statistically significant difference in abstinence by age group.\n")
} else {
  cat("\nConclusion: There is NO statistically significant difference in abstinence by age group.\n")
}

# Plot
plot(km_age,
     conf.int = TRUE,
     col = c("red", "green", "blue"),
     lwd = 2,
     main = "Kaplan-Meier Curves by Age Group",
     xlab = "Days Since Quitting",
     ylab = "Probability of Remaining Abstinent",
     mark.time = TRUE)
legend("topright",
       legend = levels(smoke_data$Age_Group),
       col = c("red", "green", "blue"),
       lwd = 2,
       bty = "n")
grid()
```

## Analysis by Cigarettes per Day

```{r problem-4.56-cigarettes}
cat("\n\n=== LIFE TABLE ANALYSIS BY CIGARETTES PER DAY ===\n\n")

# Create life table by cigarette category
life_table_cig <- create_life_table_subgroup(smoke_data, "Cig_Category")

life_table_cig %>%
  mutate(
    Pct_1mo = Surv_1mo * 100,
    Pct_3mo = Surv_3mo * 100,
    Pct_6mo = Surv_6mo * 100,
    Pct_12mo = Surv_12mo * 100
  ) %>%
  select(Cig_Category, N_Total, N_1mo, N_3mo, N_6mo, N_12mo,
         Pct_1mo, Pct_3mo, Pct_6mo, Pct_12mo) %>%
  kable(digits = 2,
        col.names = c("Cigarettes/Day", "N Total", "N 1mo", "N 3mo", "N 6mo", "N 12mo",
                      "% 1mo", "% 3mo", "% 6mo", "% 12mo"),
        caption = "Life Table by Cigarettes per Day")

# Kaplan-Meier by cigarette category
km_cig <- survfit(Surv(time, event) ~ Cig_Category, data = smoke_data)

# Log-rank test
logrank_cig <- survdiff(Surv(time, event) ~ Cig_Category, data = smoke_data)

cat("\n\nLog-Rank Test for Cigarettes per Day:\n")
cat(sprintf("Chi-square: %.3f\n", logrank_cig$chisq))
cat(sprintf("p-value: %.4f\n", pchisq(logrank_cig$chisq, df = 2, lower.tail = FALSE)))

if (pchisq(logrank_cig$chisq, df = 2, lower.tail = FALSE) < 0.05) {
  cat("\nConclusion: There IS a statistically significant difference in abstinence by smoking intensity.\n")
} else {
  cat("\nConclusion: There is NO statistically significant difference in abstinence by smoking intensity.\n")
}

# Plot
plot(km_cig,
     conf.int = TRUE,
     col = c("darkgreen", "orange", "red"),
     lwd = 2,
     main = "Kaplan-Meier Curves by Cigarettes per Day",
     xlab = "Days Since Quitting",
     ylab = "Probability of Remaining Abstinent",
     mark.time = TRUE)
legend("topright",
       legend = levels(smoke_data$Cig_Category),
       col = c("darkgreen", "orange", "red"),
       lwd = 2,
       bty = "n")
grid()
```

## Analysis by CO Level

```{r problem-4.56-co}
cat("\n\n=== LIFE TABLE ANALYSIS BY CO LEVEL ===\n\n")

# Create life table by CO category (excluding missing values)
smoke_co <- smoke_data %>% filter(!is.na(CO_Category))

life_table_co <- create_life_table_subgroup(smoke_co, "CO_Category")

life_table_co %>%
  mutate(
    Pct_1mo = Surv_1mo * 100,
    Pct_3mo = Surv_3mo * 100,
    Pct_6mo = Surv_6mo * 100,
    Pct_12mo = Surv_12mo * 100
  ) %>%
  select(CO_Category, N_Total, N_1mo, N_3mo, N_6mo, N_12mo,
         Pct_1mo, Pct_3mo, Pct_6mo, Pct_12mo) %>%
  kable(digits = 2,
        col.names = c("CO Level", "N Total", "N 1mo", "N 3mo", "N 6mo", "N 12mo",
                      "% 1mo", "% 3mo", "% 6mo", "% 12mo"),
        caption = "Life Table by CO Level")

cat(sprintf("\nMedian CO level: %.1f ppm\n", median(smoke_data$CO_clean, na.rm = TRUE)))

# Kaplan-Meier by CO level
km_co <- survfit(Surv(time, event) ~ CO_Category, data = smoke_co)

# Log-rank test
logrank_co <- survdiff(Surv(time, event) ~ CO_Category, data = smoke_co)

cat("\n\nLog-Rank Test for CO Level:\n")
cat(sprintf("Chi-square: %.3f\n", logrank_co$chisq))
cat(sprintf("p-value: %.4f\n", pchisq(logrank_co$chisq, df = 1, lower.tail = FALSE)))

if (pchisq(logrank_co$chisq, df = 1, lower.tail = FALSE) < 0.05) {
  cat("\nConclusion: There IS a statistically significant difference in abstinence by CO level.\n")
} else {
  cat("\nConclusion: There is NO statistically significant difference in abstinence by CO level.\n")
}

# Plot
plot(km_co,
     conf.int = TRUE,
     col = c("darkgreen", "darkorange"),
     lwd = 2,
     main = "Kaplan-Meier Curves by CO Level",
     xlab = "Days Since Quitting",
     ylab = "Probability of Remaining Abstinent",
     mark.time = TRUE)
legend("topright",
       legend = c("Low CO", "High CO"),
       col = c("darkgreen", "darkorange"),
       lwd = 2,
       bty = "n")
grid()
```

## Summary Comparison: All Variables

```{r problem-4.56-summary}
cat("\n\n=== SUMMARY: COMPARISON OF ALL PREDICTORS ===\n\n")

# Create summary table of 12-month survival rates
summary_all <- data.frame(
  Variable = c("Overall", "Male", "Female", "Age ≤35", "Age 36-50", "Age >50",
               "Cig ≤20/day", "Cig 21-30/day", "Cig >30/day", "CO Low", "CO High"),
  N = c(
    nrow(smoke_data),
    life_table_gender$N_Total[1],
    life_table_gender$N_Total[2],
    life_table_age$N_Total[1],
    life_table_age$N_Total[2],
    life_table_age$N_Total[3],
    life_table_cig$N_Total[1],
    life_table_cig$N_Total[2],
    life_table_cig$N_Total[3],
    life_table_co$N_Total[1],
    life_table_co$N_Total[2]
  ),
  Survival_12mo = c(
    prob_12mo * 100,
    life_table_gender$Surv_12mo[1] * 100,
    life_table_gender$Surv_12mo[2] * 100,
    life_table_age$Surv_12mo[1] * 100,
    life_table_age$Surv_12mo[2] * 100,
    life_table_age$Surv_12mo[3] * 100,
    life_table_cig$Surv_12mo[1] * 100,
    life_table_cig$Surv_12mo[2] * 100,
    life_table_cig$Surv_12mo[3] * 100,
    life_table_co$Surv_12mo[1] * 100,
    life_table_co$Surv_12mo[2] * 100
  )
)

summary_all %>%
  kable(digits = 2,
        col.names = c("Group", "N", "12-Month Abstinence (%)"),
        caption = "12-Month Abstinence Rates by Subgroup")

# Statistical test results summary
test_summary <- data.frame(
  Variable = c("Gender", "Age Group", "Cigarettes/Day", "CO Level"),
  Chi_Square = c(
    logrank_gender$chisq,
    logrank_age$chisq,
    logrank_cig$chisq,
    logrank_co$chisq
  ),
  P_Value = c(
    pchisq(logrank_gender$chisq, df = 1, lower.tail = FALSE),
    pchisq(logrank_age$chisq, df = 2, lower.tail = FALSE),
    pchisq(logrank_cig$chisq, df = 2, lower.tail = FALSE),
    pchisq(logrank_co$chisq, df = 1, lower.tail = FALSE)
  )
) %>%
  mutate(
    Significant = ifelse(P_Value < 0.05, "Yes", "No"),
    Conclusion = case_when(
      P_Value < 0.001 ~ "Highly Significant (***)",
      P_Value < 0.01 ~ "Very Significant (**)",
      P_Value < 0.05 ~ "Significant (*)",
      TRUE ~ "Not Significant"
    )
  )

cat("\n\nLog-Rank Test Results Summary:\n")
test_summary %>%
  kable(digits = 4,
        col.names = c("Variable", "Chi-Square", "p-value", "Significant (α=0.05)", "Conclusion"),
        caption = "Statistical Test Results for All Predictors")
```

## Visualization: Comparative Survival Curves

```{r problem-4.56-comparative-plot, fig.height=12, fig.width=14}
# Note: Each plot is shown separately due to ggsurvplot formatting
cat("Comparative survival curves are shown in the individual sections above.\n")
cat("The following provides a summary visualization using base survival plots.\n\n")

# Create a 2x2 grid of base survival plots
par(mfrow = c(2, 2))

# Gender
plot(km_gender, col = c("blue", "red"), lwd = 2,
     main = "Survival by Gender",
     xlab = "Days Since Quitting",
     ylab = "Survival Probability")
legend("topright", legend = c("Male", "Female"),
       col = c("blue", "red"), lwd = 2, bty = "n")

# Age Group
plot(km_age, col = 1:3, lwd = 2,
     main = "Survival by Age Group",
     xlab = "Days Since Quitting",
     ylab = "Survival Probability")
legend("topright", legend = levels(smoke_data$Age_Group),
       col = 1:3, lwd = 2, bty = "n")

# Cigarettes per Day
plot(km_cig, col = c("green", "orange", "red"), lwd = 2,
     main = "Survival by Cigarettes/Day",
     xlab = "Days Since Quitting",
     ylab = "Survival Probability")
legend("topright", legend = levels(smoke_data$Cig_Category),
       col = c("green", "orange", "red"), lwd = 2, bty = "n")

# CO Level
plot(km_co, col = c("darkgreen", "darkorange"), lwd = 2,
     main = "Survival by CO Level",
     xlab = "Days Since Quitting",
     ylab = "Survival Probability")
legend("topright", legend = c("Low CO", "High CO"),
       col = c("darkgreen", "darkorange"), lwd = 2, bty = "n")

par(mfrow = c(1, 1))
```

---

# Overall Study Conclusions

```{r overall-conclusions}
cat("=== OVERALL STUDY CONCLUSIONS ===\n\n")

cat("1. OVERALL ABSTINENCE RATES:\n")
cat(sprintf("   - 1-month abstinence: %.1f%%\n", prob_1mo * 100))
cat(sprintf("   - 3-month abstinence: %.1f%%\n", prob_3mo * 100))
cat(sprintf("   - 6-month abstinence: %.1f%%\n", prob_6mo * 100))
cat(sprintf("   - 12-month abstinence: %.1f%%\n", prob_12mo * 100))

cat("\n2. PATTERN OF RELAPSE:\n")
first_month_relapse <- (1 - prob_1mo) * 100
cat(sprintf("   - Approximately %.1f%% relapse within the first month\n", first_month_relapse))
cat("   - The relapse rate is highest in the early months after quitting\n")
cat("   - Survival curve shows steepest decline in first 3 months\n")

cat("\n3. PREDICTORS OF SUCCESS:\n")
cat("\n   a) GENDER:\n")
cat(sprintf("      - p-value: %.4f\n", test_summary$P_Value[1]))
if (test_summary$P_Value[1] < 0.05) {
  cat("      - Gender IS a significant predictor of abstinence\n")
  male_surv <- life_table_gender$Surv_12mo[1] * 100
  female_surv <- life_table_gender$Surv_12mo[2] * 100
  if (male_surv > female_surv) {
    cat(sprintf("      - Males have higher abstinence rates (%.1f%% vs %.1f%%)\n", male_surv, female_surv))
  } else {
    cat(sprintf("      - Females have higher abstinence rates (%.1f%% vs %.1f%%)\n", female_surv, male_surv))
  }
} else {
  cat("      - Gender is NOT a significant predictor of abstinence\n")
}

cat("\n   b) AGE GROUP:\n")
cat(sprintf("      - p-value: %.4f\n", test_summary$P_Value[2]))
if (test_summary$P_Value[2] < 0.05) {
  cat("      - Age IS a significant predictor of abstinence\n")
  cat(sprintf("      - Age ≤35: %.1f%% abstinent at 12 months\n", life_table_age$Surv_12mo[1] * 100))
  cat(sprintf("      - Age 36-50: %.1f%% abstinent at 12 months\n", life_table_age$Surv_12mo[2] * 100))
  cat(sprintf("      - Age >50: %.1f%% abstinent at 12 months\n", life_table_age$Surv_12mo[3] * 100))
} else {
  cat("      - Age is NOT a significant predictor of abstinence\n")
}

cat("\n   c) CIGARETTES PER DAY:\n")
cat(sprintf("      - p-value: %.4f\n", test_summary$P_Value[3]))
if (test_summary$P_Value[3] < 0.05) {
  cat("      - Smoking intensity IS a significant predictor of abstinence\n")
  cat(sprintf("      - ≤20 cig/day: %.1f%% abstinent at 12 months\n", life_table_cig$Surv_12mo[1] * 100))
  cat(sprintf("      - 21-30 cig/day: %.1f%% abstinent at 12 months\n", life_table_cig$Surv_12mo[2] * 100))
  cat(sprintf("      - >30 cig/day: %.1f%% abstinent at 12 months\n", life_table_cig$Surv_12mo[3] * 100))
} else {
  cat("      - Smoking intensity is NOT a significant predictor of abstinence\n")
}

cat("\n   d) CO LEVEL:\n")
cat(sprintf("      - p-value: %.4f\n", test_summary$P_Value[4]))
if (test_summary$P_Value[4] < 0.05) {
  cat("      - CO level IS a significant predictor of abstinence\n")
  cat(sprintf("      - Low CO: %.1f%% abstinent at 12 months\n", life_table_co$Surv_12mo[1] * 100))
  cat(sprintf("      - High CO: %.1f%% abstinent at 12 months\n", life_table_co$Surv_12mo[2] * 100))
} else {
  cat("      - CO level is NOT a significant predictor of abstinence\n")
}

cat("\n4. CLINICAL IMPLICATIONS:\n")
cat("   - Smoking cessation programs should focus intensive support in the first 3 months\n")
cat("   - The majority of relapses occur early in the quit attempt\n")

sig_predictors <- test_summary$Variable[test_summary$P_Value < 0.05]
if (length(sig_predictors) > 0) {
  cat(sprintf("   - Significant predictors (%s) should be used to identify high-risk individuals\n",
              paste(sig_predictors, collapse = ", ")))
  cat("   - Tailored interventions based on these characteristics may improve outcomes\n")
} else {
  cat("   - No strong predictors identified; all participants benefit from support\n")
}

cat("\n5. STUDY STRENGTHS:\n")
cat(sprintf("   - Good sample size (N = %d)\n", nrow(smoke_data)))
cat("   - Complete follow-up (all participants followed for full year)\n")
cat("   - Objective measures (CO level) in addition to self-report\n")
cat("   - Multiple potential predictors examined\n")
```

---

# Session Information

```{r session-info}
sessionInfo()
```
