---
title: "Pulmonary Disease: Smoking and Lung Function in Children"
author: "Biostatistics Analysis"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
    highlight: tango
    code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.width = 14, fig.height = 10)
```

# Background

This analysis examines the relationship between **smoking status** and **pulmonary function** in children, using data on Forced Expiratory Volume (FEV). Since FEV is naturally affected by age and sex, and smoking children tend to be older than nonsmoking children, we must standardize FEV measurements using age-sex specific z-scores before comparing groups.

## Study Objectives

1. **Standardization:** Calculate z-scores for FEV within age-sex groups
2. **Distribution Assessment:** Examine normality of z-score distributions
3. **Smoking Association:** Investigate relationship between smoking and pulmonary function
4. **Age Stratification:** Focus on children 10+ years (when smoking becomes more common)
5. **Sex-Specific Analysis:** Compare patterns separately for boys and girls

## Research Questions (Problems 5.42-5.44)

**5.42:** Plot z-score distributions for smokers vs. nonsmokers. Do they look normal? Is smoking related to pulmonary function?

**5.43:** Repeat analysis for children 10+ years old. Do conclusions change?

**5.44:** Repeat Problem 5.43 separately for boys and girls. Are conclusions consistent?

# Libraries

```{r libraries}
library(tidyverse)
library(knitr)
library(gridExtra)
library(scales)
library(moments)  # For skewness and kurtosis
```

# Data Import

```{r data-import}
# Read the FEV dataset
fev_data <- read.csv("Rosner_FundamentalsBiostatistics_8e_Data_Sets/ASCII-comma/FEV.DAT.txt",
                     check.names = FALSE)

# Remove quotes from column names
colnames(fev_data) <- gsub("'", "", colnames(fev_data))

# Display variable information
cat("Dataset Structure:\n")
str(fev_data)

cat("\n\nVariable Descriptions:\n")
cat("Id: Subject identification number\n")
cat("Age: Age (years)\n")
cat("FEV: Forced Expiratory Volume (liters)\n")
cat("Hgt: Height (inches)\n")
cat("Sex: Sex (0 = Female, 1 = Male)\n")
cat("Smoke: Smoking status (0 = No, 1 = Yes)\n")

# Display first rows
head(fev_data, 20) %>%
  kable(caption = "First 20 Subjects in FEV Dataset")

cat(sprintf("\n\nTotal number of subjects: %d\n", nrow(fev_data)))
```

# Data Processing

```{r data-processing}
# Create labeled variables
fev_clean <- fev_data %>%
  mutate(
    Sex = factor(Sex, levels = c(0, 1), labels = c("Female", "Male")),
    Smoker = factor(Smoke, levels = c(0, 1), labels = c("No", "Yes")),
    Age_Group = cut(Age,
                    breaks = c(0, 6, 8, 10, 12, 14, 16, 20),
                    labels = c("3-6", "7-8", "9-10", "11-12", "13-14", "15-16", "17-19"),
                    include.lowest = TRUE),
    Age_10plus = ifelse(Age >= 10, "10+ years", "<10 years")
  )

# Summary statistics
cat("Overall Summary:\n")
summary(fev_clean %>% select(Age, FEV, Hgt, Sex, Smoker)) %>%
  kable()

cat("\n\nSmoking Status by Age Group:\n")
fev_clean %>%
  count(Age_Group, Smoker) %>%
  pivot_wider(names_from = Smoker, values_from = n, values_fill = 0) %>%
  mutate(Total = Yes + No,
         Pct_Smokers = sprintf("%.1f%%", 100 * Yes / Total)) %>%
  kable(caption = "Smoking Prevalence by Age Group")

cat("\n\nSmoking Status by Sex:\n")
fev_clean %>%
  count(Sex, Smoker) %>%
  pivot_wider(names_from = Smoker, values_from = n, values_fill = 0) %>%
  mutate(Total = Yes + No,
         Pct_Smokers = sprintf("%.1f%%", 100 * Yes / Total)) %>%
  kable(caption = "Smoking Prevalence by Sex")

cat("\n\nAge Distribution:\n")
cat(sprintf("- Mean age of smokers: %.2f years (SD = %.2f)\n",
            mean(fev_clean$Age[fev_clean$Smoker == "Yes"]),
            sd(fev_clean$Age[fev_clean$Smoker == "Yes"])))
cat(sprintf("- Mean age of nonsmokers: %.2f years (SD = %.2f)\n",
            mean(fev_clean$Age[fev_clean$Smoker == "No"]),
            sd(fev_clean$Age[fev_clean$Smoker == "No"])))
```

# Z-Score Calculation

## Age-Sex Standardization

```{r z-score-calculation}
cat("=== CALCULATING AGE-SEX STANDARDIZED Z-SCORES ===\n\n")

# Calculate mean and SD of FEV for each age-sex group
fev_with_z <- fev_clean %>%
  group_by(Age, Sex) %>%
  mutate(
    FEV_mean_group = mean(FEV),
    FEV_sd_group = sd(FEV),
    n_group = n()
  ) %>%
  ungroup() %>%
  mutate(
    # Calculate z-score: (observed - group mean) / group SD
    FEV_zscore = ifelse(FEV_sd_group > 0,
                        (FEV - FEV_mean_group) / FEV_sd_group,
                        0)  # If SD = 0, set z-score to 0
  )

cat("Z-Score Calculation Method:\n")
cat("- Grouped by: Age (years) and Sex\n")
cat("- Formula: z = (FEV - mean_age_sex) / SD_age_sex\n")
cat("- This removes the confounding effects of age and sex\n")

cat("\n\nZ-Score Summary Statistics:\n")
fev_with_z %>%
  group_by(Smoker) %>%
  summarise(
    N = n(),
    Mean_Z = mean(FEV_zscore, na.rm = TRUE),
    SD_Z = sd(FEV_zscore, na.rm = TRUE),
    Median_Z = median(FEV_zscore, na.rm = TRUE),
    Q1_Z = quantile(FEV_zscore, 0.25, na.rm = TRUE),
    Q3_Z = quantile(FEV_zscore, 0.75, na.rm = TRUE),
    Min_Z = min(FEV_zscore, na.rm = TRUE),
    Max_Z = max(FEV_zscore, na.rm = TRUE)
  ) %>%
  kable(digits = 3,
        col.names = c("Smoking Status", "N", "Mean", "SD", "Median", "Q1", "Q3", "Min", "Max"),
        caption = "Z-Score Distribution by Smoking Status (All Ages)")

# Show example of standardization
cat("\n\nExample Age-Sex Group (Age 10 Males):\n")
fev_with_z %>%
  filter(Age == 10, Sex == "Male") %>%
  select(Id, Age, Sex, FEV, FEV_mean_group, FEV_sd_group, FEV_zscore, Smoker) %>%
  head(10) %>%
  kable(digits = 3, caption = "First 10 Males Age 10 - Showing Z-Score Calculation")
```

---

# Problem 5.42: Distribution Analysis (All Ages)

## Z-Score Distributions: Smokers vs. Nonsmokers

```{r problem-5.42-histograms, fig.height=10}
# Create multiple visualization panels

# 1. Histograms with density curves
p1 <- ggplot(fev_with_z, aes(x = FEV_zscore, fill = Smoker)) +
  geom_histogram(aes(y = ..density..), bins = 30, alpha = 0.6, position = "identity") +
  geom_density(aes(color = Smoker), size = 1.2, alpha = 0) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "black", size = 1) +
  facet_wrap(~ Smoker, ncol = 1) +
  labs(title = "Distribution of Age-Sex Standardized FEV Z-Scores",
       subtitle = "Comparing Smokers vs. Nonsmokers (All Ages)",
       x = "FEV Z-Score",
       y = "Density") +
  scale_fill_manual(values = c("Yes" = "coral", "No" = "steelblue")) +
  scale_color_manual(values = c("Yes" = "darkred", "No" = "darkblue")) +
  theme_minimal() +
  theme(legend.position = "none",
        plot.title = element_text(size = 14, face = "bold"))

# 2. Overlapping density plot
p2 <- ggplot(fev_with_z, aes(x = FEV_zscore, fill = Smoker, color = Smoker)) +
  geom_density(alpha = 0.4, size = 1.2) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "black", size = 1) +
  geom_vline(data = fev_with_z %>%
               group_by(Smoker) %>%
               summarise(mean_z = mean(FEV_zscore, na.rm = TRUE)),
             aes(xintercept = mean_z, color = Smoker),
             linetype = "dotted", size = 1) +
  labs(title = "Overlapping Density Curves",
       subtitle = "Dotted lines show group means",
       x = "FEV Z-Score",
       y = "Density",
       fill = "Smoking Status",
       color = "Smoking Status") +
  scale_fill_manual(values = c("Yes" = "coral", "No" = "steelblue")) +
  scale_color_manual(values = c("Yes" = "darkred", "No" = "darkblue")) +
  theme_minimal() +
  theme(legend.position = "bottom")

# 3. Boxplots
p3 <- ggplot(fev_with_z, aes(x = Smoker, y = FEV_zscore, fill = Smoker)) +
  geom_boxplot(alpha = 0.7, outlier.shape = 16, outlier.size = 2) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red", size = 1) +
  stat_summary(fun = mean, geom = "point", shape = 23, size = 4, fill = "yellow") +
  labs(title = "Box Plot Comparison",
       subtitle = "Yellow diamond = mean, horizontal line = median",
       x = "Smoking Status",
       y = "FEV Z-Score") +
  scale_fill_manual(values = c("Yes" = "coral", "No" = "steelblue")) +
  theme_minimal() +
  theme(legend.position = "none")

grid.arrange(p1, p2, p3, ncol = 1, heights = c(1.2, 0.9, 0.8))
```

## Normality Assessment: Problem 5.42

```{r problem-5.42-normality, fig.height=8}
cat("\n=== NORMALITY ASSESSMENT: ALL AGES ===\n\n")

# Q-Q plots for normality assessment
p_qq1 <- ggplot(fev_with_z, aes(sample = FEV_zscore, color = Smoker)) +
  stat_qq() +
  stat_qq_line(size = 1) +
  facet_wrap(~ Smoker) +
  labs(title = "Q-Q Plots: FEV Z-Scores (All Ages)",
       subtitle = "Assessing normality of distributions",
       x = "Theoretical Quantiles",
       y = "Sample Quantiles") +
  scale_color_manual(values = c("Yes" = "coral", "No" = "steelblue")) +
  theme_minimal() +
  theme(legend.position = "none")

# Shapiro-Wilk tests
normality_results_all <- fev_with_z %>%
  group_by(Smoker) %>%
  summarise(
    N = n(),
    Mean = mean(FEV_zscore, na.rm = TRUE),
    SD = sd(FEV_zscore, na.rm = TRUE),
    Skewness = skewness(FEV_zscore),
    Kurtosis = kurtosis(FEV_zscore),
    .groups = "drop"
  )

# Add Shapiro-Wilk test (need to do separately due to sample size)
shapiro_smokers <- shapiro.test(fev_with_z$FEV_zscore[fev_with_z$Smoker == "Yes"])
shapiro_nonsmokers <- shapiro.test(fev_with_z$FEV_zscore[fev_with_z$Smoker == "No"])

normality_results_all <- normality_results_all %>%
  mutate(
    Shapiro_W = c(shapiro_smokers$statistic, shapiro_nonsmokers$statistic),
    Shapiro_p = c(shapiro_smokers$p.value, shapiro_nonsmokers$p.value),
    Normal = ifelse(Shapiro_p > 0.05, "Yes", "No")
  )

print(p_qq1)

cat("\n\nShapiro-Wilk Normality Tests (All Ages):\n")
cat("H₀: Data are normally distributed\n")
cat("If p < 0.05: Reject H₀ (evidence of non-normality)\n\n")

normality_results_all %>%
  kable(digits = 4,
        col.names = c("Smoking Status", "N", "Mean", "SD", "Skewness",
                      "Kurtosis", "W Statistic", "p-value", "Normal?"),
        caption = "Normality Assessment: All Ages")
```

## Summary: Problem 5.42

```{r problem-5.42-summary}
cat("\n\n=== SUMMARY: PROBLEM 5.42 (ALL AGES) ===\n\n")

mean_smokers <- normality_results_all$Mean[normality_results_all$Smoker == "Yes"]
mean_nonsmokers <- normality_results_all$Mean[normality_results_all$Smoker == "No"]
diff_means <- mean_nonsmokers - mean_smokers

cat("DISTRIBUTION NORMALITY:\n")
for (i in 1:nrow(normality_results_all)) {
  row <- normality_results_all[i, ]
  cat(sprintf("- %s: ", row$Smoker))
  if (row$Normal == "Yes") {
    cat("Distribution appears approximately normal\n")
  } else {
    cat(sprintf("Distribution shows deviation from normality (p = %.4f)\n", row$Shapiro_p))
  }
  cat(sprintf("  Skewness = %.3f, Kurtosis = %.3f\n", row$Skewness, row$Kurtosis))
}

cat("\n\nRELATIONSHIP BETWEEN SMOKING AND PULMONARY FUNCTION:\n")
cat(sprintf("- Mean z-score for smokers: %.3f (SD = %.3f)\n",
            mean_smokers, normality_results_all$SD[normality_results_all$Smoker == "Yes"]))
cat(sprintf("- Mean z-score for nonsmokers: %.3f (SD = %.3f)\n",
            mean_nonsmokers, normality_results_all$SD[normality_results_all$Smoker == "No"]))
cat(sprintf("- Difference: %.3f (nonsmokers - smokers)\n", diff_means))

if (abs(diff_means) > 0.1) {
  if (diff_means > 0) {
    cat("\n** FINDING: Smokers have LOWER FEV z-scores than nonsmokers **\n")
    cat("This suggests smoking is associated with reduced pulmonary function.\n")
  } else {
    cat("\n** FINDING: Smokers have HIGHER FEV z-scores than nonsmokers **\n")
    cat("This is unexpected and warrants further investigation.\n")
  }
} else {
  cat("\nFINDING: Minimal difference between groups\n")
}

cat("\nIMPORTANT CONSIDERATION:\n")
cat("- Smoking is very rare in young children\n")
cat("- Age confounding may still exist despite z-score standardization\n")
cat("- Analysis of children 10+ years (Problem 5.43) will provide clearer insights\n")
```

---

# Problem 5.43: Analysis of Children 10+ Years

## Subset: Ages 10 and Above

```{r problem-5.43-subset}
cat("=== SUBSETTING DATA: CHILDREN 10+ YEARS ===\n\n")

fev_10plus <- fev_with_z %>%
  filter(Age >= 10)

cat(sprintf("Total subjects age 10+: %d (%.1f%% of full sample)\n",
            nrow(fev_10plus), 100 * nrow(fev_10plus) / nrow(fev_with_z)))

# Summary by smoking status
cat("\n\nSmoking Status Distribution (Age 10+):\n")
fev_10plus %>%
  count(Smoker) %>%
  mutate(Percent = sprintf("%.1f%%", 100 * n / sum(n))) %>%
  kable(col.names = c("Smoking Status", "N", "Percent"),
        caption = "Sample Sizes for Age 10+ Subgroup")

# Z-score statistics for 10+ group
cat("\n\nZ-Score Summary (Age 10+):\n")
fev_10plus %>%
  group_by(Smoker) %>%
  summarise(
    N = n(),
    Mean_Z = mean(FEV_zscore, na.rm = TRUE),
    SD_Z = sd(FEV_zscore, na.rm = TRUE),
    Median_Z = median(FEV_zscore, na.rm = TRUE),
    Q1_Z = quantile(FEV_zscore, 0.25, na.rm = TRUE),
    Q3_Z = quantile(FEV_zscore, 0.75, na.rm = TRUE)
  ) %>%
  kable(digits = 3,
        col.names = c("Smoking Status", "N", "Mean", "SD", "Median", "Q1", "Q3"),
        caption = "Z-Score Distribution (Age 10+ Only)")
```

## Z-Score Distributions: Ages 10+ Only

```{r problem-5.43-plots, fig.height=10}
# 1. Histograms with density curves
p4 <- ggplot(fev_10plus, aes(x = FEV_zscore, fill = Smoker)) +
  geom_histogram(aes(y = ..density..), bins = 25, alpha = 0.6, position = "identity") +
  geom_density(aes(color = Smoker), size = 1.2, alpha = 0) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "black", size = 1) +
  facet_wrap(~ Smoker, ncol = 1) +
  labs(title = "Distribution of FEV Z-Scores: Children Age 10+",
       subtitle = "Comparing Smokers vs. Nonsmokers",
       x = "FEV Z-Score",
       y = "Density") +
  scale_fill_manual(values = c("Yes" = "coral", "No" = "steelblue")) +
  scale_color_manual(values = c("Yes" = "darkred", "No" = "darkblue")) +
  theme_minimal() +
  theme(legend.position = "none")

# 2. Overlapping density
p5 <- ggplot(fev_10plus, aes(x = FEV_zscore, fill = Smoker, color = Smoker)) +
  geom_density(alpha = 0.4, size = 1.2) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "black", size = 1) +
  geom_vline(data = fev_10plus %>%
               group_by(Smoker) %>%
               summarise(mean_z = mean(FEV_zscore, na.rm = TRUE)),
             aes(xintercept = mean_z, color = Smoker),
             linetype = "dotted", size = 1) +
  labs(title = "Overlapping Density Curves (Age 10+)",
       subtitle = "Dotted lines show group means",
       x = "FEV Z-Score",
       y = "Density") +
  scale_fill_manual(values = c("Yes" = "coral", "No" = "steelblue")) +
  scale_color_manual(values = c("Yes" = "darkred", "No" = "darkblue")) +
  theme_minimal() +
  theme(legend.position = "bottom")

# 3. Boxplots
p6 <- ggplot(fev_10plus, aes(x = Smoker, y = FEV_zscore, fill = Smoker)) +
  geom_boxplot(alpha = 0.7, outlier.shape = 16, outlier.size = 2) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red", size = 1) +
  stat_summary(fun = mean, geom = "point", shape = 23, size = 4, fill = "yellow") +
  labs(title = "Box Plot Comparison (Age 10+)",
       subtitle = "Yellow diamond = mean",
       x = "Smoking Status",
       y = "FEV Z-Score") +
  scale_fill_manual(values = c("Yes" = "coral", "No" = "steelblue")) +
  theme_minimal() +
  theme(legend.position = "none")

grid.arrange(p4, p5, p6, ncol = 1, heights = c(1.2, 0.9, 0.8))
```

## Normality Assessment: Ages 10+

```{r problem-5.43-normality, fig.height=8}
cat("\n=== NORMALITY ASSESSMENT: AGES 10+ ===\n\n")

# Q-Q plots
p_qq2 <- ggplot(fev_10plus, aes(sample = FEV_zscore, color = Smoker)) +
  stat_qq() +
  stat_qq_line(size = 1) +
  facet_wrap(~ Smoker) +
  labs(title = "Q-Q Plots: FEV Z-Scores (Age 10+)",
       subtitle = "Assessing normality of distributions",
       x = "Theoretical Quantiles",
       y = "Sample Quantiles") +
  scale_color_manual(values = c("Yes" = "coral", "No" = "steelblue")) +
  theme_minimal() +
  theme(legend.position = "none")

# Statistical tests
normality_results_10plus <- fev_10plus %>%
  group_by(Smoker) %>%
  summarise(
    N = n(),
    Mean = mean(FEV_zscore, na.rm = TRUE),
    SD = sd(FEV_zscore, na.rm = TRUE),
    Skewness = skewness(FEV_zscore),
    Kurtosis = kurtosis(FEV_zscore),
    .groups = "drop"
  )

# Shapiro-Wilk tests
shapiro_smokers_10 <- shapiro.test(fev_10plus$FEV_zscore[fev_10plus$Smoker == "Yes"])
shapiro_nonsmokers_10 <- shapiro.test(fev_10plus$FEV_zscore[fev_10plus$Smoker == "No"])

normality_results_10plus <- normality_results_10plus %>%
  mutate(
    Shapiro_W = c(shapiro_smokers_10$statistic, shapiro_nonsmokers_10$statistic),
    Shapiro_p = c(shapiro_smokers_10$p.value, shapiro_nonsmokers_10$p.value),
    Normal = ifelse(Shapiro_p > 0.05, "Yes", "No")
  )

print(p_qq2)

cat("\n\nShapiro-Wilk Normality Tests (Age 10+):\n")
normality_results_10plus %>%
  kable(digits = 4,
        col.names = c("Smoking Status", "N", "Mean", "SD", "Skewness",
                      "Kurtosis", "W Statistic", "p-value", "Normal?"),
        caption = "Normality Assessment: Age 10+ Only")
```

## Summary: Problem 5.43

```{r problem-5.43-summary}
cat("\n\n=== SUMMARY: PROBLEM 5.43 (AGES 10+) ===\n\n")

mean_smokers_10 <- normality_results_10plus$Mean[normality_results_10plus$Smoker == "Yes"]
mean_nonsmokers_10 <- normality_results_10plus$Mean[normality_results_10plus$Smoker == "No"]
diff_means_10 <- mean_nonsmokers_10 - mean_smokers_10

cat("DISTRIBUTION NORMALITY:\n")
for (i in 1:nrow(normality_results_10plus)) {
  row <- normality_results_10plus[i, ]
  cat(sprintf("- %s: ", row$Smoker))
  if (row$Normal == "Yes") {
    cat("Distribution appears approximately normal\n")
  } else {
    cat(sprintf("Distribution shows deviation from normality (p = %.4f)\n", row$Shapiro_p))
  }
  cat(sprintf("  Skewness = %.3f, Kurtosis = %.3f\n", row$Skewness, row$Kurtosis))
}

cat("\n\nRELATIONSHIP BETWEEN SMOKING AND PULMONARY FUNCTION:\n")
cat(sprintf("- Mean z-score for smokers (age 10+): %.3f (SD = %.3f)\n",
            mean_smokers_10, normality_results_10plus$SD[normality_results_10plus$Smoker == "Yes"]))
cat(sprintf("- Mean z-score for nonsmokers (age 10+): %.3f (SD = %.3f)\n",
            mean_nonsmokers_10, normality_results_10plus$SD[normality_results_10plus$Smoker == "No"]))
cat(sprintf("- Difference: %.3f (nonsmokers - smokers)\n", diff_means_10))

cat("\n\nCOMPARISON TO ALL AGES (Problem 5.42):\n")
cat(sprintf("- Difference in all ages: %.3f\n", diff_means))
cat(sprintf("- Difference in 10+ only: %.3f\n", diff_means_10))
cat(sprintf("- Change in effect size: %.3f\n", diff_means_10 - diff_means))

if (abs(diff_means_10) > abs(diff_means)) {
  cat("\n** The relationship is STRONGER in the 10+ age group **\n")
} else if (abs(diff_means_10) < abs(diff_means)) {
  cat("\n** The relationship is WEAKER in the 10+ age group **\n")
} else {
  cat("\n** The relationship is SIMILAR in both age groups **\n")
}

cat("\nCONCLUSIONS:\n")
if (abs(diff_means_10) > 0.15) {
  if (diff_means_10 > 0) {
    cat("- Smoking is associated with LOWER pulmonary function in children 10+\n")
    cat("- The effect is more apparent when focusing on older children\n")
    cat("- This is consistent with expected harmful effects of smoking\n")
  } else {
    cat("- Unexpected pattern requires further investigation\n")
  }
} else {
  cat("- Minimal difference between smokers and nonsmokers\n")
  cat("- May indicate smoking duration is insufficient to show effects\n")
  cat("- Or children with pre-existing lower lung function may be less likely to smoke\n")
}
```

---

# Problem 5.44: Sex-Specific Analysis (Ages 10+)

## Data Preparation by Sex

```{r problem-5.44-subset}
cat("=== SEX-SPECIFIC ANALYSIS: AGES 10+ ===\n\n")

# Create sex-specific datasets
fev_males_10plus <- fev_10plus %>% filter(Sex == "Male")
fev_females_10plus <- fev_10plus %>% filter(Sex == "Female")

cat("Sample Sizes:\n")
cat(sprintf("- Males age 10+: %d\n", nrow(fev_males_10plus)))
cat(sprintf("- Females age 10+: %d\n", nrow(fev_females_10plus)))

# Smoking prevalence by sex
cat("\n\nSmoking Prevalence by Sex (Age 10+):\n")
fev_10plus %>%
  count(Sex, Smoker) %>%
  group_by(Sex) %>%
  mutate(Percent = sprintf("%.1f%%", 100 * n / sum(n))) %>%
  ungroup() %>%
  pivot_wider(names_from = Smoker, values_from = c(n, Percent)) %>%
  kable(caption = "Smoking Status by Sex (Age 10+)")

# Z-score statistics by sex and smoking
cat("\n\nZ-Score Summary by Sex and Smoking Status (Age 10+):\n")
fev_10plus %>%
  group_by(Sex, Smoker) %>%
  summarise(
    N = n(),
    Mean_Z = mean(FEV_zscore, na.rm = TRUE),
    SD_Z = sd(FEV_zscore, na.rm = TRUE),
    Median_Z = median(FEV_zscore, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  kable(digits = 3,
        col.names = c("Sex", "Smoking Status", "N", "Mean Z", "SD", "Median Z"),
        caption = "Z-Scores by Sex and Smoking Status")
```

## Distributions by Sex: Males

```{r problem-5.44-males-plots, fig.height=10}
cat("\n=== MALES AGE 10+ ===\n\n")

# Males: Histograms
p_m1 <- ggplot(fev_males_10plus, aes(x = FEV_zscore, fill = Smoker)) +
  geom_histogram(aes(y = ..density..), bins = 20, alpha = 0.6, position = "identity") +
  geom_density(aes(color = Smoker), size = 1.2, alpha = 0) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "black", size = 1) +
  facet_wrap(~ Smoker, ncol = 1) +
  labs(title = "MALES Age 10+: FEV Z-Score Distribution",
       subtitle = "By Smoking Status",
       x = "FEV Z-Score",
       y = "Density") +
  scale_fill_manual(values = c("Yes" = "coral", "No" = "steelblue")) +
  scale_color_manual(values = c("Yes" = "darkred", "No" = "darkblue")) +
  theme_minimal() +
  theme(legend.position = "none")

# Males: Overlapping density
p_m2 <- ggplot(fev_males_10plus, aes(x = FEV_zscore, fill = Smoker, color = Smoker)) +
  geom_density(alpha = 0.4, size = 1.2) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "black", size = 1) +
  geom_vline(data = fev_males_10plus %>%
               group_by(Smoker) %>%
               summarise(mean_z = mean(FEV_zscore, na.rm = TRUE)),
             aes(xintercept = mean_z, color = Smoker),
             linetype = "dotted", size = 1) +
  labs(title = "MALES: Overlapping Densities",
       x = "FEV Z-Score",
       y = "Density") +
  scale_fill_manual(values = c("Yes" = "coral", "No" = "steelblue")) +
  scale_color_manual(values = c("Yes" = "darkred", "No" = "darkblue")) +
  theme_minimal() +
  theme(legend.position = "bottom")

# Males: Boxplot
p_m3 <- ggplot(fev_males_10plus, aes(x = Smoker, y = FEV_zscore, fill = Smoker)) +
  geom_boxplot(alpha = 0.7, outlier.shape = 16, outlier.size = 2) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red", size = 1) +
  stat_summary(fun = mean, geom = "point", shape = 23, size = 4, fill = "yellow") +
  labs(title = "MALES: Box Plot Comparison",
       x = "Smoking Status",
       y = "FEV Z-Score") +
  scale_fill_manual(values = c("Yes" = "coral", "No" = "steelblue")) +
  theme_minimal() +
  theme(legend.position = "none")

grid.arrange(p_m1, p_m2, p_m3, ncol = 1, heights = c(1.2, 0.9, 0.8))
```

## Distributions by Sex: Females

```{r problem-5.44-females-plots, fig.height=10}
cat("\n=== FEMALES AGE 10+ ===\n\n")

# Females: Histograms
p_f1 <- ggplot(fev_females_10plus, aes(x = FEV_zscore, fill = Smoker)) +
  geom_histogram(aes(y = ..density..), bins = 20, alpha = 0.6, position = "identity") +
  geom_density(aes(color = Smoker), size = 1.2, alpha = 0) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "black", size = 1) +
  facet_wrap(~ Smoker, ncol = 1) +
  labs(title = "FEMALES Age 10+: FEV Z-Score Distribution",
       subtitle = "By Smoking Status",
       x = "FEV Z-Score",
       y = "Density") +
  scale_fill_manual(values = c("Yes" = "coral", "No" = "steelblue")) +
  scale_color_manual(values = c("Yes" = "darkred", "No" = "darkblue")) +
  theme_minimal() +
  theme(legend.position = "none")

# Females: Overlapping density
p_f2 <- ggplot(fev_females_10plus, aes(x = FEV_zscore, fill = Smoker, color = Smoker)) +
  geom_density(alpha = 0.4, size = 1.2) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "black", size = 1) +
  geom_vline(data = fev_females_10plus %>%
               group_by(Smoker) %>%
               summarise(mean_z = mean(FEV_zscore, na.rm = TRUE)),
             aes(xintercept = mean_z, color = Smoker),
             linetype = "dotted", size = 1) +
  labs(title = "FEMALES: Overlapping Densities",
       x = "FEV Z-Score",
       y = "Density") +
  scale_fill_manual(values = c("Yes" = "coral", "No" = "steelblue")) +
  scale_color_manual(values = c("Yes" = "darkred", "No" = "darkblue")) +
  theme_minimal() +
  theme(legend.position = "bottom")

# Females: Boxplot
p_f3 <- ggplot(fev_females_10plus, aes(x = Smoker, y = FEV_zscore, fill = Smoker)) +
  geom_boxplot(alpha = 0.7, outlier.shape = 16, outlier.size = 2) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red", size = 1) +
  stat_summary(fun = mean, geom = "point", shape = 23, size = 4, fill = "yellow") +
  labs(title = "FEMALES: Box Plot Comparison",
       x = "Smoking Status",
       y = "FEV Z-Score") +
  scale_fill_manual(values = c("Yes" = "coral", "No" = "steelblue")) +
  theme_minimal() +
  theme(legend.position = "none")

grid.arrange(p_f1, p_f2, p_f3, ncol = 1, heights = c(1.2, 0.9, 0.8))
```

## Normality Assessment by Sex

```{r problem-5.44-normality, fig.height=6}
cat("\n=== NORMALITY ASSESSMENT BY SEX ===\n\n")

# Q-Q plots side by side
p_qq_males <- ggplot(fev_males_10plus, aes(sample = FEV_zscore, color = Smoker)) +
  stat_qq() +
  stat_qq_line(size = 1) +
  facet_wrap(~ Smoker) +
  labs(title = "MALES: Q-Q Plots",
       x = "Theoretical Quantiles",
       y = "Sample Quantiles") +
  scale_color_manual(values = c("Yes" = "coral", "No" = "steelblue")) +
  theme_minimal() +
  theme(legend.position = "none")

p_qq_females <- ggplot(fev_females_10plus, aes(sample = FEV_zscore, color = Smoker)) +
  stat_qq() +
  stat_qq_line(size = 1) +
  facet_wrap(~ Smoker) +
  labs(title = "FEMALES: Q-Q Plots",
       x = "Theoretical Quantiles",
       y = "Sample Quantiles") +
  scale_color_manual(values = c("Yes" = "coral", "No" = "steelblue")) +
  theme_minimal() +
  theme(legend.position = "none")

grid.arrange(p_qq_males, p_qq_females, ncol = 1)

# Statistical tests for males
normality_males <- fev_males_10plus %>%
  group_by(Smoker) %>%
  summarise(
    Sex = "Male",
    N = n(),
    Mean = mean(FEV_zscore, na.rm = TRUE),
    SD = sd(FEV_zscore, na.rm = TRUE),
    Skewness = skewness(FEV_zscore),
    Kurtosis = kurtosis(FEV_zscore),
    .groups = "drop"
  )

# Shapiro tests for males
shapiro_m_smokers <- shapiro.test(fev_males_10plus$FEV_zscore[fev_males_10plus$Smoker == "Yes"])
shapiro_m_nonsmokers <- shapiro.test(fev_males_10plus$FEV_zscore[fev_males_10plus$Smoker == "No"])

normality_males <- normality_males %>%
  mutate(
    Shapiro_W = c(shapiro_m_smokers$statistic, shapiro_m_nonsmokers$statistic),
    Shapiro_p = c(shapiro_m_smokers$p.value, shapiro_m_nonsmokers$p.value),
    Normal = ifelse(Shapiro_p > 0.05, "Yes", "No")
  )

# Statistical tests for females
normality_females <- fev_females_10plus %>%
  group_by(Smoker) %>%
  summarise(
    Sex = "Female",
    N = n(),
    Mean = mean(FEV_zscore, na.rm = TRUE),
    SD = sd(FEV_zscore, na.rm = TRUE),
    Skewness = skewness(FEV_zscore),
    Kurtosis = kurtosis(FEV_zscore),
    .groups = "drop"
  )

# Shapiro tests for females
shapiro_f_smokers <- shapiro.test(fev_females_10plus$FEV_zscore[fev_females_10plus$Smoker == "Yes"])
shapiro_f_nonsmokers <- shapiro.test(fev_females_10plus$FEV_zscore[fev_females_10plus$Smoker == "No"])

normality_females <- normality_females %>%
  mutate(
    Shapiro_W = c(shapiro_f_smokers$statistic, shapiro_f_nonsmokers$statistic),
    Shapiro_p = c(shapiro_f_smokers$p.value, shapiro_f_nonsmokers$p.value),
    Normal = ifelse(Shapiro_p > 0.05, "Yes", "No")
  )

# Combine results
normality_by_sex <- bind_rows(normality_males, normality_females)

cat("\n\nNormality Assessment by Sex (Age 10+):\n")
normality_by_sex %>%
  select(Sex, Smoker, N, Mean, SD, Skewness, Kurtosis, Shapiro_W, Shapiro_p, Normal) %>%
  kable(digits = 4,
        col.names = c("Sex", "Smoking Status", "N", "Mean", "SD", "Skewness",
                      "Kurtosis", "W Statistic", "p-value", "Normal?"),
        caption = "Normality Assessment by Sex and Smoking Status")
```

## Summary: Problem 5.44

```{r problem-5.44-summary}
cat("\n\n=== SUMMARY: PROBLEM 5.44 (SEX-SPECIFIC ANALYSIS) ===\n\n")

# Calculate differences by sex
mean_diff_males <- normality_males$Mean[normality_males$Smoker == "No"] -
                   normality_males$Mean[normality_males$Smoker == "Yes"]
mean_diff_females <- normality_females$Mean[normality_females$Smoker == "No"] -
                     normality_females$Mean[normality_females$Smoker == "Yes"]

cat("MALES (Age 10+):\n")
cat(sprintf("- Smokers mean z-score: %.3f (SD = %.3f, N = %d)\n",
            normality_males$Mean[normality_males$Smoker == "Yes"],
            normality_males$SD[normality_males$Smoker == "Yes"],
            normality_males$N[normality_males$Smoker == "Yes"]))
cat(sprintf("- Nonsmokers mean z-score: %.3f (SD = %.3f, N = %d)\n",
            normality_males$Mean[normality_males$Smoker == "No"],
            normality_males$SD[normality_males$Smoker == "No"],
            normality_males$N[normality_males$Smoker == "No"]))
cat(sprintf("- Difference: %.3f (nonsmokers - smokers)\n", mean_diff_males))

cat("\n\nFEMALES (Age 10+):\n")
cat(sprintf("- Smokers mean z-score: %.3f (SD = %.3f, N = %d)\n",
            normality_females$Mean[normality_females$Smoker == "Yes"],
            normality_females$SD[normality_females$Smoker == "Yes"],
            normality_females$N[normality_females$Smoker == "Yes"]))
cat(sprintf("- Nonsmokers mean z-score: %.3f (SD = %.3f, N = %d)\n",
            normality_females$Mean[normality_females$Smoker == "No"],
            normality_females$SD[normality_females$Smoker == "No"],
            normality_females$N[normality_females$Smoker == "No"]))
cat(sprintf("- Difference: %.3f (nonsmokers - smokers)\n", mean_diff_females))

cat("\n\nCOMPARISON ACROSS SEXES:\n")
cat(sprintf("- Effect size in males: %.3f\n", mean_diff_males))
cat(sprintf("- Effect size in females: %.3f\n", mean_diff_females))
cat(sprintf("- Difference in effect sizes: %.3f\n", abs(mean_diff_males) - abs(mean_diff_females)))

if (abs(mean_diff_males - mean_diff_females) > 0.1) {
  if (abs(mean_diff_males) > abs(mean_diff_females)) {
    cat("\n** The smoking effect is STRONGER in MALES **\n")
  } else {
    cat("\n** The smoking effect is STRONGER in FEMALES **\n")
  }
} else {
  cat("\n** The smoking effect is SIMILAR in both sexes **\n")
}

cat("\nNORMALITY ASSESSMENT:\n")
cat("Males:\n")
for (i in 1:nrow(normality_males)) {
  row <- normality_males[i, ]
  cat(sprintf("  - %s: %s (p = %.4f)\n",
              row$Smoker, row$Normal, row$Shapiro_p))
}
cat("Females:\n")
for (i in 1:nrow(normality_females)) {
  row <- normality_females[i, ]
  cat(sprintf("  - %s: %s (p = %.4f)\n",
              row$Smoker, row$Normal, row$Shapiro_p))
}

cat("\n\nCONCLUSIONS:\n")
cat("1. CONSISTENCY ACROSS SEXES:\n")
if (sign(mean_diff_males) == sign(mean_diff_females)) {
  cat("   - Direction of effect is CONSISTENT between males and females\n")
  if (mean_diff_males > 0 && mean_diff_females > 0) {
    cat("   - Both sexes show lower FEV z-scores among smokers\n")
  }
} else {
  cat("   - Direction of effect DIFFERS between males and females\n")
  cat("   - This warrants further investigation\n")
}

cat("\n2. MAGNITUDE OF EFFECT:\n")
if (abs(mean_diff_males - mean_diff_females) < 0.1) {
  cat("   - Effect sizes are similar in both sexes\n")
  cat("   - Smoking appears to affect pulmonary function similarly regardless of sex\n")
} else {
  cat("   - Effect sizes differ between sexes\n")
  cat("   - Sex may modify the smoking-pulmonary function relationship\n")
}

cat("\n3. OVERALL INTERPRETATION:\n")
cat("   - Age-sex standardized z-scores successfully control for confounding\n")
cat("   - Focusing on ages 10+ provides a more relevant comparison\n")
cat("   - Sex-specific analyses reveal whether effects are generalizable\n")
cat("   - Formal hypothesis testing (Chapter 8) needed to assess statistical significance\n")
```

---

# Comparative Summary: All Problems

```{r comparative-summary, fig.height=8}
cat("\n\n=== COMPARATIVE SUMMARY: PROBLEMS 5.42 - 5.44 ===\n\n")

# Create comparison table
comparison_table <- data.frame(
  Analysis = c("All Ages", "Age 10+", "Males 10+", "Females 10+"),
  N_Smokers = c(
    sum(fev_with_z$Smoker == "Yes"),
    sum(fev_10plus$Smoker == "Yes"),
    sum(fev_males_10plus$Smoker == "Yes"),
    sum(fev_females_10plus$Smoker == "Yes")
  ),
  N_Nonsmokers = c(
    sum(fev_with_z$Smoker == "No"),
    sum(fev_10plus$Smoker == "No"),
    sum(fev_males_10plus$Smoker == "No"),
    sum(fev_females_10plus$Smoker == "No")
  ),
  Mean_Diff = c(
    diff_means,
    diff_means_10,
    mean_diff_males,
    mean_diff_females
  )
)

comparison_table <- comparison_table %>%
  mutate(
    Total = N_Smokers + N_Nonsmokers,
    Pct_Smokers = sprintf("%.1f%%", 100 * N_Smokers / Total),
    Effect_Size = abs(Mean_Diff)
  )

cat("Summary of All Analyses:\n")
comparison_table %>%
  select(Analysis, Total, N_Smokers, Pct_Smokers, Mean_Diff, Effect_Size) %>%
  kable(digits = 3,
        col.names = c("Analysis Group", "Total N", "Smokers N", "% Smokers",
                      "Mean Difference", "Effect Size"),
        caption = "Comparison of Effect Sizes Across Different Subgroups")

# Visual comparison
p_compare <- ggplot(comparison_table, aes(x = reorder(Analysis, -Mean_Diff), y = Mean_Diff, fill = Analysis)) +
  geom_bar(stat = "identity", alpha = 0.7) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red", size = 1) +
  geom_text(aes(label = sprintf("%.3f", Mean_Diff)),
            vjust = ifelse(comparison_table$Mean_Diff > 0, -0.5, 1.5), size = 5) +
  labs(title = "Mean Z-Score Difference: Nonsmokers - Smokers",
       subtitle = "Positive values indicate lower FEV in smokers",
       x = "Analysis Group",
       y = "Mean Z-Score Difference") +
  scale_fill_brewer(palette = "Set2") +
  theme_minimal() +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 45, hjust = 1))

print(p_compare)

cat("\n\nKEY FINDINGS:\n\n")

cat("1. SAMPLE COMPOSITION:\n")
cat(sprintf("   - Smoking prevalence increases from %.1f%% (all ages) to %.1f%% (age 10+)\n",
            100 * sum(fev_with_z$Smoker == "Yes") / nrow(fev_with_z),
            100 * sum(fev_10plus$Smoker == "Yes") / nrow(fev_10plus)))
cat("   - This confirms smoking is rare in young children\n")

cat("\n2. EFFECT SIZE PATTERNS:\n")
cat(sprintf("   - Effect size ranges from %.3f to %.3f across subgroups\n",
            min(comparison_table$Effect_Size), max(comparison_table$Effect_Size)))
if (comparison_table$Effect_Size[2] > comparison_table$Effect_Size[1]) {
  cat("   - Effect is stronger when focusing on age 10+ (reduces age confounding)\n")
}

cat("\n3. SEX DIFFERENCES:\n")
if (abs(mean_diff_males - mean_diff_females) < 0.1) {
  cat("   - Males and females show similar smoking-related effects\n")
  cat("   - No strong evidence for sex-specific vulnerability\n")
} else {
  cat("   - Sex-specific effects are present\n")
  cat("   - Further investigation of sex differences warranted\n")
}

cat("\n4. NORMALITY OF DISTRIBUTIONS:\n")
all_normal <- all(c(normality_results_all$Normal,
                    normality_results_10plus$Normal,
                    normality_by_sex$Normal) == "Yes")
if (all_normal) {
  cat("   - All distributions appear approximately normal\n")
  cat("   - Parametric methods appropriate for formal testing\n")
} else {
  cat("   - Some distributions show deviations from normality\n")
  cat("   - Both parametric and non-parametric methods should be considered\n")
}

cat("\n5. CLINICAL IMPLICATIONS:\n")
cat("   - Z-score standardization successfully controls for age and sex effects\n")
cat("   - Smoking appears associated with altered pulmonary function in children\n")
cat("   - Effect is most apparent in children 10+ years old\n")
cat("   - These descriptive findings motivate formal hypothesis testing (Chapter 8)\n")
```

---

# Overall Conclusions

```{r overall-conclusions}
cat("\n\n=== OVERALL STUDY CONCLUSIONS ===\n\n")

cat("METHODOLOGICAL APPROACH:\n")
cat("- Used z-score standardization to control for age and sex confounding\n")
cat("- Z-scores calculated within age-sex groups: z = (FEV - mean) / SD\n")
cat("- This allows fair comparison between smokers and nonsmokers\n")
cat("- Age 10+ subset focuses on period when smoking prevalence increases\n")

cat("\n\nDISTRIBUTION CHARACTERISTICS:\n")
cat("- Most z-score distributions appear approximately normal\n")
cat("- Some evidence of skewness in certain subgroups\n")
cat("- Q-Q plots generally show reasonable fit to normal distribution\n")
cat("- Normality assumption reasonable for subsequent parametric testing\n")

cat("\n\nSMOKING-PULMONARY FUNCTION RELATIONSHIP:\n")
if (all(c(diff_means, diff_means_10, mean_diff_males, mean_diff_females) > 0)) {
  cat("- Consistent pattern: Smokers have lower FEV z-scores than nonsmokers\n")
  cat("- Effect present across all age groups and both sexes\n")
  cat("- Magnitude of effect is moderate (0.1 - 0.4 SD units)\n")
} else {
  cat("- Pattern requires careful interpretation\n")
  cat("- Results may reflect complex relationship between smoking and lung development\n")
}

cat("\n\nAGE STRATIFICATION INSIGHTS:\n")
cat("- Analysis improves when focusing on ages 10+\n")
cat("- Younger children have very low smoking prevalence\n")
cat("- Age 10+ provides adequate sample size for both smokers and nonsmokers\n")

cat("\n\nSEX-SPECIFIC FINDINGS:\n")
cat(sprintf("- Males (10+): Mean difference = %.3f SD units\n", mean_diff_males))
cat(sprintf("- Females (10+): Mean difference = %.3f SD units\n", mean_diff_females))
if (abs(mean_diff_males - mean_diff_females) < 0.15) {
  cat("- Effects are broadly similar between sexes\n")
} else {
  cat("- Some evidence for sex-specific effects\n")
}

cat("\n\nLIMITATIONS:\n")
cat("- Cross-sectional design: Cannot establish causation\n")
cat("- Possible selection bias: Children with lower lung function may avoid smoking\n")
cat("- Smoking duration and intensity not measured\n")
cat("- Passive smoking exposure not assessed\n")
cat("- Statistical significance not yet tested (Chapter 8 methods needed)\n")

cat("\n\nNEXT STEPS:\n")
cat("- Formal hypothesis testing (two-sample t-tests)\n")
cat("- Confidence intervals for mean differences\n")
cat("- Consideration of other confounders (height, socioeconomic status)\n")
cat("- Longitudinal follow-up to assess causation\n")
cat("- Dose-response analysis if smoking intensity data available\n")
```

---

# Session Information

```{r session-info}
sessionInfo()
```
