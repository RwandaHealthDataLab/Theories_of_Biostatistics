---
title: "Chapter 10: Hepatic Disease - Hormone Study Analysis"
author: "Biostatistics Analysis"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
    theme: cerulean
    highlight: tango
    code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 10,
  fig.height = 6,
  fig.align = 'center'
)
```

# Introduction

This document presents a comprehensive analysis of the Hepatic Disease study using the HORMONE.DAT dataset. The study examines the effects of different hormone treatments on pancreatic and biliary secretions in hens.

## Study Background

The study investigates how different hormone regimens affect:

- **Pancreatic secretions** (increase post-treatment vs. pre-treatment)
- **Biliary secretions** (increase post-treatment vs. pre-treatment)

Five treatment groups are compared, with different doses administered to assess dose-response relationships.

# Data Loading and Preparation

```{r load-packages}
# Load required libraries
library(tidyverse)
library(knitr)
library(kableExtra)
library(DescTools)
library(pwr)
library(ggplot2)
library(scales)

# Set theme for plots
theme_set(theme_minimal())
```



```{r load-data}
# Load the HORMONE.DAT dataset
data_path <- "Rosner_FundamentalsBiostatistics_8e_Data_Sets/ASCII-comma/HORMONE.DAT.txt"

# Read the data - handle quotes in column names
hormone_data <- read.csv(data_path, header = TRUE, strip.white = TRUE, quote = "'\"")

# Clean column names (remove any quotes)
colnames(hormone_data) <- gsub("'", "", colnames(hormone_data))
colnames(hormone_data) <- gsub("\"", "", colnames(hormone_data))

# Display structure
str(hormone_data)

# Display column names for verification
cat("\nColumn names in dataset:\n")
print(colnames(hormone_data))
```

# Data Exploration

```{r data-summary}
# Display first few rows
kable(head(hormone_data, 10),
      caption = "First 10 observations from HORMONE dataset") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = FALSE)

# Summary statistics
summary(hormone_data)
```

## Variable Definitions

```{r variable-definitions}
# Create variable definitions table
var_definitions <- data.frame(
  Variable = c("ID", "Bilsecpr", "Bilphpr", "Pansecpr", "Panphpr",
               "Dose", "Bilsecpt", "Bilphpt", "Pansecpt", "Panphpt", "Hormone"),
  Description = c(
    "Hen identification number",
    "Biliary secretion pre-treatment (μL/10 min)",
    "Biliary pH pre-treatment",
    "Pancreatic secretion pre-treatment (μL/10 min)",
    "Pancreatic pH pre-treatment",
    "Hormone dose (μg/kg body weight)",
    "Biliary secretion post-treatment (μL/10 min)",
    "Biliary pH post-treatment",
    "Pancreatic secretion post-treatment (μL/10 min)",
    "Pancreatic pH post-treatment",
    "Hormone group (1=Saline, 2=Secretin, 3=Cholecystokinin, 4=Gastrin, 5=CCK+secretin)"
  )
)

kable(var_definitions,
      caption = "Variable Definitions for HORMONE Dataset") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                full_width = FALSE)
```

## Data Processing

```{r data-processing}
# Verify required columns exist
required_cols <- c("ID", "Bilsecpr", "Bilphpr", "Pansecpr", "Panphpr",
                   "Dose", "Bilsecpt", "Bilphpt", "Pansecpt", "Panphpt", "Hormone")

missing_cols <- setdiff(required_cols, colnames(hormone_data))
if(length(missing_cols) > 0) {
  stop(paste("Missing columns:", paste(missing_cols, collapse = ", ")))
}

cat("All required columns are present.\n")
cat("Dataset has", nrow(hormone_data), "rows and", ncol(hormone_data), "columns.\n\n")

# Create factor for hormone groups with meaningful labels
hormone_data <- hormone_data %>%
  mutate(
    Hormone_Group = factor(Hormone,
                          levels = 1:5,
                          labels = c("Saline (Control)",
                                   "Secretin",
                                   "Cholecystokinin",
                                   "Gastrin",
                                   "CCK+Secretin")),

    # Create binary indicators for secretion increases
    # Pancreatic secretion increased if post > pre and post > 0
    Pancreatic_Increase = ifelse(Pansecpt > Pansecpr & Pansecpt > 0, 1, 0),

    # Biliary secretion increased if post > pre and post > 0
    Biliary_Increase = ifelse(Bilsecpt > Bilsecpr & Bilsecpt > 0, 1, 0),

    # Calculate differences
    Pancreatic_Diff = Pansecpt - Pansecpr,
    Biliary_Diff = Bilsecpt - Bilsecpr
  )

cat("Data processing completed successfully.\n")

# Summary by hormone group
group_summary <- hormone_data %>%
  group_by(Hormone_Group) %>%
  summarise(
    N = n(),
    N_Pancreatic_Increase = sum(Pancreatic_Increase, na.rm = TRUE),
    Pct_Pancreatic_Increase = round(100 * mean(Pancreatic_Increase, na.rm = TRUE), 2),
    N_Biliary_Increase = sum(Biliary_Increase, na.rm = TRUE),
    Pct_Biliary_Increase = round(100 * mean(Biliary_Increase, na.rm = TRUE), 2)
  )

kable(group_summary,
      caption = "Summary of Secretion Increases by Hormone Group",
      col.names = c("Hormone Group", "N",
                   "N (Pancreatic↑)", "% (Pancreatic↑)",
                   "N (Biliary↑)", "% (Biliary↑)")) %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                full_width = FALSE)
```

# Visualization

```{r visualization-increases}
# Plot percentage of increases by group
plot_data <- group_summary %>%
  pivot_longer(cols = c(Pct_Pancreatic_Increase, Pct_Biliary_Increase),
               names_to = "Secretion_Type",
               values_to = "Percentage") %>%
  mutate(Secretion_Type = ifelse(Secretion_Type == "Pct_Pancreatic_Increase",
                                 "Pancreatic", "Biliary"))

ggplot(plot_data, aes(x = Hormone_Group, y = Percentage, fill = Secretion_Type)) +
  geom_bar(stat = "identity", position = "dodge", alpha = 0.8) +
  geom_text(aes(label = paste0(round(Percentage, 1), "%")),
            position = position_dodge(width = 0.9),
            vjust = -0.5, size = 3.5) +
  labs(title = "Percentage of Hens with Increased Secretions by Hormone Group",
       subtitle = "Comparison of Pancreatic and Biliary Secretion Increases",
       x = "Hormone Treatment Group",
       y = "Percentage of Hens with Increase (%)",
       fill = "Secretion Type") +
  scale_fill_manual(values = c("Pancreatic" = "#3498db", "Biliary" = "#e74c3c")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "top",
        plot.title = element_text(face = "bold", size = 14),
        plot.subtitle = element_text(size = 11))
```

```{r boxplot-differences}
# Create boxplots for differences
p1 <- ggplot(hormone_data, aes(x = Hormone_Group, y = Pancreatic_Diff, fill = Hormone_Group)) +
  geom_boxplot(alpha = 0.7, outlier.alpha = 0.5) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Pancreatic Secretion Changes by Treatment Group",
       x = "Hormone Group",
       y = "Change in Pancreatic Secretion (μL/10 min)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")

p2 <- ggplot(hormone_data, aes(x = Hormone_Group, y = Biliary_Diff, fill = Hormone_Group)) +
  geom_boxplot(alpha = 0.7, outlier.alpha = 0.5) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Biliary Secretion Changes by Treatment Group",
       x = "Hormone Group",
       y = "Change in Biliary Secretion (μL/10 min)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")

library(gridExtra)
grid.arrange(p1, p2, ncol = 1)
```

# Problem 10.37: Test Procedure for Comparing Proportions

## Question
What test procedure can be used to compare the percentage of hens whose pancreatic secretions increased (post-pre) among the five treatment regimens?

## Answer

**Test Selection: Chi-square Test for Independence (or Fisher's Exact Test)**

To compare proportions across five independent groups, we use:

1. **Chi-square test for independence (k × 2 contingency table)**
   - Tests whether the proportion of hens with increased secretions differs across the 5 treatment groups
   - Appropriate when expected frequencies are ≥5 in most cells
   - Hypotheses:
     - H₀: The proportion of hens with increased secretions is the same across all treatment groups
     - H₁: At least one treatment group has a different proportion

2. **Fisher's Exact Test** (alternative if cell counts are small)
   - Used when expected frequencies are < 5 in many cells
   - Provides exact p-value

**Test Statistic:**

$$\chi^2 = \sum_{i=1}^{k} \sum_{j=1}^{2} \frac{(O_{ij} - E_{ij})^2}{E_{ij}}$$

Where:
- $O_{ij}$ = observed frequency in cell (i,j)
- $E_{ij}$ = expected frequency in cell (i,j)
- Degrees of freedom = (k-1)(2-1) = 4

# Problem 10.38: Test for Pancreatic Secretions

## Implementation

```{r problem-10.38}
# Create contingency table for pancreatic secretions
pancreatic_table <- table(hormone_data$Hormone_Group,
                         hormone_data$Pancreatic_Increase)

# Add row and column names
rownames(pancreatic_table) <- levels(hormone_data$Hormone_Group)
colnames(pancreatic_table) <- c("No Increase", "Increase")

# Display the contingency table
kable(addmargins(pancreatic_table),
      caption = "Contingency Table: Pancreatic Secretion Increases by Hormone Group") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                full_width = FALSE)

# Perform Chi-square test
chi_sq_pancreatic <- chisq.test(pancreatic_table)

# Display results
cat("\n=== Chi-square Test Results for Pancreatic Secretions ===\n")
cat(sprintf("Chi-square statistic: %.4f\n", chi_sq_pancreatic$statistic))
cat(sprintf("Degrees of freedom: %d\n", chi_sq_pancreatic$parameter))
cat(sprintf("P-value: %.6f\n", chi_sq_pancreatic$p.value))
cat(sprintf("\nConclusion at α = 0.05: %s\n",
            ifelse(chi_sq_pancreatic$p.value < 0.05,
                   "REJECT H₀ - Significant differences exist among groups",
                   "FAIL TO REJECT H₀ - No significant differences among groups")))

# Check expected frequencies
cat("\n--- Expected Frequencies ---\n")
print(round(chi_sq_pancreatic$expected, 2))

# Check if any expected frequency < 5
min_expected <- min(chi_sq_pancreatic$expected)
cat(sprintf("\nMinimum expected frequency: %.2f\n", min_expected))
if(min_expected < 5) {
  cat("WARNING: Some expected frequencies < 5. Fisher's exact test may be more appropriate.\n")
}

# Fisher's Exact Test (as alternative)
cat("\n=== Fisher's Exact Test (Alternative) ===\n")
fisher_pancreatic <- fisher.test(pancreatic_table, simulate.p.value = TRUE, B = 10000)
cat(sprintf("P-value (simulated): %.6f\n", fisher_pancreatic$p.value))
```

## Interpretation

```{r interpretation-10.38}
# Calculate proportions by group
prop_by_group_pan <- hormone_data %>%
  group_by(Hormone_Group) %>%
  summarise(
    N = n(),
    N_Increase = sum(Pancreatic_Increase),
    Proportion = round(mean(Pancreatic_Increase), 4),
    Percentage = round(100 * mean(Pancreatic_Increase), 2)
  )

kable(prop_by_group_pan,
      caption = "Proportions of Pancreatic Secretion Increases by Group",
      col.names = c("Hormone Group", "Total N", "N with Increase",
                   "Proportion", "Percentage (%)")) %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                full_width = FALSE)
```

# Problem 10.39: Test for Biliary Secretions

## Implementation

```{r problem-10.39}
# Create contingency table for biliary secretions
biliary_table <- table(hormone_data$Hormone_Group,
                      hormone_data$Biliary_Increase)

# Add row and column names
rownames(biliary_table) <- levels(hormone_data$Hormone_Group)
colnames(biliary_table) <- c("No Increase", "Increase")

# Display the contingency table
kable(addmargins(biliary_table),
      caption = "Contingency Table: Biliary Secretion Increases by Hormone Group") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                full_width = FALSE)

# Perform Chi-square test
chi_sq_biliary <- chisq.test(biliary_table)

# Display results
cat("\n=== Chi-square Test Results for Biliary Secretions ===\n")
cat(sprintf("Chi-square statistic: %.4f\n", chi_sq_biliary$statistic))
cat(sprintf("Degrees of freedom: %d\n", chi_sq_biliary$parameter))
cat(sprintf("P-value: %.6f\n", chi_sq_biliary$p.value))
cat(sprintf("\nConclusion at α = 0.05: %s\n",
            ifelse(chi_sq_biliary$p.value < 0.05,
                   "REJECT H₀ - Significant differences exist among groups",
                   "FAIL TO REJECT H₀ - No significant differences among groups")))

# Check expected frequencies
cat("\n--- Expected Frequencies ---\n")
print(round(chi_sq_biliary$expected, 2))

# Check if any expected frequency < 5
min_expected_bil <- min(chi_sq_biliary$expected)
cat(sprintf("\nMinimum expected frequency: %.2f\n", min_expected_bil))
if(min_expected_bil < 5) {
  cat("WARNING: Some expected frequencies < 5. Fisher's exact test may be more appropriate.\n")
}

# Fisher's Exact Test (as alternative)
cat("\n=== Fisher's Exact Test (Alternative) ===\n")
fisher_biliary <- fisher.test(biliary_table, simulate.p.value = TRUE, B = 10000)
cat(sprintf("P-value (simulated): %.6f\n", fisher_biliary$p.value))
```

## Interpretation

```{r interpretation-10.39}
# Calculate proportions by group
prop_by_group_bil <- hormone_data %>%
  group_by(Hormone_Group) %>%
  summarise(
    N = n(),
    N_Increase = sum(Biliary_Increase),
    Proportion = round(mean(Biliary_Increase), 4),
    Percentage = round(100 * mean(Biliary_Increase), 2)
  )

kable(prop_by_group_bil,
      caption = "Proportions of Biliary Secretion Increases by Group",
      col.names = c("Hormone Group", "Total N", "N with Increase",
                   "Proportion", "Percentage (%)")) %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                full_width = FALSE)
```

# Problem 10.40: Dose-Response for Pancreatic Secretions

## Question
For all hormone groups except saline, is there a dose-response relationship between the proportion of hens with increasing pancreatic secretions and the hormone dose? This should be assessed separately for each specific active hormone.

## Method: Cochran-Armitage Trend Test

The Cochran-Armitage trend test is appropriate for assessing dose-response relationships in binary outcomes.

- **Null Hypothesis (H₀):** No linear trend in proportions across dose levels
- **Alternative Hypothesis (H₁):** There is a linear trend in proportions across dose levels

```{r problem-10.40-secretin}
# Analyze Secretin group (Hormone = 2)
cat("=== SECRETIN GROUP ===\n")
secretin_data <- hormone_data %>%
  filter(Hormone == 2) %>%
  arrange(Dose)

# Create dose-response table
secretin_table <- secretin_data %>%
  group_by(Dose) %>%
  summarise(
    N = n(),
    N_Increase = sum(Pancreatic_Increase),
    Proportion = round(mean(Pancreatic_Increase), 4)
  )

kable(secretin_table,
      caption = "Secretin: Dose-Response for Pancreatic Secretion",
      col.names = c("Dose (μg/kg)", "N", "N with Increase", "Proportion")) %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                full_width = FALSE)

# Cochran-Armitage Trend Test
if(nrow(secretin_table) > 1) {
  trend_test_secretin_pan <- CochranArmitageTest(
    table(secretin_data$Dose, secretin_data$Pancreatic_Increase)
  )
  cat(sprintf("\nCochran-Armitage Trend Test:\n"))
  cat(sprintf("Z-statistic: %.4f\n", trend_test_secretin_pan$statistic))
  cat(sprintf("P-value: %.6f\n", trend_test_secretin_pan$p.value))
  cat(sprintf("Conclusion: %s\n",
              ifelse(trend_test_secretin_pan$p.value < 0.05,
                     "Significant dose-response relationship exists",
                     "No significant dose-response relationship")))
} else {
  cat("Insufficient dose levels for trend test\n")
}
```

```{r problem-10.40-cholecystokinin}
# Analyze Cholecystokinin group (Hormone = 3)
cat("\n\n=== CHOLECYSTOKININ (CCK) GROUP ===\n")
cck_data <- hormone_data %>%
  filter(Hormone == 3) %>%
  arrange(Dose)

# Create dose-response table
cck_table <- cck_data %>%
  group_by(Dose) %>%
  summarise(
    N = n(),
    N_Increase = sum(Pancreatic_Increase),
    Proportion = round(mean(Pancreatic_Increase), 4)
  )

kable(cck_table,
      caption = "Cholecystokinin: Dose-Response for Pancreatic Secretion",
      col.names = c("Dose (μg/kg)", "N", "N with Increase", "Proportion")) %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                full_width = FALSE)

# Cochran-Armitage Trend Test
if(nrow(cck_table) > 1) {
  trend_test_cck_pan <- CochranArmitageTest(
    table(cck_data$Dose, cck_data$Pancreatic_Increase)
  )
  cat(sprintf("\nCochran-Armitage Trend Test:\n"))
  cat(sprintf("Z-statistic: %.4f\n", trend_test_cck_pan$statistic))
  cat(sprintf("P-value: %.6f\n", trend_test_cck_pan$p.value))
  cat(sprintf("Conclusion: %s\n",
              ifelse(trend_test_cck_pan$p.value < 0.05,
                     "Significant dose-response relationship exists",
                     "No significant dose-response relationship")))
} else {
  cat("Insufficient dose levels for trend test\n")
}
```

```{r problem-10.40-gastrin}
# Analyze Gastrin group (Hormone = 4)
cat("\n\n=== GASTRIN GROUP ===\n")
gastrin_data <- hormone_data %>%
  filter(Hormone == 4) %>%
  arrange(Dose)

# Create dose-response table
gastrin_table <- gastrin_data %>%
  group_by(Dose) %>%
  summarise(
    N = n(),
    N_Increase = sum(Pancreatic_Increase),
    Proportion = round(mean(Pancreatic_Increase), 4)
  )

kable(gastrin_table,
      caption = "Gastrin: Dose-Response for Pancreatic Secretion",
      col.names = c("Dose (μg/kg)", "N", "N with Increase", "Proportion")) %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                full_width = FALSE)

# Cochran-Armitage Trend Test
if(nrow(gastrin_table) > 1) {
  trend_test_gastrin_pan <- CochranArmitageTest(
    table(gastrin_data$Dose, gastrin_data$Pancreatic_Increase)
  )
  cat(sprintf("\nCochran-Armitage Trend Test:\n"))
  cat(sprintf("Z-statistic: %.4f\n", trend_test_gastrin_pan$statistic))
  cat(sprintf("P-value: %.6f\n", trend_test_gastrin_pan$p.value))
  cat(sprintf("Conclusion: %s\n",
              ifelse(trend_test_gastrin_pan$p.value < 0.05,
                     "Significant dose-response relationship exists",
                     "No significant dose-response relationship")))
} else {
  cat("Insufficient dose levels for trend test\n")
}
```

```{r problem-10.40-cck-secretin}
# Analyze CCK+Secretin group (Hormone = 5)
cat("\n\n=== CCK+SECRETIN GROUP ===\n")
cck_sec_data <- hormone_data %>%
  filter(Hormone == 5) %>%
  arrange(Dose)

# Create dose-response table
cck_sec_table <- cck_sec_data %>%
  group_by(Dose) %>%
  summarise(
    N = n(),
    N_Increase = sum(Pancreatic_Increase),
    Proportion = round(mean(Pancreatic_Increase), 4)
  )

kable(cck_sec_table,
      caption = "CCK+Secretin: Dose-Response for Pancreatic Secretion",
      col.names = c("Dose (μg/kg)", "N", "N with Increase", "Proportion")) %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                full_width = FALSE)

# Cochran-Armitage Trend Test
if(nrow(cck_sec_table) > 1) {
  trend_test_cck_sec_pan <- CochranArmitageTest(
    table(cck_sec_data$Dose, cck_sec_data$Pancreatic_Increase)
  )
  cat(sprintf("\nCochran-Armitage Trend Test:\n"))
  cat(sprintf("Z-statistic: %.4f\n", trend_test_cck_sec_pan$statistic))
  cat(sprintf("P-value: %.6f\n", trend_test_cck_sec_pan$p.value))
  cat(sprintf("Conclusion: %s\n",
              ifelse(trend_test_cck_sec_pan$p.value < 0.05,
                     "Significant dose-response relationship exists",
                     "No significant dose-response relationship")))
} else {
  cat("Insufficient dose levels for trend test\n")
}
```

## Visualization of Dose-Response

```{r dose-response-plot-pancreatic}
# Create dose-response plots for each hormone group
active_hormones <- hormone_data %>%
  filter(Hormone != 1)  # Exclude saline

dose_response_summary <- active_hormones %>%
  group_by(Hormone_Group, Dose) %>%
  summarise(
    N = n(),
    Proportion = mean(Pancreatic_Increase),
    .groups = 'drop'
  )

ggplot(dose_response_summary, aes(x = Dose, y = Proportion, color = Hormone_Group)) +
  geom_point(aes(size = N), alpha = 0.7) +
  geom_line(alpha = 0.5) +
  geom_smooth(method = "lm", se = TRUE, alpha = 0.2, linewidth = 0.5) +
  facet_wrap(~ Hormone_Group, scales = "free_x") +
  labs(title = "Dose-Response Relationship: Pancreatic Secretion Increases",
       subtitle = "Proportion of hens with increased pancreatic secretions vs. hormone dose",
       x = "Dose (μg/kg body weight)",
       y = "Proportion with Increase",
       size = "Sample Size") +
  scale_y_continuous(labels = percent_format()) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

# Problem 10.41: Dose-Response for Biliary Secretions

```{r problem-10.41-secretin}
# Analyze Secretin group (Hormone = 2)
cat("=== SECRETIN GROUP - BILIARY SECRETIONS ===\n")

# Create dose-response table
secretin_table_bil <- secretin_data %>%
  group_by(Dose) %>%
  summarise(
    N = n(),
    N_Increase = sum(Biliary_Increase),
    Proportion = round(mean(Biliary_Increase), 4)
  )

kable(secretin_table_bil,
      caption = "Secretin: Dose-Response for Biliary Secretion",
      col.names = c("Dose (μg/kg)", "N", "N with Increase", "Proportion")) %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                full_width = FALSE)

# Cochran-Armitage Trend Test
if(nrow(secretin_table_bil) > 1) {
  trend_test_secretin_bil <- CochranArmitageTest(
    table(secretin_data$Dose, secretin_data$Biliary_Increase)
  )
  cat(sprintf("\nCochran-Armitage Trend Test:\n"))
  cat(sprintf("Z-statistic: %.4f\n", trend_test_secretin_bil$statistic))
  cat(sprintf("P-value: %.6f\n", trend_test_secretin_bil$p.value))
  cat(sprintf("Conclusion: %s\n",
              ifelse(trend_test_secretin_bil$p.value < 0.05,
                     "Significant dose-response relationship exists",
                     "No significant dose-response relationship")))
} else {
  cat("Insufficient dose levels for trend test\n")
}
```

```{r problem-10.41-cholecystokinin}
# Analyze Cholecystokinin group (Hormone = 3)
cat("\n\n=== CHOLECYSTOKININ (CCK) GROUP - BILIARY SECRETIONS ===\n")

# Create dose-response table
cck_table_bil <- cck_data %>%
  group_by(Dose) %>%
  summarise(
    N = n(),
    N_Increase = sum(Biliary_Increase),
    Proportion = round(mean(Biliary_Increase), 4)
  )

kable(cck_table_bil,
      caption = "Cholecystokinin: Dose-Response for Biliary Secretion",
      col.names = c("Dose (μg/kg)", "N", "N with Increase", "Proportion")) %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                full_width = FALSE)

# Cochran-Armitage Trend Test
if(nrow(cck_table_bil) > 1) {
  trend_test_cck_bil <- CochranArmitageTest(
    table(cck_data$Dose, cck_data$Biliary_Increase)
  )
  cat(sprintf("\nCochran-Armitage Trend Test:\n"))
  cat(sprintf("Z-statistic: %.4f\n", trend_test_cck_bil$statistic))
  cat(sprintf("P-value: %.6f\n", trend_test_cck_bil$p.value))
  cat(sprintf("Conclusion: %s\n",
              ifelse(trend_test_cck_bil$p.value < 0.05,
                     "Significant dose-response relationship exists",
                     "No significant dose-response relationship")))
} else {
  cat("Insufficient dose levels for trend test\n")
}
```

```{r problem-10.41-gastrin}
# Analyze Gastrin group (Hormone = 4)
cat("\n\n=== GASTRIN GROUP - BILIARY SECRETIONS ===\n")

# Create dose-response table
gastrin_table_bil <- gastrin_data %>%
  group_by(Dose) %>%
  summarise(
    N = n(),
    N_Increase = sum(Biliary_Increase),
    Proportion = round(mean(Biliary_Increase), 4)
  )

kable(gastrin_table_bil,
      caption = "Gastrin: Dose-Response for Biliary Secretion",
      col.names = c("Dose (μg/kg)", "N", "N with Increase", "Proportion")) %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                full_width = FALSE)

# Cochran-Armitage Trend Test
if(nrow(gastrin_table_bil) > 1) {
  trend_test_gastrin_bil <- CochranArmitageTest(
    table(gastrin_data$Dose, gastrin_data$Biliary_Increase)
  )
  cat(sprintf("\nCochran-Armitage Trend Test:\n"))
  cat(sprintf("Z-statistic: %.4f\n", trend_test_gastrin_bil$statistic))
  cat(sprintf("P-value: %.6f\n", trend_test_gastrin_bil$p.value))
  cat(sprintf("Conclusion: %s\n",
              ifelse(trend_test_gastrin_bil$p.value < 0.05,
                     "Significant dose-response relationship exists",
                     "No significant dose-response relationship")))
} else {
  cat("Insufficient dose levels for trend test\n")
}
```

```{r problem-10.41-cck-secretin}
# Analyze CCK+Secretin group (Hormone = 5)
cat("\n\n=== CCK+SECRETIN GROUP - BILIARY SECRETIONS ===\n")

# Create dose-response table
cck_sec_table_bil <- cck_sec_data %>%
  group_by(Dose) %>%
  summarise(
    N = n(),
    N_Increase = sum(Biliary_Increase),
    Proportion = round(mean(Biliary_Increase), 4)
  )

kable(cck_sec_table_bil,
      caption = "CCK+Secretin: Dose-Response for Biliary Secretion",
      col.names = c("Dose (μg/kg)", "N", "N with Increase", "Proportion")) %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                full_width = FALSE)

# Cochran-Armitage Trend Test
if(nrow(cck_sec_table_bil) > 1) {
  trend_test_cck_sec_bil <- CochranArmitageTest(
    table(cck_sec_data$Dose, cck_sec_data$Biliary_Increase)
  )
  cat(sprintf("\nCochran-Armitage Trend Test:\n"))
  cat(sprintf("Z-statistic: %.4f\n", trend_test_cck_sec_bil$statistic))
  cat(sprintf("P-value: %.6f\n", trend_test_cck_sec_bil$p.value))
  cat(sprintf("Conclusion: %s\n",
              ifelse(trend_test_cck_sec_bil$p.value < 0.05,
                     "Significant dose-response relationship exists",
                     "No significant dose-response relationship")))
} else {
  cat("Insufficient dose levels for trend test\n")
}
```

## Visualization of Dose-Response (Biliary)

```{r dose-response-plot-biliary}
# Create dose-response plots for biliary secretions
dose_response_summary_bil <- active_hormones %>%
  group_by(Hormone_Group, Dose) %>%
  summarise(
    N = n(),
    Proportion = mean(Biliary_Increase),
    .groups = 'drop'
  )

ggplot(dose_response_summary_bil, aes(x = Dose, y = Proportion, color = Hormone_Group)) +
  geom_point(aes(size = N), alpha = 0.7) +
  geom_line(alpha = 0.5) +
  geom_smooth(method = "lm", se = TRUE, alpha = 0.2, linewidth = 0.5) +
  facet_wrap(~ Hormone_Group, scales = "free_x") +
  labs(title = "Dose-Response Relationship: Biliary Secretion Increases",
       subtitle = "Proportion of hens with increased biliary secretions vs. hormone dose",
       x = "Dose (μg/kg body weight)",
       y = "Proportion with Increase",
       size = "Sample Size") +
  scale_y_continuous(labels = percent_format()) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

# Problems 10.42-10.46: Sample Size Calculations

## Background

These problems involve sample size calculations for a cholesterol-lowering drug study with:

- **Design:** Two-group comparison (treatment vs. control)
- **Significance level:** α = 0.05 (one-sided test)
- **Power:** 80% (β = 0.20)
- **Compliance issues:** 5% non-compliance in treatment group, 10% non-compliance in control group

## Problem Setup

```{r sample-size-setup}
# Parameters for sample size calculation
alpha <- 0.05  # One-sided
power <- 0.80  # 80% power
beta <- 1 - power

# Compliance rates (these would be provided in problems 10.42-10.43)
# For demonstration purposes, let's assume hypothetical values
# NOTE: Replace these with actual values from your textbook problems 10.42-10.43
p1_ideal <- 0.05  # Expected event rate in treatment group (hypothetical)
p2_ideal <- 0.10  # Expected event rate in control group (hypothetical)

# Non-compliance rates
noncompliance_treatment <- 0.05  # 5% in treatment group
noncompliance_control <- 0.10    # 10% in control group

cat("NOTE: Using hypothetical values for demonstration.\n")
cat("Replace p1_ideal and p2_ideal with actual values from Problems 10.42-10.43\n\n")
```

## Problem 10.44: Sample Size Without Considering Non-Compliance

```{r problem-10.44}
cat("=== Problem 10.44: Sample Size Calculation (No Non-Compliance) ===\n\n")

# Using two-proportion test (one-sided)
# We need the difference in proportions
effect_size <- ES.h(p1_ideal, p2_ideal)

cat(sprintf("Assumed Treatment Group Rate: %.3f\n", p1_ideal))
cat(sprintf("Assumed Control Group Rate: %.3f\n", p2_ideal))
cat(sprintf("Difference in proportions: %.3f\n", p2_ideal - p1_ideal))
cat(sprintf("Effect Size (Cohen's h): %.4f\n\n", effect_size))

# Check if effect size is valid
if(abs(effect_size) < 0.001) {
  cat("ERROR: Effect size is too small (proportions are nearly identical).\n")
  cat("Please check your values for p1_ideal and p2_ideal.\n")
  cat("These should come from Problems 10.42 and 10.43 in your textbook.\n\n")
} else {
  # Sample size calculation
  tryCatch({
    sample_size_result <- pwr.2p.test(
      h = effect_size,
      sig.level = alpha,
      power = power,
      alternative = "greater"
    )

    n_per_group <- ceiling(sample_size_result$n)
    n_total <- 2 * n_per_group

    cat("Sample Size Calculation:\n")
    cat(sprintf("  Sample size per group: %d\n", n_per_group))
    cat(sprintf("  Total sample size: %d\n\n", n_total))

    print(sample_size_result)
  }, error = function(e) {
    cat("ERROR in sample size calculation:\n")
    cat(conditionMessage(e), "\n\n")
    cat("Possible causes:\n")
    cat("1. Effect size is too small\n")
    cat("2. Power requirement cannot be achieved with these proportions\n")
    cat("3. Invalid proportion values (must be between 0 and 1)\n\n")
    cat("Please verify the values from Problems 10.42-10.43 in your textbook.\n")
  })
}
```

## Problem 10.45: Expected Rates with Non-Compliance

```{r problem-10.45}
cat("\n=== Problem 10.45: Expected Rates with Non-Compliance ===\n\n")

# Adjust for non-compliance
# Treatment group: 5% will not comply (won't take drug)
# Control group: 10% will start taking cholesterol drugs outside study

# Expected rate in treatment group with non-compliance
# Those who comply have rate p1, those who don't comply have rate p2 (same as control)
p1_actual <- (1 - noncompliance_treatment) * p1_ideal +
             noncompliance_treatment * p2_ideal

# Expected rate in control group with non-compliance
# Those who comply (don't take drugs) have rate p2, those who don't comply have rate p1
p2_actual <- (1 - noncompliance_control) * p2_ideal +
             noncompliance_control * p1_ideal

cat("Adjusted Rates Accounting for Non-Compliance:\n")
cat(sprintf("  Treatment group (ideal): %.4f\n", p1_ideal))
cat(sprintf("  Treatment group (actual with 5%% non-compliance): %.4f\n", p1_actual))
cat(sprintf("  Control group (ideal): %.4f\n", p2_ideal))
cat(sprintf("  Control group (actual with 10%% non-compliance): %.4f\n\n", p2_actual))

cat(sprintf("Reduction in effect size due to non-compliance:\n"))
cat(sprintf("  Ideal difference: %.4f\n", p2_ideal - p1_ideal))
cat(sprintf("  Actual difference: %.4f\n", p2_actual - p1_actual))
cat(sprintf("  Percentage reduction: %.2f%%\n",
            100 * (1 - (p2_actual - p1_actual)/(p2_ideal - p1_ideal))))
```

## Problem 10.46: Revised Sample Size with Non-Compliance

```{r problem-10.46}
cat("\n=== Problem 10.46: Revised Sample Size Accounting for Non-Compliance ===\n\n")

# Calculate effect size with actual (adjusted) rates
effect_size_actual <- ES.h(p1_actual, p2_actual)

cat(sprintf("Effect Size with Non-Compliance (Cohen's h): %.4f\n", effect_size_actual))
cat(sprintf("Effect Size without Non-Compliance (Cohen's h): %.4f\n", effect_size))
cat(sprintf("Difference in actual proportions: %.4f\n\n", p2_actual - p1_actual))

# Check if effect size is valid
if(abs(effect_size_actual) < 0.001) {
  cat("ERROR: Effect size with non-compliance is too small.\n")
  cat("Non-compliance has eliminated the detectable difference between groups.\n\n")
} else {
  # Sample size calculation with adjusted rates
  tryCatch({
    sample_size_result_adjusted <- pwr.2p.test(
      h = effect_size_actual,
      sig.level = alpha,
      power = power,
      alternative = "greater"
    )

    n_per_group_adjusted <- ceiling(sample_size_result_adjusted$n)
    n_total_adjusted <- 2 * n_per_group_adjusted

    cat("Revised Sample Size Calculation:\n")
    cat(sprintf("  Sample size per group: %d\n", n_per_group_adjusted))
    cat(sprintf("  Total sample size: %d\n\n", n_total_adjusted))

    # Only show comparison if original calculation succeeded
    if(exists("n_per_group") && !is.null(n_per_group)) {
      cat("Comparison:\n")
      cat(sprintf("  Original sample size per group (no non-compliance): %d\n", n_per_group))
      cat(sprintf("  Revised sample size per group (with non-compliance): %d\n", n_per_group_adjusted))
      cat(sprintf("  Increase in sample size: %d (%.1f%%)\n\n",
                  n_per_group_adjusted - n_per_group,
                  100 * (n_per_group_adjusted - n_per_group) / n_per_group))
    }

    print(sample_size_result_adjusted)
  }, error = function(e) {
    cat("ERROR in revised sample size calculation:\n")
    cat(conditionMessage(e), "\n\n")
    cat("The adjusted effect size may be too small due to non-compliance.\n")
    cat("This suggests that the study may not be feasible with these compliance rates.\n")
  })
}
```

## Visualization: Impact of Non-Compliance on Sample Size

```{r sample-size-visualization}
# Create visualization showing impact of non-compliance
# Only create if the base sample size calculation was successful

if(abs(effect_size) > 0.001) {
  tryCatch({
    compliance_rates_treat <- seq(0.70, 1.00, by = 0.05)
    compliance_rates_control <- seq(0.70, 1.00, by = 0.05)

    sample_size_grid <- expand.grid(
      compliance_treat = compliance_rates_treat,
      compliance_control = compliance_rates_control
    )

    sample_size_grid$p1_adj <- (sample_size_grid$compliance_treat) * p1_ideal +
                                (1 - sample_size_grid$compliance_treat) * p2_ideal

    sample_size_grid$p2_adj <- (sample_size_grid$compliance_control) * p2_ideal +
                                (1 - sample_size_grid$compliance_control) * p1_ideal

    sample_size_grid$effect_size <- ES.h(sample_size_grid$p1_adj, sample_size_grid$p2_adj)

    sample_size_grid$n_per_group <- sapply(sample_size_grid$effect_size, function(h) {
      if(h > 0.001) {
        tryCatch({
          result <- pwr.2p.test(h = h, sig.level = alpha, power = power, alternative = "greater")
          return(ceiling(result$n))
        }, error = function(e) {
          return(NA)
        })
      } else {
        return(NA)
      }
    })

    # Check if we have any valid values
    valid_values <- sum(!is.na(sample_size_grid$n_per_group))

    if(valid_values > 0) {
      # Create heatmap only if we have valid data
      p <- ggplot(sample_size_grid, aes(x = compliance_treat, y = compliance_control, fill = n_per_group)) +
        geom_tile() +
        geom_text(aes(label = ifelse(is.na(n_per_group), "-", n_per_group)),
                  size = 3, color = "white") +
        scale_fill_gradient(low = "green", high = "red", na.value = "grey50",
                           limits = c(min(sample_size_grid$n_per_group, na.rm = TRUE),
                                     max(sample_size_grid$n_per_group, na.rm = TRUE))) +
        scale_x_continuous(labels = percent_format()) +
        scale_y_continuous(labels = percent_format()) +
        labs(title = "Required Sample Size per Group",
             subtitle = "Impact of compliance rates on sample size requirements",
             x = "Treatment Group Compliance Rate",
             y = "Control Group Compliance Rate",
             fill = "N per Group") +
        theme_minimal() +
        theme(plot.title = element_text(face = "bold"))

      print(p)

      cat(sprintf("\nVisualization created with %d valid sample size calculations.\n", valid_values))
      cat(sprintf("Sample sizes range from %d to %d per group.\n",
                  min(sample_size_grid$n_per_group, na.rm = TRUE),
                  max(sample_size_grid$n_per_group, na.rm = TRUE)))
    } else {
      cat("Cannot create visualization: All sample size calculations resulted in NA.\n")
      cat("This occurs when effect sizes are too small across all compliance scenarios.\n")
      cat("Please verify your proportion values (p1_ideal and p2_ideal) from Problems 10.42-10.43.\n\n")

      # Show what's happening
      cat("Summary of effect sizes:\n")
      cat(sprintf("  Minimum effect size: %.4f\n", min(sample_size_grid$effect_size, na.rm = TRUE)))
      cat(sprintf("  Maximum effect size: %.4f\n", max(sample_size_grid$effect_size, na.rm = TRUE)))
      cat(sprintf("  Mean effect size: %.4f\n", mean(sample_size_grid$effect_size, na.rm = TRUE)))
      cat("\nFor meaningful sample size calculations, effect sizes should typically be > 0.2\n")
    }

  }, error = function(e) {
    cat("Could not create visualization:\n")
    cat(conditionMessage(e), "\n\n")
    cat("This usually means the effect size is too small for reliable calculations.\n")
    cat("Please check the proportion values from Problems 10.42-10.43.\n")
  })
} else {
  cat("Visualization skipped due to invalid effect size.\n")
  cat("Please provide valid proportion values from Problems 10.42-10.43.\n\n")

  cat("Current values:\n")
  cat(sprintf("  Treatment group rate (p1_ideal): %.3f\n", p1_ideal))
  cat(sprintf("  Control group rate (p2_ideal): %.3f\n", p2_ideal))
  cat(sprintf("  Difference: %.3f\n", p2_ideal - p1_ideal))
  cat(sprintf("  Effect size: %.4f\n", effect_size))
  cat("\nFor sample size calculations to work, you need:\n")
  cat("  1. p2_ideal > p1_ideal (control has higher event rate)\n")
  cat("  2. Difference of at least 0.03-0.05 (3-5 percentage points)\n")
  cat("  3. Both values between 0 and 1\n")
}
```

# Summary of Results

```{r summary-table}
# Create summary table of all test results
summary_results <- data.frame(
  Problem = c(
    "10.38 - Pancreatic Secretions (Chi-square)",
    "10.38 - Pancreatic Secretions (Fisher)",
    "10.39 - Biliary Secretions (Chi-square)",
    "10.39 - Biliary Secretions (Fisher)"
  ),
  Test_Statistic = c(
    sprintf("χ² = %.4f", chi_sq_pancreatic$statistic),
    "Simulated",
    sprintf("χ² = %.4f", chi_sq_biliary$statistic),
    "Simulated"
  ),
  P_Value = c(
    sprintf("%.6f", chi_sq_pancreatic$p.value),
    sprintf("%.6f", fisher_pancreatic$p.value),
    sprintf("%.6f", chi_sq_biliary$p.value),
    sprintf("%.6f", fisher_biliary$p.value)
  ),
  Conclusion = c(
    ifelse(chi_sq_pancreatic$p.value < 0.05, "Reject H₀", "Fail to reject H₀"),
    ifelse(fisher_pancreatic$p.value < 0.05, "Reject H₀", "Fail to reject H₀"),
    ifelse(chi_sq_biliary$p.value < 0.05, "Reject H₀", "Fail to reject H₀"),
    ifelse(fisher_biliary$p.value < 0.05, "Reject H₀", "Fail to reject H₀")
  )
)

kable(summary_results,
      caption = "Summary of Hypothesis Test Results",
      col.names = c("Problem", "Test Statistic", "P-value", "Conclusion (α=0.05)")) %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                full_width = FALSE)
```

# Conclusions

## Key Findings

1. **Overall Group Comparison (Problems 10.37-10.39)**
   - Chi-square tests were used to compare proportions across five hormone groups
   - Both pancreatic and biliary secretions show variations across treatment groups
   - Fisher's exact tests were provided as alternatives for robustness

2. **Dose-Response Relationships (Problems 10.40-10.41)**
   - Cochran-Armitage trend tests assessed linear dose-response relationships
   - Each active hormone group was analyzed separately
   - Results indicate varying degrees of dose-response relationships depending on the hormone and secretion type

3. **Sample Size Considerations (Problems 10.42-10.46)**
   - Non-compliance significantly impacts required sample sizes
   - Even modest levels of non-compliance (5-10%) can require substantial increases in sample size
   - Careful consideration of expected compliance rates is essential in study planning

## Statistical Methods Used

- **Chi-square test for independence:** Comparing proportions across multiple groups
- **Fisher's exact test:** Alternative for small expected frequencies
- **Cochran-Armitage trend test:** Assessing dose-response relationships
- **Power analysis:** Sample size calculations for two-proportion tests
- **Effect size (Cohen's h):** Standardized measure of difference between proportions

# Session Information

```{r session-info}
sessionInfo()
```

---
**End of Analysis**
