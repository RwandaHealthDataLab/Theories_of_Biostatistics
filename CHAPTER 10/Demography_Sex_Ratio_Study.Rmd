---
title: "Demography: Sex Ratio and Independence of Offspring Gender"
author: "Analysis of 51,868 Families with 5 Children"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
    theme: cerulean
    highlight: tango
    code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 10,
  fig.height = 6,
  fig.align = 'center'
)
```

# Introduction

## Study Background

A common assumption in demography is that the **gender of successive offspring is independent**. This study tests this assumption using birth records from **51,868 families** with exactly 5 children.

### Research Questions

1. Does the observed distribution of male offspring match the expected binomial distribution (under independence)?
2. Are successive births independent of each other?
3. Is there evidence of correlation between offspring genders?

### Theoretical Framework

**Under Independence Assumption:**
- Each birth has probability p = 0.5 of being male
- Number of males follows a Binomial(n=5, p=0.5) distribution
- Gender of one child does not affect the probability for subsequent children

**Testing Strategy:**
- Compare observed frequencies to expected binomial frequencies
- Use chi-square goodness-of-fit test
- Examine patterns in successive births
- Test for runs and sequences

# Data Loading and Preparation

```{r load-packages}
# Load required libraries
library(tidyverse)
library(knitr)
library(kableExtra)
library(ggplot2)
library(scales)

# Set theme for plots
theme_set(theme_minimal())
```

```{r load-data}
# Load the SEXRAT.DAT dataset
data_path <- "Rosner_FundamentalsBiostatistics_8e_Data_Sets/ASCII-comma/SEXRAT.DAT.txt"

# Read the data - handle quotes in column names
sexrat_data <- read.csv(data_path, header = TRUE, strip.white = TRUE, quote = "'\"")

# Clean column names (remove any quotes)
colnames(sexrat_data) <- gsub("'", "", colnames(sexrat_data))
colnames(sexrat_data) <- gsub("\"", "", colnames(sexrat_data))

# Display structure
str(sexrat_data)

# Display column names for verification
cat("\nColumn names in dataset:\n")
print(colnames(sexrat_data))

# Note: The dataset has a typo in column name 'sx-4' (should be 'sx_4')
# Let's fix it - check for both hyphen and dash variations
if("sx-4" %in% colnames(sexrat_data)) {
  colnames(sexrat_data)[colnames(sexrat_data) == "sx-4"] <- "sx_4"
  cat("\nFixed column name: 'sx-4' renamed to 'sx_4'\n")
}

# Also check for any column that contains '4' for the 4th child
sx4_col <- grep("sx.*4", colnames(sexrat_data), value = TRUE)
if(length(sx4_col) > 0 && sx4_col != "sx_4") {
  colnames(sexrat_data)[colnames(sexrat_data) == sx4_col] <- "sx_4"
  cat(sprintf("\nFixed column name: '%s' renamed to 'sx_4'\n", sx4_col))
}

cat("\nColumn names after fix:\n")
print(colnames(sexrat_data))
```

# Variable Definitions

```{r variable-definitions}
# Create variable definitions table
var_definitions <- data.frame(
  Variable = c("nm_chld", "sx_1", "sx_2", "sx_3", "sx_4", "sx_5", "sexchldn", "num_fam"),
  Description = c(
    "Number of children in family (2, 3, 4, or 5)",
    "Sex of 1st child (M = Male, F = Female)",
    "Sex of 2nd child (M = Male, F = Female)",
    "Sex of 3rd child (M = Male, F = Female)",
    "Sex of 4th child (M = Male, F = Female)",
    "Sex of 5th child (M = Male, F = Female)",
    "Combined sex sequence (e.g., MMFMF)",
    "Number of families with this pattern"
  )
)

kable(var_definitions,
      caption = "Variable Definitions for SEXRAT Dataset") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                full_width = FALSE)
```

# Data Processing

## Extract Families with 5 Children

```{r extract-five-children}
# Filter to families with exactly 5 children
five_child_data <- sexrat_data %>%
  filter(nm_chld == 5)

# Verify we have all necessary columns
required_cols <- c("sx_1", "sx_2", "sx_3", "sx_4", "sx_5", "sexchldn", "num_fam")
missing_cols <- setdiff(required_cols, colnames(five_child_data))
if(length(missing_cols) > 0) {
  cat("WARNING: Missing columns:", paste(missing_cols, collapse = ", "), "\n")
  cat("Available columns:", paste(colnames(five_child_data), collapse = ", "), "\n")
}

cat("Families with exactly 5 children:", nrow(five_child_data), "\n")
cat("Total families represented:", sum(five_child_data$num_fam), "\n\n")

# Calculate number of males for each family pattern
five_child_data <- five_child_data %>%
  mutate(
    # Count males in the sex sequence
    num_males = str_count(sexchldn, "M"),
    num_females = str_count(sexchldn, "F")
  )

# Verify
cat("Number of male children ranges from", min(five_child_data$num_males),
    "to", max(five_child_data$num_males), "\n")
```

## Table 10.37: Frequency Distribution of Male Offspring

```{r table-10.37}
# Create frequency distribution by number of males
freq_dist <- five_child_data %>%
  group_by(num_males) %>%
  summarise(
    Observed_Families = sum(num_fam),
    .groups = 'drop'
  ) %>%
  arrange(num_males)

# Add total
total_families <- sum(freq_dist$Observed_Families)

# Add column names and format
freq_dist_table <- freq_dist %>%
  mutate(
    Observed_Proportion = round(Observed_Families / total_families, 4),
    Observed_Percentage = round(100 * Observed_Families / total_families, 2)
  )

kable(freq_dist_table,
      caption = "Table 10.37: Frequency Distribution of Number of Male Offspring (n=5 children)",
      col.names = c("Number of Males", "Observed Families", "Proportion", "Percentage (%)")) %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                full_width = FALSE)

cat(sprintf("\nTotal families: %d\n", total_families))
```

# Goodness-of-Fit Test: Binomial Distribution

## Expected Frequencies Under Independence

```{r expected-frequencies}
# Under independence: Binomial(n=5, p=0.5)
n <- 5  # number of children
p <- 0.5  # probability of male
N <- total_families  # total number of families

# Calculate expected frequencies
expected_freq <- data.frame(
  num_males = 0:5,
  Expected_Families = N * dbinom(0:5, size = n, prob = p)
)

# Combine observed and expected
comparison_table <- freq_dist_table %>%
  left_join(expected_freq, by = "num_males") %>%
  mutate(
    Expected_Proportion = round(Expected_Families / total_families, 4),
    Expected_Percentage = round(100 * Expected_Families / total_families, 2),
    Difference = Observed_Families - Expected_Families,
    Chi_Square_Component = (Observed_Families - Expected_Families)^2 / Expected_Families
  )

kable(comparison_table %>%
        select(num_males, Observed_Families, Expected_Families,
               Observed_Percentage, Expected_Percentage, Difference),
      caption = "Observed vs. Expected Frequencies (Binomial Model)",
      col.names = c("Number of Males", "Observed", "Expected",
                   "Observed %", "Expected %", "Difference"),
      digits = c(0, 0, 2, 2, 2, 2)) %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                full_width = FALSE)
```

## Chi-square Goodness-of-Fit Test

```{r chi-square-test}
cat("=== CHI-SQUARE GOODNESS-OF-FIT TEST ===\n\n")

# Perform chi-square test
chi_sq_stat <- sum(comparison_table$Chi_Square_Component)
df <- nrow(comparison_table) - 1  # degrees of freedom (6 categories - 1)
p_value <- pchisq(chi_sq_stat, df, lower.tail = FALSE)

cat(sprintf("Null Hypothesis: Number of males follows Binomial(5, 0.5) distribution\n"))
cat(sprintf("  (i.e., genders are independent and p(male) = 0.5)\n\n"))

cat(sprintf("Chi-square statistic: %.4f\n", chi_sq_stat))
cat(sprintf("Degrees of freedom: %d\n", df))
cat(sprintf("P-value: %.6f\n", p_value))

cat(sprintf("\nConclusion at α = 0.05: %s\n",
            ifelse(p_value < 0.05,
                   "REJECT H₀ - Observed distribution differs significantly from binomial",
                   "FAIL TO REJECT H₀ - Data consistent with binomial distribution")))

cat(sprintf("\nConclusion at α = 0.01: %s\n",
            ifelse(p_value < 0.01,
                   "REJECT H₀ - Observed distribution differs significantly from binomial",
                   "FAIL TO REJECT H₀ - Data consistent with binomial distribution")))

# Show components of chi-square statistic
cat("\n--- Chi-square Components ---\n")
comp_table <- comparison_table %>%
  select(num_males, Observed_Families, Expected_Families, Chi_Square_Component)

kable(comp_table,
      caption = "Components of Chi-square Statistic",
      col.names = c("Males", "Observed", "Expected", "χ² Component"),
      digits = c(0, 0, 2, 4)) %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                full_width = FALSE)
```

## Visualization

```{r visualization-comparison}
# Create comparison plot
plot_data <- comparison_table %>%
  select(num_males, Observed_Families, Expected_Families) %>%
  pivot_longer(cols = c(Observed_Families, Expected_Families),
               names_to = "Type", values_to = "Families") %>%
  mutate(Type = ifelse(Type == "Observed_Families", "Observed", "Expected"))

ggplot(plot_data, aes(x = factor(num_males), y = Families, fill = Type)) +
  geom_bar(stat = "identity", position = "dodge", alpha = 0.8) +
  geom_text(aes(label = round(Families, 0)),
            position = position_dodge(width = 0.9),
            vjust = -0.5, size = 3.5) +
  scale_fill_manual(values = c("Observed" = "#3498db", "Expected" = "#e74c3c")) +
  labs(title = "Observed vs. Expected Distribution of Male Offspring",
       subtitle = paste0("51,868 families with 5 children (p-value = ",
                        sprintf("%.4f", p_value), ")"),
       x = "Number of Male Children",
       y = "Number of Families",
       fill = "Distribution") +
  theme_minimal() +
  theme(legend.position = "top",
        plot.title = element_text(face = "bold", size = 14))

# Proportions plot
ggplot(plot_data, aes(x = factor(num_males), y = Families / total_families, fill = Type)) +
  geom_bar(stat = "identity", position = "dodge", alpha = 0.8) +
  scale_y_continuous(labels = percent_format()) +
  scale_fill_manual(values = c("Observed" = "#3498db", "Expected" = "#e74c3c")) +
  labs(title = "Proportion Distribution: Observed vs. Binomial(5, 0.5)",
       x = "Number of Male Children",
       y = "Proportion of Families",
       fill = "Distribution") +
  theme_minimal() +
  theme(legend.position = "top")
```

# Analysis of Birth Order Patterns

## First vs. Second Birth

```{r first-second-birth}
cat("=== ANALYSIS OF SUCCESSIVE BIRTHS ===\n\n")

# Create contingency table for 1st and 2nd child
first_second <- five_child_data %>%
  group_by(sx_1, sx_2) %>%
  summarise(Families = sum(num_fam), .groups = 'drop')

# Pivot to create 2x2 table
first_second_table <- first_second %>%
  pivot_wider(names_from = sx_2, values_from = Families, values_fill = 0) %>%
  column_to_rownames("sx_1")

kable(addmargins(as.matrix(first_second_table)),
      caption = "First Child vs. Second Child Gender") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                full_width = FALSE)

# Chi-square test for independence
chi_1_2 <- chisq.test(as.matrix(first_second_table))

cat(sprintf("\nChi-square test for independence:\n"))
cat(sprintf("  χ² = %.4f\n", chi_1_2$statistic))
cat(sprintf("  df = %d\n", chi_1_2$parameter))
cat(sprintf("  P-value = %.4f\n", chi_1_2$p.value))
cat(sprintf("\nConclusion: %s\n",
            ifelse(chi_1_2$p.value < 0.05,
                   "1st and 2nd child genders are NOT independent",
                   "1st and 2nd child genders are independent")))
```

## All Successive Birth Pairs

```{r all-successive-pairs}
cat("\n=== CHI-SQUARE TESTS FOR ALL SUCCESSIVE PAIRS ===\n\n")

# Function to test successive pairs
test_successive_pair <- function(data, child1, child2) {
  # Check if columns exist
  if(!(child1 %in% colnames(data)) || !(child2 %in% colnames(data))) {
    cat(sprintf("ERROR: Columns '%s' or '%s' not found\n", child1, child2))
    cat("Available columns:", paste(colnames(data), collapse = ", "), "\n")
    return(NULL)
  }

  # Create contingency table
  pair_data <- data %>%
    group_by(!!sym(child1), !!sym(child2)) %>%
    summarise(Families = sum(num_fam), .groups = 'drop') %>%
    pivot_wider(names_from = !!sym(child2), values_from = Families, values_fill = 0)

  # Convert to matrix
  pair_matrix <- pair_data %>%
    column_to_rownames(child1) %>%
    as.matrix()

  # Chi-square test
  chi_result <- chisq.test(pair_matrix)

  return(list(
    table = pair_matrix,
    chi_sq = chi_result$statistic,
    df = chi_result$parameter,
    p_value = chi_result$p.value
  ))
}

# Test all pairs
pairs <- list(
  c("sx_1", "sx_2"),
  c("sx_2", "sx_3"),
  c("sx_3", "sx_4"),
  c("sx_4", "sx_5")
)

pair_results <- data.frame(
  Pair = c("1st → 2nd", "2nd → 3rd", "3rd → 4th", "4th → 5th"),
  Chi_Square = numeric(4),
  P_Value = numeric(4)
)

for(i in 1:4) {
  result <- test_successive_pair(five_child_data, pairs[[i]][1], pairs[[i]][2])
  if(!is.null(result)) {
    pair_results$Chi_Square[i] <- result$chi_sq
    pair_results$P_Value[i] <- result$p_value
  } else {
    pair_results$Chi_Square[i] <- NA
    pair_results$P_Value[i] <- NA
  }
}

pair_results <- pair_results %>%
  mutate(
    Significant = ifelse(is.na(P_Value), "Error",
                        ifelse(P_Value < 0.05, "Yes*", "No"))
  )

kable(pair_results,
      caption = "Independence Tests for Successive Birth Pairs",
      col.names = c("Birth Pair", "χ² Statistic", "P-value", "Significant (α=0.05)"),
      digits = c(0, 4, 6, 0)) %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                full_width = FALSE)

cat("\nConclusion: ", ifelse(any(pair_results$P_Value < 0.05),
                             "At least one pair shows dependence",
                             "All pairs are independent"), "\n")
```

# Analysis of Specific Patterns

## Runs of Same Gender

```{r runs-analysis}
cat("\n=== ANALYSIS OF RUNS (Consecutive Same Gender) ===\n\n")

# Count runs of all males or all females
five_child_data <- five_child_data %>%
  mutate(
    All_Male = num_males == 5,
    All_Female = num_males == 0,
    Four_Male = num_males == 4,
    Four_Female = num_males == 1,
    Has_Run = All_Male | All_Female
  )

runs_summary <- five_child_data %>%
  summarise(
    All_Male_Families = sum(num_fam[All_Male]),
    All_Female_Families = sum(num_fam[All_Female]),
    Total_Extreme = sum(num_fam[Has_Run]),
    Pct_Extreme = round(100 * sum(num_fam[Has_Run]) / sum(num_fam), 2)
  )

kable(runs_summary,
      caption = "Families with Extreme Gender Patterns",
      col.names = c("All Male (MMMMM)", "All Female (FFFFF)",
                   "Total Extreme", "Percentage")) %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                full_width = FALSE)

# Expected under independence
expected_all_same <- total_families * (2 * (0.5)^5)
observed_all_same <- runs_summary$Total_Extreme

cat(sprintf("\nObserved families with all same gender: %d\n", observed_all_same))
cat(sprintf("Expected under independence: %.2f\n", expected_all_same))
cat(sprintf("Difference: %d\n", observed_all_same - expected_all_same))
```

## Most Common Patterns

```{r common-patterns}
# Show most common patterns
top_patterns <- five_child_data %>%
  arrange(desc(num_fam)) %>%
  head(10) %>%
  select(sexchldn, num_males, num_fam) %>%
  mutate(
    Percentage = round(100 * num_fam / total_families, 2)
  )

kable(top_patterns,
      caption = "Top 10 Most Common Gender Patterns",
      col.names = c("Pattern", "Number of Males", "Families", "Percentage (%)")) %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                full_width = FALSE)
```

# Test for Overall Probability of Male Birth

## Proportion Test

```{r proportion-test}
cat("=== TEST: Is p(Male) = 0.5? ===\n\n")

# Calculate total births and males across all families
total_births <- sum(five_child_data$num_fam) * 5
total_males <- sum(five_child_data$num_males * five_child_data$num_fam)
observed_prop <- total_males / total_births

cat(sprintf("Total births: %d\n", total_births))
cat(sprintf("Total males: %d\n", total_males))
cat(sprintf("Observed proportion male: %.6f\n", observed_prop))

# One-sample proportion test
prop_test <- prop.test(total_males, total_births, p = 0.5)

cat(sprintf("\nOne-sample proportion test:\n"))
cat(sprintf("  Null hypothesis: p = 0.5\n"))
cat(sprintf("  χ² = %.4f\n", prop_test$statistic))
cat(sprintf("  P-value: %.6f\n", prop_test$p.value))
cat(sprintf("  95%% CI for p: (%.6f, %.6f)\n",
            prop_test$conf.int[1], prop_test$conf.int[2]))

cat(sprintf("\nConclusion: %s\n",
            ifelse(prop_test$p.value < 0.05,
                   "Reject H₀ - Proportion differs significantly from 0.5",
                   "Fail to reject H₀ - Proportion consistent with 0.5")))

# Calculate how much it differs from 0.5
diff_from_half <- observed_prop - 0.5
pct_diff <- 100 * diff_from_half

cat(sprintf("\nDifference from 0.5: %.6f (%.4f%%)\n", diff_from_half, pct_diff))
```

# Summary and Conclusions

## Summary of All Tests

```{r summary-all-tests}
# Create comprehensive summary
summary_tests <- data.frame(
  Test = c(
    "Goodness-of-fit to Binomial(5, 0.5)",
    "Overall proportion = 0.5",
    "1st → 2nd child independence",
    "2nd → 3rd child independence",
    "3rd → 4th child independence",
    "4th → 5th child independence"
  ),
  Test_Statistic = c(
    sprintf("χ² = %.4f", chi_sq_stat),
    sprintf("χ² = %.4f", prop_test$statistic),
    sprintf("χ² = %.4f", pair_results$Chi_Square[1]),
    sprintf("χ² = %.4f", pair_results$Chi_Square[2]),
    sprintf("χ² = %.4f", pair_results$Chi_Square[3]),
    sprintf("χ² = %.4f", pair_results$Chi_Square[4])
  ),
  P_Value = c(
    sprintf("%.6f", p_value),
    sprintf("%.6f", prop_test$p.value),
    sprintf("%.6f", pair_results$P_Value[1]),
    sprintf("%.6f", pair_results$P_Value[2]),
    sprintf("%.6f", pair_results$P_Value[3]),
    sprintf("%.6f", pair_results$P_Value[4])
  ),
  Result = c(
    ifelse(p_value < 0.05, "Significant", "Not significant"),
    ifelse(prop_test$p.value < 0.05, "Significant", "Not significant"),
    ifelse(pair_results$P_Value[1] < 0.05, "Dependent", "Independent"),
    ifelse(pair_results$P_Value[2] < 0.05, "Dependent", "Independent"),
    ifelse(pair_results$P_Value[3] < 0.05, "Dependent", "Independent"),
    ifelse(pair_results$P_Value[4] < 0.05, "Dependent", "Independent")
  )
)

kable(summary_tests,
      caption = "Summary of All Statistical Tests (α = 0.05)") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                full_width = FALSE) %>%
  row_spec(which(summary_tests$Result %in% c("Significant", "Dependent")),
           bold = TRUE, background = "#ffffcc")
```

## Key Findings

### 1. Distribution of Male Offspring

**Question:** Does the number of males follow a Binomial(5, 0.5) distribution?

**Finding:**
- Chi-square statistic: `r sprintf("%.4f", chi_sq_stat)` (df = `r df`)
- P-value: `r sprintf("%.6f", p_value)`
- **Conclusion:** `r ifelse(p_value < 0.05, "The observed distribution DIFFERS significantly from the expected binomial distribution", "The observed distribution is CONSISTENT with the binomial distribution")`

### 2. Overall Probability of Male Birth

**Question:** Is the probability of male birth equal to 0.5?

**Finding:**
- Observed proportion: `r sprintf("%.6f", observed_prop)`
- Expected: 0.500000
- P-value: `r sprintf("%.6f", prop_test$p.value)`
- **Conclusion:** `r ifelse(prop_test$p.value < 0.05, "The proportion of males DIFFERS significantly from 0.5", "The proportion of males is CONSISTENT with 0.5")`

### 3. Independence of Successive Births

**Question:** Are successive births independent?

**Finding:**
- All four successive pairs tested (1st→2nd, 2nd→3rd, 3rd→4th, 4th→5th)
- Number showing dependence: `r sum(pair_results$P_Value < 0.05)`
- **Conclusion:** `r ifelse(any(pair_results$P_Value < 0.05), "Evidence of DEPENDENCE in at least one pair", "All pairs show INDEPENDENCE")`

## Overall Interpretation

Based on the analysis of 51,868 families with 5 children:

1. **Goodness-of-Fit:** The distribution of male offspring `r ifelse(p_value < 0.05, "does not follow", "follows")` the expected binomial pattern

2. **Sex Ratio:** The overall sex ratio `r ifelse(abs(observed_prop - 0.5) < 0.01, "is very close to", ifelse(observed_prop > 0.5, "slightly favors males", "slightly favors females"))`  1:1

3. **Independence:** Successive births appear to be `r ifelse(any(pair_results$P_Value < 0.05), "dependent", "independent")`

4. **Sample Size:** With such a large sample (N = 51,868 families = 259,340 births), even small departures from theoretical expectations can be statistically significant

## Practical vs. Statistical Significance

With a sample size this large, we have very high power to detect even tiny departures from the null hypothesis. Therefore, we should consider both:

- **Statistical significance** (p-values)
- **Practical significance** (magnitude of differences)

**Example:** If observed p(Male) = 0.512 vs. expected 0.500:
- Difference is only 1.2 percentage points
- May be statistically significant due to large N
- But practically, this is very close to 50/50

# Session Information

```{r session-info}
sessionInfo()
```

---
**End of Analysis**
