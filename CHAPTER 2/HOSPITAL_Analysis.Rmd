---
title: "Infectious Disease: Antibiotic Usage in Hospitalized Patients"
author: "Analysis of Hospital Data"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
    code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.width = 10, fig.height = 6)
```

# Background

This analysis examines data from a retrospective chart review of antibiotic usage in a Pennsylvania hospital. The study focuses on understanding hospitalization duration and its relationship with antibiotic treatment.

## Study Details

- **Data Source**: Retrospective chart review from a Pennsylvania hospital
- **Sample Size**: 25 patients discharged from the hospital
- **Primary Outcome**: Duration of hospitalization (days)
- **Key Variable**: Antibiotic usage (Yes/No)

## Variables in Dataset

1. **Id**: Patient identification number
2. **Dur_stay**: Duration of hospitalization (days)
3. **Age**: Patient age (years)
4. **Sex**: Patient sex (1 = Male, 2 = Female)
5. **Temp**: Body temperature (°F)
6. **WBC**: White blood cell count (thousands/mm³)
7. **Antibio**: Antibiotic received (1 = Yes, 2 = No)
8. **Bact_cul**: Bacterial culture result (1 = Positive, 2 = Negative)
9. **Service**: Hospital service (1 = Medical, 2 = Surgical)

# Load Required Libraries

```{r libraries}
library(tidyverse)
library(ggplot2)
library(gridExtra)
library(knitr)
library(scales)
```

# Data Import

```{r import-data}
# Define file path
csv_path <- "Rosner_FundamentalsBiostatistics_8e_Data_Sets/ASCII-comma/HOSPITAL.DAT.txt"

# Read the HOSPITAL dataset
hospital_data <- read.csv(csv_path, check.names = FALSE)

# Remove quotes from column names if present
colnames(hospital_data) <- gsub("'", "", colnames(hospital_data))

# Display dataset information
cat("Dataset dimensions:", nrow(hospital_data), "patients,", ncol(hospital_data), "variables\n\n")

# Create labeled variables for better analysis
hospital_data <- hospital_data %>%
  mutate(
    Sex_label = factor(Sex, levels = c(1, 2), labels = c("Male", "Female")),
    Antibio_label = factor(Antibio, levels = c(1, 2), labels = c("Yes", "No")),
    Bact_cul_label = factor(Bact_cul, levels = c(1, 2), labels = c("Positive", "Negative")),
    Service_label = factor(Service, levels = c(1, 2), labels = c("Medical", "Surgical"))
  )

# Display the complete dataset
cat("Complete Dataset:\n\n")
kable(hospital_data %>% select(Id, Dur_stay, Age, Sex_label, Temp, WBC, Antibio_label, Bact_cul_label, Service_label),
      col.names = c("ID", "Duration (days)", "Age", "Sex", "Temp (°F)", "WBC", "Antibiotic", "Culture", "Service"),
      caption = "Hospital Patient Data (n=25)")
```

---

# Problem 2.1: Mean and Median for Duration of Hospitalization

**Question**: Compute the mean and median for the duration of hospitalization for the 25 patients.

```{r problem-2-1}
# Calculate mean and median
mean_duration <- mean(hospital_data$Dur_stay, na.rm = TRUE)
median_duration <- median(hospital_data$Dur_stay, na.rm = TRUE)

# Display results
cat("PROBLEM 2.1 RESULTS\n")
cat("===================\n\n")
cat("Duration of Hospitalization (n=25 patients):\n")
cat(sprintf("  Mean:   %.2f days\n", mean_duration))
cat(sprintf("  Median: %.1f days\n", median_duration))
cat("\n")

# Create a summary table
summary_2_1 <- data.frame(
  Measure = c("Mean", "Median"),
  Value = c(mean_duration, median_duration),
  Unit = c("days", "days")
)

kable(summary_2_1, digits = 2,
      caption = "Problem 2.1: Central Tendency Measures for Hospitalization Duration")

# Visualize the distribution with mean and median
ggplot(hospital_data, aes(x = Dur_stay)) +
  geom_histogram(binwidth = 2, fill = "steelblue", color = "black", alpha = 0.7) +
  geom_vline(aes(xintercept = mean_duration, color = "Mean"),
             linetype = "dashed", size = 1.2) +
  geom_vline(aes(xintercept = median_duration, color = "Median"),
             linetype = "solid", size = 1.2) +
  scale_color_manual(name = "Statistics",
                     values = c("Mean" = "red", "Median" = "darkgreen")) +
  labs(
    title = "Distribution of Hospitalization Duration",
    subtitle = sprintf("Mean = %.2f days, Median = %.1f days", mean_duration, median_duration),
    x = "Duration of Stay (days)",
    y = "Frequency (Number of Patients)"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    legend.position = "right"
  )
```

**Interpretation**: The mean duration of `r round(mean_duration, 2)` days is slightly higher than the median of `r median_duration` days, suggesting a slight right skew in the distribution (a few patients with longer hospital stays).

---

# Problem 2.2: Standard Deviation and Range

**Question**: Compute the standard deviation and range for the duration of hospitalization for the 25 patients.

```{r problem-2-2}
# Calculate standard deviation and range
sd_duration <- sd(hospital_data$Dur_stay, na.rm = TRUE)
range_duration <- range(hospital_data$Dur_stay, na.rm = TRUE)
range_value <- diff(range_duration)

# Display results
cat("PROBLEM 2.2 RESULTS\n")
cat("===================\n\n")
cat("Duration of Hospitalization - Variability Measures:\n")
cat(sprintf("  Standard Deviation: %.2f days\n", sd_duration))
cat(sprintf("  Range: %d to %d days (Range = %d days)\n",
            range_duration[1], range_duration[2], range_value))
cat(sprintf("  Variance: %.2f days²\n", sd_duration^2))
cat("\n")

# Create a summary table
summary_2_2 <- data.frame(
  Measure = c("Standard Deviation", "Minimum", "Maximum", "Range", "Variance"),
  Value = c(sd_duration, range_duration[1], range_duration[2], range_value, sd_duration^2),
  Unit = c("days", "days", "days", "days", "days²")
)

kable(summary_2_2, digits = 2,
      caption = "Problem 2.2: Variability Measures for Hospitalization Duration")

# Box plot to visualize variability
ggplot(hospital_data, aes(y = Dur_stay, x = "All Patients")) +
  geom_boxplot(fill = "lightblue", alpha = 0.7, outlier.color = "red", outlier.size = 3) +
  geom_jitter(width = 0.1, alpha = 0.5, size = 2) +
  stat_summary(fun = mean, geom = "point", shape = 23, size = 4,
               fill = "red", color = "black") +
  labs(
    title = "Box Plot: Hospitalization Duration",
    subtitle = sprintf("SD = %.2f days, Range = %d-%d days",
                      sd_duration, range_duration[1], range_duration[2]),
    y = "Duration of Stay (days)",
    x = "",
    caption = "Red diamond = Mean, Red circles = Outliers"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    axis.text.x = element_text(size = 12)
  )
```

**Interpretation**: The standard deviation of `r round(sd_duration, 2)` days indicates considerable variability in hospitalization duration. The range spans from `r range_duration[1]` to `r range_duration[2]` days, a spread of `r range_value` days.

---

# Problem 2.3: Effect of Antibiotic Treatment on Hospitalization Duration

**Question**: Is the duration of hospitalization affected by whether a patient has received antibiotics? Answer descriptively using numeric or graphic methods.

```{r problem-2-3}
cat("PROBLEM 2.3 RESULTS\n")
cat("===================\n\n")

# Calculate summary statistics by antibiotic group
summary_by_antibio <- hospital_data %>%
  group_by(Antibio_label) %>%
  summarise(
    N = n(),
    Mean = mean(Dur_stay, na.rm = TRUE),
    SD = sd(Dur_stay, na.rm = TRUE),
    Median = median(Dur_stay, na.rm = TRUE),
    Q1 = quantile(Dur_stay, 0.25, na.rm = TRUE),
    Q3 = quantile(Dur_stay, 0.75, na.rm = TRUE),
    Min = min(Dur_stay, na.rm = TRUE),
    Max = max(Dur_stay, na.rm = TRUE),
    Range = Max - Min
  )

# Display table
cat("Summary Statistics by Antibiotic Treatment:\n\n")
kable(summary_by_antibio, digits = 2,
      col.names = c("Antibiotic", "N", "Mean", "SD", "Median", "Q1", "Q3", "Min", "Max", "Range"),
      caption = "Problem 2.3: Hospitalization Duration by Antibiotic Treatment")

# Calculate difference
antibio_yes <- hospital_data %>% filter(Antibio == 1) %>% pull(Dur_stay)
antibio_no <- hospital_data %>% filter(Antibio == 2) %>% pull(Dur_stay)

mean_diff <- mean(antibio_yes) - mean(antibio_no)
median_diff <- median(antibio_yes) - median(antibio_no)

cat("\n")
cat(sprintf("Mean difference (Yes - No): %.2f days\n", mean_diff))
cat(sprintf("Median difference (Yes - No): %.1f days\n", median_diff))
```

## Graphical Comparisons

```{r problem-2-3-plots, fig.width=12, fig.height=10}
# Create multiple visualizations

# 1. Side-by-side box plots
p1 <- ggplot(hospital_data, aes(x = Antibio_label, y = Dur_stay, fill = Antibio_label)) +
  geom_boxplot(alpha = 0.7, outlier.size = 3) +
  geom_jitter(width = 0.2, alpha = 0.4, size = 2) +
  stat_summary(fun = mean, geom = "point", shape = 23, size = 4,
               fill = "red", color = "black") +
  scale_fill_manual(values = c("Yes" = "#E74C3C", "No" = "#3498DB")) +
  labs(
    title = "Hospitalization Duration by Antibiotic Treatment",
    subtitle = "Box plots with individual data points",
    x = "Received Antibiotics",
    y = "Duration of Stay (days)",
    caption = "Red diamond = Mean"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    legend.position = "none"
  )

# 2. Violin plots with box plots
p2 <- ggplot(hospital_data, aes(x = Antibio_label, y = Dur_stay, fill = Antibio_label)) +
  geom_violin(alpha = 0.5, trim = FALSE) +
  geom_boxplot(width = 0.2, alpha = 0.7, outlier.shape = NA) +
  geom_jitter(width = 0.1, alpha = 0.5, size = 2) +
  scale_fill_manual(values = c("Yes" = "#E74C3C", "No" = "#3498DB")) +
  labs(
    title = "Distribution Comparison: Violin Plot",
    x = "Received Antibiotics",
    y = "Duration of Stay (days)"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 12),
    legend.position = "none"
  )

# 3. Histograms by group
p3 <- ggplot(hospital_data, aes(x = Dur_stay, fill = Antibio_label)) +
  geom_histogram(binwidth = 2, alpha = 0.6, position = "identity", color = "black") +
  scale_fill_manual(values = c("Yes" = "#E74C3C", "No" = "#3498DB")) +
  facet_wrap(~ Antibio_label, ncol = 1) +
  labs(
    title = "Distribution by Antibiotic Treatment",
    x = "Duration of Stay (days)",
    y = "Frequency",
    fill = "Antibiotics"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 12),
    strip.text = element_text(face = "bold", size = 11)
  )

# 4. Density plots
p4 <- ggplot(hospital_data, aes(x = Dur_stay, fill = Antibio_label)) +
  geom_density(alpha = 0.5) +
  geom_vline(data = summary_by_antibio,
             aes(xintercept = Mean, color = Antibio_label),
             linetype = "dashed", size = 1) +
  scale_fill_manual(values = c("Yes" = "#E74C3C", "No" = "#3498DB")) +
  scale_color_manual(values = c("Yes" = "#E74C3C", "No" = "#3498DB")) +
  labs(
    title = "Density Plot Comparison",
    x = "Duration of Stay (days)",
    y = "Density",
    fill = "Antibiotics",
    color = "Mean",
    caption = "Dashed lines indicate group means"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 12)
  )

# Arrange all plots
grid.arrange(p1, p2, p3, p4, ncol = 2, nrow = 2)
```

**Interpretation**:

- Patients who received antibiotics had a **mean duration** of `r round(summary_by_antibio$Mean[summary_by_antibio$Antibio_label == "Yes"], 2)` days
- Patients who did NOT receive antibiotics had a **mean duration** of `r round(summary_by_antibio$Mean[summary_by_antibio$Antibio_label == "No"], 2)` days
- **Difference**: Patients receiving antibiotics stayed approximately `r round(mean_diff, 1)` days longer on average

This suggests that patients receiving antibiotics tend to have longer hospital stays, which could indicate they had more severe conditions requiring both longer hospitalization and antibiotic treatment.

---

# Problems 2.4-2.7: Effects of Scale Transformation

These problems explore what happens when each observation in a dataset is multiplied by a positive constant *c*.

## Problem 2.4: Effect on the Median

**Question**: What is the effect on the median when multiplying each observation by a positive constant?

```{r problem-2-4}
cat("PROBLEM 2.4: EFFECT ON MEDIAN\n")
cat("==============================\n\n")

# Original median
original_median <- median(hospital_data$Dur_stay)

# Test with different constants
constants <- c(2, 5, 10)
results_median <- data.frame()

for (c in constants) {
  transformed_data <- hospital_data$Dur_stay * c
  new_median <- median(transformed_data)
  ratio <- new_median / original_median

  results_median <- rbind(results_median,
                         data.frame(Constant = c,
                                   Original_Median = original_median,
                                   New_Median = new_median,
                                   Ratio = ratio))
}

kable(results_median, digits = 2,
      col.names = c("Constant (c)", "Original Median", "New Median", "New/Original"),
      caption = "Effect of Multiplication on Median")

cat("\n**ANSWER**: When each observation is multiplied by a positive constant c,\n")
cat("the median is also multiplied by c.\n")
cat("Formula: new_median = c × original_median\n")
```

## Problem 2.5: Effect on the Mode

**Question**: What is the effect on the mode when multiplying each observation by a positive constant?

```{r problem-2-5}
cat("\nPROBLEM 2.5: EFFECT ON MODE\n")
cat("============================\n\n")

# Find mode(s) in original data
get_mode <- function(x) {
  freq_table <- table(x)
  mode_val <- as.numeric(names(freq_table)[which.max(freq_table)])
  mode_freq <- max(freq_table)
  return(list(value = mode_val, frequency = mode_freq))
}

original_mode <- get_mode(hospital_data$Dur_stay)

# Test with constants
results_mode <- data.frame()

for (c in constants) {
  transformed_data <- hospital_data$Dur_stay * c
  new_mode <- get_mode(transformed_data)
  ratio <- new_mode$value / original_mode$value

  results_mode <- rbind(results_mode,
                       data.frame(Constant = c,
                                 Original_Mode = original_mode$value,
                                 New_Mode = new_mode$value,
                                 Ratio = ratio))
}

kable(results_mode, digits = 2,
      col.names = c("Constant (c)", "Original Mode", "New Mode", "New/Original"),
      caption = "Effect of Multiplication on Mode")

cat("\n**ANSWER**: When each observation is multiplied by a positive constant c,\n")
cat("the mode is also multiplied by c.\n")
cat("Formula: new_mode = c × original_mode\n")
```

## Problem 2.6: Effect on the Geometric Mean

**Question**: What is the effect on the geometric mean when multiplying each observation by a positive constant?

```{r problem-2-6}
cat("\nPROBLEM 2.6: EFFECT ON GEOMETRIC MEAN\n")
cat("======================================\n\n")

# Calculate geometric mean
geometric_mean <- function(x) {
  exp(mean(log(x[x > 0])))
}

original_geom_mean <- geometric_mean(hospital_data$Dur_stay)

# Test with constants
results_geom <- data.frame()

for (c in constants) {
  transformed_data <- hospital_data$Dur_stay * c
  new_geom_mean <- geometric_mean(transformed_data)
  ratio <- new_geom_mean / original_geom_mean

  results_geom <- rbind(results_geom,
                       data.frame(Constant = c,
                                 Original_GM = original_geom_mean,
                                 New_GM = new_geom_mean,
                                 Ratio = ratio))
}

kable(results_geom, digits = 4,
      col.names = c("Constant (c)", "Original GM", "New GM", "New/Original"),
      caption = "Effect of Multiplication on Geometric Mean")

cat("\n**ANSWER**: When each observation is multiplied by a positive constant c,\n")
cat("the geometric mean is also multiplied by c.\n")
cat("Formula: new_geometric_mean = c × original_geometric_mean\n\n")
cat("Mathematical proof:\n")
cat("  GM(cx₁, cx₂, ..., cxₙ) = (cx₁ × cx₂ × ... × cxₙ)^(1/n)\n")
cat("                          = (cⁿ × x₁ × x₂ × ... × xₙ)^(1/n)\n")
cat("                          = c × (x₁ × x₂ × ... × xₙ)^(1/n)\n")
cat("                          = c × GM(x₁, x₂, ..., xₙ)\n")
```

## Problem 2.7: Effect on the Range

**Question**: What is the effect on the range when multiplying each observation by a positive constant?

```{r problem-2-7}
cat("\nPROBLEM 2.7: EFFECT ON RANGE\n")
cat("=============================\n\n")

# Original range
original_range <- diff(range(hospital_data$Dur_stay))

# Test with constants
results_range <- data.frame()

for (c in constants) {
  transformed_data <- hospital_data$Dur_stay * c
  new_range <- diff(range(transformed_data))
  ratio <- new_range / original_range

  results_range <- rbind(results_range,
                        data.frame(Constant = c,
                                  Original_Range = original_range,
                                  New_Range = new_range,
                                  Ratio = ratio))
}

kable(results_range, digits = 2,
      col.names = c("Constant (c)", "Original Range", "New Range", "New/Original"),
      caption = "Effect of Multiplication on Range")

cat("\n**ANSWER**: When each observation is multiplied by a positive constant c,\n")
cat("the range is also multiplied by c.\n")
cat("Formula: new_range = c × original_range\n\n")
cat("Mathematical proof:\n")
cat("  Range = Max - Min\n")
cat("  New Range = c×Max - c×Min = c(Max - Min) = c × Original Range\n")
```

---

# Summary of Scale Transformation Effects

```{r summary-transformations}
cat("\nSUMMARY: EFFECTS OF MULTIPLYING DATA BY CONSTANT c\n")
cat("====================================================\n\n")

transformation_summary <- data.frame(
  Statistic = c("Mean", "Median", "Mode", "Geometric Mean", "Range",
                "Standard Deviation", "Variance", "IQR"),
  Effect = c("Multiplied by c", "Multiplied by c", "Multiplied by c",
             "Multiplied by c", "Multiplied by c", "Multiplied by c",
             "Multiplied by c²", "Multiplied by c"),
  Formula = c("c × mean", "c × median", "c × mode", "c × GM", "c × range",
              "c × SD", "c² × variance", "c × IQR")
)

kable(transformation_summary,
      caption = "Summary: Effect of Multiplying All Observations by Constant c > 0")

cat("\nKey Insight: All measures of central tendency and spread (except variance)\n")
cat("are linearly scaled by the same constant c. Variance is scaled by c².\n")
```

---

# Complete Summary Statistics Table

```{r complete-summary}
# Complete summary for all patients
complete_summary <- hospital_data %>%
  summarise(
    N = n(),
    Mean = mean(Dur_stay),
    Median = median(Dur_stay),
    Mode = get_mode(Dur_stay)$value,
    Geometric_Mean = geometric_mean(Dur_stay),
    SD = sd(Dur_stay),
    Variance = var(Dur_stay),
    Range = diff(range(Dur_stay)),
    Min = min(Dur_stay),
    Max = max(Dur_stay),
    Q1 = quantile(Dur_stay, 0.25),
    Q3 = quantile(Dur_stay, 0.75),
    IQR = IQR(Dur_stay)
  )

kable(t(complete_summary), digits = 2,
      col.names = "Value",
      caption = "Complete Summary Statistics: Duration of Hospitalization (days)")
```

---

# References

- Rosner, B. (2015). *Fundamentals of Biostatistics* (8th ed.). Cengage Learning.
- Data from retrospective chart review of antibiotic usage in a Pennsylvania hospital
- Chapter 2: Descriptive Statistics

---

**Note**: This analysis is for educational purposes based on the HOSPITAL dataset from Rosner's Fundamentals of Biostatistics textbook.
