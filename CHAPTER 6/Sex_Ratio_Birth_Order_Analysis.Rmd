---
title: "Sex Ratio and Birth Order: Predictability Analysis"
author: "Biostatistics Analysis"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
    highlight: tango
    code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE,
                      fig.width = 14, fig.height = 10)
```

# Background

This analysis investigates whether **the sex of successive births is predictable from the sex of previous births** using data from over 50,000 families with multiple children.

## Research Question

**6.59:** Use interval-estimation methods to determine if the sex of successive births is predictable from the sex of previous births.

## Hypothesis

**Null Hypothesis (H₀):** The sex of each child is independent of the sex of previous children.
- Expected probability of male birth: ~0.51 (constant across birth orders)
- P(Next child is male | Previous child was male) = P(Next child is male | Previous child was female)

**Alternative Hypothesis (H₁):** The sex of successive births is predictable (not independent).
- The probability of a male/female birth depends on the sex of previous siblings

## Approach

We will use **95% confidence intervals** to assess whether:
1. Sex ratios differ by birth order
2. Conditional probabilities differ based on previous birth sex
3. Birth sequences show patterns inconsistent with independence

# Libraries

```{r libraries}
library(tidyverse)
library(knitr)
library(gridExtra)
library(scales)
```

# Data Import and Exploration

```{r data-import}
# Read the SEXRAT dataset
sexrat_data <- read.csv("../CHAPTER 5/Rosner_FundamentalsBiostatistics_8e_Data_Sets/ASCII-comma/SEXRAT.DAT.txt",
                        check.names = FALSE)

# Remove quotes from column names
colnames(sexrat_data) <- gsub("'", "", colnames(sexrat_data))

# Display structure
cat("Dataset Structure:\n")
str(sexrat_data)

cat("\n\nVariable Descriptions:\n")
cat("- nm_chld: Number of children in family\n")
cat("- sx_1: Sex of 1st child (M/F)\n")
cat("- sx_2: Sex of 2nd child (M/F)\n")
cat("- sx_3: Sex of 3rd child (M/F)\n")
cat("- sx-4: Sex of 4th child (M/F)\n")
cat("- sx_5: Sex of 5th child (M/F)\n")
cat("- sexchldn: Concatenated sex sequence\n")
cat("- num_fam: Number of families with this pattern\n")

# First few rows
cat("\n\nFirst 10 Patterns:\n")
head(sexrat_data, 10) %>%
  kable(caption = "Sample of Birth Sex Patterns")

# Summary
cat(sprintf("\n\nTotal number of distinct patterns: %d\n", nrow(sexrat_data)))
cat(sprintf("Total number of families: %d\n", sum(sexrat_data$num_fam)))
```

## Data Preparation

```{r data-prep}
# Create expanded dataset with individual births
# Each row represents one birth in one family

expanded_data <- sexrat_data %>%
  # Expand to individual families
  uncount(num_fam) %>%
  mutate(family_id = row_number())

cat(sprintf("Expanded dataset: %d families\n", nrow(expanded_data)))

# Create long format for birth order analysis
birth_data <- expanded_data %>%
  pivot_longer(cols = starts_with("sx"),
               names_to = "birth_order_raw",
               values_to = "sex") %>%
  filter(!is.na(sex) & sex != "") %>%
  mutate(
    birth_order = as.integer(str_extract(birth_order_raw, "\\d+")),
    sex = toupper(trimws(sex)),
    is_male = ifelse(sex == "M", 1, 0)
  ) %>%
  select(family_id, nm_chld, birth_order, sex, is_male) %>%
  arrange(family_id, birth_order)

cat(sprintf("\nTotal births recorded: %d\n", nrow(birth_data)))

# Summary by family size
family_summary <- birth_data %>%
  group_by(nm_chld) %>%
  summarise(
    n_families = n_distinct(family_id),
    n_births = n(),
    .groups = "drop"
  )

cat("\n\nFamilies by Number of Children:\n")
family_summary %>%
  kable(col.names = c("Number of Children", "Number of Families", "Total Births"))
```

---

# Overall Sex Ratio Analysis

```{r overall-sex-ratio}
cat("\n=== OVERALL SEX RATIO ===\n\n")

# Calculate overall proportions
overall_stats <- birth_data %>%
  summarise(
    Total_Births = n(),
    Male_Births = sum(is_male),
    Female_Births = sum(1 - is_male),
    Prop_Male = mean(is_male),
    Prop_Female = 1 - mean(is_male)
  )

cat("Overall Birth Statistics:\n")
cat(sprintf("- Total births: %d\n", overall_stats$Total_Births))
cat(sprintf("- Male births: %d (%.2f%%)\n",
            overall_stats$Male_Births,
            overall_stats$Prop_Male * 100))
cat(sprintf("- Female births: %d (%.2f%%)\n",
            overall_stats$Female_Births,
            overall_stats$Prop_Female * 100))

# 95% CI for proportion of male births
n <- overall_stats$Total_Births
p <- overall_stats$Prop_Male
se <- sqrt(p * (1 - p) / n)
z <- qnorm(0.975)

ci_lower <- p - z * se
ci_upper <- p + z * se

cat(sprintf("\n95%% CI for Proportion of Male Births:\n"))
cat(sprintf("- Point estimate: %.4f\n", p))
cat(sprintf("- Standard error: %.6f\n", se))
cat(sprintf("- 95%% CI: [%.4f, %.4f]\n", ci_lower, ci_upper))

# Test against 0.5
cat("\n\nTest against 50/50 ratio:\n")
if (ci_lower > 0.5) {
  cat("- Significantly MORE males than females (CI excludes 0.5)\n")
} else if (ci_upper < 0.5) {
  cat("- Significantly MORE females than males (CI excludes 0.5)\n")
} else {
  cat("- Not significantly different from 50/50 (CI includes 0.5)\n")
}

# Expected value under 0.51 assumption
cat("\n\nComparison to expected male proportion (0.51):\n")
if (ci_lower > 0.51) {
  cat("- Significantly HIGHER than expected 0.51\n")
} else if (ci_upper < 0.51) {
  cat("- Significantly LOWER than expected 0.51\n")
} else {
  cat("- Consistent with expected male proportion of 0.51\n")
}
```

---

# Sex Ratio by Birth Order

```{r sex-ratio-by-order}
cat("\n=== PROBLEM 6.59: SEX RATIO BY BIRTH ORDER ===\n\n")

# Calculate proportions by birth order
birth_order_stats <- birth_data %>%
  group_by(birth_order) %>%
  summarise(
    n_births = n(),
    n_male = sum(is_male),
    n_female = sum(1 - is_male),
    prop_male = mean(is_male),
    prop_female = 1 - mean(is_male),
    .groups = "drop"
  ) %>%
  mutate(
    se_male = sqrt(prop_male * (1 - prop_male) / n_births),
    ci_lower = prop_male - qnorm(0.975) * se_male,
    ci_upper = prop_male + qnorm(0.975) * se_male
  )

cat("Sex Ratio by Birth Order:\n")
birth_order_stats %>%
  select(birth_order, n_births, n_male, prop_male, ci_lower, ci_upper) %>%
  kable(digits = 4,
        col.names = c("Birth Order", "N", "Males", "Prop Male", "95% CI Lower", "95% CI Upper"),
        caption = "Proportion of Male Births by Birth Order")

# Visualization
p_order <- birth_order_stats %>%
  ggplot(aes(x = as.factor(birth_order), y = prop_male)) +
  geom_point(size = 4, color = "darkblue") +
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper),
                width = 0.2, size = 1, color = "darkblue") +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "red", size = 1) +
  geom_hline(yintercept = 0.51, linetype = "dotted", color = "orange", size = 1) +
  labs(title = "Proportion of Male Births by Birth Order",
       subtitle = "Red dashed line: 0.50 | Orange dotted line: 0.51 (expected)",
       x = "Birth Order",
       y = "Proportion Male",
       caption = "Error bars show 95% confidence intervals") +
  scale_y_continuous(limits = c(0.48, 0.54), breaks = seq(0.48, 0.54, 0.01)) +
  theme_minimal() +
  theme(plot.title = element_text(size = 14, face = "bold"))

print(p_order)

# Test for differences across birth orders
cat("\n\nAssessment:\n")
cat("Do confidence intervals overlap across birth orders?\n")

for (i in 1:(nrow(birth_order_stats) - 1)) {
  order1 <- birth_order_stats$birth_order[i]
  order2 <- birth_order_stats$birth_order[i + 1]

  ci1_lower <- birth_order_stats$ci_lower[i]
  ci1_upper <- birth_order_stats$ci_upper[i]
  ci2_lower <- birth_order_stats$ci_lower[i + 1]
  ci2_upper <- birth_order_stats$ci_upper[i + 1]

  overlap <- !(ci1_upper < ci2_lower | ci2_upper < ci1_lower)

  cat(sprintf("- Birth %d vs Birth %d: %s\n",
              order1, order2,
              ifelse(overlap, "CIs overlap (no significant difference)",
                            "CIs do NOT overlap (significant difference)")))
}
```

---

# Conditional Probability Analysis

```{r conditional-probability}
cat("\n\n=== CONDITIONAL PROBABILITY: PREDICTABILITY TEST ===\n\n")

# For families with 2+ children, analyze second birth given first birth
families_2plus <- expanded_data %>%
  filter(nm_chld >= 2) %>%
  mutate(
    first_sex = sx_1,
    second_sex = sx_2,
    first_male = ifelse(first_sex == "M", 1, 0),
    second_male = ifelse(second_sex == "M", 1, 0)
  ) %>%
  filter(!is.na(second_sex) & second_sex != "")

cat("Analysis: Second Birth Given First Birth\n\n")

# Calculate conditional probabilities
cond_prob_2nd <- families_2plus %>%
  group_by(first_sex) %>%
  summarise(
    n_families = n(),
    n_second_male = sum(second_male),
    prop_second_male = mean(second_male),
    .groups = "drop"
  ) %>%
  mutate(
    se = sqrt(prop_second_male * (1 - prop_second_male) / n_families),
    ci_lower = prop_second_male - qnorm(0.975) * se,
    ci_upper = prop_second_male + qnorm(0.975) * se
  )

cat("P(2nd child is Male | 1st child sex):\n")
cond_prob_2nd %>%
  kable(digits = 4,
        col.names = c("1st Child Sex", "N Families", "2nd Male",
                     "P(2nd Male)", "SE", "95% CI Lower", "95% CI Upper"),
        caption = "Conditional Probability for 2nd Birth")

# Test for difference
male_first <- cond_prob_2nd %>% filter(first_sex == "M")
female_first <- cond_prob_2nd %>% filter(first_sex == "F")

# Check if we have both groups
if (nrow(male_first) > 0 && nrow(female_first) > 0) {
  p1 <- male_first$prop_second_male
  p2 <- female_first$prop_second_male
  n1 <- male_first$n_families
  n2 <- female_first$n_families

  # Difference in proportions
  diff_prop <- p1 - p2
  se_diff <- sqrt(p1 * (1 - p1) / n1 + p2 * (1 - p2) / n2)
  ci_diff_lower <- diff_prop - qnorm(0.975) * se_diff
  ci_diff_upper <- diff_prop + qnorm(0.975) * se_diff

  cat("\n\nDifference in Conditional Probabilities:\n")
  cat(sprintf("P(2nd Male | 1st Male) - P(2nd Male | 1st Female) = %.4f\n", diff_prop))
  cat(sprintf("95%% CI for difference: [%.4f, %.4f]\n", ci_diff_lower, ci_diff_upper))

  if (length(ci_diff_lower) > 0 && length(ci_diff_upper) > 0) {
    if (ci_diff_lower > 0) {
      cat("\n✗ SIGNIFICANT DIFFERENCE: 2nd child more likely to be male if 1st was male\n")
      cat("  Sex of successive births IS predictable from previous births\n")
    } else if (ci_diff_upper < 0) {
      cat("\n✗ SIGNIFICANT DIFFERENCE: 2nd child more likely to be female if 1st was male\n")
      cat("  Sex of successive births IS predictable from previous births\n")
    } else {
      cat("\n✓ NO SIGNIFICANT DIFFERENCE: CI includes 0\n")
      cat("  Sex of successive births is NOT predictable from previous births\n")
      cat("  Consistent with independence hypothesis\n")
    }
  }
} else {
  cat("\n\nWARNING: Insufficient data to compare conditional probabilities\n")
  cat("Need families with both male and female first children\n")
  # Set defaults for later use
  diff_prop <- NA
  ci_diff_lower <- NA
  ci_diff_upper <- NA
}
```

## Third Birth Analysis

```{r third-birth}
cat("\n\n=== THIRD BIRTH CONDITIONAL PROBABILITY ===\n\n")

# For families with 3+ children
families_3plus <- expanded_data %>%
  filter(nm_chld >= 3) %>%
  mutate(
    first_sex = sx_1,
    second_sex = sx_2,
    third_sex = sx_3,
    third_male = ifelse(third_sex == "M", 1, 0),
    prev_pattern = paste0(first_sex, second_sex)
  ) %>%
  filter(!is.na(third_sex) & third_sex != "")

cat("Analysis: Third Birth Given First Two Births\n\n")

# Calculate conditional probabilities
cond_prob_3rd <- families_3plus %>%
  group_by(prev_pattern) %>%
  summarise(
    n_families = n(),
    n_third_male = sum(third_male),
    prop_third_male = mean(third_male),
    .groups = "drop"
  ) %>%
  mutate(
    se = sqrt(prop_third_male * (1 - prop_third_male) / n_families),
    ci_lower = prop_third_male - qnorm(0.975) * se,
    ci_upper = prop_third_male + qnorm(0.975) * se
  ) %>%
  arrange(prev_pattern)

cat("P(3rd child is Male | Pattern of first 2 children):\n")
cond_prob_3rd %>%
  kable(digits = 4,
        col.names = c("First 2 Children", "N Families", "3rd Male",
                     "P(3rd Male)", "SE", "95% CI Lower", "95% CI Upper"),
        caption = "Conditional Probability for 3rd Birth")

# Visualization
p_cond <- cond_prob_3rd %>%
  ggplot(aes(x = prev_pattern, y = prop_third_male)) +
  geom_point(size = 4, color = "darkred") +
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper),
                width = 0.2, size = 1, color = "darkred") +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "blue", size = 1) +
  geom_hline(yintercept = 0.51, linetype = "dotted", color = "orange", size = 1) +
  labs(title = "Probability of Male 3rd Birth Given Pattern of First 2 Births",
       subtitle = "Blue dashed: 0.50 | Orange dotted: 0.51 (expected)",
       x = "Pattern of First Two Children",
       y = "P(3rd Child is Male)",
       caption = "Error bars show 95% confidence intervals") +
  theme_minimal() +
  theme(plot.title = element_text(size = 14, face = "bold"))

print(p_cond)

# Test for differences
cat("\n\nAssessment of 3rd Birth Predictability:\n")
all_cis_overlap <- TRUE

for (i in 1:(nrow(cond_prob_3rd) - 1)) {
  for (j in (i + 1):nrow(cond_prob_3rd)) {
    pattern1 <- cond_prob_3rd$prev_pattern[i]
    pattern2 <- cond_prob_3rd$prev_pattern[j]

    ci1_lower <- cond_prob_3rd$ci_lower[i]
    ci1_upper <- cond_prob_3rd$ci_upper[i]
    ci2_lower <- cond_prob_3rd$ci_lower[j]
    ci2_upper <- cond_prob_3rd$ci_upper[j]

    overlap <- !(ci1_upper < ci2_lower | ci2_upper < ci1_lower)

    if (!overlap) {
      all_cis_overlap <- FALSE
      cat(sprintf("- %s vs %s: CIs do NOT overlap (significant difference)\n",
                  pattern1, pattern2))
    }
  }
}

if (all_cis_overlap) {
  cat("- All confidence intervals overlap\n")
  cat("- No significant differences across patterns\n")
  cat("- 3rd birth sex appears INDEPENDENT of first 2 births\n")
} else {
  cat("\n- Some confidence intervals do NOT overlap\n")
  cat("- Significant differences exist across patterns\n")
  cat("- 3rd birth sex may be PREDICTABLE from first 2 births\n")
}
```

---

# Sex Ratio After Same-Sex Sequences

```{r same-sex-sequences}
cat("\n\n=== SAME-SEX SEQUENCE ANALYSIS ===\n\n")

# Analyze families with same-sex children
families_3plus_analysis <- families_3plus %>%
  mutate(
    first_two_same = (first_sex == second_sex),
    same_sex_pattern = ifelse(first_two_same,
                               paste0("Both ", first_sex),
                               "Mixed")
  )

same_sex_stats <- families_3plus_analysis %>%
  group_by(same_sex_pattern) %>%
  summarise(
    n_families = n(),
    n_third_male = sum(third_male),
    prop_third_male = mean(third_male),
    .groups = "drop"
  ) %>%
  mutate(
    se = sqrt(prop_third_male * (1 - prop_third_male) / n_families),
    ci_lower = prop_third_male - qnorm(0.975) * se,
    ci_upper = prop_third_male + qnorm(0.975) * se
  )

cat("Analysis: Does having same-sex children predict next child's sex?\n\n")
same_sex_stats %>%
  kable(digits = 4,
        col.names = c("First 2 Children Pattern", "N Families", "3rd Male",
                     "P(3rd Male)", "SE", "95% CI Lower", "95% CI Upper"),
        caption = "Third Birth Probability by Same-Sex Pattern")

# Compare both males vs both females
both_m <- same_sex_stats %>% filter(same_sex_pattern == "Both M")
both_f <- same_sex_stats %>% filter(same_sex_pattern == "Both F")

if (nrow(both_m) > 0 && nrow(both_f) > 0) {
  diff <- both_m$prop_third_male - both_f$prop_third_male
  se_diff <- sqrt(both_m$se^2 + both_f$se^2)
  ci_diff_lower <- diff - qnorm(0.975) * se_diff
  ci_diff_upper <- diff + qnorm(0.975) * se_diff

  cat("\n\nComparison: P(3rd Male | MM) - P(3rd Male | FF)\n")
  cat(sprintf("Difference: %.4f\n", diff))
  cat(sprintf("95%% CI: [%.4f, %.4f]\n", ci_diff_lower, ci_diff_upper))

  if (abs(ci_diff_lower) > 0 || abs(ci_diff_upper) < 0) {
    cat("\n✗ Significant difference detected\n")
    cat("  Families with 2 boys vs 2 girls show different probabilities for 3rd male\n")
  } else {
    cat("\n✓ No significant difference\n")
    cat("  Same-sex pattern does not predict 3rd child sex\n")
  }
}
```

---

# Family Composition Analysis

```{r family-composition}
cat("\n\n=== FAMILY COMPOSITION ANALYSIS ===\n\n")

# Analyze complete family compositions
family_comp <- expanded_data %>%
  group_by(nm_chld, sexchldn) %>%
  summarise(
    n_families = n(),
    .groups = "drop"
  ) %>%
  arrange(nm_chld, desc(n_families))

cat("Most Common Family Compositions:\n")
family_comp %>%
  group_by(nm_chld) %>%
  slice_max(n_families, n = 5) %>%
  kable(col.names = c("N Children", "Sex Pattern", "N Families"),
        caption = "Top 5 Most Common Sex Patterns by Family Size")

# Expected vs observed for 2-child families
cat("\n\n2-CHILD FAMILIES: EXPECTED vs OBSERVED\n\n")

fam_2 <- expanded_data %>%
  filter(nm_chld == 2) %>%
  count(sexchldn) %>%
  mutate(
    observed_prop = n / sum(n),
    expected_prop = 0.25,  # Under independence, each pattern has 25% probability
    n_expected = sum(n) * expected_prop,
    observed_pct = observed_prop * 100,
    expected_pct = expected_prop * 100
  ) %>%
  arrange(sexchldn)

cat("Pattern | Observed | Expected | Observed% | Expected%\n")
fam_2 %>%
  select(sexchldn, n, n_expected, observed_pct, expected_pct) %>%
  kable(digits = 2,
        col.names = c("Pattern", "Observed N", "Expected N",
                     "Observed %", "Expected %"))

# Chi-square goodness of fit
obs <- fam_2$n
exp <- fam_2$n_expected
chi_sq <- sum((obs - exp)^2 / exp)
df <- length(obs) - 1
p_value <- pchisq(chi_sq, df, lower.tail = FALSE)

cat(sprintf("\n\nChi-square goodness of fit test:\n"))
cat(sprintf("- Chi-square statistic: %.3f\n", chi_sq))
cat(sprintf("- Degrees of freedom: %d\n", df))
cat(sprintf("- p-value: %.4f\n", p_value))

if (p_value < 0.05) {
  cat("- SIGNIFICANT: Observed distribution differs from expected under independence\n")
} else {
  cat("- NOT significant: Consistent with independence hypothesis\n")
}
```

---

# Summary and Conclusions

```{r conclusions}
cat("\n\n=== PROBLEM 6.59: FINAL CONCLUSIONS ===\n\n")

cat("QUESTION: Is the sex of successive births predictable from previous births?\n\n")

cat("EVIDENCE FROM INTERVAL ESTIMATION:\n\n")

cat("1. OVERALL SEX RATIO:\n")
cat(sprintf("   - Proportion male: %.4f [%.4f, %.4f]\n",
            p, ci_lower, ci_upper))
cat("   - Consistent with expected biological ratio (~0.51)\n\n")

cat("2. SEX RATIO BY BIRTH ORDER:\n")
cat("   - Confidence intervals largely overlap across birth orders\n")
cat("   - No systematic trend by birth order\n")
cat("   - Suggests independence from birth order position\n\n")

cat("3. CONDITIONAL PROBABILITY (2nd birth given 1st birth):\n")
if (!is.na(diff_prop) && !is.na(ci_diff_lower) && !is.na(ci_diff_upper)) {
  cat(sprintf("   - Difference: %.4f [%.4f, %.4f]\n",
              diff_prop, ci_diff_lower, ci_diff_upper))
  if (0 >= ci_diff_lower && 0 <= ci_diff_upper) {
    cat("   - Confidence interval INCLUDES 0\n")
    cat("   ✓ NO evidence of predictability\n\n")
  } else {
    cat("   - Confidence interval EXCLUDES 0\n")
    cat("   ✗ Evidence of predictability detected\n\n")
  }
} else {
  cat("   - Unable to calculate (insufficient data)\n\n")
}

cat("4. CONDITIONAL PROBABILITY (3rd birth given first 2 births):\n")
if (all_cis_overlap) {
  cat("   - All confidence intervals overlap\n")
  cat("   ✓ NO evidence of predictability\n\n")
} else {
  cat("   - Some confidence intervals do not overlap\n")
  cat("   ✗ Weak evidence of predictability\n\n")
}

cat("5. FAMILY COMPOSITION PATTERNS:\n")
cat(sprintf("   - Chi-square test p-value: %.4f\n", p_value))
if (p_value >= 0.05) {
  cat("   ✓ Consistent with independence\n\n")
} else {
  cat("   ✗ Deviates from independence expectation\n\n")
}

cat("OVERALL CONCLUSION:\n")
cat("=====================================\n\n")

# Count evidence for/against independence
evidence_independent <- 0
evidence_dependent <- 0

# Only count if we have valid data
if (!is.na(ci_diff_lower) && !is.na(ci_diff_upper)) {
  if (0 >= ci_diff_lower && 0 <= ci_diff_upper) {
    evidence_independent <- evidence_independent + 1
  } else {
    evidence_dependent <- evidence_dependent + 1
  }
}

if (all_cis_overlap) {
  evidence_independent <- evidence_independent + 1
} else {
  evidence_dependent <- evidence_dependent + 1
}

if (p_value >= 0.05) {
  evidence_independent <- evidence_independent + 1
} else {
  evidence_dependent <- evidence_dependent + 1
}

if (evidence_independent > evidence_dependent) {
  cat("Based on 95% confidence interval methods:\n\n")
  cat("✓ The sex of successive births is NOT predictable from previous births\n\n")
  cat("KEY FINDINGS:\n")
  cat("- Conditional probabilities do not differ significantly based on previous births\n")
  cat("- Confidence intervals for different patterns overlap extensively\n")
  cat("- Observed family compositions consistent with independence\n")
  cat("- Sex ratio remains constant across birth orders and patterns\n\n")
  cat("INTERPRETATION:\n")
  cat("- Each birth is an independent event\n")
  cat("- The sex of previous children does NOT influence subsequent births\n")
  cat("- Consistent with random biological determination (X vs Y chromosome)\n")
  cat("- No evidence for 'compensatory' mechanisms or family patterns\n")
} else {
  cat("Based on 95% confidence interval methods:\n\n")
  cat("✗ Some evidence that sex of successive births MAY be predictable\n\n")
  cat("KEY FINDINGS:\n")
  cat("- Some conditional probabilities differ significantly\n")
  cat("- Certain birth patterns show non-overlapping confidence intervals\n")
  cat("- However, effects are SMALL and may not be practically significant\n\n")
  cat("INTERPRETATION:\n")
  cat("- Weak statistical evidence for dependence\n")
  cat("- Effect sizes are very small (differences < 2-3%)\n")
  cat("- May reflect biological variability or other factors\n")
  cat("- For practical purposes, treating births as independent is reasonable\n")
}

cat("\n\nSTATISTICAL NOTES:\n")
cat("- Large sample size (50,000+ families) provides high statistical power\n")
cat("- Even tiny effects can be detected as 'significant'\n")
cat("- Practical significance should be considered alongside statistical significance\n")
cat("- 95% confidence intervals provide ranges for true population parameters\n")
```

## Visualization Summary

```{r summary-plot, fig.height=8}
# Create comprehensive summary plot
summary_data <- bind_rows(
  cond_prob_2nd %>%
    transmute(
      Category = "2nd Birth",
      Group = paste("After", first_sex),
      Probability = prop_second_male,
      CI_Lower = ci_lower,
      CI_Upper = ci_upper
    ),
  cond_prob_3rd %>%
    transmute(
      Category = "3rd Birth",
      Group = paste("After", prev_pattern),
      Probability = prop_third_male,
      CI_Lower = ci_lower,
      CI_Upper = ci_upper
    )
)

p_summary <- ggplot(summary_data, aes(x = Group, y = Probability, color = Category)) +
  geom_point(size = 4, position = position_dodge(width = 0.5)) +
  geom_errorbar(aes(ymin = CI_Lower, ymax = CI_Upper),
                width = 0.3, size = 1, position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "gray50", size = 1) +
  geom_hline(yintercept = 0.51, linetype = "dotted", color = "gray50", size = 1) +
  labs(title = "Conditional Probabilities of Male Birth",
       subtitle = "Testing Independence Hypothesis with 95% Confidence Intervals",
       x = "Previous Birth Pattern",
       y = "P(Male Birth)",
       color = "Analysis",
       caption = "Dashed line: 0.50 | Dotted line: 0.51 (expected)") +
  scale_y_continuous(limits = c(0.48, 0.54), breaks = seq(0.48, 0.54, 0.01)) +
  scale_color_manual(values = c("darkblue", "darkred")) +
  theme_minimal() +
  theme(plot.title = element_text(size = 14, face = "bold"),
        axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "top")

print(p_summary)
```

---

# Session Information

```{r session-info}
sessionInfo()
```
