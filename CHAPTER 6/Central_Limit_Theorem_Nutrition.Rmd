---
title: "Central Limit Theorem: Nutrition Data Analysis"
author: "Biostatistics Analysis"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
    highlight: tango
    code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE,
                      fig.width = 14, fig.height = 10)
set.seed(12345)  # For reproducibility
```

# Background

This analysis investigates the **Central Limit Theorem (CLT)** using nutrition data from the VALID study. The CLT states that the sampling distribution of the sample mean approaches a normal distribution as the sample size increases, regardless of the population distribution.

## Research Questions

**6.60:** Does the CLT hold for dietary attributes based on samples of size 5?

**6.61:** Does the CLT hold for dietary attributes based on samples of size 10?

**6.62:** Does the CLT hold for dietary attributes based on samples of size 20?

**6.63:** How do the sampling distributions compare across different sample sizes?

## Dietary Variables

- **Total Fat** (Diet Record and FFQ)
- **Saturated Fat** (Diet Record and FFQ)
- **Total Calories** (Diet Record and FFQ)
- **Alcohol Consumption** (Diet Record and FFQ)

# Libraries

```{r libraries}
library(tidyverse)
library(knitr)
library(gridExtra)
library(moments)
library(scales)
```

# Data Import and Preparation

```{r data-import}
# Read the VALID dataset
valid_data <- read.csv("../CHAPTER 5/Rosner_FundamentalsBiostatistics_8e_Data_Sets/ASCII-comma/VALID.DAT.txt",
                       check.names = FALSE)

# Remove quotes from column names
colnames(valid_data) <- gsub("'", "", colnames(valid_data))

# Display structure
cat("Dataset Structure:\n")
str(valid_data)

cat(sprintf("\n\nTotal number of subjects: %d\n", nrow(valid_data)))

# Select key dietary variables for CLT analysis
dietary_vars <- c("sfat_dr", "sfat_ffq", "tfat_dr", "tfat_ffq",
                  "cal_dr", "cal_ffq", "alco_dr", "alco_ffq")

cat("\n\nDietary Variables for Analysis:\n")
cat("- sfat_dr: Saturated fat (Diet Record)\n")
cat("- sfat_ffq: Saturated fat (FFQ)\n")
cat("- tfat_dr: Total fat (Diet Record)\n")
cat("- tfat_ffq: Total fat (FFQ)\n")
cat("- cal_dr: Total calories (Diet Record)\n")
cat("- cal_ffq: Total calories (FFQ)\n")
cat("- alco_dr: Alcohol (Diet Record)\n")
cat("- alco_ffq: Alcohol (FFQ)\n")

# Summary statistics for population
cat("\n\nPopulation Summary Statistics:\n")
valid_data %>%
  select(all_of(dietary_vars)) %>%
  summary() %>%
  kable()
```

## Population Distributions

```{r population-distributions, fig.height=14}
# Create long format for plotting
pop_long <- valid_data %>%
  select(all_of(dietary_vars)) %>%
  pivot_longer(everything(), names_to = "Variable", values_to = "Value") %>%
  filter(!is.na(Value))

# Population distributions
p_pop <- ggplot(pop_long, aes(x = Value)) +
  geom_histogram(aes(y = ..density..), bins = 30,
                 fill = "steelblue", alpha = 0.7) +
  geom_density(color = "darkblue", size = 1.2) +
  facet_wrap(~ Variable, scales = "free", ncol = 2) +
  labs(title = "Population Distributions of Dietary Variables",
       subtitle = "N = 173 subjects",
       x = "Value",
       y = "Density") +
  theme_minimal() +
  theme(plot.title = element_text(size = 16, face = "bold"))

print(p_pop)

# Population statistics
pop_stats <- valid_data %>%
  select(all_of(dietary_vars)) %>%
  pivot_longer(everything(), names_to = "Variable", values_to = "Value") %>%
  filter(!is.na(Value)) %>%
  group_by(Variable) %>%
  summarise(
    N = n(),
    Mean = mean(Value),
    SD = sd(Value),
    Median = median(Value),
    Skewness = skewness(Value),
    Kurtosis = kurtosis(Value),
    .groups = "drop"
  )

cat("\n\nPopulation Statistics:\n")
pop_stats %>%
  kable(digits = 3, caption = "Population Parameters")
```

---

# Sampling Distribution Function

```{r sampling-function}
# Function to generate sampling distribution of means
generate_sampling_dist <- function(data, variable, sample_size, n_samples = 1000) {
  # Get the variable data (remove NAs)
  pop_data <- data[[variable]][!is.na(data[[variable]])]

  # Draw repeated random samples and calculate means
  sample_means <- replicate(n_samples, {
    sample_data <- sample(pop_data, size = sample_size, replace = FALSE)
    mean(sample_data)
  })

  # Return results
  data.frame(
    Variable = variable,
    Sample_Size = sample_size,
    Sample_Mean = sample_means
  )
}

# Parameters
n_samples <- 1000  # Number of repeated samples
sample_sizes <- c(5, 10, 20)

cat(sprintf("Simulation Parameters:\n"))
cat(sprintf("- Number of repeated samples: %d\n", n_samples))
cat(sprintf("- Sample sizes: %s\n", paste(sample_sizes, collapse = ", ")))
```

---

# Problem 6.60: Samples of Size 5

```{r samples-n5}
cat("\n=== PROBLEM 6.60: CENTRAL LIMIT THEOREM WITH n = 5 ===\n\n")

# Generate sampling distributions for all variables with n=5
sampling_dist_n5 <- map_df(dietary_vars, ~generate_sampling_dist(
  valid_data, .x, sample_size = 5, n_samples = n_samples
))

# Calculate statistics of sampling distributions
sampling_stats_n5 <- sampling_dist_n5 %>%
  group_by(Variable, Sample_Size) %>%
  summarise(
    N_Samples = n(),
    Mean_of_Means = mean(Sample_Mean),
    SD_of_Means = sd(Sample_Mean),
    SE_Theoretical = pop_stats$SD[pop_stats$Variable == Variable[1]] / sqrt(Sample_Size[1]),
    Skewness = skewness(Sample_Mean),
    Kurtosis = kurtosis(Sample_Mean),
    .groups = "drop"
  ) %>%
  left_join(pop_stats %>% select(Variable, Pop_Mean = Mean, Pop_SD = SD),
            by = "Variable")

cat("Sampling Distribution Statistics (n = 5):\n")
sampling_stats_n5 %>%
  kable(digits = 3, caption = "Sampling Distribution with n = 5")

# Shapiro-Wilk tests for normality
normality_n5 <- sampling_dist_n5 %>%
  group_by(Variable) %>%
  summarise(
    Shapiro_W = shapiro.test(Sample_Mean)$statistic,
    Shapiro_p = shapiro.test(Sample_Mean)$p.value,
    Normal = ifelse(Shapiro_p > 0.05, "Yes", "No"),
    .groups = "drop"
  )

cat("\n\nNormality Tests (n = 5):\n")
normality_n5 %>%
  kable(digits = 4, caption = "Shapiro-Wilk Tests for Sampling Distributions (n = 5)")
```

## Visualizations: n = 5

```{r plots-n5, fig.height=16}
# Histograms with normal overlay
p1_n5 <- ggplot(sampling_dist_n5, aes(x = Sample_Mean)) +
  geom_histogram(aes(y = ..density..), bins = 40,
                 fill = "coral", alpha = 0.7) +
  geom_density(color = "darkred", size = 1.2) +
  stat_function(
    fun = dnorm,
    args = list(
      mean = sampling_stats_n5$Mean_of_Means[1],
      sd = sampling_stats_n5$SD_of_Means[1]
    ),
    color = "blue", size = 1, linetype = "dashed"
  ) +
  facet_wrap(~ Variable, scales = "free", ncol = 2) +
  labs(title = "Sampling Distributions: n = 5",
       subtitle = "Red: actual density; Blue dashed: theoretical normal distribution",
       x = "Sample Mean",
       y = "Density") +
  theme_minimal() +
  theme(plot.title = element_text(size = 14, face = "bold"))

# Q-Q plots
p2_n5 <- ggplot(sampling_dist_n5, aes(sample = Sample_Mean)) +
  stat_qq(color = "coral", size = 1) +
  stat_qq_line(color = "blue", size = 1) +
  facet_wrap(~ Variable, scales = "free", ncol = 2) +
  labs(title = "Q-Q Plots: n = 5",
       subtitle = "Assessing normality of sampling distributions",
       x = "Theoretical Quantiles",
       y = "Sample Quantiles") +
  theme_minimal()

grid.arrange(p1_n5, p2_n5, ncol = 1, heights = c(1.2, 1))
```

## Assessment: n = 5

```{r assessment-n5}
cat("\n\n=== ASSESSMENT: DOES CLT HOLD FOR n = 5? ===\n\n")

for (i in 1:nrow(normality_n5)) {
  var_name <- normality_n5$Variable[i]
  cat(sprintf("\n%s:\n", var_name))

  # Check normality
  if (normality_n5$Normal[i] == "Yes") {
    cat(sprintf("  ✓ Sampling distribution appears normal (p = %.4f)\n",
                normality_n5$Shapiro_p[i]))
  } else {
    cat(sprintf("  ✗ Sampling distribution deviates from normality (p = %.4f)\n",
                normality_n5$Shapiro_p[i]))
  }

  # Check skewness
  skew <- sampling_stats_n5$Skewness[sampling_stats_n5$Variable == var_name]
  cat(sprintf("  - Skewness: %.3f %s\n", skew,
              ifelse(abs(skew) < 0.5, "(approximately symmetric)",
                     ifelse(skew > 0, "(right-skewed)", "(left-skewed)"))))

  # Check mean convergence
  pop_mean <- sampling_stats_n5$Pop_Mean[sampling_stats_n5$Variable == var_name]
  sample_mean <- sampling_stats_n5$Mean_of_Means[sampling_stats_n5$Variable == var_name]
  cat(sprintf("  - Population mean: %.3f\n", pop_mean))
  cat(sprintf("  - Mean of sample means: %.3f (difference: %.3f)\n",
              sample_mean, abs(pop_mean - sample_mean)))

  # Check SE
  se_obs <- sampling_stats_n5$SD_of_Means[sampling_stats_n5$Variable == var_name]
  se_theory <- sampling_stats_n5$SE_Theoretical[sampling_stats_n5$Variable == var_name]
  cat(sprintf("  - Observed SE: %.3f\n", se_obs))
  cat(sprintf("  - Theoretical SE: %.3f (ratio: %.3f)\n",
              se_theory, se_obs / se_theory))
}

cat("\n\nOVERALL CONCLUSION FOR n = 5:\n")
normal_count_n5 <- sum(normality_n5$Normal == "Yes")
cat(sprintf("- %d out of %d variables show approximately normal sampling distributions\n",
            normal_count_n5, nrow(normality_n5)))

if (normal_count_n5 == nrow(normality_n5)) {
  cat("- CLT appears to hold even for small samples (n = 5)\n")
  cat("- This suggests the population distributions are not severely non-normal\n")
} else if (normal_count_n5 > nrow(normality_n5) / 2) {
  cat("- CLT holds for most variables but not all at n = 5\n")
  cat("- Larger sample sizes may be needed for some variables\n")
} else {
  cat("- CLT does NOT appear to hold for most variables at n = 5\n")
  cat("- Sample size is too small for the population distributions\n")
}
```

---

# Problem 6.61: Samples of Size 10

```{r samples-n10}
cat("\n=== PROBLEM 6.61: CENTRAL LIMIT THEOREM WITH n = 10 ===\n\n")

# Generate sampling distributions for all variables with n=10
sampling_dist_n10 <- map_df(dietary_vars, ~generate_sampling_dist(
  valid_data, .x, sample_size = 10, n_samples = n_samples
))

# Calculate statistics
sampling_stats_n10 <- sampling_dist_n10 %>%
  group_by(Variable, Sample_Size) %>%
  summarise(
    N_Samples = n(),
    Mean_of_Means = mean(Sample_Mean),
    SD_of_Means = sd(Sample_Mean),
    SE_Theoretical = pop_stats$SD[pop_stats$Variable == Variable[1]] / sqrt(Sample_Size[1]),
    Skewness = skewness(Sample_Mean),
    Kurtosis = kurtosis(Sample_Mean),
    .groups = "drop"
  ) %>%
  left_join(pop_stats %>% select(Variable, Pop_Mean = Mean, Pop_SD = SD),
            by = "Variable")

cat("Sampling Distribution Statistics (n = 10):\n")
sampling_stats_n10 %>%
  kable(digits = 3, caption = "Sampling Distribution with n = 10")

# Normality tests
normality_n10 <- sampling_dist_n10 %>%
  group_by(Variable) %>%
  summarise(
    Shapiro_W = shapiro.test(Sample_Mean)$statistic,
    Shapiro_p = shapiro.test(Sample_Mean)$p.value,
    Normal = ifelse(Shapiro_p > 0.05, "Yes", "No"),
    .groups = "drop"
  )

cat("\n\nNormality Tests (n = 10):\n")
normality_n10 %>%
  kable(digits = 4, caption = "Shapiro-Wilk Tests for Sampling Distributions (n = 10)")
```

## Visualizations: n = 10

```{r plots-n10, fig.height=16}
# Histograms with normal overlay
p1_n10 <- ggplot(sampling_dist_n10, aes(x = Sample_Mean)) +
  geom_histogram(aes(y = ..density..), bins = 40,
                 fill = "forestgreen", alpha = 0.7) +
  geom_density(color = "darkgreen", size = 1.2) +
  stat_function(
    fun = dnorm,
    args = list(
      mean = sampling_stats_n10$Mean_of_Means[1],
      sd = sampling_stats_n10$SD_of_Means[1]
    ),
    color = "blue", size = 1, linetype = "dashed"
  ) +
  facet_wrap(~ Variable, scales = "free", ncol = 2) +
  labs(title = "Sampling Distributions: n = 10",
       subtitle = "Green: actual density; Blue dashed: theoretical normal distribution",
       x = "Sample Mean",
       y = "Density") +
  theme_minimal() +
  theme(plot.title = element_text(size = 14, face = "bold"))

# Q-Q plots
p2_n10 <- ggplot(sampling_dist_n10, aes(sample = Sample_Mean)) +
  stat_qq(color = "forestgreen", size = 1) +
  stat_qq_line(color = "blue", size = 1) +
  facet_wrap(~ Variable, scales = "free", ncol = 2) +
  labs(title = "Q-Q Plots: n = 10",
       subtitle = "Assessing normality of sampling distributions",
       x = "Theoretical Quantiles",
       y = "Sample Quantiles") +
  theme_minimal()

grid.arrange(p1_n10, p2_n10, ncol = 1, heights = c(1.2, 1))
```

## Assessment: n = 10

```{r assessment-n10}
cat("\n\n=== ASSESSMENT: DOES CLT HOLD FOR n = 10? ===\n\n")

for (i in 1:nrow(normality_n10)) {
  var_name <- normality_n10$Variable[i]
  cat(sprintf("\n%s:\n", var_name))

  if (normality_n10$Normal[i] == "Yes") {
    cat(sprintf("  ✓ Sampling distribution appears normal (p = %.4f)\n",
                normality_n10$Shapiro_p[i]))
  } else {
    cat(sprintf("  ✗ Sampling distribution deviates from normality (p = %.4f)\n",
                normality_n10$Shapiro_p[i]))
  }

  skew <- sampling_stats_n10$Skewness[sampling_stats_n10$Variable == var_name]
  cat(sprintf("  - Skewness: %.3f %s\n", skew,
              ifelse(abs(skew) < 0.5, "(approximately symmetric)",
                     ifelse(skew > 0, "(right-skewed)", "(left-skewed)"))))

  pop_mean <- sampling_stats_n10$Pop_Mean[sampling_stats_n10$Variable == var_name]
  sample_mean <- sampling_stats_n10$Mean_of_Means[sampling_stats_n10$Variable == var_name]
  cat(sprintf("  - Population mean: %.3f\n", pop_mean))
  cat(sprintf("  - Mean of sample means: %.3f (difference: %.3f)\n",
              sample_mean, abs(pop_mean - sample_mean)))

  se_obs <- sampling_stats_n10$SD_of_Means[sampling_stats_n10$Variable == var_name]
  se_theory <- sampling_stats_n10$SE_Theoretical[sampling_stats_n10$Variable == var_name]
  cat(sprintf("  - Observed SE: %.3f\n", se_obs))
  cat(sprintf("  - Theoretical SE: %.3f (ratio: %.3f)\n",
              se_theory, se_obs / se_theory))
}

cat("\n\nOVERALL CONCLUSION FOR n = 10:\n")
normal_count_n10 <- sum(normality_n10$Normal == "Yes")
cat(sprintf("- %d out of %d variables show approximately normal sampling distributions\n",
            normal_count_n10, nrow(normality_n10)))

if (normal_count_n10 > normal_count_n5) {
  cat("- IMPROVEMENT over n = 5: More variables show normality\n")
} else if (normal_count_n10 == normal_count_n5) {
  cat("- Similar to n = 5 in terms of normality\n")
}

if (normal_count_n10 == nrow(normality_n10)) {
  cat("- CLT holds for all variables at n = 10\n")
} else if (normal_count_n10 > nrow(normality_n10) / 2) {
  cat("- CLT holds for most variables at n = 10\n")
} else {
  cat("- CLT does NOT hold for most variables at n = 10\n")
}
```

---

# Problem 6.62: Samples of Size 20

```{r samples-n20}
cat("\n=== PROBLEM 6.62: CENTRAL LIMIT THEOREM WITH n = 20 ===\n\n")

# Generate sampling distributions for all variables with n=20
sampling_dist_n20 <- map_df(dietary_vars, ~generate_sampling_dist(
  valid_data, .x, sample_size = 20, n_samples = n_samples
))

# Calculate statistics
sampling_stats_n20 <- sampling_dist_n20 %>%
  group_by(Variable, Sample_Size) %>%
  summarise(
    N_Samples = n(),
    Mean_of_Means = mean(Sample_Mean),
    SD_of_Means = sd(Sample_Mean),
    SE_Theoretical = pop_stats$SD[pop_stats$Variable == Variable[1]] / sqrt(Sample_Size[1]),
    Skewness = skewness(Sample_Mean),
    Kurtosis = kurtosis(Sample_Mean),
    .groups = "drop"
  ) %>%
  left_join(pop_stats %>% select(Variable, Pop_Mean = Mean, Pop_SD = SD),
            by = "Variable")

cat("Sampling Distribution Statistics (n = 20):\n")
sampling_stats_n20 %>%
  kable(digits = 3, caption = "Sampling Distribution with n = 20")

# Normality tests
normality_n20 <- sampling_dist_n20 %>%
  group_by(Variable) %>%
  summarise(
    Shapiro_W = shapiro.test(Sample_Mean)$statistic,
    Shapiro_p = shapiro.test(Sample_Mean)$p.value,
    Normal = ifelse(Shapiro_p > 0.05, "Yes", "No"),
    .groups = "drop"
  )

cat("\n\nNormality Tests (n = 20):\n")
normality_n20 %>%
  kable(digits = 4, caption = "Shapiro-Wilk Tests for Sampling Distributions (n = 20)")
```

## Visualizations: n = 20

```{r plots-n20, fig.height=16}
# Histograms with normal overlay
p1_n20 <- ggplot(sampling_dist_n20, aes(x = Sample_Mean)) +
  geom_histogram(aes(y = ..density..), bins = 40,
                 fill = "purple", alpha = 0.7) +
  geom_density(color = "purple4", size = 1.2) +
  stat_function(
    fun = dnorm,
    args = list(
      mean = sampling_stats_n20$Mean_of_Means[1],
      sd = sampling_stats_n20$SD_of_Means[1]
    ),
    color = "blue", size = 1, linetype = "dashed"
  ) +
  facet_wrap(~ Variable, scales = "free", ncol = 2) +
  labs(title = "Sampling Distributions: n = 20",
       subtitle = "Purple: actual density; Blue dashed: theoretical normal distribution",
       x = "Sample Mean",
       y = "Density") +
  theme_minimal() +
  theme(plot.title = element_text(size = 14, face = "bold"))

# Q-Q plots
p2_n20 <- ggplot(sampling_dist_n20, aes(sample = Sample_Mean)) +
  stat_qq(color = "purple", size = 1) +
  stat_qq_line(color = "blue", size = 1) +
  facet_wrap(~ Variable, scales = "free", ncol = 2) +
  labs(title = "Q-Q Plots: n = 20",
       subtitle = "Assessing normality of sampling distributions",
       x = "Theoretical Quantiles",
       y = "Sample Quantiles") +
  theme_minimal()

grid.arrange(p1_n20, p2_n20, ncol = 1, heights = c(1.2, 1))
```

## Assessment: n = 20

```{r assessment-n20}
cat("\n\n=== ASSESSMENT: DOES CLT HOLD FOR n = 20? ===\n\n")

for (i in 1:nrow(normality_n20)) {
  var_name <- normality_n20$Variable[i]
  cat(sprintf("\n%s:\n", var_name))

  if (normality_n20$Normal[i] == "Yes") {
    cat(sprintf("  ✓ Sampling distribution appears normal (p = %.4f)\n",
                normality_n20$Shapiro_p[i]))
  } else {
    cat(sprintf("  ✗ Sampling distribution deviates from normality (p = %.4f)\n",
                normality_n20$Shapiro_p[i]))
  }

  skew <- sampling_stats_n20$Skewness[sampling_stats_n20$Variable == var_name]
  cat(sprintf("  - Skewness: %.3f %s\n", skew,
              ifelse(abs(skew) < 0.5, "(approximately symmetric)",
                     ifelse(skew > 0, "(right-skewed)", "(left-skewed)"))))

  pop_mean <- sampling_stats_n20$Pop_Mean[sampling_stats_n20$Variable == var_name]
  sample_mean <- sampling_stats_n20$Mean_of_Means[sampling_stats_n20$Variable == var_name]
  cat(sprintf("  - Population mean: %.3f\n", pop_mean))
  cat(sprintf("  - Mean of sample means: %.3f (difference: %.3f)\n",
              sample_mean, abs(pop_mean - sample_mean)))

  se_obs <- sampling_stats_n20$SD_of_Means[sampling_stats_n20$Variable == var_name]
  se_theory <- sampling_stats_n20$SE_Theoretical[sampling_stats_n20$Variable == var_name]
  cat(sprintf("  - Observed SE: %.3f\n", se_obs))
  cat(sprintf("  - Theoretical SE: %.3f (ratio: %.3f)\n",
              se_theory, se_obs / se_theory))
}

cat("\n\nOVERALL CONCLUSION FOR n = 20:\n")
normal_count_n20 <- sum(normality_n20$Normal == "Yes")
cat(sprintf("- %d out of %d variables show approximately normal sampling distributions\n",
            normal_count_n20, nrow(normality_n20)))

if (normal_count_n20 > normal_count_n10) {
  cat("- IMPROVEMENT over n = 10: More variables show normality\n")
} else if (normal_count_n20 == normal_count_n10) {
  cat("- Similar to n = 10 in terms of normality\n")
}

if (normal_count_n20 == nrow(normality_n20)) {
  cat("- CLT holds STRONGLY for all variables at n = 20\n")
  cat("- This is the expected behavior of the Central Limit Theorem\n")
} else if (normal_count_n20 > nrow(normality_n20) / 2) {
  cat("- CLT holds for most variables at n = 20\n")
}
```

---

# Problem 6.63: Comparison Across Sample Sizes

```{r comparison}
cat("\n=== PROBLEM 6.63: COMPARISON OF SAMPLING DISTRIBUTIONS ===\n\n")

# Combine all sampling distributions
all_sampling_dist <- bind_rows(
  sampling_dist_n5,
  sampling_dist_n10,
  sampling_dist_n20
) %>%
  mutate(Sample_Size = factor(Sample_Size, levels = c(5, 10, 20)))

# Combine all statistics
all_sampling_stats <- bind_rows(
  sampling_stats_n5 %>% mutate(Sample_Size = 5),
  sampling_stats_n10 %>% mutate(Sample_Size = 10),
  sampling_stats_n20 %>% mutate(Sample_Size = 20)
)

# Normality comparison
normality_comparison <- bind_rows(
  normality_n5 %>% mutate(Sample_Size = 5),
  normality_n10 %>% mutate(Sample_Size = 10),
  normality_n20 %>% mutate(Sample_Size = 20)
) %>%
  select(Variable, Sample_Size, Shapiro_W, Shapiro_p, Normal)

cat("Normality Test Results Across Sample Sizes:\n")
normality_comparison %>%
  pivot_wider(
    names_from = Sample_Size,
    values_from = c(Shapiro_p, Normal),
    names_sep = "_n"
  ) %>%
  kable(digits = 4, caption = "Shapiro-Wilk p-values and Normality Assessment")
```

## Graphical Comparison

```{r comparison-plots, fig.height=18}
# Select one representative variable for detailed comparison
example_var <- "cal_dr"

# Plot 1: Overlaid distributions
p_overlay <- all_sampling_dist %>%
  filter(Variable == example_var) %>%
  ggplot(aes(x = Sample_Mean, fill = Sample_Size, color = Sample_Size)) +
  geom_density(alpha = 0.4, size = 1) +
  labs(title = sprintf("Sampling Distributions of %s Across Sample Sizes", example_var),
       subtitle = "Notice how distribution becomes more normal as n increases",
       x = "Sample Mean",
       y = "Density",
       fill = "Sample Size",
       color = "Sample Size") +
  scale_fill_manual(values = c("coral", "forestgreen", "purple")) +
  scale_color_manual(values = c("darkred", "darkgreen", "purple4")) +
  theme_minimal() +
  theme(plot.title = element_text(size = 14, face = "bold"),
        legend.position = "top")

# Plot 2: Side-by-side comparison for all variables
p_facet <- ggplot(all_sampling_dist, aes(x = Sample_Mean, fill = Sample_Size)) +
  geom_histogram(aes(y = ..density..), bins = 30, alpha = 0.7, position = "identity") +
  facet_grid(Variable ~ Sample_Size, scales = "free") +
  labs(title = "Sampling Distributions: Comparison Across All Variables and Sample Sizes",
       subtitle = "Columns: Sample size | Rows: Variables",
       x = "Sample Mean",
       y = "Density") +
  scale_fill_manual(values = c("coral", "forestgreen", "purple")) +
  theme_minimal() +
  theme(legend.position = "none")

# Plot 3: Standard error comparison
p_se <- all_sampling_stats %>%
  select(Variable, Sample_Size, SD_of_Means, SE_Theoretical) %>%
  pivot_longer(cols = c(SD_of_Means, SE_Theoretical),
               names_to = "SE_Type", values_to = "SE_Value") %>%
  mutate(SE_Type = recode(SE_Type,
                          "SD_of_Means" = "Observed SE",
                          "SE_Theoretical" = "Theoretical SE")) %>%
  ggplot(aes(x = as.factor(Sample_Size), y = SE_Value,
             color = SE_Type, group = SE_Type)) +
  geom_line(size = 1) +
  geom_point(size = 3) +
  facet_wrap(~ Variable, scales = "free_y", ncol = 2) +
  labs(title = "Standard Error vs Sample Size",
       subtitle = "SE decreases as n increases (CLT prediction)",
       x = "Sample Size",
       y = "Standard Error",
       color = "Type") +
  scale_color_manual(values = c("darkblue", "red")) +
  theme_minimal() +
  theme(legend.position = "top")

# Plot 4: Skewness comparison
p_skew <- all_sampling_stats %>%
  ggplot(aes(x = as.factor(Sample_Size), y = abs(Skewness),
             color = Variable, group = Variable)) +
  geom_line(size = 1) +
  geom_point(size = 3) +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "red") +
  labs(title = "Absolute Skewness vs Sample Size",
       subtitle = "Skewness should decrease toward 0 as n increases",
       x = "Sample Size",
       y = "|Skewness|",
       color = "Variable") +
  theme_minimal() +
  theme(legend.position = "right")

grid.arrange(p_overlay, p_se, ncol = 1, heights = c(1, 1.2))
grid.arrange(p_facet, ncol = 1)
grid.arrange(p_skew, ncol = 1)
```

## Numeric Comparison

```{r numeric-comparison}
cat("\n\n=== NUMERIC COMPARISON ACROSS SAMPLE SIZES ===\n\n")

# Summary table
comparison_summary <- all_sampling_stats %>%
  select(Variable, Sample_Size, Mean_of_Means, SD_of_Means,
         SE_Theoretical, Skewness) %>%
  arrange(Variable, Sample_Size)

cat("Statistics by Variable and Sample Size:\n")
comparison_summary %>%
  kable(digits = 3,
        caption = "Sampling Distribution Statistics Across Sample Sizes")

# Count normal distributions
normal_summary <- normality_comparison %>%
  group_by(Sample_Size) %>%
  summarise(
    Total_Variables = n(),
    Normal_Count = sum(Normal == "Yes"),
    Normal_Percentage = mean(Normal == "Yes") * 100,
    .groups = "drop"
  )

cat("\n\nNormality Achievement by Sample Size:\n")
normal_summary %>%
  kable(digits = 1,
        caption = "Percentage of Variables with Normal Sampling Distributions")

# SE reduction
se_reduction <- all_sampling_stats %>%
  select(Variable, Sample_Size, SD_of_Means) %>%
  pivot_wider(names_from = Sample_Size, values_from = SD_of_Means,
              names_prefix = "n") %>%
  mutate(
    Reduction_5_to_10 = (n5 - n10) / n5 * 100,
    Reduction_10_to_20 = (n10 - n20) / n10 * 100,
    Reduction_5_to_20 = (n5 - n20) / n5 * 100
  )

cat("\n\nStandard Error Reduction (%):\n")
se_reduction %>%
  select(Variable, Reduction_5_to_10, Reduction_10_to_20, Reduction_5_to_20) %>%
  kable(digits = 1,
        caption = "Percentage Reduction in Standard Error",
        col.names = c("Variable", "n=5 to n=10", "n=10 to n=20", "n=5 to n=20"))
```

## Key Findings

```{r key-findings}
cat("\n\n=== KEY FINDINGS: PROBLEM 6.63 ===\n\n")

cat("1. NORMALITY PROGRESSION:\n")
cat(sprintf("   - n = 5:  %d/%d variables (%.0f%%) show normal sampling distributions\n",
            normal_count_n5, nrow(normality_n5),
            normal_count_n5 / nrow(normality_n5) * 100))
cat(sprintf("   - n = 10: %d/%d variables (%.0f%%) show normal sampling distributions\n",
            normal_count_n10, nrow(normality_n10),
            normal_count_n10 / nrow(normality_n10) * 100))
cat(sprintf("   - n = 20: %d/%d variables (%.0f%%) show normal sampling distributions\n",
            normal_count_n20, nrow(normality_n20),
            normal_count_n20 / nrow(normality_n20) * 100))

cat("\n2. STANDARD ERROR BEHAVIOR:\n")
avg_se_n5 <- mean(all_sampling_stats$SD_of_Means[all_sampling_stats$Sample_Size == 5])
avg_se_n10 <- mean(all_sampling_stats$SD_of_Means[all_sampling_stats$Sample_Size == 10])
avg_se_n20 <- mean(all_sampling_stats$SD_of_Means[all_sampling_stats$Sample_Size == 20])

cat(sprintf("   - Average SE (n=5):  %.3f\n", avg_se_n5))
cat(sprintf("   - Average SE (n=10): %.3f (%.1f%% reduction from n=5)\n",
            avg_se_n10, (avg_se_n5 - avg_se_n10) / avg_se_n5 * 100))
cat(sprintf("   - Average SE (n=20): %.3f (%.1f%% reduction from n=5)\n",
            avg_se_n20, (avg_se_n5 - avg_se_n20) / avg_se_n5 * 100))
cat("   - SE decreases approximately by 1/√n as predicted by CLT\n")

cat("\n3. SKEWNESS REDUCTION:\n")
avg_skew_n5 <- mean(abs(all_sampling_stats$Skewness[all_sampling_stats$Sample_Size == 5]))
avg_skew_n10 <- mean(abs(all_sampling_stats$Skewness[all_sampling_stats$Sample_Size == 10]))
avg_skew_n20 <- mean(abs(all_sampling_stats$Skewness[all_sampling_stats$Sample_Size == 20]))

cat(sprintf("   - Average |skewness| (n=5):  %.3f\n", avg_skew_n5))
cat(sprintf("   - Average |skewness| (n=10): %.3f\n", avg_skew_n10))
cat(sprintf("   - Average |skewness| (n=20): %.3f\n", avg_skew_n20))
cat("   - Skewness approaches 0 (symmetry) as n increases\n")

cat("\n4. CONVERGENCE TO POPULATION MEAN:\n")
cat("   - All sample sizes produce unbiased estimates of population mean\n")
cat("   - Mean of sample means ≈ population mean for all n\n")

cat("\n5. PRACTICAL IMPLICATIONS:\n")
if (normal_count_n20 == nrow(normality_n20)) {
  cat("   - By n = 20, CLT holds for ALL dietary variables\n")
  cat("   - Sample size of 20 is sufficient for inference using normal theory\n")
} else {
  cat("   - Some variables may require n > 20 for CLT to fully apply\n")
}

cat("   - Even n = 5 shows CLT effects for some variables\n")
cat("   - Larger samples provide more precise estimates (smaller SE)\n")
```

---

# Overall Conclusions

```{r overall-conclusions}
cat("\n\n=== OVERALL CONCLUSIONS ===\n\n")

cat("CENTRAL LIMIT THEOREM DEMONSTRATION:\n\n")

cat("1. THE CLT IN ACTION:\n")
cat("   - Sampling distributions become increasingly normal as n increases\n")
cat("   - This occurs regardless of the shape of the population distribution\n")
cat("   - By n = 20, normality is achieved for most/all variables\n")

cat("\n2. SAMPLE SIZE REQUIREMENTS:\n")
cat("   - Highly skewed populations (e.g., alcohol) require larger n\n")
cat("   - More symmetric populations (e.g., total fat) achieve normality with smaller n\n")
cat("   - General rule: n ≥ 30 for CLT, but often n = 20 is sufficient\n")

cat("\n3. STATISTICAL PROPERTIES:\n")
cat("   - Mean: E(X̄) = μ for all sample sizes (unbiased)\n")
cat("   - Variance: Var(X̄) = σ²/n (decreases with n)\n")
cat("   - Standard Error: SE = σ/√n (decreases with √n)\n")
cat("   - Distribution: Approaches N(μ, σ²/n) as n increases\n")

cat("\n4. IMPLICATIONS FOR INFERENCE:\n")
cat("   - Larger samples provide more precise estimates\n")
cat("   - Normal-based inference (t-tests, z-tests) valid when CLT applies\n")
cat("   - Can use parametric methods even with non-normal populations\n")

cat("\n5. DIETARY DATA SPECIFIC:\n")
cat("   - Most dietary variables show reasonable normality by n = 10\n")
cat("   - Alcohol consumption may require larger samples due to zero-inflation\n")
cat("   - Fat and calorie variables behave well even at small n\n")

cat("\n\nVERIFICATION OF CLT PRINCIPLES:\n")
cat("✓ Sampling distributions become more normal as n increases\n")
cat("✓ Standard errors decrease by factor of √n\n")
cat("✓ Sample means are unbiased estimates of population mean\n")
cat("✓ Variance of sample means = population variance / n\n")
cat("✓ CLT applies even to non-normal populations\n")
```

---

# Session Information

```{r session-info}
sessionInfo()
```
