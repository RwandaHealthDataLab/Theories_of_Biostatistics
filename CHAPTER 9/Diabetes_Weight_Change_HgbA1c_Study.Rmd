---
title: "Diabetes - Weight Change and Insulin Consistency in Adolescent Boys"
subtitle: "Nonparametric Analysis of Paired Periods"
author: "Biostatistics Analysis"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
    theme: united
    highlight: tango
    fig_width: 10
    fig_height: 6
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.align = 'center'
)
```

# Introduction

This document analyzes data from a study of adolescent boys with Type I diabetes examining the relationship between consistency in taking insulin injections and weight change during growth. The study uses a **matched pairs design** where each boy serves as his own control.

## Study Background

Growth during adolescence among girls with diabetes has been shown to relate to consistency in taking insulin injections. This study tested a similar hypothesis in **adolescent boys ages 13-17**.

### Study Design

- **Participants**: 23 adolescent boys with Type I diabetes
- **Measurements**: Weight and HgbA1c measured at repeated visits ~90 days apart
- **HgbA1c**: A marker reflecting consistency in taking insulin injections over the past 30 days
  - People with diabetes have higher-than-normal HgbA1c
  - Goal of insulin treatment: Lower HgbA1c as much as possible
  - Higher HgbA1c indicates poor glycemic control/inconsistent insulin use

### Matched Periods Design

Each boy was ascertained during TWO different 90-day intervals:

1. **Control Period**: HgbA1c change was minimal (change < 1%)
   - Indicates consistent insulin use

2. **Lack-of-Consistency Period**: HgbA1c increased by ≥ 1%
   - Fairly large increase indicating lack of consistency in taking insulin

### Outcome Measure

$$\Delta = \text{(Weight change, control period)} - \text{(Weight change, lack-of-consistency period)}$$

**Interpretation**:
- **Positive Δ**: Greater weight gain during control (consistent insulin) period
- **Negative Δ**: Greater weight gain during lack-of-consistency period
- **Zero Δ**: No difference in weight change between periods

## Research Hypothesis

**Alternative Hypothesis**: Consistency in taking insulin injections affects weight change during adolescent growth

**Null Hypothesis**: There is no difference in weight change between control and lack-of-consistency periods

---

# Data: Table 9.13

The frequency distribution of Δ values sorted in increasing order:

```{r data-table-913}
# Data from Table 9.13
# Delta values: (weight change, control) - (weight change, lack-of-consistency)
delta_values <- c(
  -5.9, -4.0, -3.7, -3.2, -2.7, -2.5, -2.3, -1.6,
  -1.4, -0.9, -0.5, -0.2, 0.2, 0.4, 0.5, 1.1,
  1.4, 1.6, 2.3, 3.6, 4.1, 5.4, 5.9
)

n_boys <- length(delta_values)

cat("=== DATA SUMMARY ===\n\n")
cat(sprintf("Number of boys: %d\n\n", n_boys))

cat("Delta values (kg) in increasing order:\n")
cat(sprintf("%.1f ", delta_values))
cat("\n\n")

# Create data frame for analysis
diabetes_data <- data.frame(
  Boy_ID = 1:n_boys,
  Delta = delta_values
)

# Display as formatted table
library(knitr)
kable(matrix(delta_values, nrow = 1),
      caption = "Weight Change Differences (Δ) in kg: Control Period - Lack-of-Consistency Period",
      digits = 1,
      col.names = paste0("Boy ", 1:n_boys))
```

---

# Descriptive Statistics

```{r descriptives}
library(tidyverse)

cat("=== DESCRIPTIVE STATISTICS ===\n\n")

# Summary statistics
summary_stats <- data.frame(
  Statistic = c("N", "Mean", "Median", "SD", "Min", "Q1", "Q3", "Max", "IQR", "Range"),
  Value = c(
    n_boys,
    mean(delta_values),
    median(delta_values),
    sd(delta_values),
    min(delta_values),
    quantile(delta_values, 0.25),
    quantile(delta_values, 0.75),
    max(delta_values),
    IQR(delta_values),
    max(delta_values) - min(delta_values)
  )
)

kable(summary_stats,
      caption = "Summary Statistics for Δ (kg)",
      digits = 3,
      col.names = c("Statistic", "Value (kg)"))

# Count positive, negative, and zero differences
n_positive <- sum(delta_values > 0)
n_negative <- sum(delta_values < 0)
n_zero <- sum(delta_values == 0)

cat("\n--- Direction of Differences ---\n\n")
cat(sprintf("Positive Δ (more weight gain in control period): %d (%.1f%%)\n",
            n_positive, 100 * n_positive / n_boys))
cat(sprintf("Negative Δ (more weight gain in lack-of-consistency period): %d (%.1f%%)\n",
            n_negative, 100 * n_negative / n_boys))
cat(sprintf("Zero Δ (equal weight change): %d (%.1f%%)\n",
            n_zero, 100 * n_zero / n_boys))

cat("\n--- Interpretation ---\n\n")
if (n_positive > n_negative) {
  cat("MAJORITY of boys gained MORE weight during the CONTROL period\n")
  cat("(when HgbA1c was stable, indicating consistent insulin use)\n")
} else if (n_negative > n_positive) {
  cat("MAJORITY of boys gained MORE weight during the LACK-OF-CONSISTENCY period\n")
  cat("(when HgbA1c increased, indicating inconsistent insulin use)\n")
} else {
  cat("Equal number of boys in each direction\n")
}
```

---

# Visualizations

```{r visualizations, fig.width=12, fig.height=10}
library(ggplot2)

# Create comprehensive visualizations

# 1. Histogram of Delta values
p1 <- ggplot(diabetes_data, aes(x = Delta)) +
  geom_histogram(bins = 12, fill = "#3498DB", alpha = 0.7, color = "black") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "red", linewidth = 1.2) +
  geom_vline(xintercept = median(delta_values), linetype = "solid", color = "blue", linewidth = 1.2) +
  labs(
    title = "Distribution of Weight Change Differences (Δ)",
    subtitle = "Red dashed = 0 (no difference), Blue solid = Median",
    x = "Δ = Weight Change (Control) - Weight Change (Lack-of-Consistency) [kg]",
    y = "Frequency"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5)) +
  annotate("text", x = 4, y = 5,
           label = paste0("Median = ", round(median(delta_values), 2), " kg"),
           color = "blue", fontface = "bold")

# 2. Dot plot with individual values
p2 <- ggplot(diabetes_data, aes(x = Delta, y = 0)) +
  geom_hline(yintercept = 0, color = "gray80") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "red", linewidth = 1) +
  geom_point(aes(color = ifelse(Delta > 0, "Positive", "Negative")),
             size = 4, alpha = 0.7) +
  scale_color_manual(values = c("Positive" = "#27AE60", "Negative" = "#E74C3C"),
                     name = "Direction") +
  labs(
    title = "Individual Delta Values for Each Boy",
    x = "Δ (kg)",
    y = ""
  ) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank())

# 3. Box plot
p3 <- ggplot(diabetes_data, aes(x = "", y = Delta)) +
  geom_boxplot(fill = "#3498DB", alpha = 0.5, outlier.color = "red", outlier.size = 3) +
  geom_jitter(width = 0.2, alpha = 0.5, size = 2.5) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red", linewidth = 1) +
  labs(
    title = "Box Plot of Weight Change Differences",
    x = "",
    y = "Δ (kg)"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold")) +
  coord_flip()

# 4. Q-Q plot for normality assessment
p4 <- ggplot(diabetes_data, aes(sample = Delta)) +
  stat_qq() +
  stat_qq_line(color = "red", linewidth = 1) +
  labs(
    title = "Q-Q Plot: Normality Assessment",
    x = "Theoretical Quantiles",
    y = "Sample Quantiles"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))

# Arrange plots
gridExtra::grid.arrange(p1, p2, p3, p4, ncol = 2)
```

---

# Sign Test

The **sign test** is the simplest nonparametric test for paired data. It only uses the direction (sign) of the differences, not their magnitude.

```{r sign-test}
cat("=== SIGN TEST ===\n\n")

cat("Null Hypothesis (H₀): Median difference = 0\n")
cat("Alternative Hypothesis (Hₐ): Median difference ≠ 0\n\n")

# Perform sign test using binom.test
# Under H0, P(positive) = 0.5
# Test statistic = number of positive differences

cat("--- Test Statistic ---\n\n")
cat(sprintf("Number of positive differences: %d\n", n_positive))
cat(sprintf("Number of negative differences: %d\n", n_negative))
cat(sprintf("Number of zero differences: %d (excluded)\n", n_zero))
cat(sprintf("Number of usable pairs (n): %d\n\n", n_positive + n_negative))

# Binomial test (two-sided)
sign_test <- binom.test(n_positive, n_positive + n_negative, p = 0.5,
                        alternative = "two.sided")

cat("--- Test Results ---\n\n")
cat(sprintf("Observed proportion positive: %.4f\n", n_positive / (n_positive + n_negative)))
cat(sprintf("Expected under H₀: 0.5000\n"))
cat(sprintf("p-value (two-sided): %.6f\n\n", sign_test$p.value))

cat("--- 95% Confidence Interval for True Proportion ---\n\n")
cat(sprintf("[%.4f, %.4f]\n\n", sign_test$conf.int[1], sign_test$conf.int[2]))

cat("--- Conclusion ---\n\n")
if (sign_test$p.value < 0.05) {
  cat("At α = 0.05, we REJECT the null hypothesis.\n")
  cat("There is significant evidence that the median difference is not zero.\n\n")
  if (n_positive > n_negative) {
    cat("INTERPRETATION: Boys tend to gain MORE weight during the CONTROL period\n")
    cat("(when taking insulin consistently, indicated by stable HgbA1c)\n")
  } else {
    cat("INTERPRETATION: Boys tend to gain MORE weight during the LACK-OF-CONSISTENCY period\n")
    cat("(when not taking insulin consistently, indicated by rising HgbA1c)\n")
  }
} else {
  cat("At α = 0.05, we FAIL TO REJECT the null hypothesis.\n")
  cat("There is insufficient evidence that the median difference differs from zero.\n")
}
```

---

# Wilcoxon Signed-Rank Test

The **Wilcoxon signed-rank test** uses both the direction AND magnitude of differences, making it more powerful than the sign test when applicable.

```{r wilcoxon-test}
cat("\n\n=== WILCOXON SIGNED-RANK TEST ===\n\n")

cat("Null Hypothesis (H₀): Pseudomedian difference = 0\n")
cat("Alternative Hypothesis (Hₐ): Pseudomedian difference ≠ 0\n\n")

# Perform Wilcoxon signed-rank test
wilcox_test <- wilcox.test(delta_values,
                           alternative = "two.sided",
                           mu = 0,
                           exact = FALSE,
                           correct = TRUE,
                           conf.int = TRUE)

cat("--- Test Results ---\n\n")
cat(sprintf("Test Statistic (V): %.1f\n", wilcox_test$statistic))
cat(sprintf("p-value: %.6f\n\n", wilcox_test$p.value))

cat("--- Effect Size Estimate ---\n\n")
cat(sprintf("Pseudomedian (Hodges-Lehmann estimator): %.4f kg\n", wilcox_test$estimate))
cat(sprintf("95%% Confidence Interval: [%.4f, %.4f] kg\n\n",
            wilcox_test$conf.int[1], wilcox_test$conf.int[2]))

cat("--- Conclusion ---\n\n")
if (wilcox_test$p.value < 0.05) {
  cat("At α = 0.05, we REJECT the null hypothesis.\n")
  cat("There is significant evidence that weight change differs between periods.\n\n")
  if (wilcox_test$estimate > 0) {
    cat(sprintf("INTERPRETATION: Boys gained approximately %.2f kg MORE weight\n", wilcox_test$estimate))
    cat("during the CONTROL period (consistent insulin use) compared to\n")
    cat("the LACK-OF-CONSISTENCY period.\n")
  } else {
    cat(sprintf("INTERPRETATION: Boys gained approximately %.2f kg MORE weight\n", abs(wilcox_test$estimate)))
    cat("during the LACK-OF-CONSISTENCY period compared to\n")
    cat("the CONTROL period (consistent insulin use).\n")
  }
} else {
  cat("At α = 0.05, we FAIL TO REJECT the null hypothesis.\n")
  cat("There is insufficient evidence of a difference in weight change between periods.\n")
}

# Calculate effect size (rank-biserial correlation)
# r = Z / sqrt(N)
# For Wilcoxon, approximate Z-score
z_approx <- qnorm(wilcox_test$p.value / 2, lower.tail = FALSE)
r_effect <- z_approx / sqrt(n_boys)

cat("\n--- Effect Size (Rank-Biserial Correlation) ---\n\n")
cat(sprintf("r = %.3f\n", r_effect))
cat("Interpretation: ", ifelse(abs(r_effect) < 0.3, "Small",
                               ifelse(abs(r_effect) < 0.5, "Medium", "Large")), " effect\n")
```

---

# Comparison with Parametric Method

Let's compare the nonparametric results with a parametric **one-sample t-test** on the differences.

```{r parametric-comparison}
cat("\n\n=== PARAMETRIC ANALYSIS: ONE-SAMPLE T-TEST ===\n\n")

# One-sample t-test (testing if mean difference = 0)
ttest_result <- t.test(delta_values, mu = 0, alternative = "two.sided")

print(ttest_result)

cat("\n--- Summary ---\n\n")
cat(sprintf("t-statistic: %.4f\n", ttest_result$statistic))
cat(sprintf("df: %d\n", ttest_result$parameter))
cat(sprintf("p-value: %.6f\n", ttest_result$p.value))
cat(sprintf("Mean difference: %.4f kg\n", ttest_result$estimate))
cat(sprintf("95%% CI: [%.4f, %.4f] kg\n\n",
            ttest_result$conf.int[1], ttest_result$conf.int[2]))

# Check normality assumption
cat("--- Normality Assessment ---\n\n")
shapiro_test <- shapiro.test(delta_values)
cat(sprintf("Shapiro-Wilk test: W = %.4f, p-value = %.6f\n",
            shapiro_test$statistic, shapiro_test$p.value))
cat(sprintf("Normality assumption: %s\n\n",
            ifelse(shapiro_test$p.value > 0.05, "SATISFIED", "VIOLATED")))

if (shapiro_test$p.value < 0.05) {
  cat("WARNING: Normality assumption is violated.\n")
  cat("The nonparametric Wilcoxon test is more appropriate.\n\n")
}

# Comparison table
cat("--- Comparison of Methods ---\n\n")
comparison <- data.frame(
  Method = c("Sign Test", "Wilcoxon Signed-Rank", "One-Sample t-test"),
  Test_Statistic = c(
    sprintf("%d positive", n_positive),
    sprintf("V = %.1f", wilcox_test$statistic),
    sprintf("t = %.4f", ttest_result$statistic)
  ),
  P_Value = c(
    sprintf("%.6f", sign_test$p.value),
    sprintf("%.6f", wilcox_test$p.value),
    sprintf("%.6f", ttest_result$p.value)
  ),
  Estimate = c(
    "N/A",
    sprintf("%.4f kg", wilcox_test$estimate),
    sprintf("%.4f kg", ttest_result$estimate)
  ),
  Significant = c(
    ifelse(sign_test$p.value < 0.05, "YES", "NO"),
    ifelse(wilcox_test$p.value < 0.05, "YES", "NO"),
    ifelse(ttest_result$p.value < 0.05, "YES", "NO")
  )
)

kable(comparison,
      caption = "Comparison of Statistical Tests",
      col.names = c("Method", "Test Statistic", "p-value", "Estimate", "Significant (α=0.05)?"))
```

---

# Clinical and Biological Interpretation

```{r clinical-interpretation}
cat("\n\n=== CLINICAL AND BIOLOGICAL INTERPRETATION ===\n\n")

cat("1. STUDY DESIGN STRENGTHS:\n\n")
cat("   a) Matched Pairs Design:\n")
cat("      - Each boy serves as his own control\n")
cat("      - Eliminates between-subject variability\n")
cat("      - Controls for genetic and environmental factors\n")
cat("      - Increases statistical power\n\n")

cat("   b) Objective Biomarker:\n")
cat("      - HgbA1c provides objective measure of insulin consistency\n")
cat("      - Not subject to self-report bias\n")
cat("      - Reflects 30-day average glucose control\n\n")

cat("2. BIOLOGICAL MECHANISM:\n\n")
cat("   Insulin and Growth in Adolescence:\n\n")
cat("   a) Insulin is an ANABOLIC hormone:\n")
cat("      - Promotes protein synthesis\n")
cat("      - Facilitates glucose uptake into cells\n")
cat("      - Essential for normal growth\n\n")

cat("   b) In adolescent boys with diabetes:\n")
cat("      - Growth spurt requires adequate nutrition AND insulin\n")
cat("      - Consistent insulin → better glucose control → anabolic state\n")
cat("      - Inconsistent insulin → hyperglycemia → catabolic state\n\n")

cat("   c) Expected pattern:\n")
if (median(delta_values) > 0) {
  cat("      OBSERVED: More weight gain during CONTROL period (consistent insulin)\n")
  cat("      This is the EXPECTED pattern:\n")
  cat("      - Consistent insulin use → better glucose utilization\n")
  cat("      - Better glycemic control → more efficient growth\n")
  cat("      - Appropriate weight gain for healthy development\n\n")
} else {
  cat("      OBSERVED: More weight gain during LACK-OF-CONSISTENCY period\n")
  cat("      This is UNEXPECTED and may indicate:\n")
  cat("      - Rebound weight gain after period of poor control\n")
  cat("      - Possible overcompensation in insulin during recovery\n")
  cat("      - Individual variation in metabolic response\n\n")
}

cat("3. PUBLIC HEALTH IMPLICATIONS:\n\n")
cat("   a) Adolescent Compliance:\n")
cat("      - Adolescence is challenging period for diabetes management\n")
cat("      - Peer pressure, independence, body image concerns\n")
cat("      - Need for tailored interventions for teens\n\n")

cat("   b) Growth Monitoring:\n")
cat("      - Regular weight and HgbA1c monitoring essential\n")
cat("      - Growth patterns can indicate treatment adherence\n")
cat("      - Early intervention for non-adherence important\n\n")

cat("   c) Clinical Recommendations:\n")
cat("      - Emphasize importance of consistent insulin use\n")
cat("      - Link insulin consistency to healthy growth\n")
cat("      - Involve adolescents in treatment decisions\n")
cat("      - Provide support systems for adherence\n\n")

cat("4. STATISTICAL METHOD CHOICE:\n\n")
cat(sprintf("   Normality assessment: p = %.4f\n", shapiro_test$p.value))
if (shapiro_test$p.value < 0.05) {
  cat("   Recommendation: USE NONPARAMETRIC METHODS\n")
  cat("   Reason: Normality assumption violated\n\n")
} else {
  cat("   Normality assumption satisfied\n")
  cat("   Both parametric and nonparametric methods valid\n\n")
}

cat("   Advantages of Nonparametric Methods:\n")
cat("   - Robust to outliers\n")
cat("   - No distributional assumptions\n")
cat("   - Appropriate for small samples\n")
cat("   - Sign test: Very simple, minimal assumptions\n")
cat("   - Wilcoxon: Uses magnitude information, more powerful\n\n")

cat("5. STUDY LIMITATIONS:\n\n")
cat("   a) Sample size: n = 23 boys\n")
cat("      - Moderate sample size\n")
cat("      - Nonparametric methods appropriate\n\n")

cat("   b) Selection of periods:\n")
cat("      - Each boy had different periods selected\n")
cat("      - Periods may not be randomly distributed in time\n\n")

cat("   c) Other factors:\n")
cat("      - Diet not controlled\n")
cat("      - Physical activity not measured\n")
cat("      - Pubertal stage may vary\n\n")
```

---

# Summary and Conclusions

```{r final-summary}
cat("\n\n=== FINAL SUMMARY ===\n\n")

cat("RESEARCH QUESTION:\n")
cat("Does consistency in taking insulin injections affect weight change\n")
cat("during adolescence in boys with Type I diabetes?\n\n")

cat("STUDY DESIGN:\n")
cat(sprintf("- Sample: %d adolescent boys (ages 13-17)\n", n_boys))
cat("- Design: Matched pairs (each boy = own control)\n")
cat("- Periods: Control (HgbA1c stable) vs Lack-of-consistency (HgbA1c ↑≥1%)\n")
cat("- Outcome: Δ = Weight change (control) - Weight change (lack-of-consistency)\n\n")

cat("DESCRIPTIVE RESULTS:\n")
cat(sprintf("- Median Δ: %.2f kg\n", median(delta_values)))
cat(sprintf("- Mean Δ: %.2f kg\n", mean(delta_values)))
cat(sprintf("- Positive Δ: %d boys (%.1f%%)\n", n_positive, 100*n_positive/n_boys))
cat(sprintf("- Negative Δ: %d boys (%.1f%%)\n\n", n_negative, 100*n_negative/n_boys))

cat("STATISTICAL TESTS:\n\n")
cat("1. Sign Test:\n")
cat(sprintf("   - p-value: %.6f\n", sign_test$p.value))
cat(sprintf("   - Significant? %s\n\n", ifelse(sign_test$p.value < 0.05, "YES", "NO")))

cat("2. Wilcoxon Signed-Rank Test:\n")
cat(sprintf("   - p-value: %.6f\n", wilcox_test$p.value))
cat(sprintf("   - Pseudomedian: %.4f kg\n", wilcox_test$estimate))
cat(sprintf("   - 95%% CI: [%.4f, %.4f] kg\n", wilcox_test$conf.int[1], wilcox_test$conf.int[2]))
cat(sprintf("   - Significant? %s\n\n", ifelse(wilcox_test$p.value < 0.05, "YES", "NO")))

cat("3. One-Sample t-test (for comparison):\n")
cat(sprintf("   - p-value: %.6f\n", ttest_result$p.value))
cat(sprintf("   - Mean difference: %.4f kg\n", ttest_result$estimate))
cat(sprintf("   - Significant? %s\n\n", ifelse(ttest_result$p.value < 0.05, "YES", "NO")))

cat("AGREEMENT BETWEEN METHODS:\n")
all_agree <- (sign_test$p.value < 0.05) == (wilcox_test$p.value < 0.05) &&
             (wilcox_test$p.value < 0.05) == (ttest_result$p.value < 0.05)
cat(sprintf("All three methods agree? %s\n\n", ifelse(all_agree, "YES", "NO")))

cat("FINAL CONCLUSION:\n")
if (wilcox_test$p.value < 0.05) {
  cat("There is SIGNIFICANT EVIDENCE that weight change differs between\n")
  cat("periods of consistent vs inconsistent insulin use.\n\n")

  if (wilcox_test$estimate > 0) {
    cat(sprintf("Boys gained approximately %.2f kg MORE weight during periods of\n", wilcox_test$estimate))
    cat("CONSISTENT insulin use (stable HgbA1c) compared to periods of\n")
    cat("inconsistent use (rising HgbA1c).\n\n")
    cat("CLINICAL IMPLICATION:\n")
    cat("Consistent insulin use is associated with better weight gain during\n")
    cat("adolescence, supporting the importance of treatment adherence for\n")
    cat("healthy growth and development in boys with Type I diabetes.\n")
  }
} else {
  cat("There is INSUFFICIENT EVIDENCE to conclude that weight change differs\n")
  cat("between periods of consistent vs inconsistent insulin use.\n\n")
  cat("However, this does not prove there is no effect; the study may be\n")
  cat("underpowered to detect a small to moderate effect with n = 23 boys.\n")
}

cat("\n\nRECOMMENDED METHOD:\n")
if (shapiro_test$p.value < 0.05) {
  cat("WILCOXON SIGNED-RANK TEST (nonparametric)\n")
  cat("Reason: Normality assumption violated; nonparametric more appropriate\n")
} else {
  cat("Either parametric or nonparametric methods are valid\n")
  cat("Wilcoxon signed-rank test provides robustness without loss of power\n")
}
```

---

# Session Information

```{r session-info}
sessionInfo()
```
