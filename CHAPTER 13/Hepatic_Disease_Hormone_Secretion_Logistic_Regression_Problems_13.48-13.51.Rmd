---
title: "Hepatic Disease: Hormone Effects on Biliary and Pancreatic Secretions"
subtitle: "Problems 13.48-13.51 - Logistic Regression Analysis"
author: "Biostatistics Analysis"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
    number_sections: true
    code_folding: show
    theme: flatly
    highlight: tango
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE,
                      fig.width = 12, fig.height = 8)
```

# Problem Statement

This analysis addresses Problems 13.48-13.51 examining hormone effects on hepatic secretions:

**Hormone Type Effects (Problems 13.48-13.49):**
- **13.48**: Assess whether presence of biliary secretions in Period 2 is related to hormone type
- **13.49**: Assess whether presence of pancreatic secretions in Period 2 is related to hormone type

**Hormone Dose Effects (Problems 13.50-13.51):**
- **13.50**: Assess whether presence of biliary secretions in Period 2 is related to hormone dose (separate analyses for each active hormone 2-5)
- **13.51**: Assess whether presence of pancreatic secretions in Period 2 is related to hormone dose (separate analyses for each active hormone 2-5)

# Background

## Study Design

This is a **crossover study** examining the effects of different gastrointestinal hormones on hepatic secretions:

**Hormones:**
1. **Hormone 1**: Placebo (control)
2. **Hormone 2**: Active hormone (type A)
3. **Hormone 3**: Active hormone (type B)
4. **Hormone 4**: Active hormone (type C)
5. **Hormone 5**: Active hormone (type D)

**Outcomes:**
- **Biliary secretions**: Bile secreted by the liver (0 = none, >0 = present)
- **Pancreatic secretions**: Pancreatic enzyme secretion (0 = none, >0 = present)

**Study Periods:**
- Each patient receives different hormone treatments across multiple periods
- We focus on **Period 2** (second period) outcomes
- Dose varies by treatment assignment

## Clinical Relevance

Understanding hormone effects on hepatic and pancreatic secretions is important for:
- Managing hepatobiliary disease
- Optimizing hormone replacement therapy
- Understanding digestive physiology
- Predicting drug interactions

# Load Required Libraries

```{r load-libraries}
library(tidyverse)      # Data manipulation and visualization
library(knitr)          # Tables
library(ggplot2)        # Advanced plotting
library(gridExtra)      # Multiple plots
library(car)            # ANOVA and regression diagnostics
library(broom)          # Tidy model outputs
library(pROC)           # ROC curves
library(ResourceSelection) # Hosmer-Lemeshow test
```

# Load and Prepare Data

## Load HORMONE.DAT

```{r load-data}
# Load hormone data
hormone_data <- read.table("Rosner_FundamentalsBiostatistics_8e_Data_Sets/ASCII-comma/HORMONE.DAT.txt",
                           header = TRUE,
                           sep = ",",
                           quote = "'\"",
                           strip.white = TRUE)

cat("Dataset dimensions:", nrow(hormone_data), "observations\n")
cat("Number of unique patients:", length(unique(hormone_data$ID)), "\n\n")

cat("First 15 observations:\n")
kable(head(hormone_data, 15),
      caption = "HORMONE.DAT - First 15 Observations")
```

## Data Structure

```{r data-structure}
# Display structure
str(hormone_data)

# Summary statistics
cat("\nSummary Statistics:\n")
summary(hormone_data)
```

## Create Analysis Variables

```{r create-variables}
# Focus on Period 2 (second period with 'pt' suffix)
# Create binary outcome variables for presence of secretions

hormone_clean <- hormone_data %>%
  mutate(
    # Binary outcomes for Period 2
    Biliary_Present = ifelse(Bilsecpt > 0, 1, 0),
    Pancreatic_Present = ifelse(Pansecpt > 0, 1, 0),

    # Hormone type as factor
    Hormone_Type = factor(Hormone,
                         levels = 1:5,
                         labels = c("Placebo", "Hormone 2", "Hormone 3",
                                   "Hormone 4", "Hormone 5")),

    # Active vs Placebo
    Active_Hormone = ifelse(Hormone == 1, "Placebo", "Active"),

    # Log dose (for dose-response analysis, adding small constant to handle 0)
    Log_Dose = log(Dose + 0.01)
  )

# Check for missing values
cat("Missing values in Period 2 variables:\n")
cat("Bilsecpt:", sum(is.na(hormone_clean$Bilsecpt)), "\n")
cat("Pansecpt:", sum(is.na(hormone_clean$Pansecpt)), "\n")
cat("Dose:", sum(is.na(hormone_clean$Dose)), "\n")
cat("Hormone:", sum(is.na(hormone_clean$Hormone)), "\n")
```

## Summary Statistics by Hormone Type

```{r summary-by-hormone}
# Biliary secretion presence by hormone type
bil_summary <- hormone_clean %>%
  group_by(Hormone_Type) %>%
  summarise(
    N = n(),
    N_Biliary_Present = sum(Biliary_Present),
    Percent_Biliary = round(100 * mean(Biliary_Present), 1),
    N_Pancreatic_Present = sum(Pancreatic_Present),
    Percent_Pancreatic = round(100 * mean(Pancreatic_Present), 1),
    Mean_Dose = round(mean(Dose, na.rm = TRUE), 2),
    SD_Dose = round(sd(Dose, na.rm = TRUE), 2),
    .groups = 'drop'
  )

kable(bil_summary,
      caption = "Secretion Presence by Hormone Type (Period 2)")
```

# Exploratory Data Analysis

## Secretion Patterns by Hormone Type

```{r secretion-patterns}
# Create visualization data
viz_data <- hormone_clean %>%
  group_by(Hormone_Type) %>%
  summarise(
    N = n(),
    Biliary = mean(Biliary_Present) * 100,
    Pancreatic = mean(Pancreatic_Present) * 100,
    .groups = 'drop'
  ) %>%
  pivot_longer(cols = c(Biliary, Pancreatic),
               names_to = "Secretion_Type",
               values_to = "Percent_Present")

# Bar plot
ggplot(viz_data, aes(x = Hormone_Type, y = Percent_Present, fill = Secretion_Type)) +
  geom_bar(stat = "identity", position = "dodge", alpha = 0.7) +
  geom_text(aes(label = paste0(round(Percent_Present, 1), "%")),
            position = position_dodge(width = 0.9),
            vjust = -0.5, size = 3) +
  labs(title = "Secretion Presence by Hormone Type (Period 2)",
       x = "Hormone Type",
       y = "Percent with Secretions Present",
       fill = "Secretion Type") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Dose Distribution by Hormone

```{r dose-distribution}
# Exclude placebo (dose = 0) for dose visualization
hormone_active <- hormone_clean %>%
  filter(Hormone != 1)

p1 <- ggplot(hormone_active, aes(x = Hormone_Type, y = Dose, fill = Hormone_Type)) +
  geom_boxplot(alpha = 0.7) +
  geom_jitter(width = 0.2, alpha = 0.3) +
  scale_y_log10() +
  labs(title = "Dose Distribution by Active Hormone Type",
       x = "Hormone Type",
       y = "Dose (log scale)") +
  theme_minimal() +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 45, hjust = 1))

# Dose vs secretion presence
p2 <- ggplot(hormone_active, aes(x = log(Dose + 0.01), y = Biliary_Present)) +
  geom_jitter(height = 0.05, alpha = 0.3) +
  geom_smooth(method = "glm", method.args = list(family = "binomial"),
              se = TRUE, color = "blue") +
  facet_wrap(~ Hormone_Type, scales = "free_x") +
  labs(title = "Biliary Secretion Presence vs Dose (by Hormone)",
       x = "Log(Dose + 0.01)",
       y = "Biliary Secretion (0=No, 1=Yes)") +
  theme_minimal()

grid.arrange(p1, p2, ncol = 1)
```

# Problem 13.48: Biliary Secretions vs Hormone Type

## Research Question

Is the presence of biliary secretions during Period 2 related to the type of hormone used during Period 2?

## Logistic Regression Analysis

```{r problem-13-48}
cat("=" %>% paste(rep("=", 80), collapse = "") %>% paste("=\n", sep = ""))
cat("PROBLEM 13.48: BILIARY SECRETIONS vs HORMONE TYPE\n")
cat("=" %>% paste(rep("=", 80), collapse = "") %>% paste("=\n", sep = ""))

# Fit logistic regression model
# Use Placebo (Hormone 1) as reference category
model_48 <- glm(Biliary_Present ~ Hormone_Type,
                data = hormone_clean,
                family = binomial(link = "logit"))

# Model summary
cat("\nLogistic Regression Model Summary:\n")
cat("-" %>% paste(rep("-", 80), collapse = "") %>% paste("-\n", sep = ""))
summary(model_48)

# Tidy output
cat("\nModel Coefficients with 95% CIs:\n")
results_48 <- tidy(model_48, conf.int = TRUE, exponentiate = FALSE)
kable(results_48, digits = 4,
      caption = "Logistic Regression Coefficients (Log-Odds Scale)")

# Odds ratios
cat("\nOdds Ratios and 95% CIs:\n")
or_48 <- tidy(model_48, conf.int = TRUE, exponentiate = TRUE)
kable(or_48, digits = 3,
      caption = "Odds Ratios (vs Placebo)")
```

## Overall Test of Hormone Effect

```{r overall-test-48}
cat("\nOverall Test of Hormone Type Effect:\n")
cat("-" %>% paste(rep("-", 80), collapse = "") %>% paste("-\n", sep = ""))

# Likelihood ratio test
null_model_48 <- glm(Biliary_Present ~ 1,
                     data = hormone_clean,
                     family = binomial)

lrt_48 <- anova(null_model_48, model_48, test = "Chisq")
print(lrt_48)

cat("\nLikelihood Ratio Test:\n")
cat("Chi-square statistic:", lrt_48$Deviance[2], "\n")
cat("Degrees of freedom:", lrt_48$Df[2], "\n")
cat("P-value:", format.pval(lrt_48$`Pr(>Chi)`[2], eps = 0.001), "\n")
```

## Predicted Probabilities

```{r pred-prob-48}
# Calculate predicted probabilities for each hormone
pred_48 <- hormone_clean %>%
  group_by(Hormone_Type) %>%
  summarise(
    N = n(),
    Observed_Prop = mean(Biliary_Present),
    .groups = 'drop'
  )

# Add model predictions
newdata_48 <- data.frame(Hormone_Type = levels(hormone_clean$Hormone_Type))
pred_48$Predicted_Prob <- predict(model_48, newdata = newdata_48, type = "response")

kable(pred_48, digits = 3,
      caption = "Observed vs Predicted Probabilities of Biliary Secretion")

# Visualization
ggplot(pred_48, aes(x = Hormone_Type)) +
  geom_bar(aes(y = Observed_Prop), stat = "identity",
           fill = "steelblue", alpha = 0.5, width = 0.6) +
  geom_point(aes(y = Predicted_Prob), color = "red", size = 4) +
  geom_line(aes(y = Predicted_Prob, group = 1), color = "red", size = 1) +
  labs(title = "Biliary Secretion: Observed vs Predicted Probabilities",
       subtitle = "Bars = Observed proportions, Red line = Model predictions",
       x = "Hormone Type",
       y = "Probability of Biliary Secretion") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Interpretation - Problem 13.48

```{r interpret-48}
cat("\n")
cat("=" %>% paste(rep("=", 80), collapse = "") %>% paste("=\n", sep = ""))
cat("INTERPRETATION - PROBLEM 13.48\n")
cat("=" %>% paste(rep("=", 80), collapse = "") %>% paste("=\n", sep = ""))

overall_p <- lrt_48$`Pr(>Chi)`[2]

if(overall_p < 0.05) {
  cat("\nCONCLUSION: There IS a significant relationship between hormone type\n")
  cat("and biliary secretion presence (p = ", format.pval(overall_p, eps = 0.001), ")\n\n", sep = "")

  cat("Pairwise comparisons vs Placebo:\n")
  for(i in 2:nrow(or_48)) {
    hormone_name <- gsub("Hormone_Type", "", or_48$term[i])
    or_val <- or_48$estimate[i]
    ci_low <- or_48$conf.low[i]
    ci_high <- or_48$conf.high[i]
    p_val <- or_48$p.value[i]

    cat("\n", hormone_name, ":\n", sep = "")
    cat("  OR = ", round(or_val, 2), " (95% CI: ", round(ci_low, 2),
        " - ", round(ci_high, 2), ")\n", sep = "")
    cat("  P-value: ", format.pval(p_val, eps = 0.001), "\n", sep = "")

    if(p_val < 0.05) {
      if(or_val > 1) {
        cat("  → HIGHER odds of biliary secretion vs placebo (significant)\n")
      } else {
        cat("  → LOWER odds of biliary secretion vs placebo (significant)\n")
      }
    } else {
      cat("  → No significant difference from placebo\n")
    }
  }
} else {
  cat("\nCONCLUSION: There is NO significant relationship between hormone type\n")
  cat("and biliary secretion presence (p = ", format.pval(overall_p, eps = 0.001), ")\n", sep = "")
  cat("\nThe type of hormone used does not significantly affect the likelihood\n")
  cat("of biliary secretion being present.\n")
}
```

# Problem 13.49: Pancreatic Secretions vs Hormone Type

## Research Question

Is the presence of pancreatic secretions during Period 2 related to the type of hormone used during Period 2?

## Logistic Regression Analysis

```{r problem-13-49}
cat("\n\n")
cat("=" %>% paste(rep("=", 80), collapse = "") %>% paste("=\n", sep = ""))
cat("PROBLEM 13.49: PANCREATIC SECRETIONS vs HORMONE TYPE\n")
cat("=" %>% paste(rep("=", 80), collapse = "") %>% paste("=\n", sep = ""))

# Fit logistic regression model
model_49 <- glm(Pancreatic_Present ~ Hormone_Type,
                data = hormone_clean,
                family = binomial(link = "logit"))

# Model summary
cat("\nLogistic Regression Model Summary:\n")
cat("-" %>% paste(rep("-", 80), collapse = "") %>% paste("-\n", sep = ""))
summary(model_49)

# Tidy output
cat("\nModel Coefficients with 95% CIs:\n")
results_49 <- tidy(model_49, conf.int = TRUE, exponentiate = FALSE)
kable(results_49, digits = 4,
      caption = "Logistic Regression Coefficients (Log-Odds Scale)")

# Odds ratios
cat("\nOdds Ratios and 95% CIs:\n")
or_49 <- tidy(model_49, conf.int = TRUE, exponentiate = TRUE)
kable(or_49, digits = 3,
      caption = "Odds Ratios (vs Placebo)")
```

## Overall Test of Hormone Effect

```{r overall-test-49}
cat("\nOverall Test of Hormone Type Effect:\n")
cat("-" %>% paste(rep("-", 80), collapse = "") %>% paste("-\n", sep = ""))

# Likelihood ratio test
null_model_49 <- glm(Pancreatic_Present ~ 1,
                     data = hormone_clean,
                     family = binomial)

lrt_49 <- anova(null_model_49, model_49, test = "Chisq")
print(lrt_49)

cat("\nLikelihood Ratio Test:\n")
cat("Chi-square statistic:", lrt_49$Deviance[2], "\n")
cat("Degrees of freedom:", lrt_49$Df[2], "\n")
cat("P-value:", format.pval(lrt_49$`Pr(>Chi)`[2], eps = 0.001), "\n")
```

## Predicted Probabilities

```{r pred-prob-49}
# Calculate predicted probabilities
pred_49 <- hormone_clean %>%
  group_by(Hormone_Type) %>%
  summarise(
    N = n(),
    Observed_Prop = mean(Pancreatic_Present),
    .groups = 'drop'
  )

# Add model predictions
newdata_49 <- data.frame(Hormone_Type = levels(hormone_clean$Hormone_Type))
pred_49$Predicted_Prob <- predict(model_49, newdata = newdata_49, type = "response")

kable(pred_49, digits = 3,
      caption = "Observed vs Predicted Probabilities of Pancreatic Secretion")

# Visualization
ggplot(pred_49, aes(x = Hormone_Type)) +
  geom_bar(aes(y = Observed_Prop), stat = "identity",
           fill = "darkgreen", alpha = 0.5, width = 0.6) +
  geom_point(aes(y = Predicted_Prob), color = "red", size = 4) +
  geom_line(aes(y = Predicted_Prob, group = 1), color = "red", size = 1) +
  labs(title = "Pancreatic Secretion: Observed vs Predicted Probabilities",
       subtitle = "Bars = Observed proportions, Red line = Model predictions",
       x = "Hormone Type",
       y = "Probability of Pancreatic Secretion") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Interpretation - Problem 13.49

```{r interpret-49}
cat("\n")
cat("=" %>% paste(rep("=", 80), collapse = "") %>% paste("=\n", sep = ""))
cat("INTERPRETATION - PROBLEM 13.49\n")
cat("=" %>% paste(rep("=", 80), collapse = "") %>% paste("=\n", sep = ""))

overall_p <- lrt_49$`Pr(>Chi)`[2]

if(overall_p < 0.05) {
  cat("\nCONCLUSION: There IS a significant relationship between hormone type\n")
  cat("and pancreatic secretion presence (p = ", format.pval(overall_p, eps = 0.001), ")\n\n", sep = "")

  cat("Pairwise comparisons vs Placebo:\n")
  for(i in 2:nrow(or_49)) {
    hormone_name <- gsub("Hormone_Type", "", or_49$term[i])
    or_val <- or_49$estimate[i]
    ci_low <- or_49$conf.low[i]
    ci_high <- or_49$conf.high[i]
    p_val <- or_49$p.value[i]

    cat("\n", hormone_name, ":\n", sep = "")
    cat("  OR = ", round(or_val, 2), " (95% CI: ", round(ci_low, 2),
        " - ", round(ci_high, 2), ")\n", sep = "")
    cat("  P-value: ", format.pval(p_val, eps = 0.001), "\n", sep = "")

    if(p_val < 0.05) {
      if(or_val > 1) {
        cat("  → HIGHER odds of pancreatic secretion vs placebo (significant)\n")
      } else {
        cat("  → LOWER odds of pancreatic secretion vs placebo (significant)\n")
      }
    } else {
      cat("  → No significant difference from placebo\n")
    }
  }
} else {
  cat("\nCONCLUSION: There is NO significant relationship between hormone type\n")
  cat("and pancreatic secretion presence (p = ", format.pval(overall_p, eps = 0.001), ")\n", sep = "")
  cat("\nThe type of hormone used does not significantly affect the likelihood\n")
  cat("of pancreatic secretion being present.\n")
}
```

# Problem 13.50: Biliary Secretions vs Dose (by Hormone)

## Research Question

Is the presence of biliary secretions during Period 2 related to the dose of hormone used during Period 2? Analyze separately for each active hormone (Hormones 2-5).

```{r problem-13-50-setup}
cat("\n\n")
cat("=" %>% paste(rep("=", 80), collapse = "") %>% paste("=\n", sep = ""))
cat("PROBLEM 13.50: BILIARY SECRETIONS vs DOSE (SEPARATE BY HORMONE)\n")
cat("=" %>% paste(rep("=", 80), collapse = "") %>% paste("=\n", sep = ""))

# Filter to active hormones only
hormone_active <- hormone_clean %>%
  filter(Hormone %in% 2:5)

# Results storage
results_50_list <- list()
```

## Hormone 2: Biliary Secretions vs Dose

```{r hormone-2-biliary}
cat("\n")
cat("-" %>% paste(rep("-", 80), collapse = "") %>% paste("-\n", sep = ""))
cat("HORMONE 2 - Biliary Secretions vs Dose\n")
cat("-" %>% paste(rep("-", 80), collapse = "") %>% paste("-\n", sep = ""))

data_h2 <- hormone_active %>% filter(Hormone == 2)
cat("Sample size:", nrow(data_h2), "\n")
cat("Dose range:", min(data_h2$Dose), "-", max(data_h2$Dose), "\n")
cat("Biliary secretion present:", sum(data_h2$Biliary_Present),
    "(", round(100*mean(data_h2$Biliary_Present), 1), "%)\n\n")

model_h2_bil <- glm(Biliary_Present ~ Dose,
                    data = data_h2,
                    family = binomial)

summary(model_h2_bil)

results_h2_bil <- tidy(model_h2_bil, conf.int = TRUE, exponentiate = TRUE)
kable(results_h2_bil, digits = 4,
      caption = "Hormone 2: Biliary Secretions - Odds Ratios per Unit Dose Increase")

results_50_list[["Hormone_2_Biliary"]] <- results_h2_bil
```

## Hormone 3: Biliary Secretions vs Dose

```{r hormone-3-biliary}
cat("\n")
cat("-" %>% paste(rep("-", 80), collapse = "") %>% paste("-\n", sep = ""))
cat("HORMONE 3 - Biliary Secretions vs Dose\n")
cat("-" %>% paste(rep("-", 80), collapse = "") %>% paste("-\n", sep = ""))

data_h3 <- hormone_active %>% filter(Hormone == 3)
cat("Sample size:", nrow(data_h3), "\n")
cat("Dose range:", min(data_h3$Dose), "-", max(data_h3$Dose), "\n")
cat("Biliary secretion present:", sum(data_h3$Biliary_Present),
    "(", round(100*mean(data_h3$Biliary_Present), 1), "%)\n\n")

model_h3_bil <- glm(Biliary_Present ~ Dose,
                    data = data_h3,
                    family = binomial)

summary(model_h3_bil)

results_h3_bil <- tidy(model_h3_bil, conf.int = TRUE, exponentiate = TRUE)
kable(results_h3_bil, digits = 4,
      caption = "Hormone 3: Biliary Secretions - Odds Ratios per Unit Dose Increase")

results_50_list[["Hormone_3_Biliary"]] <- results_h3_bil
```

## Hormone 4: Biliary Secretions vs Dose

```{r hormone-4-biliary}
cat("\n")
cat("-" %>% paste(rep("-", 80), collapse = "") %>% paste("-\n", sep = ""))
cat("HORMONE 4 - Biliary Secretions vs Dose\n")
cat("-" %>% paste(rep("-", 80), collapse = "") %>% paste("-\n", sep = ""))

data_h4 <- hormone_active %>% filter(Hormone == 4)
cat("Sample size:", nrow(data_h4), "\n")
cat("Dose range:", min(data_h4$Dose), "-", max(data_h4$Dose), "\n")
cat("Biliary secretion present:", sum(data_h4$Biliary_Present),
    "(", round(100*mean(data_h4$Biliary_Present), 1), "%)\n\n")

model_h4_bil <- glm(Biliary_Present ~ Dose,
                    data = data_h4,
                    family = binomial)

summary(model_h4_bil)

results_h4_bil <- tidy(model_h4_bil, conf.int = TRUE, exponentiate = TRUE)
kable(results_h4_bil, digits = 4,
      caption = "Hormone 4: Biliary Secretions - Odds Ratios per Unit Dose Increase")

results_50_list[["Hormone_4_Biliary"]] <- results_h4_bil
```

## Hormone 5: Biliary Secretions vs Dose

```{r hormone-5-biliary}
cat("\n")
cat("-" %>% paste(rep("-", 80), collapse = "") %>% paste("-\n", sep = ""))
cat("HORMONE 5 - Biliary Secretions vs Dose\n")
cat("-" %>% paste(rep("-", 80), collapse = "") %>% paste("-\n", sep = ""))

data_h5 <- hormone_active %>% filter(Hormone == 5)
cat("Sample size:", nrow(data_h5), "\n")
cat("Dose range:", min(data_h5$Dose), "-", max(data_h5$Dose), "\n")
cat("Biliary secretion present:", sum(data_h5$Biliary_Present),
    "(", round(100*mean(data_h5$Biliary_Present), 1), "%)\n\n")

model_h5_bil <- glm(Biliary_Present ~ Dose,
                    data = data_h5,
                    family = binomial)

summary(model_h5_bil)

results_h5_bil <- tidy(model_h5_bil, conf.int = TRUE, exponentiate = TRUE)
kable(results_h5_bil, digits = 4,
      caption = "Hormone 5: Biliary Secretions - Odds Ratios per Unit Dose Increase")

results_50_list[["Hormone_5_Biliary"]] <- results_h5_bil
```

## Summary - Problem 13.50

```{r summary-50}
cat("\n")
cat("=" %>% paste(rep("=", 80), collapse = "") %>% paste("=\n", sep = ""))
cat("SUMMARY - PROBLEM 13.50: Biliary Secretions vs Dose\n")
cat("=" %>% paste(rep("=", 80), collapse = "") %>% paste("=\n", sep = ""))

# Combine results
summary_50 <- data.frame(
  Hormone = c("Hormone 2", "Hormone 3", "Hormone 4", "Hormone 5"),
  N = c(nrow(data_h2), nrow(data_h3), nrow(data_h4), nrow(data_h5)),
  OR_per_unit = c(
    results_h2_bil$estimate[2],
    results_h3_bil$estimate[2],
    results_h4_bil$estimate[2],
    results_h5_bil$estimate[2]
  ),
  CI_Lower = c(
    results_h2_bil$conf.low[2],
    results_h3_bil$conf.low[2],
    results_h4_bil$conf.low[2],
    results_h5_bil$conf.low[2]
  ),
  CI_Upper = c(
    results_h2_bil$conf.high[2],
    results_h3_bil$conf.high[2],
    results_h4_bil$conf.high[2],
    results_h5_bil$conf.high[2]
  ),
  P_Value = c(
    results_h2_bil$p.value[2],
    results_h3_bil$p.value[2],
    results_h4_bil$p.value[2],
    results_h5_bil$p.value[2]
  )
) %>%
  mutate(
    Significant = ifelse(P_Value < 0.05, "Yes", "No"),
    P_Value_Format = format.pval(P_Value, eps = 0.001, digits = 3)
  )

kable(summary_50 %>% select(-P_Value),
      digits = 3,
      caption = "Summary: Dose Effects on Biliary Secretions by Hormone Type")

# Interpretation
cat("\nInterpretation:\n")
for(i in 1:nrow(summary_50)) {
  cat("\n", summary_50$Hormone[i], ":\n", sep = "")
  if(summary_50$Significant[i] == "Yes") {
    if(summary_50$OR_per_unit[i] > 1) {
      cat("  → Significant POSITIVE dose-response (p = ", summary_50$P_Value_Format[i], ")\n", sep = "")
      cat("  → Higher doses associated with INCREASED biliary secretion\n")
    } else {
      cat("  → Significant NEGATIVE dose-response (p = ", summary_50$P_Value_Format[i], ")\n", sep = "")
      cat("  → Higher doses associated with DECREASED biliary secretion\n")
    }
    cat("  → OR per unit dose = ", round(summary_50$OR_per_unit[i], 3),
        " (95% CI: ", round(summary_50$CI_Lower[i], 3), "-",
        round(summary_50$CI_Upper[i], 3), ")\n", sep = "")
  } else {
    cat("  → NO significant dose-response relationship (p = ",
        summary_50$P_Value_Format[i], ")\n", sep = "")
  }
}
```

## Visualization - Problem 13.50

```{r viz-50, fig.height=10}
# Dose-response curves for each hormone
plot_list <- list()

for(h in 2:5) {
  data_h <- hormone_active %>% filter(Hormone == h)

  # Fit model for predictions
  model_h <- glm(Biliary_Present ~ Dose, data = data_h, family = binomial)

  # Create prediction data
  dose_seq <- seq(min(data_h$Dose), max(data_h$Dose), length.out = 100)
  pred_data <- data.frame(Dose = dose_seq)
  pred_data$Prob <- predict(model_h, newdata = pred_data, type = "response")

  p <- ggplot(data_h, aes(x = Dose, y = Biliary_Present)) +
    geom_jitter(height = 0.05, alpha = 0.4) +
    geom_line(data = pred_data, aes(x = Dose, y = Prob),
              color = "blue", size = 1.5) +
    labs(title = paste("Hormone", h, "- Biliary Secretion vs Dose"),
         x = "Dose",
         y = "Probability of Biliary Secretion") +
    theme_minimal()

  plot_list[[h-1]] <- p
}

do.call(grid.arrange, c(plot_list, ncol = 2))
```

# Problem 13.51: Pancreatic Secretions vs Dose (by Hormone)

## Research Question

Is the presence of pancreatic secretions during Period 2 related to the dose of hormone used during Period 2? Analyze separately for each active hormone (Hormones 2-5).

```{r problem-13-51-setup}
cat("\n\n")
cat("=" %>% paste(rep("=", 80), collapse = "") %>% paste("=\n", sep = ""))
cat("PROBLEM 13.51: PANCREATIC SECRETIONS vs DOSE (SEPARATE BY HORMONE)\n")
cat("=" %>% paste(rep("=", 80), collapse = "") %>% paste("=\n", sep = ""))

# Results storage
results_51_list <- list()
```

## Hormone 2: Pancreatic Secretions vs Dose

```{r hormone-2-pancreatic}
cat("\n")
cat("-" %>% paste(rep("-", 80), collapse = "") %>% paste("-\n", sep = ""))
cat("HORMONE 2 - Pancreatic Secretions vs Dose\n")
cat("-" %>% paste(rep("-", 80), collapse = "") %>% paste("-\n", sep = ""))

cat("Sample size:", nrow(data_h2), "\n")
cat("Pancreatic secretion present:", sum(data_h2$Pancreatic_Present),
    "(", round(100*mean(data_h2$Pancreatic_Present), 1), "%)\n\n")

model_h2_pan <- glm(Pancreatic_Present ~ Dose,
                    data = data_h2,
                    family = binomial)

summary(model_h2_pan)

results_h2_pan <- tidy(model_h2_pan, conf.int = TRUE, exponentiate = TRUE)
kable(results_h2_pan, digits = 4,
      caption = "Hormone 2: Pancreatic Secretions - Odds Ratios per Unit Dose Increase")

results_51_list[["Hormone_2_Pancreatic"]] <- results_h2_pan
```

## Hormone 3: Pancreatic Secretions vs Dose

```{r hormone-3-pancreatic}
cat("\n")
cat("-" %>% paste(rep("-", 80), collapse = "") %>% paste("-\n", sep = ""))
cat("HORMONE 3 - Pancreatic Secretions vs Dose\n")
cat("-" %>% paste(rep("-", 80), collapse = "") %>% paste("-\n", sep = ""))

cat("Sample size:", nrow(data_h3), "\n")
cat("Pancreatic secretion present:", sum(data_h3$Pancreatic_Present),
    "(", round(100*mean(data_h3$Pancreatic_Present), 1), "%)\n\n")

model_h3_pan <- glm(Pancreatic_Present ~ Dose,
                    data = data_h3,
                    family = binomial)

summary(model_h3_pan)

results_h3_pan <- tidy(model_h3_pan, conf.int = TRUE, exponentiate = TRUE)
kable(results_h3_pan, digits = 4,
      caption = "Hormone 3: Pancreatic Secretions - Odds Ratios per Unit Dose Increase")

results_51_list[["Hormone_3_Pancreatic"]] <- results_h3_pan
```

## Hormone 4: Pancreatic Secretions vs Dose

```{r hormone-4-pancreatic}
cat("\n")
cat("-" %>% paste(rep("-", 80), collapse = "") %>% paste("-\n", sep = ""))
cat("HORMONE 4 - Pancreatic Secretions vs Dose\n")
cat("-" %>% paste(rep("-", 80), collapse = "") %>% paste("-\n", sep = ""))

cat("Sample size:", nrow(data_h4), "\n")
cat("Pancreatic secretion present:", sum(data_h4$Pancreatic_Present),
    "(", round(100*mean(data_h4$Pancreatic_Present), 1), "%)\n\n")

model_h4_pan <- glm(Pancreatic_Present ~ Dose,
                    data = data_h4,
                    family = binomial)

summary(model_h4_pan)

results_h4_pan <- tidy(model_h4_pan, conf.int = TRUE, exponentiate = TRUE)
kable(results_h4_pan, digits = 4,
      caption = "Hormone 4: Pancreatic Secretions - Odds Ratios per Unit Dose Increase")

results_51_list[["Hormone_4_Pancreatic"]] <- results_h4_pan
```

## Hormone 5: Pancreatic Secretions vs Dose

```{r hormone-5-pancreatic}
cat("\n")
cat("-" %>% paste(rep("-", 80), collapse = "") %>% paste("-\n", sep = ""))
cat("HORMONE 5 - Pancreatic Secretions vs Dose\n")
cat("-" %>% paste(rep("-", 80), collapse = "") %>% paste("-\n", sep = ""))

cat("Sample size:", nrow(data_h5), "\n")
cat("Pancreatic secretion present:", sum(data_h5$Pancreatic_Present),
    "(", round(100*mean(data_h5$Pancreatic_Present), 1), "%)\n\n")

model_h5_pan <- glm(Pancreatic_Present ~ Dose,
                    data = data_h5,
                    family = binomial)

summary(model_h5_pan)

results_h5_pan <- tidy(model_h5_pan, conf.int = TRUE, exponentiate = TRUE)
kable(results_h5_pan, digits = 4,
      caption = "Hormone 5: Pancreatic Secretions - Odds Ratios per Unit Dose Increase")

results_51_list[["Hormone_5_Pancreatic"]] <- results_h5_pan
```

## Summary - Problem 13.51

```{r summary-51}
cat("\n")
cat("=" %>% paste(rep("=", 80), collapse = "") %>% paste("=\n", sep = ""))
cat("SUMMARY - PROBLEM 13.51: Pancreatic Secretions vs Dose\n")
cat("=" %>% paste(rep("=", 80), collapse = "") %>% paste("=\n", sep = ""))

# Combine results
summary_51 <- data.frame(
  Hormone = c("Hormone 2", "Hormone 3", "Hormone 4", "Hormone 5"),
  N = c(nrow(data_h2), nrow(data_h3), nrow(data_h4), nrow(data_h5)),
  OR_per_unit = c(
    results_h2_pan$estimate[2],
    results_h3_pan$estimate[2],
    results_h4_pan$estimate[2],
    results_h5_pan$estimate[2]
  ),
  CI_Lower = c(
    results_h2_pan$conf.low[2],
    results_h3_pan$conf.low[2],
    results_h4_pan$conf.low[2],
    results_h5_pan$conf.low[2]
  ),
  CI_Upper = c(
    results_h2_pan$conf.high[2],
    results_h3_pan$conf.high[2],
    results_h4_pan$conf.high[2],
    results_h5_pan$conf.high[2]
  ),
  P_Value = c(
    results_h2_pan$p.value[2],
    results_h3_pan$p.value[2],
    results_h4_pan$p.value[2],
    results_h5_pan$p.value[2]
  )
) %>%
  mutate(
    Significant = ifelse(P_Value < 0.05, "Yes", "No"),
    P_Value_Format = format.pval(P_Value, eps = 0.001, digits = 3)
  )

kable(summary_51 %>% select(-P_Value),
      digits = 3,
      caption = "Summary: Dose Effects on Pancreatic Secretions by Hormone Type")

# Interpretation
cat("\nInterpretation:\n")
for(i in 1:nrow(summary_51)) {
  cat("\n", summary_51$Hormone[i], ":\n", sep = "")
  if(summary_51$Significant[i] == "Yes") {
    if(summary_51$OR_per_unit[i] > 1) {
      cat("  → Significant POSITIVE dose-response (p = ", summary_51$P_Value_Format[i], ")\n", sep = "")
      cat("  → Higher doses associated with INCREASED pancreatic secretion\n")
    } else {
      cat("  → Significant NEGATIVE dose-response (p = ", summary_51$P_Value_Format[i], ")\n", sep = "")
      cat("  → Higher doses associated with DECREASED pancreatic secretion\n")
    }
    cat("  → OR per unit dose = ", round(summary_51$OR_per_unit[i], 3),
        " (95% CI: ", round(summary_51$CI_Lower[i], 3), "-",
        round(summary_51$CI_Upper[i], 3), ")\n", sep = "")
  } else {
    cat("  → NO significant dose-response relationship (p = ",
        summary_51$P_Value_Format[i], ")\n", sep = "")
  }
}
```

## Visualization - Problem 13.51

```{r viz-51, fig.height=10}
# Dose-response curves for pancreatic secretions
plot_list_pan <- list()

for(h in 2:5) {
  data_h <- hormone_active %>% filter(Hormone == h)

  # Fit model for predictions
  model_h <- glm(Pancreatic_Present ~ Dose, data = data_h, family = binomial)

  # Create prediction data
  dose_seq <- seq(min(data_h$Dose), max(data_h$Dose), length.out = 100)
  pred_data <- data.frame(Dose = dose_seq)
  pred_data$Prob <- predict(model_h, newdata = pred_data, type = "response")

  p <- ggplot(data_h, aes(x = Dose, y = Pancreatic_Present)) +
    geom_jitter(height = 0.05, alpha = 0.4, color = "darkgreen") +
    geom_line(data = pred_data, aes(x = Dose, y = Prob),
              color = "darkgreen", size = 1.5) +
    labs(title = paste("Hormone", h, "- Pancreatic Secretion vs Dose"),
         x = "Dose",
         y = "Probability of Pancreatic Secretion") +
    theme_minimal()

  plot_list_pan[[h-1]] <- p
}

do.call(grid.arrange, c(plot_list_pan, ncol = 2))
```

# Comprehensive Summary

## Summary Table of All Results

```{r final-summary}
cat("=" %>% paste(rep("=", 80), collapse = "") %>% paste("=\n", sep = ""))
cat("COMPREHENSIVE SUMMARY: ALL PROBLEMS (13.48-13.51)\n")
cat("=" %>% paste(rep("=", 80), collapse = "") %>% paste("=\n", sep = ""))

# Create comprehensive summary
final_summary <- rbind(
  data.frame(
    Problem = "13.48",
    Analysis = "Biliary vs Hormone Type",
    Test = "Overall LRT",
    P_Value = lrt_48$`Pr(>Chi)`[2],
    Significant = ifelse(lrt_48$`Pr(>Chi)`[2] < 0.05, "Yes", "No")
  ),
  data.frame(
    Problem = "13.49",
    Analysis = "Pancreatic vs Hormone Type",
    Test = "Overall LRT",
    P_Value = lrt_49$`Pr(>Chi)`[2],
    Significant = ifelse(lrt_49$`Pr(>Chi)`[2] < 0.05, "Yes", "No")
  ),
  data.frame(
    Problem = "13.50",
    Analysis = paste("Biliary vs Dose -", summary_50$Hormone),
    Test = "Dose Effect",
    P_Value = summary_50$P_Value,
    Significant = summary_50$Significant
  ),
  data.frame(
    Problem = "13.51",
    Analysis = paste("Pancreatic vs Dose -", summary_51$Hormone),
    Test = "Dose Effect",
    P_Value = summary_51$P_Value,
    Significant = summary_51$Significant
  )
) %>%
  mutate(P_Value_Format = format.pval(P_Value, eps = 0.001, digits = 3))

kable(final_summary %>% select(-P_Value),
      caption = "Summary of All Logistic Regression Analyses")
```

## Clinical Conclusions

```{r clinical-conclusions}
cat("\n")
cat("CLINICAL INTERPRETATION AND CONCLUSIONS:\n")
cat("=" %>% paste(rep("=", 80), collapse = "") %>% paste("=\n", sep = ""))

cat("\n1. HORMONE TYPE EFFECTS:\n")
cat("-" %>% paste(rep("-", 50), collapse = "") %>% paste("-\n", sep = ""))

cat("\nBiliary Secretions (Problem 13.48):\n")
if(lrt_48$`Pr(>Chi)`[2] < 0.05) {
  cat("  ✓ Hormone type DOES affect biliary secretion likelihood\n")
  cat("  → Different hormones have different effects on bile secretion\n")
} else {
  cat("  ✗ Hormone type does NOT significantly affect biliary secretion\n")
  cat("  → All hormones have similar effects on bile secretion\n")
}

cat("\nPancreatic Secretions (Problem 13.49):\n")
if(lrt_49$`Pr(>Chi)`[2] < 0.05) {
  cat("  ✓ Hormone type DOES affect pancreatic secretion likelihood\n")
  cat("  → Different hormones have different effects on pancreatic secretion\n")
} else {
  cat("  ✗ Hormone type does NOT significantly affect pancreatic secretion\n")
  cat("  → All hormones have similar effects on pancreatic secretion\n")
}

cat("\n\n2. DOSE-RESPONSE RELATIONSHIPS:\n")
cat("-" %>% paste(rep("-", 50), collapse = "") %>% paste("-\n", sep = ""))

cat("\nBiliary Secretions (Problem 13.50):\n")
n_sig_bil <- sum(summary_50$Significant == "Yes")
if(n_sig_bil > 0) {
  cat("  → Significant dose-response found for", n_sig_bil, "out of 4 hormones\n")
  sig_hormones <- summary_50$Hormone[summary_50$Significant == "Yes"]
  cat("  → Significant for:", paste(sig_hormones, collapse = ", "), "\n")
} else {
  cat("  → No significant dose-response relationships found\n")
}

cat("\nPancreatic Secretions (Problem 13.51):\n")
n_sig_pan <- sum(summary_51$Significant == "Yes")
if(n_sig_pan > 0) {
  cat("  → Significant dose-response found for", n_sig_pan, "out of 4 hormones\n")
  sig_hormones <- summary_51$Hormone[summary_51$Significant == "Yes"]
  cat("  → Significant for:", paste(sig_hormones, collapse = ", "), "\n")
} else {
  cat("  → No significant dose-response relationships found\n")
}

cat("\n\n3. OVERALL IMPLICATIONS:\n")
cat("-" %>% paste(rep("-", 50), collapse = "") %>% paste("-\n", sep = ""))
cat("\n• These findings help identify which hormones affect hepatic secretions\n")
cat("• Dose-response relationships inform optimal dosing strategies\n")
cat("• Understanding secretion patterns aids in managing hepatobiliary disease\n")
cat("• Results can guide hormone selection for therapeutic purposes\n")
```

# Session Information

```{r session-info}
sessionInfo()
```

# References

**Statistical Methods:**
- Hosmer DW, Lemeshow S, Sturdivant RX (2013). Applied Logistic Regression, 3rd ed. Wiley
- Agresti A (2013). Categorical Data Analysis, 3rd ed. Wiley
- Rosner B (2015). Fundamentals of Biostatistics, 8th ed. Chapter 13

**Key Concepts:**
- Logistic regression for binary outcomes
- Odds ratios and their interpretation
- Dose-response relationships
- Multiple comparisons in regression context
