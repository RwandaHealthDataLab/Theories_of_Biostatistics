---
title: "Environmental Health & Pediatrics: Lead Exposure and IQ Analysis"
subtitle: "Problems 12.40 - 12.41"
author: "Your Name"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.width = 10, fig.height = 6)
```

# Overview

This analysis examines the relationship between lead exposure and full-scale IQ scores in children. The study includes three groups:

1. **Control group**: No lead exposure
2. **Currently exposed group**: Children with current lead exposure
3. **Previously exposed group**: Children with past lead exposure

## Research Questions

**Problem 12.40**: Use ANOVA methods to assess whether there are any overall differences between the control group, the currently exposed group, and the previously exposed group in mean full-scale IQ. Also, compare each pair of groups and report p-values.

**Problem 12.41**: Determine a 95% CI for the underlying mean difference in full-scale IQ for each pair of groups considered.

# Load Required Libraries

```{r load-libraries}
library(tidyverse)
library(knitr)
library(ggplot2)
library(car)        # For Levene's test
library(multcomp)   # For multiple comparisons
library(broom)      # For tidy output
```

# Load and Explore Data

```{r load-data}
# Read the LEAD.DAT file from the data sets folder
lead_data <- read.table("Rosner_FundamentalsBiostatistics_8e_Data_Sets/ASCII-tab/LEAD.DAT.txt",
                        header = TRUE,
                        sep = "\t",
                        quote = "'\"",
                        strip.white = TRUE)

# Display structure
str(lead_data)

# Key variables:
# - id: Subject ID
# - iqf: Full-scale IQ (our outcome variable)
# - lead_grp: Lead exposure group (1 = Control, 2 = Currently exposed, 3 = Previously exposed)

cat("\nDataset dimensions:", nrow(lead_data), "rows x", ncol(lead_data), "columns\n")
```

## Data Preparation

```{r data-prep}
# Check column names to ensure they're correct
cat("Column names in dataset:\n")
print(names(lead_data))
cat("\n")

# Create a clean dataset with relevant variables
lead_iq <- lead_data %>%
  dplyr::select(id, iqf, lead_grp) %>%
  dplyr::mutate(
    # Create factor with descriptive labels
    exposure_group = factor(lead_grp,
                           levels = c(1, 2, 3),
                           labels = c("Control",
                                     "Currently Exposed",
                                     "Previously Exposed"))
  ) %>%
  # Remove any missing values in IQ
  dplyr::filter(!is.na(iqf))

# Display first few rows
head(lead_iq)

# Summary by group
cat("\nSample sizes by group:\n")
table(lead_iq$exposure_group)
```

# Descriptive Statistics

```{r descriptive-stats}
# Calculate descriptive statistics by group
desc_stats <- lead_iq %>%
  dplyr::group_by(exposure_group) %>%
  dplyr::summarise(
    N = n(),
    Mean = mean(iqf),
    SD = sd(iqf),
    SE = sd(iqf) / sqrt(n()),
    Median = median(iqf),
    Min = min(iqf),
    Max = max(iqf),
    Q1 = quantile(iqf, 0.25),
    Q3 = quantile(iqf, 0.75),
    .groups = 'drop'
  )

kable(desc_stats, digits = 2,
      caption = "Descriptive Statistics for Full-Scale IQ by Lead Exposure Group")

# Overall statistics
cat("\n\nOverall IQ Statistics:\n")
cat("Mean:", round(mean(lead_iq$iqf), 2), "\n")
cat("SD:", round(sd(lead_iq$iqf), 2), "\n")
cat("Range:", range(lead_iq$iqf), "\n")
```

# Visualizations

## Distribution of IQ by Group

```{r boxplot}
ggplot(lead_iq, aes(x = exposure_group, y = iqf, fill = exposure_group)) +
  geom_boxplot(alpha = 0.7, outlier.shape = 16) +
  geom_jitter(width = 0.2, alpha = 0.3, size = 1.5) +
  stat_summary(fun = mean, geom = "point", shape = 23, size = 3,
               fill = "red", color = "darkred") +
  labs(title = "Distribution of Full-Scale IQ by Lead Exposure Group",
       subtitle = "Red diamonds indicate group means",
       x = "Lead Exposure Group",
       y = "Full-Scale IQ",
       fill = "Group") +
  theme_minimal() +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 0, hjust = 0.5))
```

## Violin Plot with Individual Points

```{r violin-plot}
ggplot(lead_iq, aes(x = exposure_group, y = iqf, fill = exposure_group)) +
  geom_violin(alpha = 0.6, trim = FALSE) +
  geom_boxplot(width = 0.2, alpha = 0.8, outlier.shape = NA) +
  geom_jitter(width = 0.1, alpha = 0.3, size = 1) +
  stat_summary(fun.data = mean_se, geom = "errorbar",
               width = 0.2, color = "red", linewidth = 1) +
  stat_summary(fun = mean, geom = "point",
               shape = 18, size = 4, color = "red") +
  labs(title = "Violin Plot: IQ Distribution by Lead Exposure Group",
       subtitle = "Red error bars show mean ± SE",
       x = "Lead Exposure Group",
       y = "Full-Scale IQ") +
  theme_minimal() +
  theme(legend.position = "none")
```

## Mean Comparison with Error Bars

```{r mean-plot}
ggplot(desc_stats, aes(x = exposure_group, y = Mean, color = exposure_group)) +
  geom_point(size = 4) +
  geom_errorbar(aes(ymin = Mean - SE, ymax = Mean + SE),
                width = 0.2, linewidth = 1) +
  geom_hline(yintercept = mean(lead_iq$iqf),
             linetype = "dashed", color = "gray50") +
  labs(title = "Mean Full-Scale IQ by Lead Exposure Group",
       subtitle = "Error bars represent ± 1 SE; dashed line shows overall mean",
       x = "Lead Exposure Group",
       y = "Mean Full-Scale IQ") +
  theme_minimal() +
  theme(legend.position = "none")
```

# Assumptions Check

Before performing ANOVA, we need to check the assumptions:

1. Independence (assumed based on study design)
2. Normality of residuals
3. Homogeneity of variance

## Normality Check

```{r normality-check}
# Shapiro-Wilk test by group
cat("Shapiro-Wilk Normality Tests by Group:\n")
cat("----------------------------------------\n")
for (group in levels(lead_iq$exposure_group)) {
  group_data <- lead_iq %>% dplyr::filter(exposure_group == group)
  shapiro_test <- shapiro.test(group_data$iqf)
  cat(group, ": W =", round(shapiro_test$statistic, 4),
      ", p-value =", round(shapiro_test$p.value, 4), "\n")
}

# Q-Q plots
par(mfrow = c(1, 3))
for (group in levels(lead_iq$exposure_group)) {
  group_data <- lead_iq %>% dplyr::filter(exposure_group == group)
  qqnorm(group_data$iqf, main = paste("Q-Q Plot:", group))
  qqline(group_data$iqf, col = "red")
}
par(mfrow = c(1, 1))

cat("\nInterpretation: If p > 0.05, data are consistent with normality.\n")
```

## Homogeneity of Variance

```{r variance-check}
# Levene's test
levene_test <- leveneTest(iqf ~ exposure_group, data = lead_iq)
print(levene_test)

cat("\nInterpretation: If p > 0.05, variances are homogeneous (equal).\n")

# Visual check: spread-location plot
ggplot(lead_iq, aes(x = exposure_group, y = iqf)) +
  geom_boxplot(aes(fill = exposure_group), alpha = 0.5) +
  stat_summary(fun = sd, geom = "text", aes(label = paste("SD =", round(..y.., 2))),
               vjust = -0.5, size = 3.5) +
  labs(title = "Variance Check: IQ Spread by Group",
       x = "Lead Exposure Group",
       y = "Full-Scale IQ") +
  theme_minimal() +
  theme(legend.position = "none")
```

# Problem 12.40: ANOVA Analysis

## One-Way ANOVA

```{r anova-12-40}
cat("=" %>% rep(70) %>% paste(collapse = ""), "\n")
cat("PROBLEM 12.40: ONE-WAY ANOVA\n")
cat("=" %>% rep(70) %>% paste(collapse = ""), "\n\n")

# Perform one-way ANOVA
anova_model <- aov(iqf ~ exposure_group, data = lead_iq)
anova_summary <- summary(anova_model)

print(anova_summary)

# Extract p-value
anova_p <- anova_summary[[1]]$`Pr(>F)`[1]

cat("\n")
cat("=" %>% rep(70) %>% paste(collapse = ""), "\n")
cat("INTERPRETATION:\n")
cat("=" %>% rep(70) %>% paste(collapse = ""), "\n")
cat("F-statistic:", round(anova_summary[[1]]$`F value`[1], 3), "\n")
cat("p-value:", format.pval(anova_p, digits = 4), "\n\n")

if (anova_p < 0.05) {
  cat("CONCLUSION: There ARE statistically significant overall differences\n")
  cat("in mean full-scale IQ among the three groups (p < 0.05).\n")
} else {
  cat("CONCLUSION: There are NO statistically significant overall differences\n")
  cat("in mean full-scale IQ among the three groups (p >= 0.05).\n")
}
cat("=" %>% rep(70) %>% paste(collapse = ""), "\n\n")

# Effect size (eta-squared)
ss_group <- anova_summary[[1]]$`Sum Sq`[1]
ss_total <- sum(anova_summary[[1]]$`Sum Sq`)
eta_squared <- ss_group / ss_total

cat("\nEffect Size (Eta-squared):", round(eta_squared, 4))
cat("\nThis indicates that", round(eta_squared * 100, 2),
    "% of variance in IQ is explained by lead exposure group.\n")
```

## Pairwise Comparisons (Tukey's HSD)

```{r tukey-pairwise}
cat("\n\n")
cat("=" %>% rep(70) %>% paste(collapse = ""), "\n")
cat("PAIRWISE COMPARISONS: Tukey's Honestly Significant Difference Test\n")
cat("=" %>% rep(70) %>% paste(collapse = ""), "\n\n")

# Tukey's HSD
tukey_result <- TukeyHSD(anova_model, conf.level = 0.95)
print(tukey_result)

# Create a nice table
tukey_df <- as.data.frame(tukey_result$exposure_group)
tukey_df$Comparison <- rownames(tukey_df)
tukey_df <- tukey_df %>%
  dplyr::select(Comparison, diff, lwr, upr, `p adj`) %>%
  dplyr::rename(
    `Mean Difference` = diff,
    `95% CI Lower` = lwr,
    `95% CI Upper` = upr,
    `p-value (adjusted)` = `p adj`
  )

cat("\n\nSummary Table of Pairwise Comparisons:\n")
kable(tukey_df, digits = 4, row.names = FALSE,
      caption = "Tukey's HSD Pairwise Comparisons with Adjusted p-values")

cat("\n\n")
cat("=" %>% rep(70) %>% paste(collapse = ""), "\n")
cat("INTERPRETATION OF PAIRWISE COMPARISONS:\n")
cat("=" %>% rep(70) %>% paste(collapse = ""), "\n\n")

for (i in 1:nrow(tukey_df)) {
  comparison <- tukey_df$Comparison[i]
  mean_diff <- tukey_df$`Mean Difference`[i]
  p_val <- tukey_df$`p-value (adjusted)`[i]

  cat(comparison, ":\n")
  cat("  Mean difference:", round(mean_diff, 2), "IQ points\n")
  cat("  p-value:", format.pval(p_val, digits = 4), "\n")

  if (p_val < 0.05) {
    cat("  Result: STATISTICALLY SIGNIFICANT difference (p < 0.05)\n")
  } else {
    cat("  Result: NO statistically significant difference (p >= 0.05)\n")
  }
  cat("\n")
}
```

## Visualization of Pairwise Comparisons

```{r tukey-plot}
# Plot Tukey's HSD results
par(mar = c(5, 12, 4, 2))
plot(tukey_result, las = 1, cex.axis = 0.8)
title(main = "Tukey's HSD: 95% Confidence Intervals for Mean Differences")
abline(v = 0, col = "red", lty = 2)
```

# Problem 12.41: 95% Confidence Intervals

```{r ci-12-41}
cat("\n\n")
cat("=" %>% rep(70) %>% paste(collapse = ""), "\n")
cat("PROBLEM 12.41: 95% CONFIDENCE INTERVALS FOR MEAN DIFFERENCES\n")
cat("=" %>% rep(70) %>% paste(collapse = ""), "\n\n")

# The Tukey's HSD already provides 95% CIs, but let's also calculate them manually
# using pairwise t-tests with pooled variance

# Get group means and sample sizes
group_stats <- lead_iq %>%
  dplyr::group_by(exposure_group) %>%
  dplyr::summarise(
    n = n(),
    mean = mean(iqf),
    sd = sd(iqf),
    var = var(iqf),
    .groups = 'drop'
  )

# Calculate pooled variance (MSE from ANOVA)
mse <- anova_summary[[1]]$`Mean Sq`[2]
pooled_sd <- sqrt(mse)

cat("Pooled Standard Deviation (from ANOVA MSE):", round(pooled_sd, 3), "\n\n")

# All pairwise comparisons
comparisons <- list(
  c("Control", "Currently Exposed"),
  c("Control", "Previously Exposed"),
  c("Currently Exposed", "Previously Exposed")
)

ci_results <- data.frame()

for (comp in comparisons) {
  group1 <- comp[1]
  group2 <- comp[2]

  stats1 <- group_stats %>% dplyr::filter(exposure_group == group1)
  stats2 <- group_stats %>% dplyr::filter(exposure_group == group2)

  mean_diff <- stats1$mean - stats2$mean
  n1 <- stats1$n
  n2 <- stats2$n

  # Standard error of difference
  se_diff <- pooled_sd * sqrt(1/n1 + 1/n2)

  # Degrees of freedom (from ANOVA)
  df <- anova_summary[[1]]$Df[2]

  # Critical t-value (two-tailed, 95% CI)
  t_crit <- qt(0.975, df)

  # Confidence interval
  ci_lower <- mean_diff - t_crit * se_diff
  ci_upper <- mean_diff + t_crit * se_diff

  # Conduct t-test for p-value
  group1_data <- lead_iq %>% dplyr::filter(exposure_group == group1) %>% dplyr::pull(iqf)
  group2_data <- lead_iq %>% dplyr::filter(exposure_group == group2) %>% dplyr::pull(iqf)
  t_test <- t.test(group1_data, group2_data, var.equal = TRUE)

  ci_results <- rbind(ci_results, data.frame(
    Comparison = paste(group1, "vs", group2),
    Mean_Diff = mean_diff,
    SE = se_diff,
    CI_Lower = ci_lower,
    CI_Upper = ci_upper,
    t_statistic = t_test$statistic,
    p_value = t_test$p.value
  ))
}

rownames(ci_results) <- NULL

kable(ci_results, digits = 3, row.names = FALSE,
      caption = "95% Confidence Intervals for Mean Differences in Full-Scale IQ",
      col.names = c("Comparison", "Mean Difference", "SE",
                    "95% CI Lower", "95% CI Upper", "t-statistic", "p-value"))

cat("\n\n")
cat("=" %>% rep(70) %>% paste(collapse = ""), "\n")
cat("INTERPRETATION OF 95% CONFIDENCE INTERVALS:\n")
cat("=" %>% rep(70) %>% paste(collapse = ""), "\n\n")

for (i in 1:nrow(ci_results)) {
  cat(ci_results$Comparison[i], ":\n")
  cat("  Mean difference:", round(ci_results$Mean_Diff[i], 2), "IQ points\n")
  cat("  95% CI: (", round(ci_results$CI_Lower[i], 2), ",",
      round(ci_results$CI_Upper[i], 2), ")\n")

  if (ci_results$CI_Lower[i] * ci_results$CI_Upper[i] > 0) {
    cat("  Interpretation: The CI does NOT include zero, indicating a\n")
    cat("                  statistically significant difference.\n")
  } else {
    cat("  Interpretation: The CI INCLUDES zero, indicating NO\n")
    cat("                  statistically significant difference.\n")
  }
  cat("\n")
}
```

## Visualization of Confidence Intervals

```{r ci-plot}
ggplot(ci_results, aes(x = Comparison, y = Mean_Diff)) +
  geom_point(size = 4, color = "blue") +
  geom_errorbar(aes(ymin = CI_Lower, ymax = CI_Upper),
                width = 0.2, linewidth = 1, color = "blue") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red", linewidth = 1) +
  coord_flip() +
  labs(title = "95% Confidence Intervals for Mean IQ Differences",
       subtitle = "Red dashed line at zero; CIs not crossing zero are significant",
       x = "Comparison",
       y = "Mean Difference in Full-Scale IQ (with 95% CI)") +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 10))
```

# Summary of Results

```{r summary}
cat("\n")
cat("=" %>% rep(70) %>% paste(collapse = ""), "\n")
cat("SUMMARY OF KEY FINDINGS\n")
cat("=" %>% rep(70) %>% paste(collapse = ""), "\n\n")

cat("Sample Sizes:\n")
print(table(lead_iq$exposure_group))

cat("\n\nMean IQ by Group:\n")
for (group in levels(lead_iq$exposure_group)) {
  mean_val <- desc_stats %>% dplyr::filter(exposure_group == group) %>% dplyr::pull(Mean)
  sd_val <- desc_stats %>% dplyr::filter(exposure_group == group) %>% dplyr::pull(SD)
  n_val <- desc_stats %>% dplyr::filter(exposure_group == group) %>% dplyr::pull(N)
  cat(sprintf("  %s: %.2f (SD = %.2f, n = %d)\n", group, mean_val, sd_val, n_val))
}

cat("\n\nProblem 12.40 - ANOVA Results:\n")
cat("  F-statistic:", round(anova_summary[[1]]$`F value`[1], 3), "\n")
cat("  p-value:", format.pval(anova_p, digits = 4), "\n")
cat("  Conclusion:", ifelse(anova_p < 0.05,
                            "Significant overall differences exist among groups.",
                            "No significant overall differences among groups."), "\n")

cat("\n\nProblem 12.40 - Pairwise Comparisons (p-values):\n")
for (i in 1:nrow(tukey_df)) {
  cat(sprintf("  %s: p = %s %s\n",
              tukey_df$Comparison[i],
              format.pval(tukey_df$`p-value (adjusted)`[i], digits = 4),
              ifelse(tukey_df$`p-value (adjusted)`[i] < 0.05, "**", "")))
}

cat("\n\nProblem 12.41 - 95% Confidence Intervals:\n")
for (i in 1:nrow(ci_results)) {
  cat(sprintf("  %s: (%.2f, %.2f)\n",
              ci_results$Comparison[i],
              ci_results$CI_Lower[i],
              ci_results$CI_Upper[i]))
}

cat("\n** indicates statistical significance at α = 0.05\n")
cat("=" %>% rep(70) %>% paste(collapse = ""), "\n")
```

# Conclusions

Based on the ANOVA analysis and pairwise comparisons:

1. **Overall Effect (Problem 12.40)**: The one-way ANOVA `r ifelse(anova_p < 0.05, "shows statistically significant", "does not show statistically significant")` differences in mean full-scale IQ among the three lead exposure groups (p = `r format.pval(anova_p, digits = 4)`).

2. **Pairwise Comparisons (Problem 12.40)**: Tukey's HSD test was used to compare each pair of groups while controlling for multiple comparisons.

3. **Confidence Intervals (Problem 12.41)**: The 95% confidence intervals for mean differences provide a range of plausible values for the true difference between groups. Intervals that do not include zero indicate statistically significant differences.

4. **Clinical Interpretation**: The findings suggest `r ifelse(anova_p < 0.05, "that lead exposure is associated with differences in cognitive function as measured by IQ", "no strong evidence of IQ differences based on lead exposure status in this sample")`.

# Session Information

```{r session-info}
sessionInfo()
```
