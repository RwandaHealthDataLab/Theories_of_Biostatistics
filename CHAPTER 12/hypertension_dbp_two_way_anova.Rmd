---
title: "Hypertension: Two-Way ANOVA for Diastolic Blood Pressure"
subtitle: "Analysis by Study Group and Sex (Reference: Table 12.15)"
author: "Your Name"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE,
                      fig.width = 12, fig.height = 8)
```

# Overview

This analysis performs a **two-way ANOVA** comparing mean diastolic blood pressure (DBP) by:
- **Study Group** (treatment/intervention groups)
- **Sex** (Male/Female)

The analysis examines:
1. **Main effect of study group** on DBP
2. **Main effect of sex** on DBP
3. **Interaction effect** between study group and sex

# Load Required Libraries

```{r load-libraries}
library(tidyverse)
library(knitr)
library(ggplot2)
library(car)
library(emmeans)
library(gridExtra)
```

# Load and Prepare Data

```{r load-data}
# NOTE: Update this section with the correct dataset path and variable names
# based on Table 12.15 reference

# Example: If using INFANTBP or similar dataset
# Adjust file path and variable names as needed

# PLACEHOLDER - Replace with actual dataset
# data <- read.table("path_to_data.txt",
#                    header = TRUE,
#                    sep = "\t",
#                    quote = "'\"",
#                    strip.white = TRUE)

# For demonstration, create sample data structure
# This should be replaced with actual data loading

set.seed(123)
n_per_group <- 20

# Create sample data (REPLACE THIS WITH ACTUAL DATA)
hypertension_data <- data.frame(
  id = 1:(n_per_group * 6),
  study_group = rep(c("Control", "Treatment_1", "Treatment_2"), each = n_per_group * 2),
  sex = rep(rep(c("Male", "Female"), each = n_per_group), 3),
  dbp = c(
    # Control - Male
    rnorm(n_per_group, mean = 85, sd = 10),
    # Control - Female
    rnorm(n_per_group, mean = 80, sd = 10),
    # Treatment 1 - Male
    rnorm(n_per_group, mean = 78, sd = 9),
    # Treatment 1 - Female
    rnorm(n_per_group, mean = 75, sd = 9),
    # Treatment 2 - Male
    rnorm(n_per_group, mean = 76, sd = 8),
    # Treatment 2 - Female
    rnorm(n_per_group, mean = 72, sd = 8)
  )
)

# Convert to factors
hypertension_data <- hypertension_data %>%
  dplyr::mutate(
    study_group = factor(study_group),
    sex = factor(sex)
  )

cat("NOTE: This uses simulated data for demonstration.\n")
cat("Replace with actual data from Table 12.15.\n\n")

# Display structure
str(hypertension_data)

cat("\nSample sizes:\n")
hypertension_data %>%
  dplyr::group_by(study_group, sex) %>%
  dplyr::summarise(N = n(), .groups = 'drop') %>%
  kable(caption = "Sample Sizes by Study Group and Sex")
```

# Descriptive Statistics

```{r descriptive-stats}
# Summary statistics by group and sex
desc_stats <- hypertension_data %>%
  dplyr::group_by(study_group, sex) %>%
  dplyr::summarise(
    N = n(),
    Mean = mean(dbp, na.rm = TRUE),
    SD = sd(dbp, na.rm = TRUE),
    SE = sd(dbp, na.rm = TRUE) / sqrt(n()),
    Median = median(dbp, na.rm = TRUE),
    Min = min(dbp, na.rm = TRUE),
    Max = max(dbp, na.rm = TRUE),
    .groups = 'drop'
  )

kable(desc_stats, digits = 2,
      caption = "Descriptive Statistics for Diastolic Blood Pressure (mmHg)")

# Overall statistics
cat("\nOverall DBP Statistics:\n")
cat("Mean:", round(mean(hypertension_data$dbp, na.rm = TRUE), 2), "mmHg\n")
cat("SD:", round(sd(hypertension_data$dbp, na.rm = TRUE), 2), "mmHg\n")
cat("Range:", round(range(hypertension_data$dbp, na.rm = TRUE), 2), "mmHg\n")
```

# Visualizations

## Boxplots by Group and Sex

```{r boxplots}
ggplot(hypertension_data, aes(x = study_group, y = dbp, fill = sex)) +
  geom_boxplot(alpha = 0.7, position = position_dodge(0.8)) +
  stat_summary(fun = mean, geom = "point", shape = 23, size = 3,
               position = position_dodge(0.8), color = "red", fill = "red") +
  labs(title = "Diastolic Blood Pressure by Study Group and Sex",
       subtitle = "Red diamonds indicate group means",
       x = "Study Group",
       y = "Diastolic Blood Pressure (mmHg)",
       fill = "Sex") +
  theme_minimal() +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 0, hjust = 0.5))
```

## Interaction Plot

```{r interaction-plot}
# Calculate means for interaction plot
interaction_data <- desc_stats %>%
  dplyr::select(study_group, sex, Mean, SE)

ggplot(interaction_data, aes(x = study_group, y = Mean, color = sex, group = sex)) +
  geom_line(linewidth = 1.5) +
  geom_point(size = 4) +
  geom_errorbar(aes(ymin = Mean - SE, ymax = Mean + SE),
                width = 0.2, linewidth = 1) +
  labs(title = "Interaction Plot: Study Group × Sex",
       subtitle = "Error bars represent ± 1 SE; parallel lines suggest no interaction",
       x = "Study Group",
       y = "Mean Diastolic Blood Pressure (mmHg)",
       color = "Sex") +
  theme_minimal() +
  theme(legend.position = "bottom")

cat("\nInteraction Interpretation:\n")
cat("- Parallel lines: No interaction (effects are additive)\n")
cat("- Non-parallel lines: Interaction present (one factor's effect depends on the other)\n")
```

## Mean Comparisons

```{r mean-comparison-plots, fig.height=10}
# By study group
p1 <- desc_stats %>%
  dplyr::group_by(study_group) %>%
  dplyr::summarise(Mean = mean(Mean), SE = sqrt(sum(SE^2))/n(), .groups = 'drop') %>%
  ggplot(aes(x = study_group, y = Mean)) +
  geom_bar(stat = "identity", fill = "steelblue", alpha = 0.7) +
  geom_errorbar(aes(ymin = Mean - SE, ymax = Mean + SE),
                width = 0.2, linewidth = 1) +
  labs(title = "Mean DBP by Study Group",
       subtitle = "(Averaged across sex)",
       x = "Study Group",
       y = "Mean DBP (mmHg)") +
  theme_minimal()

# By sex
p2 <- desc_stats %>%
  dplyr::group_by(sex) %>%
  dplyr::summarise(Mean = mean(Mean), SE = sqrt(sum(SE^2))/n(), .groups = 'drop') %>%
  ggplot(aes(x = sex, y = Mean, fill = sex)) +
  geom_bar(stat = "identity", alpha = 0.7) +
  geom_errorbar(aes(ymin = Mean - SE, ymax = Mean + SE),
                width = 0.2, linewidth = 1) +
  labs(title = "Mean DBP by Sex",
       subtitle = "(Averaged across study groups)",
       x = "Sex",
       y = "Mean DBP (mmHg)") +
  theme_minimal() +
  theme(legend.position = "none")

grid.arrange(p1, p2, ncol = 1)
```

# Assumptions Check

## Normality

```{r normality-check}
cat("### Normality Assessment ###\n\n")

# Shapiro-Wilk tests by group
cat("Shapiro-Wilk Tests by Study Group and Sex:\n")
cat("-------------------------------------------\n")

for (grp in levels(hypertension_data$study_group)) {
  for (s in levels(hypertension_data$sex)) {
    subset_data <- hypertension_data %>%
      dplyr::filter(study_group == grp, sex == s)

    if (nrow(subset_data) >= 3) {
      sw_test <- shapiro.test(subset_data$dbp)
      cat(sprintf("%s - %s: W = %.4f, p = %.4f\n",
                  grp, s, sw_test$statistic, sw_test$p.value))
    }
  }
}

cat("\nInterpretation: If p > 0.05, data are consistent with normality.\n\n")

# Q-Q plots
n_groups <- length(levels(hypertension_data$study_group))
n_sex <- length(levels(hypertension_data$sex))

par(mfrow = c(n_groups, n_sex))
for (grp in levels(hypertension_data$study_group)) {
  for (s in levels(hypertension_data$sex)) {
    subset_data <- hypertension_data %>%
      dplyr::filter(study_group == grp, sex == s)

    if (nrow(subset_data) >= 3) {
      qqnorm(subset_data$dbp, main = paste(grp, "-", s))
      qqline(subset_data$dbp, col = "red")
    }
  }
}
par(mfrow = c(1, 1))
```

## Homogeneity of Variance

```{r variance-check}
cat("\n### Levene's Test for Homogeneity of Variance ###\n\n")

# Levene's test
levene_test <- leveneTest(dbp ~ study_group * sex, data = hypertension_data)
print(levene_test)

cat("\nInterpretation: If p > 0.05, variances are homogeneous across groups.\n")
```

# Two-Way ANOVA

```{r two-way-anova}
cat("\n")
cat("=" %>% rep(70) %>% paste(collapse = ""), "\n")
cat("TWO-WAY ANOVA: DBP ~ Study Group + Sex + Interaction\n")
cat("=" %>% rep(70) %>% paste(collapse = ""), "\n\n")

# Fit two-way ANOVA model
anova_model <- aov(dbp ~ study_group * sex, data = hypertension_data)
anova_summary <- summary(anova_model)

print(anova_summary)

# Type III sums of squares (using car package)
cat("\n\n### Type III Sums of Squares ###\n")
cat("(For unbalanced designs)\n\n")
anova_type3 <- Anova(anova_model, type = "III")
print(anova_type3)

# Extract p-values
p_group <- anova_summary[[1]]$`Pr(>F)`[1]
p_sex <- anova_summary[[1]]$`Pr(>F)`[2]
p_interaction <- anova_summary[[1]]$`Pr(>F)`[3]

cat("\n")
cat("=" %>% rep(70) %>% paste(collapse = ""), "\n")
cat("INTERPRETATION OF TWO-WAY ANOVA RESULTS\n")
cat("=" %>% rep(70) %>% paste(collapse = ""), "\n\n")

cat("1. INTERACTION EFFECT (Study Group × Sex):\n")
cat("   ", rep("-", 40), "\n", sep = "")
cat("   F-statistic:", round(anova_summary[[1]]$`F value`[3], 3), "\n")
cat("   p-value:", format.pval(p_interaction, digits = 4), "\n")
if (is.na(p_interaction)) {
  cat("   Result: Unable to test (insufficient data)\n")
} else if (p_interaction < 0.05) {
  cat("   Result: SIGNIFICANT interaction (p < 0.05)\n")
  cat("   Interpretation: The effect of study group on DBP differs by sex,\n")
  cat("                   or vice versa. Main effects should be interpreted\n")
  cat("                   with caution.\n")
} else {
  cat("   Result: NO significant interaction (p >= 0.05)\n")
  cat("   Interpretation: The effects of study group and sex are independent.\n")
  cat("                   Main effects can be interpreted directly.\n")
}

cat("\n2. MAIN EFFECT OF STUDY GROUP:\n")
cat("   ", rep("-", 40), "\n", sep = "")
cat("   F-statistic:", round(anova_summary[[1]]$`F value`[1], 3), "\n")
cat("   p-value:", format.pval(p_group, digits = 4), "\n")
if (p_group < 0.05) {
  cat("   Result: SIGNIFICANT main effect (p < 0.05)\n")
  cat("   Interpretation: Mean DBP differs significantly among study groups,\n")
  cat("                   averaging across sex.\n")
} else {
  cat("   Result: NO significant main effect (p >= 0.05)\n")
  cat("   Interpretation: No significant differences in DBP among study groups.\n")
}

cat("\n3. MAIN EFFECT OF SEX:\n")
cat("   ", rep("-", 40), "\n", sep = "")
cat("   F-statistic:", round(anova_summary[[1]]$`F value`[2], 3), "\n")
cat("   p-value:", format.pval(p_sex, digits = 4), "\n")
if (p_sex < 0.05) {
  cat("   Result: SIGNIFICANT main effect (p < 0.05)\n")
  cat("   Interpretation: Mean DBP differs significantly between males and females,\n")
  cat("                   averaging across study groups.\n")
} else {
  cat("   Result: NO significant main effect (p >= 0.05)\n")
  cat("   Interpretation: No significant difference in DBP between sexes.\n")
}

cat("\n")
cat("=" %>% rep(70) %>% paste(collapse = ""), "\n")

# Effect sizes
ss_group <- anova_summary[[1]]$`Sum Sq`[1]
ss_sex <- anova_summary[[1]]$`Sum Sq`[2]
ss_interaction <- anova_summary[[1]]$`Sum Sq`[3]
ss_total <- sum(anova_summary[[1]]$`Sum Sq`)

eta2_group <- ss_group / ss_total
eta2_sex <- ss_sex / ss_total
eta2_interaction <- ss_interaction / ss_total

cat("\n### Effect Sizes (Eta-Squared) ###\n\n")
cat("Study Group:  η² =", round(eta2_group, 4),
    "(", round(eta2_group * 100, 2), "% of variance)\n")
cat("Sex:          η² =", round(eta2_sex, 4),
    "(", round(eta2_sex * 100, 2), "% of variance)\n")
cat("Interaction:  η² =", round(eta2_interaction, 4),
    "(", round(eta2_interaction * 100, 2), "% of variance)\n")
```

# Post-Hoc Comparisons

## Estimated Marginal Means

```{r emmeans}
cat("\n### Estimated Marginal Means (EMMs) ###\n\n")

# EMMs for study group
emm_group <- emmeans(anova_model, ~ study_group)
cat("Study Group:\n")
print(summary(emm_group))

# EMMs for sex
emm_sex <- emmeans(anova_model, ~ sex)
cat("\nSex:\n")
print(summary(emm_sex))

# EMMs for interaction
emm_interaction <- emmeans(anova_model, ~ study_group * sex)
cat("\nStudy Group × Sex:\n")
print(summary(emm_interaction))
```

## Pairwise Comparisons

```{r pairwise-comparisons}
cat("\n### Pairwise Comparisons with Tukey Adjustment ###\n\n")

# Study group comparisons
if (p_group < 0.05) {
  cat("Study Group Comparisons:\n")
  cat("------------------------\n")
  pairs_group <- pairs(emm_group, adjust = "tukey")
  print(summary(pairs_group))
}

# If significant interaction, do simple effects
if (!is.na(p_interaction) && p_interaction < 0.05) {
  cat("\n\nSimple Effects (due to significant interaction):\n")
  cat("------------------------------------------------\n")

  cat("\nEffect of Study Group within each Sex:\n")
  simple_group <- emmeans(anova_model, ~ study_group | sex)
  pairs_simple_group <- pairs(simple_group, adjust = "tukey")
  print(summary(pairs_simple_group))

  cat("\n\nEffect of Sex within each Study Group:\n")
  simple_sex <- emmeans(anova_model, ~ sex | study_group)
  pairs_simple_sex <- pairs(simple_sex, adjust = "tukey")
  print(summary(pairs_simple_sex))
}

# Visualize pairwise comparisons
cat("\n")
plot(emm_interaction, comparisons = TRUE) +
  labs(title = "Estimated Marginal Means with 95% CIs",
       subtitle = "Red arrows indicate comparison intervals",
       x = "Mean DBP (mmHg)",
       y = "Group × Sex Combination") +
  theme_minimal()
```

# Model Diagnostics

```{r diagnostics}
cat("\n### Model Diagnostic Plots ###\n\n")

par(mfrow = c(2, 2))
plot(anova_model)
par(mfrow = c(1, 1))

cat("\nDiagnostic Interpretation:\n")
cat("1. Residuals vs Fitted: Should show random scatter (constant variance)\n")
cat("2. Q-Q Plot: Points should follow line (normality)\n")
cat("3. Scale-Location: Should show random scatter (homoscedasticity)\n")
cat("4. Residuals vs Leverage: Identify influential points\n")
```

# Summary and Conclusions

```{r summary}
cat("\n\n")
cat("=" %>% rep(70) %>% paste(collapse = ""), "\n")
cat("SUMMARY OF FINDINGS\n")
cat("=" %>% rep(70) %>% paste(collapse = ""), "\n\n")

cat("Sample Sizes:\n")
print(table(hypertension_data$study_group, hypertension_data$sex))

cat("\n\nMean DBP by Study Group and Sex:\n")
desc_stats %>%
  dplyr::select(study_group, sex, N, Mean, SD) %>%
  kable(digits = 2)

cat("\n\nANOVA Results Summary:\n")
cat("----------------------\n")
cat("Study Group:  F =", round(anova_summary[[1]]$`F value`[1], 3),
    ", p =", format.pval(p_group, digits = 4),
    ifelse(p_group < 0.05, "***", ""), "\n")
cat("Sex:          F =", round(anova_summary[[1]]$`F value`[2], 3),
    ", p =", format.pval(p_sex, digits = 4),
    ifelse(p_sex < 0.05, "***", ""), "\n")
cat("Interaction:  F =", round(anova_summary[[1]]$`F value`[3], 3),
    ", p =", format.pval(p_interaction, digits = 4),
    ifelse(!is.na(p_interaction) && p_interaction < 0.05, "***", ""), "\n")
cat("(*** indicates p < 0.05)\n\n")

cat("CONCLUSIONS:\n")
cat("------------\n")

if (!is.na(p_interaction) && p_interaction < 0.05) {
  cat("1. There is a SIGNIFICANT INTERACTION between study group and sex.\n")
  cat("   The effect of treatment on DBP differs for males and females.\n")
  cat("   Simple effects analyses should be examined for detailed interpretation.\n\n")
} else {
  cat("1. There is NO significant interaction between study group and sex.\n")
  cat("   The effects are independent and additive.\n\n")
}

if (p_group < 0.05) {
  cat("2. Study group has a SIGNIFICANT effect on DBP.\n")
  cat("   Different treatment/intervention groups show different mean DBP levels.\n\n")
} else {
  cat("2. Study group does NOT have a significant effect on DBP.\n\n")
}

if (p_sex < 0.05) {
  cat("3. Sex has a SIGNIFICANT effect on DBP.\n")
  cat("   Males and females show different mean DBP levels.\n\n")
} else {
  cat("3. Sex does NOT have a significant effect on DBP.\n\n")
}

cat("=" %>% rep(70) %>% paste(collapse = ""), "\n")
```

# Clinical Interpretation

```{r clinical}
cat("\n\nCLINICAL IMPLICATIONS:\n")
cat("---------------------\n\n")

cat("Diastolic blood pressure is an important cardiovascular risk marker.\n")
cat("Normal DBP is typically < 80 mmHg, while DBP ≥ 90 mmHg indicates hypertension.\n\n")

# Calculate proportion with high DBP
high_dbp <- hypertension_data %>%
  dplyr::mutate(hypertensive = dbp >= 90) %>%
  dplyr::group_by(study_group, sex) %>%
  dplyr::summarise(
    N = n(),
    N_Hypertensive = sum(hypertensive),
    Pct_Hypertensive = round(100 * mean(hypertensive), 1),
    .groups = 'drop'
  )

cat("Prevalence of Elevated DBP (≥ 90 mmHg):\n")
kable(high_dbp, caption = "Hypertension Prevalence by Group and Sex")

cat("\n\nIMPLICATIONS OF FINDINGS:\n")

if (p_group < 0.05) {
  cat("- Treatment/intervention effects on blood pressure were observed\n")
  cat("- Groups should be managed according to their BP profiles\n")
}

if (p_sex < 0.05) {
  cat("- Sex differences in DBP suggest need for sex-specific considerations\n")
  cat("- Treatment approaches may need to account for biological sex\n")
}

if (!is.na(p_interaction) && p_interaction < 0.05) {
  cat("- The interaction suggests that treatment effectiveness may differ by sex\n")
  cat("- Personalized treatment strategies accounting for sex may be warranted\n")
}
```

# Session Information

```{r session-info}
sessionInfo()
```

---

## Notes

**Important**: This R Markdown file uses simulated data for demonstration purposes. To analyze actual data from Table 12.15:

1. Replace the data loading section with the correct dataset
2. Update variable names to match the actual data (e.g., `dbp`, `study_group`, `sex`)
3. Adjust factor levels and labels as appropriate
4. Verify that the data structure matches the expected format

The analytical framework and interpretation remain the same regardless of the specific dataset used.
