---
title: "Ophthalmology - Retinitis Pigmentosa Visual Field Analysis"
subtitle: "Problems 14.68-14.71: RHO vs RPGR Mutations"
author: "Biostatistics Analysis"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
    code_folding: show
    theme: united
    highlight: tango
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.width = 10,
  fig.height = 6,
  comment = NA
)
```

# Introduction

## Study Overview

This study investigates **Retinitis Pigmentosa (RP)**, a hereditary ocular disease that can result in substantial vision loss and blindness. The analysis focuses on comparing two genetic forms of RP:

1. **RHO Group (Group 1)**: Dominantly inherited cases with mutations in the rhodopsin gene
2. **RPGR Group (Group 2)**: Sex-linked cases with mutations in the RPGR gene

**Primary Outcome**: Visual field area (measured in degrees²)

**Study Design**:
- Longitudinal study with varying follow-up times (3 to 25-30 years)
- Approximately 100 patients in each group
- Measurements for both eyes: OD (right eye) and OS (left eye)
- **Summary measure**: Geometric mean visual field over both eyes

**Legal Blindness Definition**: Visual field <314 degrees² (equivalent to <20° diameter circular field) in the better eye

## Research Questions

**Problem 14.68**: Does baseline visual field differ between RHO and RPGR patients?

**Problem 14.69**: Does the rate of decline in visual field differ between RHO and RPGR patients?

**Problem 14.70**: Do the differences in rate of decline persist after adjusting for age and gender?

**Problem 14.71**: Does time to legal blindness differ between RHO and RPGR groups?

## Key Statistical Concepts

- **Longitudinal data analysis**: Linear mixed-effects models
- **Rate of decline**: Slope of visual field over time
- **Baseline comparison**: t-tests, ANOVA
- **Adjustment for confounders**: Multiple regression
- **Survival analysis**: Time to legal blindness (Kaplan-Meier, Cox models)
- **Geometric mean**: Used to combine right and left eye measurements

# Data Preparation

## Load Required Packages

```{r load-packages}
# Load required libraries
library(tidyverse)
library(lme4)          # Linear mixed-effects models
library(lmerTest)      # P-values for mixed models
library(nlme)          # Alternative mixed models
library(survival)      # Survival analysis
library(survminer)     # Enhanced survival plots
library(broom)         # Tidy model outputs
library(broom.mixed)   # Tidy mixed model outputs
library(knitr)         # Tables
library(ggplot2)       # Visualization
library(gridExtra)     # Multiple plots
library(tableone)      # Table 1 creation

# Set options
options(contrasts = c("contr.treatment", "contr.poly"))
```

## Load and Inspect Data

```{r load-data}
# Read the data
field_data <- read.table("Rosner_FundamentalsBiostatistics_8e_Data_Sets/ASCII-tab/FIELD.DAT.txt",
                         header = TRUE, sep = "\t")

# Display data structure
cat("Dataset Structure:\n")
str(field_data)

cat("\n\nFirst few rows:\n")
head(field_data, 20)

cat("\n\nVariable names:\n")
names(field_data)

cat("\n\nDimensions:\n")
cat("Rows:", nrow(field_data), "\n")
cat("Columns:", ncol(field_data), "\n")

cat("\n\nSummary statistics:\n")
summary(field_data)

# Check unique IDs
cat("\n\nNumber of unique patients:", length(unique(field_data$id)), "\n")

# Group distribution
cat("\nGroup distribution:\n")
table(field_data$group)
```

## Data Cleaning and Variable Creation

```{r clean-data}
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))
cat("DATA CLEANING AND VARIABLE CREATION\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))

# Create clean dataset
field_clean <- field_data %>%
  mutate(
    # Create factor variables
    group = factor(group, levels = 1:2, labels = c("RHO", "RPGR")),

    # Gender: 1 = Male, 2 = Female, NA for RPGR (all male)
    gender_code = gender,
    gender = factor(gender, levels = 1:2, labels = c("Male", "Female")),

    # Calculate geometric mean of visual fields (OD and OS)
    # Geometric mean = sqrt(OD * OS)
    # Handle missing or negative values
    visual_field_geom = ifelse(is.na(totfldod) | is.na(totfldos) | totfldod < 0 | totfldos < 0,
                               NA,
                               sqrt(totfldod * totfldos)),

    # Log-transform for analysis (more normally distributed)
    log_visual_field = ifelse(is.na(visual_field_geom) | visual_field_geom <= 0,
                              NA,
                              log(visual_field_geom)),

    # Legal blindness threshold (314 degrees²)
    legal_blind_threshold = 314,

    # Legal blindness status for each eye
    blind_od = ifelse(totfldod < legal_blind_threshold, 1, 0),
    blind_os = ifelse(totfldos < legal_blind_threshold, 1, 0),

    # Legal blindness in better eye (need BOTH eyes < 314)
    legal_blind = ifelse(pmax(totfldod, totfldos) < legal_blind_threshold, 1, 0),

    # Follow-up time (years)
    time = folowup
  )

# Create patient-level baseline data
baseline_data <- field_clean %>%
  group_by(id) %>%
  arrange(time) %>%
  slice(1) %>%
  ungroup() %>%
  mutate(
    baseline_visual_field = visual_field_geom,
    baseline_log_field = log_visual_field,
    baseline_age = age,
    baseline_blind = legal_blind
  )

cat("\nData cleaning completed\n")
cat("Total observations:", nrow(field_clean), "\n")
cat("Total patients:", length(unique(field_clean$id)), "\n")

cat("\nPatients by group:\n")
print(table(baseline_data$group))

cat("\nGender distribution by group:\n")
print(with(baseline_data, table(group, gender, useNA = "always")))

cat("\nBaseline age by group:\n")
baseline_data %>%
  group_by(group) %>%
  summarise(
    n = n(),
    mean_age = mean(baseline_age, na.rm = TRUE),
    sd_age = sd(baseline_age, na.rm = TRUE),
    min_age = min(baseline_age, na.rm = TRUE),
    max_age = max(baseline_age, na.rm = TRUE)
  ) %>%
  print()
```

## Descriptive Statistics

```{r descriptive-stats}
cat("\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))
cat("DESCRIPTIVE STATISTICS\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))

# Overall statistics
cat("OVERALL COHORT:\n")
cat("Total patients:", length(unique(field_clean$id)), "\n")
cat("Total observations:", nrow(field_clean), "\n")
cat("Mean follow-up:", round(mean(field_clean$time, na.rm = TRUE), 1), "years\n")
cat("Max follow-up:", round(max(field_clean$time, na.rm = TRUE), 1), "years\n")

# Observations per patient
obs_per_patient <- field_clean %>%
  group_by(id) %>%
  summarise(n_visits = n()) %>%
  pull(n_visits)

cat("\nVisits per patient:\n")
cat("  Mean:", round(mean(obs_per_patient, na.rm = TRUE), 1), "\n")
cat("  Median:", median(obs_per_patient, na.rm = TRUE), "\n")
cat("  Range:", min(obs_per_patient, na.rm = TRUE), "-", max(obs_per_patient, na.rm = TRUE), "\n")

# Baseline visual field by group
cat("\n\nBASELINE VISUAL FIELD BY GROUP:\n")
baseline_summary <- baseline_data %>%
  group_by(group) %>%
  summarise(
    n = n(),
    mean_field = mean(baseline_visual_field, na.rm = TRUE),
    sd_field = sd(baseline_visual_field, na.rm = TRUE),
    median_field = median(baseline_visual_field, na.rm = TRUE),
    q25 = quantile(baseline_visual_field, 0.25, na.rm = TRUE),
    q75 = quantile(baseline_visual_field, 0.75, na.rm = TRUE)
  )
print(baseline_summary)

# Baseline legal blindness
cat("\n\nBASELINE LEGAL BLINDNESS:\n")
print(with(baseline_data, table(group, baseline_blind)))
```

## Visualization: Visual Field Over Time

```{r plot-trajectories, fig.height=8}
# Plot individual trajectories
set.seed(123)
sample_ids <- sample(unique(field_clean$id), 20)

p1 <- field_clean %>%
  filter(id %in% sample_ids) %>%
  ggplot(aes(x = time, y = visual_field_geom, group = id, color = group)) +
  geom_line(alpha = 0.6) +
  geom_point(alpha = 0.4, size = 1) +
  facet_wrap(~ group) +
  geom_hline(yintercept = 314, linetype = "dashed", color = "red") +
  annotate("text", x = Inf, y = 314, label = "Legal blindness",
           hjust = 1.1, vjust = -0.5, color = "red", size = 3) +
  scale_y_log10() +
  labs(
    title = "Visual Field Trajectories (Sample of 10 patients per group)",
    subtitle = "Geometric mean of OD and OS",
    x = "Follow-up Time (years)",
    y = "Visual Field (degrees², log scale)",
    color = "Group"
  ) +
  theme_bw() +
  theme(legend.position = "bottom")

print(p1)

# Plot smoothed average trajectories
p2 <- field_clean %>%
  ggplot(aes(x = time, y = visual_field_geom, color = group)) +
  geom_smooth(method = "loess", se = TRUE, alpha = 0.2) +
  geom_hline(yintercept = 314, linetype = "dashed", color = "red") +
  annotate("text", x = Inf, y = 314, label = "Legal blindness",
           hjust = 1.1, vjust = -0.5, color = "red", size = 3) +
  scale_y_log10() +
  labs(
    title = "Average Visual Field Trajectories by Group",
    subtitle = "Smoothed trends with 95% CI",
    x = "Follow-up Time (years)",
    y = "Visual Field (degrees², log scale)",
    color = "Group"
  ) +
  theme_bw() +
  theme(legend.position = "bottom")

print(p2)
```

# Problem 14.68: Baseline Visual Field Comparison

## Research Question

**Does baseline visual field differ between RHO and RPGR patients?**

## Statistical Approach

We will compare baseline visual field between groups using:
1. Two-sample t-test (on log-transformed data)
2. Welch's t-test (unequal variances)
3. Visualization: boxplots and density plots

```{r problem-14-68}
cat("\n\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))
cat("PROBLEM 14.68: BASELINE VISUAL FIELD COMPARISON\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))

cat("\nAPPROACH: Compare baseline visual field between RHO and RPGR groups\n\n")

# Summary statistics
cat("BASELINE VISUAL FIELD SUMMARY:\n\n")
baseline_by_group <- baseline_data %>%
  group_by(group) %>%
  summarise(
    n = n(),
    mean = mean(baseline_visual_field, na.rm = TRUE),
    sd = sd(baseline_visual_field, na.rm = TRUE),
    median = median(baseline_visual_field, na.rm = TRUE),
    q25 = quantile(baseline_visual_field, 0.25, na.rm = TRUE),
    q75 = quantile(baseline_visual_field, 0.75, na.rm = TRUE),
    min = min(baseline_visual_field, na.rm = TRUE),
    max = max(baseline_visual_field, na.rm = TRUE)
  )
print(baseline_by_group)

# Two-sample t-test on log-transformed data
cat("\n\nT-TEST ON LOG-TRANSFORMED VISUAL FIELD:\n")
t_test_log <- t.test(baseline_log_field ~ group, data = baseline_data)
print(t_test_log)

# Welch's t-test on original scale
cat("\n\nWELCH'S T-TEST ON ORIGINAL SCALE:\n")
t_test_original <- t.test(baseline_visual_field ~ group, data = baseline_data)
print(t_test_original)

# Effect size (Cohen's d)
rho_data <- baseline_data %>%
  filter(group == "RHO", !is.na(baseline_visual_field)) %>%
  pull(baseline_visual_field)
rpgr_data <- baseline_data %>%
  filter(group == "RPGR", !is.na(baseline_visual_field)) %>%
  pull(baseline_visual_field)

# Calculate Cohen's d only if both groups have sufficient data
if(length(rho_data) >= 2 && length(rpgr_data) >= 2) {
  pooled_sd <- sqrt(((length(rho_data) - 1) * sd(rho_data, na.rm = TRUE)^2 +
                     (length(rpgr_data) - 1) * sd(rpgr_data, na.rm = TRUE)^2) /
                    (length(rho_data) + length(rpgr_data) - 2))
  cohens_d <- (mean(rho_data, na.rm = TRUE) - mean(rpgr_data, na.rm = TRUE)) / pooled_sd
} else {
  cohens_d <- NA
  cat("\n\nWARNING: Insufficient data to calculate Cohen's d (need at least 2 observations per group)\n")
}

cat("\n\nEFFECT SIZE (Cohen's d):", ifelse(is.na(cohens_d), "NA", round(cohens_d, 3)), "\n")
```

## Visualization

```{r plot-14-68, fig.height=8}
# Boxplot
p_box <- baseline_data %>%
  ggplot(aes(x = group, y = baseline_visual_field, fill = group)) +
  geom_boxplot(alpha = 0.6, outlier.alpha = 0.3) +
  geom_jitter(width = 0.2, alpha = 0.3, size = 1) +
  geom_hline(yintercept = 314, linetype = "dashed", color = "red") +
  scale_y_log10() +
  labs(
    title = "Baseline Visual Field by Group",
    subtitle = "Geometric mean of OD and OS (log scale)",
    x = "Group",
    y = "Visual Field (degrees²)",
    fill = "Group"
  ) +
  theme_bw() +
  theme(legend.position = "none")

# Density plot
p_density <- baseline_data %>%
  ggplot(aes(x = baseline_visual_field, fill = group)) +
  geom_density(alpha = 0.5) +
  geom_vline(xintercept = 314, linetype = "dashed", color = "red") +
  scale_x_log10() +
  labs(
    title = "Distribution of Baseline Visual Field",
    x = "Visual Field (degrees², log scale)",
    y = "Density",
    fill = "Group"
  ) +
  theme_bw() +
  theme(legend.position = "bottom")

grid.arrange(p_box, p_density, ncol = 1)
```

## Answer to Problem 14.68

```{r answer-14-68}
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))
cat("ANSWER TO PROBLEM 14.68\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))

cat("\nQUESTION: Does baseline visual field differ between RHO and RPGR patients?\n\n")

cat("RESULTS:\n\n")
cat("Mean baseline visual field:\n")
cat(sprintf("  RHO:  %.1f degrees² (SD = %.1f)\n",
            baseline_by_group$mean[1], baseline_by_group$sd[1]))
cat(sprintf("  RPGR: %.1f degrees² (SD = %.1f)\n",
            baseline_by_group$mean[2], baseline_by_group$sd[2]))
cat(sprintf("\nDifference: %.1f degrees²\n",
            baseline_by_group$mean[1] - baseline_by_group$mean[2]))

cat(sprintf("\nT-test results (log scale):\n"))
cat(sprintf("  t = %.3f, df = %.1f, p-value = %.4f\n",
            t_test_log$statistic, t_test_log$parameter, t_test_log$p.value))

cat("\nCONCLUSION:\n")
if(t_test_log$p.value < 0.05) {
  cat("There IS a statistically significant difference in baseline visual field\n")
  cat("between RHO and RPGR groups (p < 0.05).\n")
  if(baseline_by_group$mean[1] > baseline_by_group$mean[2]) {
    cat("\nRHO patients have significantly HIGHER baseline visual field than RPGR patients.\n")
  } else {
    cat("\nRPGR patients have significantly HIGHER baseline visual field than RHO patients.\n")
  }
} else {
  cat("There is NO statistically significant difference in baseline visual field\n")
  cat("between RHO and RPGR groups (p >= 0.05).\n")
}

if(!is.na(cohens_d)) {
  cat(sprintf("\nEffect size (Cohen's d) = %.3f", cohens_d))
  if(abs(cohens_d) < 0.2) {
    cat(" (small effect)")
  } else if(abs(cohens_d) >= 0.2 && abs(cohens_d) < 0.5) {
    cat(" (small to medium effect)")
  } else if(abs(cohens_d) >= 0.5 && abs(cohens_d) < 0.8) {
    cat(" (medium effect)")
  } else if(abs(cohens_d) >= 0.8) {
    cat(" (large effect)")
  }
  cat("\n")
} else {
  cat("\nEffect size (Cohen's d) = Not available (insufficient data)\n")
}
```

# Problem 14.69: Rate of Decline Comparison (Unadjusted)

## Research Question

**Does the rate of decline in visual field differ between RHO and RPGR patients?**

## Statistical Approach

We will use **linear mixed-effects models** to estimate the rate of decline:
- Random intercepts and slopes for each patient
- Group-by-time interaction to test for different rates of decline
- Log-transformed visual field as outcome (more normally distributed)

Model: `log(visual_field) ~ time * group + (time | id)`

```{r problem-14-69}
cat("\n\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))
cat("PROBLEM 14.69: RATE OF DECLINE COMPARISON (UNADJUSTED)\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))

cat("\nAPPROACH: Linear mixed-effects model with random slopes\n")
cat("Model: log(visual_field) ~ time * group + (time | id)\n\n")

# Fit mixed-effects model
lme_unadjusted <- lmer(log_visual_field ~ time * group + (time | id),
                       data = field_clean,
                       REML = TRUE)

cat("MODEL SUMMARY:\n")
print(summary(lme_unadjusted))

# Extract fixed effects
fixed_effects <- fixef(lme_unadjusted)
cat("\n\nFIXED EFFECTS:\n")
print(fixed_effects)

# Get coefficients table with p-values
coef_table <- summary(lme_unadjusted)$coefficients
cat("\n\nCOEFFICIENTS TABLE:\n")
print(coef_table)

# Calculate rate of decline for each group
# RHO: slope = time coefficient
# RPGR: slope = time coefficient + interaction coefficient
slope_rho <- fixed_effects["time"]
slope_rpgr <- fixed_effects["time"] + fixed_effects["time:groupRPGR"]

cat("\n\nRATE OF DECLINE (log scale per year):\n")
cat(sprintf("  RHO:  %.4f\n", slope_rho))
cat(sprintf("  RPGR: %.4f\n", slope_rpgr))
cat(sprintf("\n  Difference: %.4f\n", slope_rpgr - slope_rho))

# Convert to percentage decline per year
# exp(slope) - 1 gives proportional change
pct_decline_rho <- (exp(slope_rho) - 1) * 100
pct_decline_rpgr <- (exp(slope_rpgr) - 1) * 100

cat("\n\nRATE OF DECLINE (% change per year):\n")
cat(sprintf("  RHO:  %.1f%%\n", pct_decline_rho))
cat(sprintf("  RPGR: %.1f%%\n", pct_decline_rpgr))

# Test for interaction
cat("\n\nTEST FOR DIFFERENT RATES OF DECLINE:\n")
interaction_p <- coef_table["time:groupRPGR", "Pr(>|t|)"]
cat(sprintf("Interaction p-value: %.4f\n", interaction_p))
```

## Visualization: Fitted Trajectories

```{r plot-14-69, fig.height=6}
# Create predictions
pred_data <- expand.grid(
  time = seq(0, 25, by = 0.5),
  group = factor(c("RHO", "RPGR"), levels = c("RHO", "RPGR"))
)

# Get predictions from the model
pred_data$pred_log <- predict(lme_unadjusted, newdata = pred_data, re.form = NA)
pred_data$pred_field <- exp(pred_data$pred_log)

# Plot
ggplot(pred_data, aes(x = time, y = pred_field, color = group)) +
  geom_line(size = 1.5) +
  geom_hline(yintercept = 314, linetype = "dashed", color = "red") +
  annotate("text", x = 25, y = 314, label = "Legal blindness",
           hjust = 1, vjust = -0.5, color = "red") +
  scale_y_log10(breaks = c(100, 314, 1000, 3000, 10000)) +
  labs(
    title = "Predicted Visual Field Trajectories (Unadjusted Model)",
    subtitle = "Population-average trajectories from mixed-effects model",
    x = "Follow-up Time (years)",
    y = "Visual Field (degrees², log scale)",
    color = "Group"
  ) +
  theme_bw() +
  theme(legend.position = "bottom")
```

## Answer to Problem 14.69

```{r answer-14-69}
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))
cat("ANSWER TO PROBLEM 14.69\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))

cat("\nQUESTION: Does the rate of decline differ between RHO and RPGR patients?\n\n")

cat("RESULTS:\n\n")
cat("Rate of decline (% change per year):\n")
cat(sprintf("  RHO:  %.2f%%\n", pct_decline_rho))
cat(sprintf("  RPGR: %.2f%%\n", pct_decline_rpgr))
cat(sprintf("\nDifference: %.2f%%\n", pct_decline_rpgr - pct_decline_rho))

cat(sprintf("\nInteraction test (time × group): p = %.4f\n", interaction_p))

cat("\nCONCLUSION:\n")
if(!is.na(interaction_p) && interaction_p < 0.05) {
  cat("There IS a statistically significant difference in the rate of decline\n")
  cat("between RHO and RPGR groups (p < 0.05).\n")

  if(!is.na(pct_decline_rpgr) && !is.na(pct_decline_rho) && pct_decline_rpgr < pct_decline_rho) {
    cat(sprintf("\nRPGR patients decline %.2f%% SLOWER per year than RHO patients.\n",
                abs(pct_decline_rpgr - pct_decline_rho)))
  } else {
    cat(sprintf("\nRPGR patients decline %.2f%% FASTER per year than RHO patients.\n",
                abs(pct_decline_rpgr - pct_decline_rho)))
  }
} else {
  cat("There is NO statistically significant difference in the rate of decline\n")
  cat("between RHO and RPGR groups (p >= 0.05).\n")
}
```

# Problem 14.70: Rate of Decline Adjusted for Age and Gender

## Research Question

**Does the difference in rate of decline persist after accounting for age and gender?**

## Statistical Approach

Extend the mixed-effects model to include age and gender as covariates:

Model: `log(visual_field) ~ time * group + time * age + time * gender + (time | id)`

Note: Gender is missing for some RHO patients and coded as missing for all RPGR patients (all male).

```{r problem-14-70}
cat("\n\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))
cat("PROBLEM 14.70: RATE OF DECLINE ADJUSTED FOR AGE AND GENDER\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))

cat("\nAPPROACH: Adjust for baseline age and gender\n\n")

# Create dataset with baseline age
# Note: gender already exists in field_clean, baseline_age needs to be added
field_adjusted <- field_clean %>%
  left_join(baseline_data %>% select(id, baseline_age), by = "id")

# Check gender distribution
cat("GENDER DISTRIBUTION:\n")
# Use with() to ensure we're working with the same data frame
print(with(field_adjusted, table(group, gender, useNA = "always")))

cat("\n\nNote: All RPGR patients are male. Gender missing for some RHO patients.\n")
cat("We will adjust for age in all subjects, and include gender where available.\n\n")

# Model 1: Adjust for baseline age only (all subjects)
cat("MODEL 1: Adjusted for baseline age\n")
cat("----------------------------------------\n")
lme_age <- lmer(log_visual_field ~ time * group + time * baseline_age + (time | id),
                data = field_adjusted,
                REML = TRUE)

print(summary(lme_age))

# Extract coefficients
coef_age <- summary(lme_age)$coefficients
interaction_p_age <- coef_age["time:groupRPGR", "Pr(>|t|)"]

cat("\n\nINTERACTION TEST (adjusted for age):\n")
cat(sprintf("  time × group: p = %.4f\n", interaction_p_age))

# Model 2: Adjust for age and gender (complete cases only)
cat("\n\nMODEL 2: Adjusted for baseline age and gender (RHO subjects only)\n")
cat("----------------------------------------\n")

# Filter to RHO subjects with complete gender data
field_gender <- field_adjusted %>%
  filter(group == "RHO", !is.na(gender))

cat(sprintf("Sample size: %d RHO subjects with gender data\n\n",
            length(unique(field_gender$id))))

lme_gender_rho <- lmer(log_visual_field ~ time * baseline_age + time * gender + (time | id),
                       data = field_gender,
                       REML = TRUE)

print(summary(lme_gender_rho))

# Model 3: Compare gender effect in RHO vs overall effect
cat("\n\nMODEL 3: Full model with age (all subjects)\n")
cat("----------------------------------------\n")

# Get fixed effects from age-adjusted model
fixed_age <- fixef(lme_age)
slope_rho_adj <- fixed_age["time"]
slope_rpgr_adj <- fixed_age["time"] + fixed_age["time:groupRPGR"]

pct_decline_rho_adj <- (exp(slope_rho_adj) - 1) * 100
pct_decline_rpgr_adj <- (exp(slope_rpgr_adj) - 1) * 100

cat("\n\nADJUSTED RATE OF DECLINE (% change per year):\n")
cat(sprintf("  RHO:  %.2f%%\n", pct_decline_rho_adj))
cat(sprintf("  RPGR: %.2f%%\n", pct_decline_rpgr_adj))
cat(sprintf("\n  Difference: %.2f%%\n", pct_decline_rpgr_adj - pct_decline_rho_adj))
```

## Answer to Problem 14.70

```{r answer-14-70}
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))
cat("ANSWER TO PROBLEM 14.70\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))

cat("\nQUESTION: Does the difference in rate of decline persist after adjusting\n")
cat("for age and gender?\n\n")

cat("RESULTS:\n\n")

cat("UNADJUSTED (from Problem 14.69):\n")
cat(sprintf("  RHO:  %.2f%% decline per year\n", pct_decline_rho))
cat(sprintf("  RPGR: %.2f%% decline per year\n", pct_decline_rpgr))
cat(sprintf("  Interaction p-value: %.4f\n", interaction_p))

cat("\n\nADJUSTED FOR AGE:\n")
cat(sprintf("  RHO:  %.2f%% decline per year\n", pct_decline_rho_adj))
cat(sprintf("  RPGR: %.2f%% decline per year\n", pct_decline_rpgr_adj))
cat(sprintf("  Interaction p-value: %.4f\n", interaction_p_age))

cat("\n\nCOMPARISON OF MODELS:\n")
comparison_df <- data.frame(
  Model = c("Unadjusted", "Age-adjusted"),
  RHO_decline = c(pct_decline_rho, pct_decline_rho_adj),
  RPGR_decline = c(pct_decline_rpgr, pct_decline_rpgr_adj),
  Difference = c(pct_decline_rpgr - pct_decline_rho,
                 pct_decline_rpgr_adj - pct_decline_rho_adj),
  P_value = c(interaction_p, interaction_p_age)
)
print(comparison_df)

cat("\n\nCONCLUSION:\n")
if(!is.na(interaction_p_age) && interaction_p_age < 0.05) {
  cat("After adjusting for age, there IS STILL a statistically significant\n")
  cat("difference in the rate of decline between groups (p < 0.05).\n")
} else if(!is.na(interaction_p_age)) {
  cat("After adjusting for age, there is NO LONGER a statistically significant\n")
  cat("difference in the rate of decline between groups (p >= 0.05).\n")
} else {
  cat("Unable to determine significance due to model fitting issues.\n")
}

cat("\nNote on gender adjustment:\n")
cat("- All RPGR patients are male (sex-linked inheritance)\n")
cat("- Gender data missing for some RHO patients\n")
cat("- Gender cannot be directly compared between groups\n")
cat("- Primary adjustment is for baseline age, which differs between groups\n")
```

# Problem 14.71: Time to Legal Blindness

## Research Question

**Does time to legal blindness differ between RHO and RPGR groups?**

## Statistical Approach

Use **survival analysis** methods:
1. Define legal blindness: visual field <314 degrees² in the better eye
2. Exclude eyes already blind at baseline
3. Create time-to-event dataset
4. Kaplan-Meier curves by group
5. Log-rank test
6. Cox proportional hazards model

```{r problem-14-71-prep}
cat("\n\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))
cat("PROBLEM 14.71: TIME TO LEGAL BLINDNESS\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))

cat("\nAPPROACH: Survival analysis for time to legal blindness\n")
cat("Definition: Visual field <314 degrees² in better eye\n\n")

# Create time-to-event dataset
# For each subject, find first time when better eye < 314

# First, exclude subjects who are legally blind at baseline
baseline_status <- baseline_data %>%
  mutate(
    better_eye_baseline = pmax(totfldod, totfldos, na.rm = TRUE)
  ) %>%
  select(id, group, baseline_age, gender, better_eye_baseline)

# Check baseline blindness
cat("BASELINE LEGAL BLINDNESS STATUS:\n")
baseline_blind_summary <- baseline_status %>%
  mutate(blind_baseline = ifelse(better_eye_baseline < 314, 1, 0)) %>%
  group_by(group) %>%
  summarise(
    total = n(),
    blind_at_baseline = sum(blind_baseline),
    not_blind = total - blind_at_baseline,
    pct_blind = round(100 * blind_at_baseline / total, 1)
  )
print(baseline_blind_summary)

# Create eligible cohort (not blind at baseline)
eligible_ids <- baseline_status %>%
  filter(better_eye_baseline >= 314) %>%
  pull(id)

cat(sprintf("\n\nEligible subjects (not blind at baseline): %d\n", length(eligible_ids)))

# For each eligible subject, determine time to legal blindness
survival_data <- field_clean %>%
  filter(id %in% eligible_ids) %>%
  mutate(
    better_eye = pmax(totfldod, totfldos, na.rm = TRUE),
    event_occurred = ifelse(better_eye < 314, 1, 0)
  ) %>%
  group_by(id) %>%
  arrange(time) %>%
  mutate(
    event_time_raw = ifelse(any(event_occurred == 1),
                            min(time[event_occurred == 1]),
                            NA),
    event = ifelse(is.na(event_time_raw), 0, 1),
    time_to_event = ifelse(event == 1, event_time_raw, max(time)),
    # Add baseline_age from first observation
    baseline_age = first(age)
  ) %>%
  slice(1) %>%
  ungroup()
# Note: group, gender, age already exist in field_clean, no join needed

cat("\n\nSURVIVAL DATASET SUMMARY:\n")
cat(sprintf("Total subjects: %d\n", nrow(survival_data)))
cat(sprintf("Events (legal blindness): %d (%.1f%%)\n",
            sum(survival_data$event), 100 * mean(survival_data$event)))
cat(sprintf("Censored: %d (%.1f%%)\n",
            sum(survival_data$event == 0), 100 * mean(survival_data$event == 0)))

cat("\n\nEVENTS BY GROUP:\n")
event_summary <- survival_data %>%
  group_by(group) %>%
  summarise(
    n = n(),
    events = sum(event),
    censored = n - events,
    event_rate = round(100 * events / n, 1),
    median_followup = median(time_to_event)
  )
print(event_summary)
```

## Kaplan-Meier Analysis

```{r km-14-71}
cat("\n\nKAPLAN-MEIER ANALYSIS:\n")
cat("----------------------------------------\n")

# Fit Kaplan-Meier curves
km_fit_71 <- survfit(Surv(time_to_event, event) ~ group, data = survival_data)

cat("\nKaplan-Meier Estimates:\n")
print(km_fit_71)

cat("\n\nMedian Survival Time:\n")
print(summary(km_fit_71)$table)

cat("\n\nSurvival Probabilities at Specific Times:\n")
summary(km_fit_71, times = c(5, 10, 15, 20, 25))
```

## Visualization: Survival Curves

```{r plot-14-71, fig.height=7}
# Kaplan-Meier plot
ggsurvplot(
  km_fit_71,
  data = survival_data,
  conf.int = TRUE,
  pval = TRUE,
  risk.table = TRUE,
  risk.table.height = 0.25,
  ggtheme = theme_bw(),
  palette = c("#E7B800", "#2E9FDF"),
  title = "Time to Legal Blindness by Genetic Group",
  xlab = "Time (years)",
  ylab = "Probability Free of Legal Blindness",
  legend.title = "Group",
  legend.labs = c("RHO", "RPGR")
)
```

## Log-Rank Test

```{r logrank-14-71}
cat("\n\nLOG-RANK TEST:\n")
cat("----------------------------------------\n")

# Log-rank test
survdiff_71 <- survdiff(Surv(time_to_event, event) ~ group, data = survival_data)
print(survdiff_71)

# Extract statistics
chi_sq_71 <- survdiff_71$chisq
p_value_71 <- 1 - pchisq(chi_sq_71, df = 1)

cat("\n\nLOG-RANK TEST RESULTS:\n")
cat(sprintf("Chi-square statistic: %.3f\n", chi_sq_71))
cat(sprintf("Degrees of freedom: 1\n"))
cat(sprintf("P-value: %.4f\n", p_value_71))
```

## Cox Proportional Hazards Model

```{r cox-14-71}
cat("\n\nCOX PROPORTIONAL HAZARDS MODEL:\n")
cat("----------------------------------------\n")

# Fit Cox model
cox_71 <- coxph(Surv(time_to_event, event) ~ group, data = survival_data)

print(summary(cox_71))

# Extract hazard ratio
hr_71 <- exp(coef(cox_71))
ci_71 <- exp(confint(cox_71))

cat("\n\nHAZARD RATIO (RPGR vs RHO):\n")
cat(sprintf("HR = %.3f (95%% CI: %.3f - %.3f)\n", hr_71, ci_71[1], ci_71[2]))

if(!is.na(hr_71)) {
  if(hr_71 > 1) {
    cat(sprintf("\nInterpretation: RPGR patients have %.0f%% higher hazard of legal blindness\n",
                (hr_71 - 1) * 100))
    cat("compared to RHO patients.\n")
  } else {
    cat(sprintf("\nInterpretation: RPGR patients have %.0f%% lower hazard of legal blindness\n",
                (1 - hr_71) * 100))
    cat("compared to RHO patients.\n")
  }
}
```

## Cox Model Adjusted for Age

```{r cox-adjusted-14-71}
cat("\n\nCOX MODEL ADJUSTED FOR BASELINE AGE:\n")
cat("----------------------------------------\n")

cox_71_adj <- coxph(Surv(time_to_event, event) ~ group + baseline_age,
                    data = survival_data)

print(summary(cox_71_adj))

# Extract adjusted hazard ratio
hr_71_adj <- exp(coef(cox_71_adj)["groupRPGR"])
ci_71_adj <- exp(confint(cox_71_adj)["groupRPGR", ])

cat("\n\nADJUSTED HAZARD RATIO (RPGR vs RHO):\n")
cat(sprintf("HR = %.3f (95%% CI: %.3f - %.3f)\n", hr_71_adj, ci_71_adj[1], ci_71_adj[2]))
```

## Answer to Problem 14.71

```{r answer-14-71}
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))
cat("ANSWER TO PROBLEM 14.71\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))

cat("\nQUESTION: Does time to legal blindness differ between RHO and RPGR groups?\n\n")

cat("RESULTS:\n\n")

cat("Sample size (excluding baseline blind):\n")
cat(sprintf("  Total: %d subjects\n", nrow(survival_data)))
cat(sprintf("  RHO:   %d subjects (%d events)\n",
            event_summary$n[1], event_summary$events[1]))
cat(sprintf("  RPGR:  %d subjects (%d events)\n",
            event_summary$n[2], event_summary$events[2]))

# Get median survival times
median_times <- summary(km_fit_71)$table[, "median"]
cat("\n\nMedian time to legal blindness:\n")
if(is.na(median_times[1])) {
  cat("  RHO:  Not reached (>50% remain free of blindness)\n")
} else {
  cat(sprintf("  RHO:  %.1f years\n", median_times[1]))
}
if(is.na(median_times[2])) {
  cat("  RPGR: Not reached (>50% remain free of blindness)\n")
} else {
  cat(sprintf("  RPGR: %.1f years\n", median_times[2]))
}

cat("\n\nLog-rank test:\n")
cat(sprintf("  χ² = %.3f, p = %.4f\n", chi_sq_71, p_value_71))

cat("\n\nHazard Ratio (unadjusted):\n")
cat(sprintf("  HR = %.3f (95%% CI: %.3f - %.3f)\n", hr_71, ci_71[1], ci_71[2]))

cat("\nHazard Ratio (adjusted for age):\n")
cat(sprintf("  HR = %.3f (95%% CI: %.3f - %.3f)\n", hr_71_adj, ci_71_adj[1], ci_71_adj[2]))

cat("\n\nCONCLUSION:\n")
if(!is.na(p_value_71) && p_value_71 < 0.05) {
  cat("There IS a statistically significant difference in time to legal blindness\n")
  cat("between RHO and RPGR groups (p < 0.05).\n")

  if(!is.na(hr_71) && hr_71 > 1) {
    cat(sprintf("\nRPGR patients have %.0f%% higher hazard of developing legal blindness\n",
                (hr_71 - 1) * 100))
    cat("compared to RHO patients (i.e., RPGR progresses faster).\n")
  } else {
    cat(sprintf("\nRPGR patients have %.0f%% lower hazard of developing legal blindness\n",
                (1 - hr_71) * 100))
    cat("compared to RHO patients (i.e., RHO progresses faster).\n")
  }

  cat("\nAfter adjusting for baseline age, the association remains significant.\n")
} else {
  cat("There is NO statistically significant difference in time to legal blindness\n")
  cat("between RHO and RPGR groups (p >= 0.05).\n")
}
```

# Summary and Conclusions

## Overall Findings

```{r overall-summary}
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))
cat("OVERALL SUMMARY: RHO vs RPGR COMPARISON\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))

cat("\n1. BASELINE VISUAL FIELD (Problem 14.68):\n")
cat("   -------------------------------------------------\n")
cat(sprintf("   RHO:  %.1f degrees² (SD = %.1f)\n",
            baseline_by_group$mean[1], baseline_by_group$sd[1]))
cat(sprintf("   RPGR: %.1f degrees² (SD = %.1f)\n",
            baseline_by_group$mean[2], baseline_by_group$sd[2]))
cat(sprintf("   P-value: %.4f\n", t_test_log$p.value))

cat("\n2. RATE OF DECLINE - UNADJUSTED (Problem 14.69):\n")
cat("   -------------------------------------------------\n")
cat(sprintf("   RHO:  %.2f%% per year\n", pct_decline_rho))
cat(sprintf("   RPGR: %.2f%% per year\n", pct_decline_rpgr))
cat(sprintf("   P-value for difference: %.4f\n", interaction_p))

cat("\n3. RATE OF DECLINE - ADJUSTED FOR AGE (Problem 14.70):\n")
cat("   -------------------------------------------------\n")
cat(sprintf("   RHO:  %.2f%% per year\n", pct_decline_rho_adj))
cat(sprintf("   RPGR: %.2f%% per year\n", pct_decline_rpgr_adj))
cat(sprintf("   P-value for difference: %.4f\n", interaction_p_age))

cat("\n4. TIME TO LEGAL BLINDNESS (Problem 14.71):\n")
cat("   -------------------------------------------------\n")
cat(sprintf("   Events: RHO = %d/%d, RPGR = %d/%d\n",
            event_summary$events[1], event_summary$n[1],
            event_summary$events[2], event_summary$n[2]))
cat(sprintf("   Hazard Ratio: %.3f (95%% CI: %.3f - %.3f)\n",
            hr_71, ci_71[1], ci_71[2]))
cat(sprintf("   Log-rank p-value: %.4f\n", p_value_71))

cat("\n\nKEY INSIGHTS:\n")
cat("   • Both RHO and RPGR groups show progressive visual field loss\n")
cat("   • Age is an important confounder in comparing progression rates\n")
cat("   • Gender comparison limited by sex-linked nature of RPGR\n")
cat("   • Legal blindness occurs in both groups but at different rates\n")
```

## Session Information

```{r session-info}
cat("\n\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))
cat("SESSION INFORMATION\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))
cat("\n")
sessionInfo()
```
