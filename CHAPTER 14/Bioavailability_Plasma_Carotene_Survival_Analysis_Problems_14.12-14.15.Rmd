---
title: "Bioavailability - Plasma Carotene Study"
subtitle: "Problems 14.12-14.15: Survival Analysis of Bioavailability"
author: "Biostatistics Analysis"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
    code_folding: show
    theme: united
    highlight: tango
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.width = 10,
  fig.height = 6,
  comment = NA
)
```

# Introduction

## Study Overview

This analysis examines **bioavailability** of beta-carotene preparations by tracking plasma carotene levels over time. We define bioavailability using survival analysis concepts:

- **Event**: Bioavailability achieved (plasma carotene increases by threshold from baseline)
- **Time**: Week when threshold is first reached
- **Censoring**: Subjects who never reach threshold during follow-up
- **Different preparations**: Compare bioavailability patterns across treatment groups

## Research Questions

**Problem 14.12**: Estimate proportion of subjects for whom preparation is NOT bioavailable at different time points (50% increase criterion).

**Problem 14.13**: Assess differences among survival curves for different preparations (50% criterion).

**Problem 14.14**: Repeat Problem 14.12 with 100% increase criterion.

**Problem 14.15**: Repeat Problem 14.13 with 100% increase criterion.

## Key Statistical Concepts

- **Time-to-bioavailability**: Time until plasma carotene reaches threshold
- **Survival function**: S(t) = P(not yet bioavailable at time t)
- **Kaplan-Meier estimator**: Non-parametric survival curve
- **Cox proportional hazards**: Compare preparations using dummy variables
- **Log-rank test**: Compare survival curves across groups
- **Threshold definitions**: 50% vs 100% increase from baseline

# Data Preparation

## Load Required Packages

```{r load-packages}
# Load required libraries
library(tidyverse)
library(survival)      # Survival analysis
library(survminer)     # Enhanced survival plots
library(broom)         # Tidy model outputs
library(knitr)         # Tables
library(ggplot2)       # Visualization
library(gridExtra)     # Multiple plots

# Set options
options(contrasts = c("contr.treatment", "contr.poly"))
```

## Load and Inspect Data

```{r load-data}
# Read the data
betacar_data <- read.table("Rosner_FundamentalsBiostatistics_8e_Data_Sets/ASCII-tab/BETACAR.DAT.txt",
                           header = TRUE, sep = "\t")

# Display data structure
cat("Dataset Structure:\n")
str(betacar_data)

cat("\n\nFirst few rows:\n")
head(betacar_data, 20)

cat("\n\nVariable names:\n")
names(betacar_data)

cat("\n\nSummary statistics:\n")
summary(betacar_data)
```

## Identify Study Structure

```{r identify-structure}
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))
cat("IDENTIFYING STUDY STRUCTURE\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))

# Expected structure:
# - Subject ID
# - Treatment group/preparation type
# - Baseline measurements (week 0, possibly 2 measurements)
# - Follow-up measurements at different weeks

# Identify key variables
id_vars <- grep("id|subject|subj|ptid", names(betacar_data), ignore.case = TRUE, value = TRUE)
group_vars <- grep("group|trt|treatment|prep|dose", names(betacar_data),
                   ignore.case = TRUE, value = TRUE)
carotene_vars <- grep("bcarot|carot|plasma|level", names(betacar_data),
                      ignore.case = TRUE, value = TRUE)

cat("\nID variables:", paste(id_vars, collapse = ", "), "\n")
cat("Group/treatment variables:", paste(group_vars, collapse = ", "), "\n")
cat("Carotene measurement variables:", paste(carotene_vars, collapse = ", "), "\n")

# Check for time-varying structure
cat("\n\nData format:\n")
if(nrow(betacar_data) > 100) {
  cat("Likely LONG format (one row per subject-time)\n")
} else {
  cat("Likely WIDE format (one row per subject, multiple time columns)\n")
}
```

## Data Reshaping and Baseline Calculation

```{r reshape-data}
cat("\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))
cat("DATA PREPARATION\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))

# Data structure:
# Prepar: Preparation type (1-4)
# Id: Subject ID
# Base1lvl, Base2lvl: Two baseline measurements
# Wk6lvl, Wk8lvl, Wk10lvl, Wk12lvl: Follow-up measurements at weeks 6, 8, 10, 12

# Create clean dataset with standardized names
betacar_clean <- betacar_data %>%
  rename(
    subject_id = Id,
    preparation = Prepar
  ) %>%
  mutate(
    preparation = factor(preparation,
                        levels = 1:4,
                        labels = paste("Preparation", 1:4))
  )

cat("\nData prepared for analysis\n")
cat("Total subjects:", nrow(betacar_clean), "\n")
cat("\nPreparation groups:\n")
print(table(betacar_clean$preparation))

cat("\n\nData columns:\n")
print(names(betacar_clean))
```

## Calculate Baseline and Determine Time to Event

```{r calculate-baseline}
cat("\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))
cat("CALCULATING BASELINE AND TIME TO BIOAVAILABILITY\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))

# Calculate baseline as average of Base1lvl and Base2lvl
betacar_clean <- betacar_clean %>%
  mutate(
    baseline = (Base1lvl + Base2lvl) / 2
  )

cat("\nBaseline carotene levels calculated\n")
cat("Mean baseline:", round(mean(betacar_clean$baseline, na.rm = TRUE), 2), "\n")
cat("Range:", round(min(betacar_clean$baseline, na.rm = TRUE), 2), "-",
    round(max(betacar_clean$baseline, na.rm = TRUE), 2), "\n")

# Display baseline by preparation
cat("\n\nBaseline by preparation:\n")
baseline_summary <- betacar_clean %>%
  group_by(preparation) %>%
  summarise(
    n = n(),
    mean = mean(baseline, na.rm = TRUE),
    sd = sd(baseline, na.rm = TRUE),
    min = min(baseline, na.rm = TRUE),
    max = max(baseline, na.rm = TRUE)
  )
print(baseline_summary)
```

## Create Survival Dataset

```{r create-survival-data}
cat("\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))
cat("CREATING SURVIVAL DATASET\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))

# Create time-to-bioavailability for both 50% and 100% criteria
# Measurements available at weeks: 6, 8, 10, 12

betacar_survival <- betacar_clean %>%
  mutate(
    # Calculate threshold levels
    threshold_50 = baseline * 1.5,   # 50% increase
    threshold_100 = baseline * 2.0,  # 100% increase (doubling)

    # For 50% criterion: find first week >= 50% increase
    time_to_bioavail_50 = case_when(
      Wk6lvl >= threshold_50 ~ 6,
      Wk8lvl >= threshold_50 ~ 8,
      Wk10lvl >= threshold_50 ~ 10,
      Wk12lvl >= threshold_50 ~ 12,
      TRUE ~ 12  # censored at week 12
    ),

    # Event indicator for 50% criterion
    event_50 = case_when(
      Wk6lvl >= threshold_50 ~ 1,
      Wk8lvl >= threshold_50 ~ 1,
      Wk10lvl >= threshold_50 ~ 1,
      Wk12lvl >= threshold_50 ~ 1,
      TRUE ~ 0  # censored
    ),

    # For 100% criterion: find first week >= 100% increase
    time_to_bioavail_100 = case_when(
      Wk6lvl >= threshold_100 ~ 6,
      Wk8lvl >= threshold_100 ~ 8,
      Wk10lvl >= threshold_100 ~ 10,
      Wk12lvl >= threshold_100 ~ 12,
      TRUE ~ 12  # censored at week 12
    ),

    # Event indicator for 100% criterion
    event_100 = case_when(
      Wk6lvl >= threshold_100 ~ 1,
      Wk8lvl >= threshold_100 ~ 1,
      Wk10lvl >= threshold_100 ~ 1,
      Wk12lvl >= threshold_100 ~ 1,
      TRUE ~ 0  # censored
    )
  )

cat("\nSurvival dataset created\n")
cat("Total subjects:", nrow(betacar_survival), "\n")

cat("\n50% INCREASE CRITERION:\n")
cat("Events (bioavailable):", sum(betacar_survival$event_50), "\n")
cat("Censored:", sum(betacar_survival$event_50 == 0), "\n")
cat("Event rate:", round(100 * mean(betacar_survival$event_50), 1), "%\n")

cat("\n100% INCREASE CRITERION:\n")
cat("Events (bioavailable):", sum(betacar_survival$event_100), "\n")
cat("Censored:", sum(betacar_survival$event_100 == 0), "\n")
cat("Event rate:", round(100 * mean(betacar_survival$event_100), 1), "%\n")

# Summary by preparation
cat("\n\nEvent rates by preparation:\n")
event_summary <- betacar_survival %>%
  group_by(preparation) %>%
  summarise(
    n = n(),
    events_50pct = sum(event_50),
    rate_50pct = round(100 * mean(event_50), 1),
    events_100pct = sum(event_100),
    rate_100pct = round(100 * mean(event_100), 1)
  )
print(event_summary)
```

# Exploratory Analysis

```{r exploratory}
cat("\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))
cat("EXPLORATORY ANALYSIS\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))

# Display a few example subjects
cat("\nExample subjects (first 5):\n")
betacar_survival %>%
  select(subject_id, preparation, baseline, Base1lvl, Base2lvl,
         Wk6lvl, Wk8lvl, Wk10lvl, Wk12lvl,
         time_to_bioavail_50, event_50,
         time_to_bioavail_100, event_100) %>%
  head(5) %>%
  print()

# Distribution of time to bioavailability
cat("\n\nDistribution of time to bioavailability (50% criterion):\n")
print(table(betacar_survival$time_to_bioavail_50, betacar_survival$event_50))

cat("\n\nDistribution of time to bioavailability (100% criterion):\n")
print(table(betacar_survival$time_to_bioavail_100, betacar_survival$event_100))
```

# Problem 14.12: Survival Curves (50% Criterion)

## Kaplan-Meier Analysis

```{r problem-14-12}
cat("\n\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))
cat("PROBLEM 14.12: KAPLAN-MEIER SURVIVAL CURVES (50% INCREASE)\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))

cat("\nOBJECTIVE: Estimate proportion NOT bioavailable over time\n")
cat("CRITERION: 50% increase from baseline (plasma carotene >= 1.5 × baseline)\n\n")

# Fit Kaplan-Meier curves by preparation
km_fit_50 <- survfit(Surv(time_to_bioavail_50, event_50) ~ preparation,
                     data = betacar_survival)

# Overall KM curve (all preparations combined)
km_fit_50_overall <- survfit(Surv(time_to_bioavail_50, event_50) ~ 1,
                             data = betacar_survival)

cat("Kaplan-Meier Survival Estimates (50% Criterion)\n")
cat("=" %>% rep(60) %>% paste(collapse = ""), "\n\n")

# Summary at available time points (6, 8, 10, 12 weeks)
summary_50 <- summary(km_fit_50, times = c(6, 8, 10, 12))

cat("Survival probabilities by preparation:\n")
print(summary_50)

# Overall survival
cat("\n\nOverall survival (all preparations combined):\n")
summary_50_overall <- summary(km_fit_50_overall, times = c(6, 8, 10, 12))
print(summary_50_overall)

# Extract median survival times
cat("\n\nMedian time to bioavailability by preparation:\n")
print(km_fit_50)
```

## Visualizations

```{r plot-14-12, fig.height=8}
# Plot 1: Survival curves (proportion NOT yet bioavailable)
p1 <- ggsurvplot(
  km_fit_50,
  data = betacar_survival,
  pval = FALSE,
  conf.int = FALSE,  # Disable confidence intervals to avoid ribbon error
  risk.table = TRUE,
  risk.table.height = 0.25,
  title = "Time to Bioavailability (50% Increase Criterion)",
  xlab = "Week",
  ylab = "Proportion NOT Yet Bioavailable",
  legend.title = "Preparation",
  legend.labs = paste("Prep", 1:4),
  break.x.by = 2,
  xlim = c(0, 12),
  palette = "jco",
  ggtheme = theme_bw()
)
print(p1)

# Plot 2: Cumulative incidence (proportion bioavailable)
p2 <- ggsurvplot(
  km_fit_50,
  data = betacar_survival,
  fun = function(y) 1 - y,
  conf.int = FALSE,  # Disable confidence intervals to avoid ribbon error
  risk.table = FALSE,
  title = "Cumulative Bioavailability (50% Criterion)",
  xlab = "Week",
  ylab = "Proportion Bioavailable",
  legend.title = "Preparation",
  legend.labs = paste("Prep", 1:4),
  break.x.by = 2,
  xlim = c(0, 12),
  palette = "jco",
  ggtheme = theme_bw()
)
print(p2)
```

## Interpretation

```{r interpret-14-12}
cat("\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))
cat("INTERPRETATION - PROBLEM 14.12\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))

# Extract summary statistics
surv_summary <- summary(km_fit_50, times = c(6, 8, 10, 12))
surv_df <- data.frame(
  preparation = surv_summary$strata,
  time = surv_summary$time,
  surv = surv_summary$surv,
  n_risk = surv_summary$n.risk,
  n_event = surv_summary$n.event
)

# Calculate proportion NOT bioavailable at each time
cat("\nPROPORTION NOT YET BIOAVAILABLE (50% criterion):\n\n")

for(prep in levels(betacar_survival$preparation)) {
  cat(prep, ":\n")
  prep_data <- surv_df[grepl(prep, surv_df$preparation, fixed = TRUE), ]

  if(nrow(prep_data) > 0) {
    for(i in 1:nrow(prep_data)) {
      week <- prep_data$time[i]
      not_bioavail <- round(100 * prep_data$surv[i], 1)
      bioavail <- round(100 * (1 - prep_data$surv[i]), 1)
      cat(sprintf("  Week %2d: %.1f%% not bioavailable, %.1f%% bioavailable\n",
                  week, not_bioavail, bioavail))
    }
  }
  cat("\n")
}

# Overall summary
cat("\nOVERALL SUMMARY:\n")
cat("- Total subjects:", nrow(betacar_survival), "\n")
cat("- Events (achieved 50% increase):", sum(betacar_survival$event_50), "\n")
cat("- Censored (did not achieve 50%):", sum(betacar_survival$event_50 == 0), "\n")
cat("- Overall bioavailability rate:", round(100 * mean(betacar_survival$event_50), 1), "%\n")

cat("\nANSWER TO PROBLEM 14.12:\n")
cat("The Kaplan-Meier survival curves display the proportion of subjects for\n")
cat("whom the preparation is NOT bioavailable at each time point (using 50%\n")
cat("increase criterion). The curves decrease over time as more subjects achieve\n")
cat("bioavailability. Different preparations show varying patterns of\n")
cat("bioavailability over the 12-week study period.\n")
```

# Problem 14.13: Compare Survival Curves (50% Criterion)

## Cox Proportional Hazards Model

```{r problem-14-13}
cat("\n\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))
cat("PROBLEM 14.13: COMPARE PREPARATIONS (50% CRITERION)\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))

cat("\nAPPROACH: Cox proportional hazards model with dummy variables\n")
cat("Reference group: Preparation 1\n\n")

# Fit Cox model with preparation as predictor
# R automatically creates dummy variables for factor variables
cox_model_50 <- coxph(Surv(time_to_bioavail_50, event_50) ~ preparation,
                      data = betacar_survival)

cat("Cox Proportional Hazards Model (50% criterion)\n")
cat("=" %>% rep(60) %>% paste(collapse = ""), "\n\n")

# Display full summary
print(summary(cox_model_50))

cat("\n\nModel coefficients (log hazard ratios):\n")
print(coef(summary(cox_model_50)))

cat("\n\nHazard ratios with 95% confidence intervals:\n")
hr_table <- tidy(cox_model_50, exponentiate = TRUE, conf.int = TRUE)
print(hr_table)
```

## Log-Rank Test

```{r logrank-14-13}
cat("\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))
cat("LOG-RANK TEST (50% CRITERION)\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))

# Log-rank test to compare survival curves
logrank_50 <- survdiff(Surv(time_to_bioavail_50, event_50) ~ preparation,
                       data = betacar_survival)

print(logrank_50)

# Extract test statistic and p-value
chi_sq <- logrank_50$chisq
df <- length(logrank_50$n) - 1
p_value <- 1 - pchisq(chi_sq, df)

cat("\n\nTest Summary:\n")
cat(sprintf("Chi-square statistic: %.3f\n", chi_sq))
cat(sprintf("Degrees of freedom: %d\n", df))
cat(sprintf("P-value: %.4f\n", p_value))

if(p_value < 0.05) {
  cat("\nConclusion: SIGNIFICANT difference among preparations (p < 0.05)\n")
} else {
  cat("\nConclusion: NO significant difference among preparations (p >= 0.05)\n")
}
```

## Interpretation

```{r interpret-14-13}
cat("\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))
cat("INTERPRETATION - PROBLEM 14.13\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))

# Extract key statistics from Cox model
cox_summary <- summary(cox_model_50)

cat("\nOVERALL TEST OF PREPARATION EFFECT:\n\n")
cat("Likelihood ratio test:\n")
cat(sprintf("  χ² = %.3f, df = %d, p = %.4f\n",
            cox_summary$logtest[1],
            cox_summary$logtest[2],
            cox_summary$logtest[3]))

cat("\nWald test:\n")
cat(sprintf("  χ² = %.3f, df = %d, p = %.4f\n",
            cox_summary$waldtest[1],
            cox_summary$waldtest[2],
            cox_summary$waldtest[3]))

cat("\nLog-rank test:\n")
cat(sprintf("  χ² = %.3f, df = %d, p = %.4f\n",
            chi_sq, df, p_value))

cat("\n\nPAIRWISE COMPARISONS (vs Preparation 1):\n\n")

# Display hazard ratios
hr_df <- tidy(cox_model_50, exponentiate = TRUE, conf.int = TRUE)

for(i in 1:nrow(hr_df)) {
  term <- hr_df$term[i]
  hr <- hr_df$estimate[i]
  ci_low <- hr_df$conf.low[i]
  ci_high <- hr_df$conf.high[i]
  p <- hr_df$p.value[i]

  cat(sprintf("%s:\n", gsub("preparation", "", term)))
  cat(sprintf("  Hazard Ratio = %.3f (95%% CI: %.3f - %.3f)\n", hr, ci_low, ci_high))
  cat(sprintf("  P-value = %.4f\n", p))

  if(hr > 1) {
    cat(sprintf("  Interpretation: %.0f%% higher hazard of bioavailability than Prep 1\n",
                (hr - 1) * 100))
    cat("  (Faster time to bioavailability)\n")
  } else {
    cat(sprintf("  Interpretation: %.0f%% lower hazard of bioavailability than Prep 1\n",
                (1 - hr) * 100))
    cat("  (Slower time to bioavailability)\n")
  }
  cat("\n")
}

cat("\nANSWER TO PROBLEM 14.13:\n")
cat("=" %>% rep(60) %>% paste(collapse = ""), "\n\n")

if(cox_summary$logtest[3] < 0.05) {
  cat("There IS a statistically significant difference among the four preparations\n")
  cat(sprintf("in time to bioavailability (50%% criterion): p = %.4f\n\n", cox_summary$logtest[3]))

  # Identify fastest/slowest
  median_times <- summary(km_fit_50)$table[, "median"]
  fastest_idx <- which.min(median_times)
  slowest_idx <- which.max(median_times)

  cat(sprintf("Fastest bioavailability: %s (median = %.1f weeks)\n",
              names(median_times)[fastest_idx], median_times[fastest_idx]))
  cat(sprintf("Slowest bioavailability: %s (median = %.1f weeks)\n",
              names(median_times)[slowest_idx], median_times[slowest_idx]))
} else {
  cat("There is NO statistically significant difference among the four preparations\n")
  cat(sprintf("in time to bioavailability (50%% criterion): p = %.4f\n", cox_summary$logtest[3]))
}
```

# Problem 14.14: Survival Curves (100% Criterion)

## Kaplan-Meier Analysis

```{r problem-14-14}
cat("\n\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))
cat("PROBLEM 14.14: KAPLAN-MEIER SURVIVAL CURVES (100% INCREASE)\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))

cat("\nOBJECTIVE: Estimate proportion NOT bioavailable over time\n")
cat("CRITERION: 100% increase from baseline (plasma carotene >= 2.0 × baseline)\n\n")

# Fit Kaplan-Meier curves by preparation (100% criterion)
km_fit_100 <- survfit(Surv(time_to_bioavail_100, event_100) ~ preparation,
                      data = betacar_survival)

# Overall KM curve
km_fit_100_overall <- survfit(Surv(time_to_bioavail_100, event_100) ~ 1,
                              data = betacar_survival)

cat("Kaplan-Meier Survival Estimates (100% Criterion)\n")
cat("=" %>% rep(60) %>% paste(collapse = ""), "\n\n")

# Summary at available time points
summary_100 <- summary(km_fit_100, times = c(6, 8, 10, 12))

cat("Survival probabilities by preparation:\n")
print(summary_100)

# Overall survival
cat("\n\nOverall survival (all preparations combined):\n")
summary_100_overall <- summary(km_fit_100_overall, times = c(6, 8, 10, 12))
print(summary_100_overall)

# Extract median survival times
cat("\n\nMedian time to bioavailability by preparation:\n")
print(km_fit_100)
```

## Visualizations

```{r plot-14-14, fig.height=8}
# Plot 1: Survival curves (proportion NOT yet bioavailable)
p3 <- ggsurvplot(
  km_fit_100,
  data = betacar_survival,
  pval = FALSE,
  conf.int = FALSE,  # Disable confidence intervals to avoid ribbon error
  risk.table = TRUE,
  risk.table.height = 0.25,
  title = "Time to Bioavailability (100% Increase Criterion)",
  xlab = "Week",
  ylab = "Proportion NOT Yet Bioavailable",
  legend.title = "Preparation",
  legend.labs = paste("Prep", 1:4),
  break.x.by = 2,
  xlim = c(0, 12),
  palette = "jco",
  ggtheme = theme_bw()
)
print(p3)

# Plot 2: Cumulative incidence (proportion bioavailable)
p4 <- ggsurvplot(
  km_fit_100,
  data = betacar_survival,
  fun = function(y) 1 - y,
  conf.int = FALSE,  # Disable confidence intervals to avoid ribbon error
  risk.table = FALSE,
  title = "Cumulative Bioavailability (100% Criterion)",
  xlab = "Week",
  ylab = "Proportion Bioavailable",
  legend.title = "Preparation",
  legend.labs = paste("Prep", 1:4),
  break.x.by = 2,
  xlim = c(0, 12),
  palette = "jco",
  ggtheme = theme_bw()
)
print(p4)
```

## Interpretation

```{r interpret-14-14}
cat("\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))
cat("INTERPRETATION - PROBLEM 14.14\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))

# Extract summary statistics
surv_summary_100 <- summary(km_fit_100, times = c(6, 8, 10, 12))
surv_df_100 <- data.frame(
  preparation = surv_summary_100$strata,
  time = surv_summary_100$time,
  surv = surv_summary_100$surv,
  n_risk = surv_summary_100$n.risk,
  n_event = surv_summary_100$n.event
)

# Calculate proportion NOT bioavailable at each time
cat("\nPROPORTION NOT YET BIOAVAILABLE (100% criterion):\n\n")

for(prep in levels(betacar_survival$preparation)) {
  cat(prep, ":\n")
  prep_data <- surv_df_100[grepl(prep, surv_df_100$preparation, fixed = TRUE), ]

  if(nrow(prep_data) > 0) {
    for(i in 1:nrow(prep_data)) {
      week <- prep_data$time[i]
      not_bioavail <- round(100 * prep_data$surv[i], 1)
      bioavail <- round(100 * (1 - prep_data$surv[i]), 1)
      cat(sprintf("  Week %2d: %.1f%% not bioavailable, %.1f%% bioavailable\n",
                  week, not_bioavail, bioavail))
    }
  }
  cat("\n")
}

# Overall summary
cat("\nOVERALL SUMMARY:\n")
cat("- Total subjects:", nrow(betacar_survival), "\n")
cat("- Events (achieved 100% increase):", sum(betacar_survival$event_100), "\n")
cat("- Censored (did not achieve 100%):", sum(betacar_survival$event_100 == 0), "\n")
cat("- Overall bioavailability rate:", round(100 * mean(betacar_survival$event_100), 1), "%\n")

cat("\nANSWER TO PROBLEM 14.14:\n")
cat("The Kaplan-Meier survival curves display the proportion of subjects for\n")
cat("whom the preparation is NOT bioavailable at each time point (using 100%\n")
cat("increase criterion). Compared to the 50% criterion, the 100% criterion\n")
cat("shows lower bioavailability rates and potentially more censoring.\n")
```

## Comparison of 50% vs 100% Criteria

```{r compare-criteria}
cat("\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))
cat("COMPARISON: 50% vs 100% CRITERIA\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))

# Create comparison table
comparison_table <- data.frame(
  Criterion = c("50%", "100%"),
  Events = c(sum(betacar_survival$event_50), sum(betacar_survival$event_100)),
  Censored = c(sum(betacar_survival$event_50 == 0), sum(betacar_survival$event_100 == 0)),
  Event_Rate = c(
    round(100 * mean(betacar_survival$event_50), 1),
    round(100 * mean(betacar_survival$event_100), 1)
  )
)

cat("\nOverall comparison:\n")
print(comparison_table)

# Median times by preparation
cat("\n\nMedian time to bioavailability by preparation:\n")
median_comparison <- data.frame(
  Preparation = paste("Prep", 1:4),
  Median_50pct = summary(km_fit_50)$table[, "median"],
  Median_100pct = summary(km_fit_100)$table[, "median"]
)
print(median_comparison)

cat("\n\nKEY OBSERVATIONS:\n")
cat("- As expected, 100% criterion requires LONGER time to achieve\n")
cat("- 100% criterion has LOWER overall bioavailability rates\n")
cat("- 100% criterion has MORE censored observations\n")
cat("- Different criteria may lead to different conclusions about preparations\n")
```

# Problem 14.15: Compare Curves (100% Criterion)

## Cox Proportional Hazards Model

```{r problem-14-15}
cat("\n\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))
cat("PROBLEM 14.15: COMPARE PREPARATIONS (100% CRITERION)\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))

cat("\nAPPROACH: Cox proportional hazards model with dummy variables\n")
cat("Reference group: Preparation 1\n\n")

# Fit Cox model with preparation as predictor (100% criterion)
cox_model_100 <- coxph(Surv(time_to_bioavail_100, event_100) ~ preparation,
                       data = betacar_survival)

cat("Cox Proportional Hazards Model (100% criterion)\n")
cat("=" %>% rep(60) %>% paste(collapse = ""), "\n\n")

# Display full summary
print(summary(cox_model_100))

cat("\n\nModel coefficients (log hazard ratios):\n")
print(coef(summary(cox_model_100)))

cat("\n\nHazard ratios with 95% confidence intervals:\n")
hr_table_100 <- tidy(cox_model_100, exponentiate = TRUE, conf.int = TRUE)
print(hr_table_100)
```

## Log-Rank Test

```{r logrank-14-15}
cat("\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))
cat("LOG-RANK TEST (100% CRITERION)\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))

# Log-rank test to compare survival curves
logrank_100 <- survdiff(Surv(time_to_bioavail_100, event_100) ~ preparation,
                        data = betacar_survival)

print(logrank_100)

# Extract test statistic and p-value
chi_sq_100 <- logrank_100$chisq
df_100 <- length(logrank_100$n) - 1
p_value_100 <- 1 - pchisq(chi_sq_100, df_100)

cat("\n\nTest Summary:\n")
cat(sprintf("Chi-square statistic: %.3f\n", chi_sq_100))
cat(sprintf("Degrees of freedom: %d\n", df_100))
cat(sprintf("P-value: %.4f\n", p_value_100))

if(p_value_100 < 0.05) {
  cat("\nConclusion: SIGNIFICANT difference among preparations (p < 0.05)\n")
} else {
  cat("\nConclusion: NO significant difference among preparations (p >= 0.05)\n")
}
```

## Interpretation

```{r interpret-14-15}
cat("\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))
cat("INTERPRETATION - PROBLEM 14.15\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))

# Extract key statistics from Cox model
cox_summary_100 <- summary(cox_model_100)

cat("\nOVERALL TEST OF PREPARATION EFFECT:\n\n")
cat("Likelihood ratio test:\n")
cat(sprintf("  χ² = %.3f, df = %d, p = %.4f\n",
            cox_summary_100$logtest[1],
            cox_summary_100$logtest[2],
            cox_summary_100$logtest[3]))

cat("\nWald test:\n")
cat(sprintf("  χ² = %.3f, df = %d, p = %.4f\n",
            cox_summary_100$waldtest[1],
            cox_summary_100$waldtest[2],
            cox_summary_100$waldtest[3]))

cat("\nLog-rank test:\n")
cat(sprintf("  χ² = %.3f, df = %d, p = %.4f\n",
            chi_sq_100, df_100, p_value_100))

cat("\n\nPAIRWISE COMPARISONS (vs Preparation 1):\n\n")

# Display hazard ratios
hr_df_100 <- tidy(cox_model_100, exponentiate = TRUE, conf.int = TRUE)

for(i in 1:nrow(hr_df_100)) {
  term <- hr_df_100$term[i]
  hr <- hr_df_100$estimate[i]
  ci_low <- hr_df_100$conf.low[i]
  ci_high <- hr_df_100$conf.high[i]
  p <- hr_df_100$p.value[i]

  cat(sprintf("%s:\n", gsub("preparation", "", term)))
  cat(sprintf("  Hazard Ratio = %.3f (95%% CI: %.3f - %.3f)\n", hr, ci_low, ci_high))
  cat(sprintf("  P-value = %.4f\n", p))

  if(hr > 1) {
    cat(sprintf("  Interpretation: %.0f%% higher hazard of bioavailability than Prep 1\n",
                (hr - 1) * 100))
    cat("  (Faster time to bioavailability)\n")
  } else {
    cat(sprintf("  Interpretation: %.0f%% lower hazard of bioavailability than Prep 1\n",
                (1 - hr) * 100))
    cat("  (Slower time to bioavailability)\n")
  }
  cat("\n")
}

cat("\nANSWER TO PROBLEM 14.15:\n")
cat("=" %>% rep(60) %>% paste(collapse = ""), "\n\n")

if(cox_summary_100$logtest[3] < 0.05) {
  cat("There IS a statistically significant difference among the four preparations\n")
  cat(sprintf("in time to bioavailability (100%% criterion): p = %.4f\n\n", cox_summary_100$logtest[3]))

  # Identify fastest/slowest
  median_times_100 <- summary(km_fit_100)$table[, "median"]
  fastest_idx_100 <- which.min(median_times_100)
  slowest_idx_100 <- which.max(median_times_100)

  cat(sprintf("Fastest bioavailability: %s (median = %.1f weeks)\n",
              names(median_times_100)[fastest_idx_100], median_times_100[fastest_idx_100]))
  cat(sprintf("Slowest bioavailability: %s (median = %.1f weeks)\n",
              names(median_times_100)[slowest_idx_100], median_times_100[slowest_idx_100]))
} else {
  cat("There is NO statistically significant difference among the four preparations\n")
  cat(sprintf("in time to bioavailability (100%% criterion): p = %.4f\n", cox_summary_100$logtest[3]))
}
```

## Comparison of Results: 50% vs 100% Criteria

```{r compare-50-vs-100}
cat("\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))
cat("COMPARISON OF STATISTICAL TESTS: 50% vs 100% CRITERIA\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))

# Extract key statistics
cox_summary_50 <- summary(cox_model_50)
cox_summary_100 <- summary(cox_model_100)

# Create comparison table
cat("\nOverall significance tests:\n\n")
cat(sprintf("%-25s %12s %12s\n", "Test", "50% Criterion", "100% Criterion"))
cat(rep("-", 50), "\n", sep = "")
cat(sprintf("%-25s    p = %.4f    p = %.4f\n",
            "Likelihood Ratio",
            cox_summary_50$logtest[3],
            cox_summary_100$logtest[3]))
cat(sprintf("%-25s    p = %.4f    p = %.4f\n",
            "Wald",
            cox_summary_50$waldtest[3],
            cox_summary_100$waldtest[3]))
cat(sprintf("%-25s    p = %.4f    p = %.4f\n",
            "Log-rank",
            p_value,
            p_value_100))

# Compare hazard ratios
cat("\n\nHazard Ratios Comparison:\n")
cat("(All compared to Preparation 1)\n\n")

hr_df_50 <- tidy(cox_model_50, exponentiate = TRUE, conf.int = TRUE)
hr_df_100 <- tidy(cox_model_100, exponentiate = TRUE, conf.int = TRUE)

cat(sprintf("%-20s %15s %15s\n", "Comparison", "50% Criterion", "100% Criterion"))
cat(rep("-", 52), "\n", sep = "")

for(i in 1:nrow(hr_df_50)) {
  prep_name <- gsub("preparation", "", hr_df_50$term[i])
  hr_50 <- hr_df_50$estimate[i]
  hr_100 <- hr_df_100$estimate[i]

  cat(sprintf("%-20s    HR = %.3f        HR = %.3f\n",
              prep_name, hr_50, hr_100))
}

cat("\n\nKEY FINDINGS:\n\n")

cat("1. Overall Significance:\n")
if(cox_summary_50$logtest[3] < 0.05 && cox_summary_100$logtest[3] < 0.05) {
  cat("   - BOTH criteria show significant differences among preparations\n")
} else if(cox_summary_50$logtest[3] < 0.05 && cox_summary_100$logtest[3] >= 0.05) {
  cat("   - 50% criterion shows significant differences\n")
  cat("   - 100% criterion shows NO significant differences\n")
} else if(cox_summary_50$logtest[3] >= 0.05 && cox_summary_100$logtest[3] < 0.05) {
  cat("   - 50% criterion shows NO significant differences\n")
  cat("   - 100% criterion shows significant differences\n")
} else {
  cat("   - NEITHER criterion shows significant differences among preparations\n")
}

cat("\n2. Hazard Ratio Patterns:\n")
cat("   - Compare direction and magnitude of hazard ratios\n")
cat("   - Assess whether the same preparations show advantages\n")
cat("   - Consider whether ranking of preparations is consistent\n")

cat("\n3. Clinical Implications:\n")
cat("   - Choice of bioavailability criterion may affect conclusions\n")
cat("   - 50% criterion: more lenient, higher event rates\n")
cat("   - 100% criterion: more stringent, potentially more informative\n")
```

# Summary Comparison Table

```{r summary-table}
cat("\n\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))
cat("COMPREHENSIVE SUMMARY TABLE\n")
cat("=" %>% paste(rep("=", 70), collapse = "") %>% paste("=\n", sep = ""))

cat("\nSummary of all four problems:\n\n")

# Get overall event rates
event_rate_50 <- round(100 * mean(betacar_survival$event_50), 1)
event_rate_100 <- round(100 * mean(betacar_survival$event_100), 1)

# Get p-values
p_50 <- summary(cox_model_50)$logtest[3]
p_100 <- summary(cox_model_100)$logtest[3]

summary_table <- data.frame(
  Problem = c("14.12", "14.13", "14.14", "14.15"),
  Criterion = c("50% increase", "50% increase", "100% increase", "100% increase"),
  Analysis = c(
    "KM survival curves",
    "Cox model comparison",
    "KM survival curves",
    "Cox model comparison"
  ),
  Key_Result = c(
    paste0(event_rate_50, "% achieved bioavailability"),
    ifelse(p_50 < 0.05,
           paste0("Significant diff (p=", sprintf("%.4f", p_50), ")"),
           paste0("No significant diff (p=", sprintf("%.4f", p_50), ")")),
    paste0(event_rate_100, "% achieved bioavailability"),
    ifelse(p_100 < 0.05,
           paste0("Significant diff (p=", sprintf("%.4f", p_100), ")"),
           paste0("No significant diff (p=", sprintf("%.4f", p_100), ")"))
  )
)

print(kable(summary_table, format = "simple"))

cat("\n\nKEY FINDINGS:\n\n")

cat("1. Bioavailability rates differ by:\n")
cat("   - Criterion: 50% (", event_rate_50, "%) vs 100% (", event_rate_100, "%)\n", sep = "")
cat("   - Preparation type (see individual analyses)\n")
cat("   - Time point (see Kaplan-Meier curves)\n\n")

cat("2. Statistical significance of preparation differences:\n")
cat("   - 50% criterion: ")
if(p_50 < 0.05) {
  cat("SIGNIFICANT (p = ", sprintf("%.4f", p_50), ")\n", sep = "")
} else {
  cat("NOT SIGNIFICANT (p = ", sprintf("%.4f", p_50), ")\n", sep = "")
}
cat("   - 100% criterion: ")
if(p_100 < 0.05) {
  cat("SIGNIFICANT (p = ", sprintf("%.4f", p_100), ")\n", sep = "")
} else {
  cat("NOT SIGNIFICANT (p = ", sprintf("%.4f", p_100), ")\n", sep = "")
}

cat("\n3. Clinical implications:\n")
cat("   - Higher bioavailability rates with 50% criterion (more lenient)\n")
cat("   - Lower bioavailability rates with 100% criterion (more stringent)\n")
cat("   - Choice of criterion may affect comparative conclusions\n")
cat("   - Consider both clinical relevance and statistical power\n")

# Median times comparison
cat("\n4. Median times to bioavailability:\n")
median_50 <- summary(km_fit_50)$table[, "median"]
median_100 <- summary(km_fit_100)$table[, "median"]

for(i in 1:4) {
  cat(sprintf("   Preparation %d: %.1f weeks (50%%), %.1f weeks (100%%)\n",
              i, median_50[i], median_100[i]))
}
```

---

# Session Information

```{r session-info}
sessionInfo()
```
